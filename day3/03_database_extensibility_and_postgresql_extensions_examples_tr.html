<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="tr" xml:lang="tr">

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="../css/style_bootstrap.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/code.css">
    <link href="https://cdn.prod.website-files.com/5efdb54f07a6812bcd95cc65/6773d0fc3013e060f08d7145_favicon.jpg"
        rel="shortcut icon" type="image/x-icon">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <title>Gun 3: PostgreSQL Uzantilari - Pratik Ornekler</title>
    <style>
        code {
            white-space: pre-wrap;
        }

        span.smallcaps {
            font-variant: small-caps;
        }

        span.underline {
            text-decoration: underline;
        }

        div.column {
            display: inline-block;
            vertical-align: top;
            width: 50%;
        }

        div.hanging-indent {
            margin-left: 1.5em;
            text-indent: -1.5em;
        }

        ul.task-list {
            list-style: none;
        }

        .exercise-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .exercise-box h4 {
            color: #495057;
            margin-bottom: 15px;
        }

        .solution-box {
            background-color: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .solution-box.show {
            display: block;
        }

        .toggle-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        .toggle-btn:hover {
            background-color: #0056b3;
        }

        .hint-box {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .hint-box::before {
            content: "Ipucu: ";
            font-weight: bold;
        }

        .warning-box {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .warning-box::before {
            content: "Uyari: ";
            font-weight: bold;
        }

        .concept-box {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .concept-box::before {
            content: "Kavram: ";
            font-weight: bold;
        }

        .extension-box {
            background-color: #e2d5f1;
            border: 1px solid #c5b3d9;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .extension-box::before {
            content: "Uzanti: ";
            font-weight: bold;
            color: #563d7c;
        }

        .challenge-box {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .challenge-box h4 {
            color: #155724;
        }

        .challenge-box::before {
            content: "";
        }

        .dataset-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
        }

        .dataset-table th,
        .dataset-table td {
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            text-align: left;
        }

        .dataset-table th {
            background-color: #343a40;
            color: white;
        }

        .dataset-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .comparison-table th,
        .comparison-table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: left;
        }

        .comparison-table th {
            background-color: #007bff;
            color: white;
        }

        .comparison-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .result-box {
            background-color: #f1f1f1;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
        }

        .ext-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin: 2px;
            background-color: #336791;
            color: white;
        }

        .use-case-box {
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 15px 0;
        }

        .use-case-box::before {
            content: "Kullanim Senaryosu: ";
            font-weight: bold;
            color: #007bff;
        }

        .output-display {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            overflow-x: auto;
            white-space: pre;
        }

        .ext-category {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin: 2px;
        }

        .cat-search {
            background-color: #28a745;
            color: white;
        }

        .cat-security {
            background-color: #dc3545;
            color: white;
        }

        .cat-data {
            background-color: #17a2b8;
            color: white;
        }

        .cat-analytics {
            background-color: #ffc107;
            color: #212529;
        }

        .cat-spatial {
            background-color: #6f42c1;
            color: white;
        }

        .tree-visual {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
        }

        .language-switcher {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px 20px;
            margin-bottom: 20px;
            display: inline-block;
        }

        .language-switcher a {
            margin: 0 10px;
            text-decoration: none;
            color: #007bff;
        }

        .language-switcher a:hover {
            text-decoration: underline;
        }

        .language-switcher a.active {
            font-weight: bold;
            color: #343a40;
        }
    </style>
</head>

<body>
    <a href="../index_tr.html" class="back-button">← Anasayfaya Don</a>
    <div class="copy-notification" id="copyNotification">Kopyalandi!</div>

    <div id="europeanunion-turkey">
        <img src="../static/eu.png" alt="">
    </div>
    <div id="sanayiteknolojibakan">
        <img src="../static/sanayitek.png" alt="">
    </div>
    <div id="rekabet">
        <img src="../static/rekabet.png" alt="">
    </div>
    <div id="tisk">
        <img src="../static/tisk.png" alt="">
    </div>
    <div id="undp">
        <img src="../static/undp.png" alt="">
    </div>
    <div class="content-container">
        <div class="container">
            <!-- Language Switcher -->
            <div class="language-switcher">
                <span>Dil / Language:</span>
                <a href="03_database_extensibility_and_postgresql_extensions_examples.html">English</a>
                <a href="03_database_extensibility_and_postgresql_extensions_examples_tr.html" class="active">Turkce</a>
            </div>

            <section>
                <h1 id="extensions-practical-examples">PostgreSQL Uzantilari - Pratik Ornekler</h1>
                <p><a href="03_database_extensibility_and_postgresql_extensions.html">&larr; PostgreSQL Uzantilari Dersine Don</a></p>
                <p>Bu sayfa, PostgreSQL uzantilarinda ustalasmak icin uygulamali alistirmalar sunmaktadir. Kriptografi, bulanik arama, UUID'ler, hiyerarsik veri ve daha fazlasi icin uzantilari kullanmayi pratik edin.</p>

                <div class="warning-box">
                    Uzantilar kullanilmadan once PostgreSQL sunucusuna yuklenmelidir.
                    Yuklemek icin <code>CREATE EXTENSION IF NOT EXISTS uzanti_adi;</code> komutunu kullanin.
                </div>
            </section>

            <!-- Extensions Quick Reference -->
            <section>
                <h2 id="extensions-reference">Uzanti Hizli Referansi</h2>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Uzanti</th>
                            <th>Kategori</th>
                            <th>Amac</th>
                            <th>Temel Fonksiyonlar/Tipler</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="ext-badge">pgcrypto</span></td>
                            <td><span class="ext-category cat-security">Guvenlik</span></td>
                            <td>Kriptografik fonksiyonlar</td>
                            <td><code>crypt()</code>, <code>gen_salt()</code>, <code>encrypt()</code></td>
                        </tr>
                        <tr>
                            <td><span class="ext-badge">uuid-ossp</span></td>
                            <td><span class="ext-category cat-data">Veri</span></td>
                            <td>UUID olusturma</td>
                            <td><code>uuid_generate_v4()</code>, <code>uuid_generate_v1()</code></td>
                        </tr>
                        <tr>
                            <td><span class="ext-badge">pg_trgm</span></td>
                            <td><span class="ext-category cat-search">Arama</span></td>
                            <td>Bulanik metin eslestirme</td>
                            <td><code>similarity()</code>, <code>%</code> operatoru</td>
                        </tr>
                        <tr>
                            <td><span class="ext-badge">ltree</span></td>
                            <td><span class="ext-category cat-data">Veri</span></td>
                            <td>Hiyerarsik agaclar</td>
                            <td><code>LTREE</code> tipi, <code>@></code>, <code><@</code> operatorleri</td>
                        </tr>
                        <tr>
                            <td><span class="ext-badge">hstore</span></td>
                            <td><span class="ext-category cat-data">Veri</span></td>
                            <td>Anahtar-deger depolama</td>
                            <td><code>HSTORE</code> tipi, <code>-></code> operatoru</td>
                        </tr>
                        <tr>
                            <td><span class="ext-badge">tablefunc</span></td>
                            <td><span class="ext-category cat-analytics">Analitik</span></td>
                            <td>Pivot tablolar</td>
                            <td><code>crosstab()</code></td>
                        </tr>
                        <tr>
                            <td><span class="ext-badge">intarray</span></td>
                            <td><span class="ext-category cat-data">Veri</span></td>
                            <td>Tamsayi dizi islemleri</td>
                            <td><code>@></code>, <code>&&</code>, <code>idx()</code></td>
                        </tr>
                        <tr>
                            <td><span class="ext-badge">pg_stat_statements</span></td>
                            <td><span class="ext-category cat-analytics">Analitik</span></td>
                            <td>Sorgu istatistikleri</td>
                            <td><code>pg_stat_statements</code> gorunumu</td>
                        </tr>
                        <tr>
                            <td><span class="ext-badge">PostGIS</span></td>
                            <td><span class="ext-category cat-spatial">Mekansal</span></td>
                            <td>Cografi veri</td>
                            <td><code>GEOMETRY</code>, <code>ST_Distance()</code>, <code>ST_Within()</code></td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <!-- Exercise 1: pgcrypto for Security -->
            <section>
                <h2 id="exercise-1">Alistirma 1: pgcrypto ile Kriptografi</h2>
                <p>Parola hashleme, sifreleme ve guvenli rastgele veri olusturma icin pgcrypto kullanmayi ogrenin.</p>

                <div class="extension-box">
                    <code>pgcrypto</code> hashleme (MD5, SHA, bcrypt) ve simetrik sifreleme (AES, 3DES, Blowfish) icin kriptografik fonksiyonlar saglar.
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 1.1: Parola Hashleme</h4>
                    <p>Duzgun hashlanmis parolalarla guvenli bir kullanici dogrulama sistemi olusturun.</p>

                    <div class="use-case-box">
                        Otomatik tuzlama ile bcrypt hashleme kullanarak parolalari saklayin.
                        Asla duz metin parola saklamayin!
                    </div>

                    <p><strong>Gorevler:</strong></p>
                    <ol>
                        <li>Hashlanmis parolalarla bir kullanicilar tablosu olusturun</li>
                        <li>Hashlanmis parolayla bir kullanici ekleyin</li>
                        <li>Parolalari dogrulamak icin bir fonksiyon yazin</li>
                    </ol>

                    <button class="toggle-btn" onclick="toggleSolution('solution1_1')">Cozumu Goster</button>
                    <div id="solution1_1" class="solution-box">
                        <pre><code class="language-sql">-- pgcrypto uzantisini etkinlestir
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- Kullanicilar tablosu olustur
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- bcrypt-hashlanmis parola ile kullanici ekle
-- gen_salt('bf') varsayilan maliyet (8) ile blowfish tuzu olusturur
-- gen_salt('bf', 12) maliyet faktoru 12 kullanir (daha yavas ama daha guvenli)
INSERT INTO users (username, email, password_hash)
VALUES (
    'john_doe',
    'john@example.com',
    crypt('MySecureP@ssw0rd', gen_salt('bf', 10))
);

-- Parola dogrulama (parola eslesiryorsa kullaniciyi dondurur)
SELECT user_id, username, email
FROM users
WHERE username = 'john_doe'
  AND password_hash = crypt('MySecureP@ssw0rd', password_hash);

-- Dogrulama icin bir fonksiyon olustur
CREATE OR REPLACE FUNCTION authenticate_user(
    p_username VARCHAR,
    p_password VARCHAR
)
RETURNS TABLE(user_id INTEGER, username VARCHAR, email VARCHAR) AS $$
BEGIN
    RETURN QUERY
    SELECT u.user_id, u.username, u.email
    FROM users u
    WHERE u.username = p_username
      AND u.password_hash = crypt(p_password, u.password_hash);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Kullanim
SELECT * FROM authenticate_user('john_doe', 'MySecureP@ssw0rd');
-- Parola eslesiryorsa kullanici bilgisini, eslesmirorsa bos dondurur

-- Yeni kullanici kaydetmek icin fonksiyon olustur
CREATE OR REPLACE FUNCTION register_user(
    p_username VARCHAR,
    p_email VARCHAR,
    p_password VARCHAR
)
RETURNS INTEGER AS $$
DECLARE
    new_user_id INTEGER;
BEGIN
    INSERT INTO users (username, email, password_hash)
    VALUES (p_username, p_email, crypt(p_password, gen_salt('bf', 10)))
    RETURNING user_id INTO new_user_id;

    RETURN new_user_id;
END;
$$ LANGUAGE plpgsql;

-- Yeni kullanici kaydet
SELECT register_user('jane_doe', 'jane@example.com', 'AnotherP@ss123');</code></pre>

                        <p><strong>Beklenen Sonuc:</strong></p>
                        <div class="output-display">
user_id | username | email
--------+----------+------------------
      1 | john_doe | john@example.com
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 1.2: Veri Sifreleme</h4>
                    <p>Kredi karti numaralari veya kisisel bilgiler gibi hassas verileri sifreleyin.</p>

                    <button class="toggle-btn" onclick="toggleSolution('solution1_2')">Cozumu Goster</button>
                    <div id="solution1_2" class="solution-box">
                        <pre><code class="language-sql">-- AES ile simetrik sifreleme
CREATE TABLE sensitive_data (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(user_id),
    encrypted_ssn BYTEA,
    encrypted_credit_card BYTEA,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Sifreleme anahtari (gercek sistemlerde guvenli saklayin, kodda degil!)
-- Bu sadece gosterim amacli
CREATE OR REPLACE FUNCTION get_encryption_key()
RETURNS BYTEA AS $$
    SELECT decode('0123456789abcdef0123456789abcdef', 'hex');
$$ LANGUAGE SQL IMMUTABLE;

-- Hassas verileri sifrele ve sakla
INSERT INTO sensitive_data (user_id, encrypted_ssn, encrypted_credit_card)
VALUES (
    1,
    pgp_sym_encrypt('123-45-6789', 'my_secret_passphrase'),
    pgp_sym_encrypt('4111-1111-1111-1111', 'my_secret_passphrase')
);

-- Veriyi coz
SELECT
    id,
    user_id,
    pgp_sym_decrypt(encrypted_ssn, 'my_secret_passphrase') AS ssn,
    pgp_sym_decrypt(encrypted_credit_card, 'my_secret_passphrase') AS credit_card
FROM sensitive_data
WHERE user_id = 1;

-- Ham AES sifreleme kullanma (daha kucuk veriler icin)
-- encrypt(data, key, 'aes') / decrypt(data, key, 'aes')
INSERT INTO sensitive_data (user_id, encrypted_ssn)
VALUES (
    1,
    encrypt('123-45-6789'::bytea, get_encryption_key(), 'aes')
);

-- AES cozme
SELECT
    convert_from(
        decrypt(encrypted_ssn, get_encryption_key(), 'aes'),
        'UTF8'
    ) AS ssn
FROM sensitive_data;

-- Rastgele token/anahtar olustur
SELECT encode(gen_random_bytes(32), 'hex') AS api_key;
SELECT encode(gen_random_bytes(16), 'base64') AS session_token;</code></pre>

                        <div class="warning-box">
                            Sifreleme anahtarlarini asla veritabaninizda veya kodunuzda saklamayin.
                            Ortam degiskenleri veya bir gizli anahtar yonetim sistemi kullanin.
                        </div>
                    </div>
                </div>
            </section>

            <!-- Exercise 2: uuid-ossp -->
            <section>
                <h2 id="exercise-2">Alistirma 2: uuid-ossp ile UUID Olusturma</h2>
                <p>Dagitik sistem dostu benzersiz tanimlayicilar icin UUID'leri kullanin.</p>

                <div class="extension-box">
                    <code>uuid-ossp</code> cesitli UUID surumlerini olusturur. V4 (rastgele) en yaygindir.
                    V1, zaman damgasi ve MAC adresini icerir.
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 2.1: UUID Birincil Anahtarlar</h4>
                    <p>Birincil anahtarlar icin seri tamsayilar yerine UUID'ler kullanan tablolar tasarlayin.</p>

                    <div class="use-case-box">
                        UUID'ler dagitik sistemler, API'ye acik kimlikler ve kimlik numaralandirma saldirillarini onlemek icin idealdir.
                    </div>

                    <button class="toggle-btn" onclick="toggleSolution('solution2_1')">Cozumu Goster</button>
                    <div id="solution2_1" class="solution-box">
                        <pre><code class="language-sql">-- uuid-ossp uzantisini etkinlestir
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Alternatif: PostgreSQL 13+ yerlesik gen_random_uuid() fonksiyonuna sahiptir
-- Temel rastgele UUID'ler icin uzanti gerekmez

-- UUID birincil anahtarli tablo
CREATE TABLE documents (
    document_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    title VARCHAR(255) NOT NULL,
    content TEXT,
    owner_id UUID,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- UUID ve referanslarla tablo
CREATE TABLE document_versions (
    version_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    document_id UUID NOT NULL REFERENCES documents(document_id),
    version_number INTEGER NOT NULL,
    content TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by UUID
);

-- Belge ekle (kimlikler otomatik olusturulur)
INSERT INTO documents (title, content)
VALUES
    ('Proje Teklifi', 'Bu proje teklifi icerigir...'),
    ('Toplanti Notlari', '2024-03-15 tarihinde yapilan toplanti...');

-- Olusturulan UUID'leri kontrol et
SELECT document_id, title FROM documents;

-- Farkli UUID surumler
SELECT
    uuid_generate_v1() AS v1_timestamp_mac,
    uuid_generate_v1mc() AS v1_random_mac,
    uuid_generate_v4() AS v4_random,
    uuid_nil() AS nil_uuid;

-- Ad alanindan UUID olustur (v5 - SHA1 tabanli)
-- Girise dayali belirleyici UUID'ler icin kullanisli
SELECT uuid_generate_v5(uuid_ns_url(), 'https://example.com/users/john');

-- UUID'lerle API token tablosu olustur
CREATE TABLE api_tokens (
    token_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id INTEGER REFERENCES users(user_id),
    token UUID UNIQUE DEFAULT uuid_generate_v4(),
    name VARCHAR(100),
    expires_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Bir kullanici icin yeni API token olustur
INSERT INTO api_tokens (user_id, name, expires_at)
VALUES (1, 'Benim API Tokenim', CURRENT_TIMESTAMP + INTERVAL '30 days')
RETURNING token;</code></pre>

                        <p><strong>Beklenen Sonuc:</strong></p>
                        <div class="output-display">
document_id                          | title
-------------------------------------+------------------
a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d | Proje Teklifi
f6e5d4c3-b2a1-4987-6543-210fedcba987 | Toplanti Notlari
                        </div>
                    </div>
                </div>
            </section>

            <!-- Exercise 3: pg_trgm for Fuzzy Search -->
            <section>
                <h2 id="exercise-3">Alistirma 3: pg_trgm ile Bulanik Metin Arama</h2>
                <p>Trigram benzerligini kullanarak yazim hatasina toleransli arama uygulayin.</p>

                <div class="extension-box">
                    <code>pg_trgm</code> metni benzerlik karsilastirmasi icin 3 karakterli dizilere (trigramlar) ayirir.
                    "Bunu mu demek istediniz?" ozellikleri ve otomatik tamamlama icin harika.
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 3.1: Benzer Isim Arama</h4>
                    <p>Yazim hatalari veya kucuk farkliliklarda bile eslesme bulan bir arama olusturun.</p>

                    <button class="toggle-btn" onclick="toggleSolution('solution3_1')">Cozumu Goster</button>
                    <div id="solution3_1" class="solution-box">
                        <pre><code class="language-sql">-- pg_trgm uzantisini etkinlestir
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- Ornek urunler tablosu
CREATE TABLE products (
    product_id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    category VARCHAR(100)
);

-- Ornek veri ekle
INSERT INTO products (name, description, category) VALUES
    ('PostgreSQL Database', 'Acik kaynakli iliskisel veritabani', 'Yazilim'),
    ('MySQL Server', 'Populer acik kaynakli veritabani', 'Yazilim'),
    ('Microsoft SQL Server', 'Microsoft kurumsal veritabani', 'Yazilim'),
    ('MongoDB Atlas', 'Bulut belge veritabani', 'Yazilim'),
    ('Apple MacBook Pro', 'Profesyonel dizustu bilgisayar', 'Donanim'),
    ('Apple iPhone 15', 'Apple''in en son akilli telefonu', 'Donanim'),
    ('Samsung Galaxy S24', 'Android amiral gemisi telefon', 'Donanim'),
    ('Dell XPS Laptop', 'Yuksek performansli Windows dizustu', 'Donanim');

-- Hizli benzerlik aramasi icin trigram indeksi olustur
CREATE INDEX idx_products_name_trgm ON products USING gin (name gin_trgm_ops);

-- Temel benzerlik aramasi ("PostgresQL" yazim hatasi)
SELECT
    name,
    similarity(name, 'PostgresQL') AS sim_score
FROM products
WHERE similarity(name, 'PostgresQL') > 0.3
ORDER BY sim_score DESC;

-- % operatorunu kullanma (benzerlik esigi gerektirir)
-- Esigi ayarla (varsayilan 0.3)
SET pg_trgm.similarity_threshold = 0.3;

SELECT name
FROM products
WHERE name % 'Postgre SQL';

-- "Bunu mu demek istediniz?" islevi
CREATE OR REPLACE FUNCTION suggest_product(search_term VARCHAR)
RETURNS TABLE(suggestion VARCHAR, similarity_score REAL) AS $$
BEGIN
    RETURN QUERY
    SELECT p.name, similarity(p.name, search_term)
    FROM products p
    WHERE similarity(p.name, search_term) > 0.2
    ORDER BY similarity(p.name, search_term) DESC
    LIMIT 5;
END;
$$ LANGUAGE plpgsql;

-- Onerileri test et
SELECT * FROM suggest_product('Appel Macbook');
SELECT * FROM suggest_product('Samsong Galaxy');

-- Kelime benzerlik (ifade eslestirme icin word_similarity)
SELECT
    name,
    word_similarity('iPhone', name) AS word_sim
FROM products
WHERE 'iPhone' <% name  -- word_similarity operatoru
ORDER BY word_sim DESC;

-- Trigram LIKE ile otomatik tamamlama
SELECT name
FROM products
WHERE name ILIKE '%macb%'
ORDER BY similarity(name, 'macb') DESC
LIMIT 10;</code></pre>

                        <p><strong>Beklenen Sonuc:</strong></p>
                        <div class="output-display">
-- 'PostgresQL' aramasi sonuclari:
name                | sim_score
--------------------+-----------
PostgreSQL Database | 0.5714286

-- 'Appel Macbook' sonuclari:
suggestion        | similarity_score
------------------+-----------------
Apple MacBook Pro | 0.35
Apple iPhone 15   | 0.15
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 3.2: Tam Metin Arama Gelistirmesi</h4>
                    <p>Guclu arama yetenekleri icin pg_trgm'yi PostgreSQL'in tam metin aramasiyla birlestirin.</p>

                    <button class="toggle-btn" onclick="toggleSolution('solution3_2')">Cozumu Goster</button>
                    <div id="solution3_2" class="solution-box">
                        <pre><code class="language-sql">-- Tam metin arama sutunu ekle
ALTER TABLE products ADD COLUMN search_vector tsvector;

-- Arama vektorunu guncelle
UPDATE products SET search_vector =
    setweight(to_tsvector('english', name), 'A') ||
    setweight(to_tsvector('english', COALESCE(description, '')), 'B') ||
    setweight(to_tsvector('english', COALESCE(category, '')), 'C');

-- Her iki arama turu icin GIN indeksleri olustur
CREATE INDEX idx_products_fts ON products USING gin(search_vector);
CREATE INDEX idx_products_desc_trgm ON products USING gin(description gin_trgm_ops);

-- Birlesik arama fonksiyonu
CREATE OR REPLACE FUNCTION search_products(
    search_query VARCHAR,
    use_fuzzy BOOLEAN DEFAULT FALSE
)
RETURNS TABLE(
    product_id INTEGER,
    name VARCHAR,
    description TEXT,
    rank REAL
) AS $$
BEGIN
    IF use_fuzzy THEN
        -- Trigramlarla bulanik arama
        RETURN QUERY
        SELECT
            p.product_id,
            p.name,
            p.description,
            similarity(p.name || ' ' || COALESCE(p.description, ''), search_query) AS rank
        FROM products p
        WHERE (p.name || ' ' || COALESCE(p.description, '')) % search_query
        ORDER BY rank DESC
        LIMIT 20;
    ELSE
        -- Tam tam metin arama
        RETURN QUERY
        SELECT
            p.product_id,
            p.name,
            p.description,
            ts_rank(p.search_vector, plainto_tsquery('english', search_query)) AS rank
        FROM products p
        WHERE p.search_vector @@ plainto_tsquery('english', search_query)
        ORDER BY rank DESC
        LIMIT 20;
    END IF;
END;
$$ LANGUAGE plpgsql;

-- Tam aramayi test et
SELECT * FROM search_products('database server');

-- Bulanik aramayi test et (yazim hatalarina toleransli)
SELECT * FROM search_products('databse servr', TRUE);</code></pre>
                    </div>
                </div>
            </section>

            <!-- Exercise 4: ltree for Hierarchies -->
            <section>
                <h2 id="exercise-4">Alistirma 4: ltree ile Hiyerarsik Veri</h2>
                <p>Kategoriler, organizasyon semalari veya dosya yollari gibi agac yapisindaki verileri verimli bir sekilde saklayin ve sorgulatin.</p>

                <div class="extension-box">
                    <code>ltree</code> etiket yollari ("A.B.C" gibi) icin ata/torun sorgularina
                    yonelik ozellestirilmis operatorlerle bir veri tipi saglar.
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 4.1: Kategori Hiyerarsisi</h4>
                    <p>Verimli hiyerarsi sorgulariyla bir urun kategori sistemi olusturun.</p>

                    <button class="toggle-btn" onclick="toggleSolution('solution4_1')">Cozumu Goster</button>
                    <div id="solution4_1" class="solution-box">
                        <pre><code class="language-sql">-- ltree uzantisini etkinlestir
CREATE EXTENSION IF NOT EXISTS ltree;

-- Hiyerarsik yollarla kategoriler
CREATE TABLE categories (
    category_id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    path LTREE NOT NULL,
    description TEXT
);

-- ltree sorgulari icin indeksler olustur
CREATE INDEX idx_categories_path_gist ON categories USING gist(path);
CREATE INDEX idx_categories_path_btree ON categories USING btree(path);

-- Hiyerarsik kategorileri ekle
INSERT INTO categories (name, path, description) VALUES
    ('Kok', 'root', 'Ust duzey kategori'),
    ('Elektronik', 'root.electronics', 'Elektronik cihazlar'),
    ('Bilgisayarlar', 'root.electronics.computers', 'Bilgi islem cihazlari'),
    ('Dizustular', 'root.electronics.computers.laptops', 'Tasinabilir bilgisayarlar'),
    ('Masaustular', 'root.electronics.computers.desktops', 'Masaustu bilgisayarlar'),
    ('Telefonlar', 'root.electronics.phones', 'Mobil telefonlar'),
    ('Akilli Telefonlar', 'root.electronics.phones.smartphones', 'Akilli mobil telefonlar'),
    ('Giyim', 'root.clothing', 'Giysi ve aksesuarlar'),
    ('Erkek', 'root.clothing.men', 'Erkek giyim'),
    ('Gomlekler', 'root.clothing.men.shirts', 'Erkek gomlekleri'),
    ('Pantolonlar', 'root.clothing.men.pants', 'Erkek pantolonlari'),
    ('Kadin', 'root.clothing.women', 'Kadin giyim');

-- Elektronik'in tum torunlarini bul
SELECT name, path
FROM categories
WHERE path <@ 'root.electronics'
ORDER BY path;

-- Dizustular'in tum atalarini bul
SELECT name, path
FROM categories
WHERE path @> 'root.electronics.computers.laptops'
ORDER BY path;

-- Bir kategorinin dogrudan cocuklarini bul
SELECT name, path
FROM categories
WHERE path ~ 'root.electronics.*{1}'  -- Tam 1 seviye asagi
ORDER BY path;

-- Kardes bul (ayni ebeveyn)
SELECT name, path
FROM categories
WHERE path ~ 'root.electronics.computers.*{1}'
ORDER BY path;

-- Kategori derinligini al
SELECT name, path, nlevel(path) AS depth
FROM categories
ORDER BY path;

-- Ortak atayi bul
SELECT lca('root.electronics.computers.laptops', 'root.electronics.phones.smartphones');
-- Dondurur: root.electronics</code></pre>

                        <div class="tree-visual">
root
├── electronics
│   ├── computers
│   │   ├── laptops
│   │   └── desktops
│   └── phones
│       └── smartphones
└── clothing
    ├── men
    │   ├── shirts
    │   └── pants
    └── women
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 4.2: Organizasyon Semasi</h4>
                    <p>Raporlama yapisi sorgulariyla bir calisan hiyerarsisi olusturun.</p>

                    <button class="toggle-btn" onclick="toggleSolution('solution4_2')">Cozumu Goster</button>
                    <div id="solution4_2" class="solution-box">
                        <pre><code class="language-sql">-- Hiyerarsi yollariyla calisanlar
CREATE TABLE employees_org (
    employee_id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    title VARCHAR(100),
    department VARCHAR(100),
    path LTREE NOT NULL,
    hire_date DATE
);

CREATE INDEX idx_employees_path ON employees_org USING gist(path);

-- Organizasyon yapisini ekle
INSERT INTO employees_org (name, title, department, path, hire_date) VALUES
    ('Ali CEO', 'Genel Mudur', 'Yonetim', 'ceo', '2010-01-01'),
    ('Burak CTO', 'Teknoloji Muduru', 'Teknoloji', 'ceo.cto', '2012-03-15'),
    ('Canan CFO', 'Finans Muduru', 'Finans', 'ceo.cfo', '2013-06-01'),
    ('Deniz Muhendislik', 'Muhendislik Muduru', 'Teknoloji', 'ceo.cto.eng_vp', '2015-02-01'),
    ('Elif Tasarim', 'Tasarim Lideri', 'Teknoloji', 'ceo.cto.design', '2016-04-01'),
    ('Fatih Backend', 'Kidemli Gelistirici', 'Teknoloji', 'ceo.cto.eng_vp.backend', '2018-01-15'),
    ('Gul Frontend', 'Kidemli Gelistirici', 'Teknoloji', 'ceo.cto.eng_vp.frontend', '2018-03-20'),
    ('Hakan QA', 'QA Lideri', 'Teknoloji', 'ceo.cto.eng_vp.qa', '2019-05-01'),
    ('Ipek Muhasebe', 'Muhasebe Muduru', 'Finans', 'ceo.cfo.accounting', '2017-08-01');

-- CTO altindaki tum raporlari (dogrudan ve dolayli) al
SELECT name, title, path
FROM employees_org
WHERE path <@ 'ceo.cto'
ORDER BY path;

-- Belirli bir calisan icin raporlama zincirini al
SELECT name, title, nlevel(path) AS level
FROM employees_org
WHERE path @> 'ceo.cto.eng_vp.backend'
ORDER BY path;

-- Her yonetici icin dogrudan rapor sayisi
SELECT
    e.name AS manager,
    COUNT(*) AS direct_reports
FROM employees_org e
JOIN employees_org reports ON reports.path ~ (e.path::text || '.*{1}')::lquery
GROUP BY e.employee_id, e.name
ORDER BY direct_reports DESC;

-- Her yonetici icin ekip buyuklugunu bul (tum torunlar)
SELECT
    e.name AS manager,
    e.title,
    (SELECT COUNT(*) FROM employees_org WHERE path <@ e.path AND path != e.path) AS team_size
FROM employees_org e
ORDER BY team_size DESC;

-- Bir calisani (ve alt agacini) yeni yoneticiye tasi
-- Ornek: Deniz'in ekibini CFO altina tasi
UPDATE employees_org
SET path = 'ceo.cfo' || subpath(path, nlevel('ceo.cto.eng_vp') - 1)
WHERE path <@ 'ceo.cto.eng_vp';</code></pre>
                    </div>
                </div>
            </section>

            <!-- Exercise 5: tablefunc for Pivot Tables -->
            <section>
                <h2 id="exercise-5">Alistirma 5: tablefunc ile Pivot Tablolar</h2>
                <p>Raporlar icin satir tabanli verileri sutun formatina donusturun.</p>

                <div class="extension-box">
                    <code>tablefunc</code> pivot tablolar - satirlari sutunlara donusturme - olusturmak icin
                    <code>crosstab()</code> fonksiyonunu saglar.
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 5.1: Satis Pivot Raporu</h4>
                    <p>Urunleri satir, aylari sutun olarak gosteren bir satis raporu olusturun.</p>

                    <button class="toggle-btn" onclick="toggleSolution('solution5_1')">Cozumu Goster</button>
                    <div id="solution5_1" class="solution-box">
                        <pre><code class="language-sql">-- tablefunc uzantisini etkinlestir
CREATE EXTENSION IF NOT EXISTS tablefunc;

-- Ornek satis verileri
CREATE TABLE sales (
    sale_id SERIAL PRIMARY KEY,
    product VARCHAR(50),
    sale_month VARCHAR(10),
    amount DECIMAL(10, 2)
);

INSERT INTO sales (product, sale_month, amount) VALUES
    ('Laptop', 'Oca', 15000),
    ('Laptop', 'Sub', 18000),
    ('Laptop', 'Mar', 22000),
    ('Phone', 'Oca', 8000),
    ('Phone', 'Sub', 9500),
    ('Phone', 'Mar', 11000),
    ('Tablet', 'Oca', 5000),
    ('Tablet', 'Sub', 6000),
    ('Tablet', 'Mar', 7500),
    ('Monitor', 'Oca', 3000),
    ('Monitor', 'Sub', 3500),
    ('Monitor', 'Mar', 4000);

-- Temel crosstab (pivot) sorgusu
SELECT * FROM crosstab(
    -- Kaynak sorgu: row_name, category, value dondurmeli
    'SELECT product, sale_month, amount
     FROM sales
     ORDER BY 1, 2',
    -- Kategoriler sorgusu: sutunlari tanimlar
    'SELECT DISTINCT sale_month FROM sales ORDER BY 1'
) AS ct (
    product VARCHAR(50),
    jan_sales DECIMAL,
    feb_sales DECIMAL,
    mar_sales DECIMAL
);

-- Toplamlarla pivot
WITH pivoted AS (
    SELECT * FROM crosstab(
        'SELECT product, sale_month, amount FROM sales ORDER BY 1, 2',
        'SELECT DISTINCT sale_month FROM sales ORDER BY 1'
    ) AS ct (product VARCHAR, jan DECIMAL, feb DECIMAL, mar DECIMAL)
)
SELECT
    product,
    COALESCE(jan, 0) AS ocak,
    COALESCE(feb, 0) AS subat,
    COALESCE(mar, 0) AS mart,
    COALESCE(jan, 0) + COALESCE(feb, 0) + COALESCE(mar, 0) AS toplam
FROM pivoted
UNION ALL
SELECT
    'TOPLAM',
    SUM(COALESCE(jan, 0)),
    SUM(COALESCE(feb, 0)),
    SUM(COALESCE(mar, 0)),
    SUM(COALESCE(jan, 0) + COALESCE(feb, 0) + COALESCE(mar, 0))
FROM pivoted;</code></pre>

                        <p><strong>Beklenen Sonuc:</strong></p>
                        <div class="output-display">
product | ocak    | subat    | mart   | toplam
--------+---------+----------+--------+--------
Laptop  | 15000   | 18000    | 22000  | 55000
Monitor | 3000    | 3500     | 4000   | 10500
Phone   | 8000    | 9500     | 11000  | 28500
Tablet  | 5000    | 6000     | 7500   | 18500
TOPLAM  | 31000   | 37000    | 44500  | 112500
                        </div>
                    </div>
                </div>
            </section>

            <!-- Exercise 6: PostGIS Basics -->
            <section>
                <h2 id="exercise-6">Alistirma 6: PostGIS ile Mekansal Veri</h2>
                <p>Konum tabanli uygulamalar icin cografi verilerle calisin.</p>

                <div class="extension-box">
                    <code>PostGIS</code> cografi nesneler (noktalar, cizgiler, cokgenler) ve mekansal sorgular icin
                    destek ekleyen birincil mekansal uzantidir.
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 6.1: Konumlari Saklama ve Sorgulama</h4>
                    <p>Yakin yerleri bulmak icin konum tabanli bir hizmet olusturun.</p>

                    <button class="toggle-btn" onclick="toggleSolution('solution6_1')">Cozumu Goster</button>
                    <div id="solution6_1" class="solution-box">
                        <pre><code class="language-sql">-- PostGIS uzantisini etkinlestir
CREATE EXTENSION IF NOT EXISTS postgis;

-- Cografi konumlarla magazalar
CREATE TABLE stores (
    store_id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    address TEXT,
    city VARCHAR(100),
    -- GEOMETRY(Point, 4326) - WGS84 koordinat sistemiyle Nokta tipi
    location GEOMETRY(Point, 4326)
);

-- Mekansal indeks olustur
CREATE INDEX idx_stores_location ON stores USING gist(location);

-- Magaza konumlarini ekle (boylam, enlem)
INSERT INTO stores (name, address, city, location) VALUES
    ('Merkez Magaza', 'Istiklal Cad. 123', 'Istanbul',
     ST_SetSRID(ST_MakePoint(28.9784, 41.0082), 4326)),
    ('Kadikoy Sube', 'Bagdat Cad. 456', 'Kadikoy',
     ST_SetSRID(ST_MakePoint(29.0225, 40.9862), 4326)),
    ('Besiktas Magaza', 'Barbaros Blv. 789', 'Besiktas',
     ST_SetSRID(ST_MakePoint(29.0027, 41.0432), 4326)),
    ('Taksim Ekspres', 'Taksim Mey. 321', 'Istanbul',
     ST_SetSRID(ST_MakePoint(28.9857, 41.0370), 4326)),
    ('Uskudar Magaza', 'Uskudar Mey. 555', 'Uskudar',
     ST_SetSRID(ST_MakePoint(29.0152, 41.0234), 4326));

-- Bir konumun 5km yakinindaki magazalari bul (Taksim Meydani)
SELECT
    name,
    city,
    ROUND(ST_Distance(
        location::geography,
        ST_SetSRID(ST_MakePoint(28.9855, 41.0370), 4326)::geography
    )::numeric) AS distance_meters
FROM stores
WHERE ST_DWithin(
    location::geography,
    ST_SetSRID(ST_MakePoint(28.9855, 41.0370), 4326)::geography,
    5000  -- 5000 metre = 5km
)
ORDER BY distance_meters;

-- Verilen konuma en yakin magazayi bul
SELECT
    name,
    city,
    ROUND(ST_Distance(
        location::geography,
        ST_SetSRID(ST_MakePoint(28.9855, 41.0370), 4326)::geography
    )::numeric) AS distance_meters
FROM stores
ORDER BY location <-> ST_SetSRID(ST_MakePoint(28.9855, 41.0370), 4326)
LIMIT 1;

-- Bir sinirlayici kutu (cokgen) icindeki tum magazalari bul
SELECT name, city
FROM stores
WHERE ST_Within(
    location,
    ST_MakeEnvelope(28.9, 40.9, 29.1, 41.1, 4326)
);

-- Iki magaza arasindaki mesafeyi hesapla
SELECT
    ROUND(ST_Distance(
        (SELECT location::geography FROM stores WHERE name = 'Merkez Magaza'),
        (SELECT location::geography FROM stores WHERE name = 'Kadikoy Sube')
    )::numeric) AS distance_meters;</code></pre>

                        <p><strong>Beklenen Sonuc:</strong></p>
                        <div class="output-display">
-- Taksim Meydaninin 5km yakinindaki magazalar:
name              | city      | distance_meters
------------------+-----------+----------------
Taksim Ekspres    | Istanbul  | 15
Merkez Magaza     | Istanbul  | 3205
Besiktas Magaza   | Besiktas  | 1523
                        </div>
                    </div>
                </div>
            </section>

            <!-- Challenge Exercises -->
            <section>
                <h2 id="challenge-exercises">Zorluk Alistirmalari</h2>
                <p>Karmasik problemleri cozmek icin birden fazla uzanti uygulayin.</p>

                <div class="challenge-box">
                    <h4>Zorluk 1: Guvenli Kullanici Sistemi</h4>
                    <p>Birden fazla uzanti kullanarak eksiksiz bir guvenli kullanici sistemi olusturun:</p>
                    <ul>
                        <li>UUID birincil anahtarlar (<code>uuid-ossp</code>)</li>
                        <li>Bcrypt parola hashleme (<code>pgcrypto</code>)</li>
                        <li>Sifrelenmi hassas veriler (<code>pgcrypto</code>)</li>
                        <li>Yazim hatasina toleransli aranabilir kullanici adlari (<code>pg_trgm</code>)</li>
                    </ul>

                    <button class="toggle-btn" onclick="toggleSolution('challenge1')">Cozumu Goster</button>
                    <div id="challenge1" class="solution-box">
                        <pre><code class="language-sql">-- Gerekli uzantilari etkinlestir
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS pgcrypto;
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- Guvenli kullanicilar tablosu
CREATE TABLE secure_users (
    user_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash TEXT NOT NULL,
    phone_encrypted BYTEA,  -- Sifrelenmi telefon numarasi
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE
);

-- Bulanik kullanici adi aramasi icin trigram indeksi
CREATE INDEX idx_secure_users_username_trgm
ON secure_users USING gin(username gin_trgm_ops);

-- Kullanici kayit fonksiyonu
CREATE OR REPLACE FUNCTION create_secure_user(
    p_username VARCHAR,
    p_email VARCHAR,
    p_password VARCHAR,
    p_phone VARCHAR DEFAULT NULL,
    p_encryption_key VARCHAR DEFAULT 'default_key'
)
RETURNS UUID AS $$
DECLARE
    new_user_id UUID;
BEGIN
    INSERT INTO secure_users (
        username,
        email,
        password_hash,
        phone_encrypted
    ) VALUES (
        p_username,
        p_email,
        crypt(p_password, gen_salt('bf', 12)),
        CASE WHEN p_phone IS NOT NULL
             THEN pgp_sym_encrypt(p_phone, p_encryption_key)
             ELSE NULL
        END
    )
    RETURNING user_id INTO new_user_id;

    RETURN new_user_id;
END;
$$ LANGUAGE plpgsql;

-- Giris fonksiyonu
CREATE OR REPLACE FUNCTION login_user(
    p_username VARCHAR,
    p_password VARCHAR
)
RETURNS TABLE(
    user_id UUID,
    username VARCHAR,
    email VARCHAR,
    session_token UUID
) AS $$
DECLARE
    v_user_id UUID;
BEGIN
    -- Kimlik bilgilerini dogrula
    SELECT su.user_id INTO v_user_id
    FROM secure_users su
    WHERE su.username = p_username
      AND su.password_hash = crypt(p_password, su.password_hash)
      AND su.is_active = TRUE;

    IF v_user_id IS NULL THEN
        RETURN;
    END IF;

    -- Son girisi guncelle
    UPDATE secure_users SET last_login = CURRENT_TIMESTAMP
    WHERE secure_users.user_id = v_user_id;

    -- Oturum tokeniyle kullanici bilgisini dondur
    RETURN QUERY
    SELECT
        su.user_id,
        su.username,
        su.email,
        uuid_generate_v4() AS session_token
    FROM secure_users su
    WHERE su.user_id = v_user_id;
END;
$$ LANGUAGE plpgsql;

-- Bulanik eslestirmeyle kullanici ara
CREATE OR REPLACE FUNCTION search_users(
    search_term VARCHAR,
    similarity_threshold REAL DEFAULT 0.3
)
RETURNS TABLE(
    user_id UUID,
    username VARCHAR,
    similarity_score REAL
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        su.user_id,
        su.username,
        similarity(su.username, search_term)
    FROM secure_users su
    WHERE similarity(su.username, search_term) > similarity_threshold
      AND su.is_active = TRUE
    ORDER BY similarity(su.username, search_term) DESC
    LIMIT 10;
END;
$$ LANGUAGE plpgsql;

-- Kullanim
SELECT create_secure_user('john_doe', 'john@example.com', 'SecureP@ss123', '555-1234');
SELECT create_secure_user('jane_smith', 'jane@example.com', 'AnotherP@ss456');

SELECT * FROM login_user('john_doe', 'SecureP@ss123');
SELECT * FROM search_users('jon doe');  -- Yazim hatasina ragmen 'john_doe' bulur</code></pre>
                    </div>
                </div>

                <div class="challenge-box">
                    <h4>Zorluk 2: Hiyerarsi ve Konumlu E-ticaret</h4>
                    <p>Asagidakilerle bir urun katalogu olusturun:</p>
                    <ul>
                        <li>Hiyerarsik kategoriler (<code>ltree</code>)</li>
                        <li>Bulanik urun arama (<code>pg_trgm</code>)</li>
                        <li>Teslim alma icin magaza konumlari (<code>PostGIS</code>)</li>
                        <li>Satis pivot raporlari (<code>tablefunc</code>)</li>
                    </ul>

                    <button class="toggle-btn" onclick="toggleSolution('challenge2')">Cozumu Goster</button>
                    <div id="challenge2" class="solution-box">
                        <pre><code class="language-sql">-- Tum gerekli uzantilari etkinlestir
CREATE EXTENSION IF NOT EXISTS ltree;
CREATE EXTENSION IF NOT EXISTS pg_trgm;
CREATE EXTENSION IF NOT EXISTS postgis;
CREATE EXTENSION IF NOT EXISTS tablefunc;

-- Hiyerarsiyle kategoriler
CREATE TABLE product_categories (
    category_id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    path LTREE NOT NULL UNIQUE
);

CREATE INDEX idx_cat_path ON product_categories USING gist(path);

INSERT INTO product_categories (name, path) VALUES
    ('Tum Urunler', 'all'),
    ('Elektronik', 'all.electronics'),
    ('Bilgisayarlar', 'all.electronics.computers'),
    ('Dizustular', 'all.electronics.computers.laptops'),
    ('Telefonlar', 'all.electronics.phones'),
    ('Giyim', 'all.clothing'),
    ('Erkek', 'all.clothing.men'),
    ('Kadin', 'all.clothing.women');

-- Kategori referansiyla urunler
CREATE TABLE catalog_products (
    product_id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    price DECIMAL(10, 2) NOT NULL,
    category_path LTREE NOT NULL
);

CREATE INDEX idx_prod_name_trgm ON catalog_products USING gin(name gin_trgm_ops);
CREATE INDEX idx_prod_category ON catalog_products USING gist(category_path);

INSERT INTO catalog_products (name, description, price, category_path) VALUES
    ('MacBook Pro 16"', 'M3 cipli Apple dizustu', 2499.00, 'all.electronics.computers.laptops'),
    ('Dell XPS 15', 'Intel Core islemcili Windows dizustu', 1799.00, 'all.electronics.computers.laptops'),
    ('iPhone 15 Pro', 'Apple''in en son akilli telefonu', 1199.00, 'all.electronics.phones'),
    ('Samsung Galaxy S24', 'Android amiral gemisi telefon', 999.00, 'all.electronics.phones'),
    ('Erkek Oxford Gomlek', 'Klasik pamuklu resmi gomlek', 79.00, 'all.clothing.men'),
    ('Kadin Blazer', 'Profesyonel yun ceket', 199.00, 'all.clothing.women');

-- Konumlarla magazalar
CREATE TABLE pickup_stores (
    store_id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    location GEOMETRY(Point, 4326) NOT NULL
);

CREATE INDEX idx_store_loc ON pickup_stores USING gist(location);

INSERT INTO pickup_stores (name, location) VALUES
    ('Merkez Magaza', ST_SetSRID(ST_MakePoint(28.9857, 41.0370), 4326)),
    ('Dogu Magaza', ST_SetSRID(ST_MakePoint(29.0632, 41.0294), 4326)),
    ('Bati Magaza', ST_SetSRID(ST_MakePoint(28.9060, 41.0182), 4326));

-- Aylik satislar
CREATE TABLE monthly_sales (
    product_id INTEGER REFERENCES catalog_products(product_id),
    sale_month VARCHAR(7) NOT NULL,  -- 'YYYY-MM'
    quantity INTEGER NOT NULL,
    revenue DECIMAL(12, 2) NOT NULL
);

INSERT INTO monthly_sales VALUES
    (1, '2024-01', 50, 124950), (1, '2024-02', 65, 162435), (1, '2024-03', 80, 199920),
    (2, '2024-01', 40, 71960), (2, '2024-02', 55, 98945), (2, '2024-03', 70, 125930),
    (3, '2024-01', 100, 119900), (3, '2024-02', 120, 143880), (3, '2024-03', 150, 179850);

-- Birlesik arama fonksiyonu
CREATE OR REPLACE FUNCTION search_catalog(
    search_term VARCHAR,
    category_filter LTREE DEFAULT 'all',
    user_lat FLOAT DEFAULT NULL,
    user_lon FLOAT DEFAULT NULL
)
RETURNS TABLE(
    product_id INTEGER,
    name VARCHAR,
    price DECIMAL,
    category VARCHAR,
    similarity REAL,
    nearest_store VARCHAR,
    store_distance_m INTEGER
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        p.product_id,
        p.name,
        p.price,
        c.name AS category,
        similarity(p.name, search_term) AS similarity,
        CASE WHEN user_lat IS NOT NULL THEN
            (SELECT s.name FROM pickup_stores s
             ORDER BY s.location <-> ST_SetSRID(ST_MakePoint(user_lon, user_lat), 4326)
             LIMIT 1)
        ELSE NULL END AS nearest_store,
        CASE WHEN user_lat IS NOT NULL THEN
            (SELECT ROUND(ST_Distance(
                s.location::geography,
                ST_SetSRID(ST_MakePoint(user_lon, user_lat), 4326)::geography
            )::numeric)::INTEGER
             FROM pickup_stores s
             ORDER BY s.location <-> ST_SetSRID(ST_MakePoint(user_lon, user_lat), 4326)
             LIMIT 1)
        ELSE NULL END AS store_distance_m
    FROM catalog_products p
    JOIN product_categories c ON p.category_path = c.path
    WHERE p.category_path <@ category_filter
      AND (search_term IS NULL OR p.name % search_term)
    ORDER BY similarity(p.name, search_term) DESC;
END;
$$ LANGUAGE plpgsql;

-- Konumla arama
SELECT * FROM search_catalog('macbook', 'all.electronics', 41.0370, 28.9855);

-- Aya gore satis pivotu
SELECT * FROM crosstab(
    $$SELECT p.name, ms.sale_month, ms.revenue
      FROM monthly_sales ms
      JOIN catalog_products p ON ms.product_id = p.product_id
      ORDER BY 1, 2$$,
    $$VALUES ('2024-01'), ('2024-02'), ('2024-03')$$
) AS ct(product VARCHAR, oca_2024 DECIMAL, sub_2024 DECIMAL, mar_2024 DECIMAL);</code></pre>
                    </div>
                </div>
            </section>

            <!-- Key Takeaways -->
            <section>
                <h2 id="key-takeaways">Onemli Noktalar</h2>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Uzanti</th>
                            <th>En Iyi Kullanim</th>
                            <th>Onemli Ipucu</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="ext-badge">pgcrypto</span></td>
                            <td>Parola hashleme, veri sifreleme</td>
                            <td>Parolalar icin bcrypt (<code>gen_salt('bf')</code>) kullanin, asla tek basina MD5/SHA kullanmayin</td>
                        </tr>
                        <tr>
                            <td><span class="ext-badge">uuid-ossp</span></td>
                            <td>Dagitik kimlikler, API kaynaklari</td>
                            <td>V4 rastgeledir; PostgreSQL 13+'da <code>gen_random_uuid()</code> kullanin</td>
                        </tr>
                        <tr>
                            <td><span class="ext-badge">pg_trgm</span></td>
                            <td>Bulanik arama, otomatik tamamlama</td>
                            <td>Performans icin <code>gin_trgm_ops</code> ile GIN indeksi olusturun</td>
                        </tr>
                        <tr>
                            <td><span class="ext-badge">ltree</span></td>
                            <td>Kategoriler, org semalari, dosya yollari</td>
                            <td>GiST indeksi kullanin; torunlar icin <code><@</code>, atalar icin <code>@></code></td>
                        </tr>
                        <tr>
                            <td><span class="ext-badge">hstore</span></td>
                            <td>Eski anahtar-deger depolama</td>
                            <td>Yeni projeler icin JSONB tercih edin; hstore daha basit ama daha az esnek</td>
                        </tr>
                        <tr>
                            <td><span class="ext-badge">tablefunc</span></td>
                            <td>Pivot tablolar, carpraz tablolama</td>
                            <td>Cikis sutunlarini acikca tanimlayin; NULL'lari COALESCE ile yonetin</td>
                        </tr>
                        <tr>
                            <td><span class="ext-badge">PostGIS</span></td>
                            <td>Konum sorgulari, haritalama</td>
                            <td>Metre cinsinden dogru mesafe icin <code>::geography</code>'ye donusturun</td>
                        </tr>
                        <tr>
                            <td><span class="ext-badge">pg_stat_statements</span></td>
                            <td>Sorgu performans izleme</td>
                            <td>postgresql.conf'ta <code>shared_preload_libraries</code> ayari gerektirir</td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <!-- Navigation -->
            <section>
                <p><a href="03_database_extensibility_and_postgresql_extensions.html">&larr; PostgreSQL Uzantilari Dersine Don</a></p>
            </section>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="../static/script.js"></script>

    <script>
        function toggleSolution(id) {
            var element = document.getElementById(id);
            if (element.classList.contains('show')) {
                element.classList.remove('show');
                event.target.textContent = 'Cozumu Goster';
            } else {
                element.classList.add('show');
                event.target.textContent = 'Cozumu Gizle';
            }
        }
    </script>
</body>

</html>
