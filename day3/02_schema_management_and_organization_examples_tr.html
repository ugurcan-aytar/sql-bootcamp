<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="tr" xml:lang="tr">

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="../css/style_bootstrap.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/code.css">
    <link href="https://cdn.prod.website-files.com/5efdb54f07a6812bcd95cc65/6773d0fc3013e060f08d7145_favicon.jpg"
        rel="shortcut icon" type="image/x-icon">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <title>Gun 3: Sema Yonetimi ve Organizasyonu - Pratik Ornekler</title>
    <style>
        code {
            white-space: pre-wrap;
        }

        span.smallcaps {
            font-variant: small-caps;
        }

        span.underline {
            text-decoration: underline;
        }

        div.column {
            display: inline-block;
            vertical-align: top;
            width: 50%;
        }

        div.hanging-indent {
            margin-left: 1.5em;
            text-indent: -1.5em;
        }

        ul.task-list {
            list-style: none;
        }

        .exercise-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .exercise-box h4 {
            color: #495057;
            margin-bottom: 15px;
        }

        .solution-box {
            background-color: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .solution-box.show {
            display: block;
        }

        .toggle-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        .toggle-btn:hover {
            background-color: #0056b3;
        }

        .hint-box {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .hint-box::before {
            content: "Ipucu: ";
            font-weight: bold;
        }

        .warning-box {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .warning-box::before {
            content: "Uyari: ";
            font-weight: bold;
        }

        .concept-box {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .concept-box::before {
            content: "Kavram: ";
            font-weight: bold;
        }

        .best-practice-box {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .best-practice-box::before {
            content: "En Iyi Uygulama: ";
            font-weight: bold;
            color: #155724;
        }

        .challenge-box {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .challenge-box h4 {
            color: #155724;
        }

        .challenge-box::before {
            content: "";
        }

        .dataset-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
        }

        .dataset-table th,
        .dataset-table td {
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            text-align: left;
        }

        .dataset-table th {
            background-color: #343a40;
            color: white;
        }

        .dataset-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .comparison-table th,
        .comparison-table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: left;
        }

        .comparison-table th {
            background-color: #007bff;
            color: white;
        }

        .comparison-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .result-box {
            background-color: #f1f1f1;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
        }

        .bad-name {
            background-color: #f8d7da;
            color: #721c24;
            padding: 2px 6px;
            border-radius: 3px;
            text-decoration: line-through;
        }

        .good-name {
            background-color: #d4edda;
            color: #155724;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .db-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin: 2px;
        }

        .db-postgresql {
            background-color: #336791;
            color: white;
        }

        .db-mysql {
            background-color: #4479A1;
            color: white;
        }

        .db-sqlserver {
            background-color: #CC2927;
            color: white;
        }

        .schema-diagram {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            overflow-x: auto;
            white-space: pre;
        }

        .migration-flow {
            background-color: #f8f9fa;
            border: 2px solid #6c757d;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }

        .migration-step {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            margin: 5px 0;
            display: inline-block;
        }

        .migration-arrow {
            color: #6c757d;
            font-size: 20px;
            margin: 0 10px;
        }

        .file-tree {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }

        .file-tree .folder {
            color: #dcdcaa;
        }

        .file-tree .file {
            color: #9cdcfe;
        }

        .change-type {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin: 2px;
        }

        .change-safe {
            background-color: #28a745;
            color: white;
        }

        .change-caution {
            background-color: #ffc107;
            color: #212529;
        }

        .change-danger {
            background-color: #dc3545;
            color: white;
        }

        .language-switcher {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px 20px;
            margin-bottom: 20px;
            display: inline-block;
        }

        .language-switcher a {
            margin: 0 10px;
            text-decoration: none;
            color: #007bff;
        }

        .language-switcher a:hover {
            text-decoration: underline;
        }

        .language-switcher a.active {
            font-weight: bold;
            color: #343a40;
        }
    </style>
</head>

<body>
    <a href="../index.html" class="back-button">← Anasayfaya Don</a>
    <div class="copy-notification" id="copyNotification">Kopyalandi!</div>

    <div id="europeanunion-turkey">
        <img src="../static/eu.png" alt="">
    </div>
    <div id="sanayiteknolojibakan">
        <img src="../static/sanayitek.png" alt="">
    </div>
    <div id="rekabet">
        <img src="../static/rekabet.png" alt="">
    </div>
    <div id="tisk">
        <img src="../static/tisk.png" alt="">
    </div>
    <div id="undp">
        <img src="../static/undp.png" alt="">
    </div>
    <div class="content-container">
        <div class="container">
            <!-- Language Switcher -->
            <div class="language-switcher">
                <span>Dil / Language:</span>
                <a href="02_schema_management_and_organization_examples.html">English</a>
                <a href="02_schema_management_and_organization_examples_tr.html" class="active">Turkce</a>
            </div>

            <section>
                <h1 id="schema-management-practical-examples">Sema Yonetimi ve Organizasyonu - Pratik Ornekler</h1>
                <p><a href="02_schema_management_and_organization.html">&larr; Sema Yonetimi Dersine Don</a></p>
                <p>Bu sayfa, sema organizasyonu, adlandirma kurallari ve migrasyon stratejilerini ustalasmak icin uygulamali alistirmalar sunmaktadir. Sema olusturmayi, adlandirma standartlarini uygulamayi ve migrasyon betikleri yazmayi pratik edin.</p>
            </section>

            <!-- Schema Terminology Reference -->
            <section>
                <h2 id="terminology-reference">Veritabanlari Arasinda Sema Terminolojisi</h2>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Kavram</th>
                            <th><span class="db-badge db-postgresql">PostgreSQL</span></th>
                            <th><span class="db-badge db-mysql">MySQL</span></th>
                            <th><span class="db-badge db-sqlserver">SQL Server</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Nesneler icin ad alani</td>
                            <td>Schema</td>
                            <td>Database</td>
                            <td>Schema</td>
                        </tr>
                        <tr>
                            <td>Ad alani olusturma</td>
                            <td><code>CREATE SCHEMA</code></td>
                            <td><code>CREATE DATABASE</code></td>
                            <td><code>CREATE SCHEMA</code></td>
                        </tr>
                        <tr>
                            <td>Varsayilan ad alani</td>
                            <td><code>public</code></td>
                            <td><code>USE</code> ile secilir</td>
                            <td><code>dbo</code></td>
                        </tr>
                        <tr>
                            <td>Gecerli ad alanini ayarlama</td>
                            <td><code>SET search_path TO</code></td>
                            <td><code>USE database_name</code></td>
                            <td><code>USE database_name</code></td>
                        </tr>
                        <tr>
                            <td>Tam nesne referansi</td>
                            <td><code>schema.table</code></td>
                            <td><code>database.table</code></td>
                            <td><code>database.schema.table</code></td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <!-- Exercise 1: Creating and Managing Schemas -->
            <section>
                <h2 id="exercise-1">Alistirma 1: Sema Olusturma ve Yonetme</h2>
                <p>Veritabani nesnelerini islevsel alana veya uygulama modulune gore organize etmek icin sema olusturmayi ogrenin.</p>

                <div class="concept-box">
                    Semalar nesneleri organize etmeye, adlandirma cakismalarini onlemeye ve ayrintili erisim kontrolu saglamaya yardimci olur. Farkli uygulama modullerini veya cok kiracilik verilerini ayirmak icin kullanin.
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 1.1: Uygulama Semalari Olusturma</h4>
                    <p>Bir e-ticaret platformu icin veritabani tasarliyorsunuz. Asagidakiler icin ayri semalar olusturun:</p>
                    <ul>
                        <li><strong>sales</strong> - siparisler, siparis kalemleri, faturalar</li>
                        <li><strong>inventory</strong> - urunler, stok seviyeleri, depolar</li>
                        <li><strong>customers</strong> - musteri profilleri, adresler, tercihler</li>
                        <li><strong>analytics</strong> - raporlar, ozetler, materyalize gorunumler</li>
                    </ul>
                    <p><strong>Gorev:</strong> Bu semalari ve her birinde bir ornek tablo olusturmak icin SQL yazin.</p>

                    <button class="toggle-btn" onclick="toggleSolution('solution1_1')">Cozumu Goster</button>
                    <div id="solution1_1" class="solution-box">
                        <pre><code class="language-sql">-- PostgreSQL

-- Semalari olustur
CREATE SCHEMA sales;
CREATE SCHEMA inventory;
CREATE SCHEMA customers;
CREATE SCHEMA analytics;

-- sales semasinda ornek tablo
CREATE TABLE sales.orders (
    order_id SERIAL PRIMARY KEY,
    customer_id INTEGER NOT NULL,
    order_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(20) DEFAULT 'pending',
    total_amount DECIMAL(12, 2)
);

CREATE TABLE sales.order_items (
    item_id SERIAL PRIMARY KEY,
    order_id INTEGER REFERENCES sales.orders(order_id),
    product_id INTEGER NOT NULL,
    quantity INTEGER NOT NULL,
    unit_price DECIMAL(10, 2) NOT NULL
);

-- inventory semasinda ornek tablo
CREATE TABLE inventory.products (
    product_id SERIAL PRIMARY KEY,
    sku VARCHAR(50) UNIQUE NOT NULL,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    current_price DECIMAL(10, 2) NOT NULL
);

CREATE TABLE inventory.warehouses (
    warehouse_id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    location VARCHAR(200),
    capacity INTEGER
);

CREATE TABLE inventory.stock_levels (
    product_id INTEGER REFERENCES inventory.products(product_id),
    warehouse_id INTEGER REFERENCES inventory.warehouses(warehouse_id),
    quantity INTEGER NOT NULL DEFAULT 0,
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (product_id, warehouse_id)
);

-- customers semasinda ornek tablo
CREATE TABLE customers.profiles (
    customer_id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE customers.addresses (
    address_id SERIAL PRIMARY KEY,
    customer_id INTEGER REFERENCES customers.profiles(customer_id),
    address_type VARCHAR(20) DEFAULT 'shipping',
    street VARCHAR(200),
    city VARCHAR(100),
    country VARCHAR(100),
    postal_code VARCHAR(20)
);

-- analytics semasinda ornek gorunum
CREATE TABLE analytics.daily_sales_summary (
    summary_date DATE PRIMARY KEY,
    total_orders INTEGER,
    total_revenue DECIMAL(15, 2),
    avg_order_value DECIMAL(10, 2),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Semalar arasi yabanci anahtar (siparisler musterilere referans verir)
ALTER TABLE sales.orders
ADD CONSTRAINT fk_orders_customer
FOREIGN KEY (customer_id) REFERENCES customers.profiles(customer_id);

-- Semalar arasi yabanci anahtar (siparis kalemleri urunlere referans verir)
ALTER TABLE sales.order_items
ADD CONSTRAINT fk_order_items_product
FOREIGN KEY (product_id) REFERENCES inventory.products(product_id);</code></pre>

                        <div class="schema-diagram">
Veritabani: ecommerce
├── Schema: sales
│   ├── orders
│   └── order_items
├── Schema: inventory
│   ├── products
│   ├── warehouses
│   └── stock_levels
├── Schema: customers
│   ├── profiles
│   └── addresses
└── Schema: analytics
    └── daily_sales_summary
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 1.2: Search Path ile Calisma</h4>
                    <p>Birden fazla semada tablolariniz var. Asagidakileri yapan sorgular yazin:</p>
                    <ol>
                        <li>Gecerli search path'i gosterin</li>
                        <li>Search path'i <code>sales</code> semasini onceliklendirmek icin ayarlayin</li>
                        <li>Sema adini belirtmeden bir tabloyu sorgulayın</li>
                        <li>Tek bir sorguda birden fazla semayi sorgulayın</li>
                    </ol>

                    <button class="toggle-btn" onclick="toggleSolution('solution1_2')">Cozumu Goster</button>
                    <div id="solution1_2" class="solution-box">
                        <pre><code class="language-sql">-- PostgreSQL

-- 1. Gecerli search path'i goster
SHOW search_path;
-- Varsayilan sonuc: "$user", public

-- 2. Search path'i sales semasini onceliklendirmek icin ayarla
SET search_path TO sales, inventory, customers, public;

-- Kalici degisiklik icin (kullanici basina):
ALTER USER myuser SET search_path TO sales, inventory, customers, public;

-- 3. Sema adi olmadan sorgula (search path kullanir)
-- search_path once sales olarak ayarlandigi icin, bu sales.orders'i bulur
SELECT * FROM orders WHERE order_date >= CURRENT_DATE - INTERVAL '7 days';

-- 4. Acik sema adlariyla semalar arasi sorgu (onerilen)
SELECT
    o.order_id,
    o.order_date,
    c.email AS customer_email,
    p.name AS product_name,
    oi.quantity,
    oi.unit_price
FROM sales.orders o
JOIN customers.profiles c ON o.customer_id = c.customer_id
JOIN sales.order_items oi ON o.order_id = oi.order_id
JOIN inventory.products p ON oi.product_id = p.product_id
WHERE o.status = 'completed';

-- MySQL esdegeri (veritabanlarini kullanarak)
USE ecommerce_sales;  -- Varsayilan veritabanini ayarla

SELECT
    o.order_id,
    o.order_date,
    c.email AS customer_email,
    p.name AS product_name
FROM orders o  -- Gecerli veritabanini kullanir
JOIN ecommerce_customers.profiles c ON o.customer_id = c.customer_id
JOIN ecommerce_inventory.products p ON o.product_id = p.product_id;</code></pre>

                        <div class="best-practice-box">
                            Belirsizligi onlemek ve kodu kendi kendini belgeleyen hale getirmek icin uygulama kodunda ve betiklerde her zaman tam nitelikli adlar (<code>schema.table</code>) kullanin.
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 1.3: Cok Kiracili Sema Tasarimi</h4>
                    <p>Her kiracinin (musterinin) izole verilere sahip oldugu bir SaaS uygulamasi icin bir sema yapisi tasarlayin. Iki kiraci ve paylasilan referans verileri icin semalar olusturun.</p>

                    <button class="toggle-btn" onclick="toggleSolution('solution1_3')">Cozumu Goster</button>
                    <div id="solution1_3" class="solution-box">
                        <pre><code class="language-sql">-- PostgreSQL Cok Kiracili Sema Tasarimi

-- Ortak referans verileri icin paylasilan sema
CREATE SCHEMA shared;

CREATE TABLE shared.countries (
    country_code CHAR(2) PRIMARY KEY,
    country_name VARCHAR(100) NOT NULL
);

CREATE TABLE shared.currencies (
    currency_code CHAR(3) PRIMARY KEY,
    currency_name VARCHAR(50) NOT NULL,
    symbol VARCHAR(5)
);

CREATE TABLE shared.subscription_plans (
    plan_id SERIAL PRIMARY KEY,
    plan_name VARCHAR(50) NOT NULL,
    monthly_price DECIMAL(10, 2),
    features JSONB
);

-- Kiraciya ozel semalar
CREATE SCHEMA tenant_acme;
CREATE SCHEMA tenant_globex;

-- Kiraci tablolari icin sablon (her kiraci semasinda olustur)
-- Kiraci: ACME Corp
CREATE TABLE tenant_acme.users (
    user_id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(200),
    role VARCHAR(50) DEFAULT 'user',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE tenant_acme.projects (
    project_id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    owner_id INTEGER REFERENCES tenant_acme.users(user_id),
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- tenant_globex icin ayni yapi
CREATE TABLE tenant_globex.users (
    user_id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(200),
    role VARCHAR(50) DEFAULT 'user',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE tenant_globex.projects (
    project_id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    owner_id INTEGER REFERENCES tenant_globex.users(user_id),
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Kiraciya gore dinamik olarak sema ayarlama fonksiyonu
CREATE OR REPLACE FUNCTION set_tenant(tenant_name TEXT)
RETURNS VOID AS $$
BEGIN
    EXECUTE format('SET search_path TO tenant_%s, shared, public', tenant_name);
END;
$$ LANGUAGE plpgsql;

-- Kullanim: SELECT set_tenant('acme');
-- Artik sorgular otomatik olarak tenant_acme semasini kullanir</code></pre>

                        <div class="schema-diagram">
Veritabani: saas_app
├── Schema: shared (referans verileri)
│   ├── countries
│   ├── currencies
│   └── subscription_plans
├── Schema: tenant_acme (Kiraci 1)
│   ├── users
│   └── projects
├── Schema: tenant_globex (Kiraci 2)
│   ├── users
│   └── projects
└── Schema: public (sistem tablolari)
                        </div>

                        <p><strong>Bu yaklaşimin faydalari:</strong></p>
                        <ul>
                            <li>Kiracılar arasında tam veri izolasyonu</li>
                            <li>Bireysel kiracıları yedeklemek/geri yuklemek kolay</li>
                            <li>Yeni kiracı eklemek basit (sema olustur, tablo yapisini kopyala)</li>
                            <li>Paylaşılan referans verileri tekrarlamayı onler</li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Exercise 2: Naming Conventions -->
            <section>
                <h2 id="exercise-2">Alistirma 2: Nesne Adlandirma Kurallari</h2>
                <p>Veritabani nesnelerine tutarli adlandirma kurallarini uygulamayi pratik edin.</p>

                <div class="concept-box">
                    Maksimum tasinabilirlik icin <code>snake_case</code> kullanin. PostgreSQL tirnak icine alinmamis tanimlayicilari kucuk harfe cevirir, MySQL davranisi isletim sistemine gore degisir, SQL Server genellikle buyuk/kucuk harf duyarsizdir.
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 2.1: Kotu Adlari Duzeltme</h4>
                    <p>Asagidaki nesne adlari adlandirma kurallarini ihlal ediyor. Sorunlari tanimlayin ve daha iyi adlar saglayin:</p>

                    <table class="dataset-table">
                        <thead>
                            <tr>
                                <th>Nesne Turu</th>
                                <th>Kotu Ad</th>
                                <th>Sorunlar</th>
                                <th>Daha Iyi Ad</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Tablo</td>
                                <td><span class="bad-name">tblCustomerData</span></td>
                                <td>?</td>
                                <td>?</td>
                            </tr>
                            <tr>
                                <td>Sutun</td>
                                <td><span class="bad-name">CustFirstName</span></td>
                                <td>?</td>
                                <td>?</td>
                            </tr>
                            <tr>
                                <td>Tablo</td>
                                <td><span class="bad-name">Order</span></td>
                                <td>?</td>
                                <td>?</td>
                            </tr>
                            <tr>
                                <td>Sutun</td>
                                <td><span class="bad-name">isdeleted</span></td>
                                <td>?</td>
                                <td>?</td>
                            </tr>
                            <tr>
                                <td>Indeks</td>
                                <td><span class="bad-name">index1</span></td>
                                <td>?</td>
                                <td>?</td>
                            </tr>
                            <tr>
                                <td>Yabanci Anahtar</td>
                                <td><span class="bad-name">FK1</span></td>
                                <td>?</td>
                                <td>?</td>
                            </tr>
                            <tr>
                                <td>Gorunum</td>
                                <td><span class="bad-name">CustomerOrdersView</span></td>
                                <td>?</td>
                                <td>?</td>
                            </tr>
                            <tr>
                                <td>Sakli Prosedur</td>
                                <td><span class="bad-name">sp_GetData</span></td>
                                <td>?</td>
                                <td>?</td>
                            </tr>
                        </tbody>
                    </table>

                    <button class="toggle-btn" onclick="toggleSolution('solution2_1')">Cozumu Goster</button>
                    <div id="solution2_1" class="solution-box">
                        <table class="dataset-table">
                            <thead>
                                <tr>
                                    <th>Nesne Turu</th>
                                    <th>Kotu Ad</th>
                                    <th>Sorunlar</th>
                                    <th>Daha Iyi Ad</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Tablo</td>
                                    <td><span class="bad-name">tblCustomerData</span></td>
                                    <td>Macar notasyonu (tbl oneki), CamelCase, gereksiz "Data"</td>
                                    <td><span class="good-name">customers</span></td>
                                </tr>
                                <tr>
                                    <td>Sutun</td>
                                    <td><span class="bad-name">CustFirstName</span></td>
                                    <td>Kisaltma, CamelCase, gereksiz onek</td>
                                    <td><span class="good-name">first_name</span></td>
                                </tr>
                                <tr>
                                    <td>Tablo</td>
                                    <td><span class="bad-name">Order</span></td>
                                    <td>SQL'de ayrilmis kelime, tekil</td>
                                    <td><span class="good-name">orders</span></td>
                                </tr>
                                <tr>
                                    <td>Sutun</td>
                                    <td><span class="bad-name">isdeleted</span></td>
                                    <td>Kelime ayirimi yok</td>
                                    <td><span class="good-name">is_deleted</span></td>
                                </tr>
                                <tr>
                                    <td>Indeks</td>
                                    <td><span class="bad-name">index1</span></td>
                                    <td>Tanimlayici degil, tablo/sutun gostergesi yok</td>
                                    <td><span class="good-name">idx_orders_customer_id</span></td>
                                </tr>
                                <tr>
                                    <td>Yabanci Anahtar</td>
                                    <td><span class="bad-name">FK1</span></td>
                                    <td>Tanimlayici degil</td>
                                    <td><span class="good-name">fk_orders_customer_id</span></td>
                                </tr>
                                <tr>
                                    <td>Gorunum</td>
                                    <td><span class="bad-name">CustomerOrdersView</span></td>
                                    <td>CamelCase, "View" soneki gereksiz</td>
                                    <td><span class="good-name">v_customer_orders</span></td>
                                </tr>
                                <tr>
                                    <td>Sakli Prosedur</td>
                                    <td><span class="bad-name">sp_GetData</span></td>
                                    <td>sp_ oneki SQL Server'da ayrilmis, belirsiz ad</td>
                                    <td><span class="good-name">get_customer_order_history</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 2.2: Adlandirma Kuralini Uygulama</h4>
                    <p>Uygun adlandirma kuralllarini izleyerek bir blog sistemi icin eksiksiz bir veritabani nesneleri seti olusturun. Tablolar, sutunlar, indeksler, yabanci anahtarlar ve bir gorunum ekleyin.</p>

                    <button class="toggle-btn" onclick="toggleSolution('solution2_2')">Cozumu Goster</button>
                    <div id="solution2_2" class="solution-box">
                        <pre><code class="language-sql">-- Uygun Adlandirma Kurallariyla Blog Sistemi

-- Tablolar: cogul isimler, snake_case
CREATE TABLE authors (
    author_id SERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(255) NOT NULL,
    display_name VARCHAR(100),
    bio TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,

    -- Adlandirilmis kisitlamalar
    CONSTRAINT uq_authors_username UNIQUE (username),
    CONSTRAINT uq_authors_email UNIQUE (email)
);

CREATE TABLE categories (
    category_id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    slug VARCHAR(100) NOT NULL,
    description TEXT,
    parent_category_id INTEGER,

    CONSTRAINT uq_categories_slug UNIQUE (slug),
    CONSTRAINT fk_categories_parent
        FOREIGN KEY (parent_category_id)
        REFERENCES categories(category_id)
        ON DELETE SET NULL
);

CREATE TABLE posts (
    post_id SERIAL PRIMARY KEY,
    author_id INTEGER NOT NULL,
    category_id INTEGER,
    title VARCHAR(300) NOT NULL,
    slug VARCHAR(300) NOT NULL,
    content TEXT,
    excerpt VARCHAR(500),
    status VARCHAR(20) DEFAULT 'draft',
    published_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    view_count INTEGER DEFAULT 0,

    -- Adlandirilmis yabanci anahtar kisitlamalari
    CONSTRAINT fk_posts_author
        FOREIGN KEY (author_id)
        REFERENCES authors(author_id)
        ON DELETE RESTRICT,

    CONSTRAINT fk_posts_category
        FOREIGN KEY (category_id)
        REFERENCES categories(category_id)
        ON DELETE SET NULL,

    -- Kontrol kisitlamalari
    CONSTRAINT chk_posts_status
        CHECK (status IN ('draft', 'published', 'archived')),

    CONSTRAINT uq_posts_slug UNIQUE (slug)
);

-- Baglanti tablosu: her iki varlik adini birlestirir
CREATE TABLE post_tags (
    post_id INTEGER NOT NULL,
    tag_id INTEGER NOT NULL,
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (post_id, tag_id),

    CONSTRAINT fk_post_tags_post
        FOREIGN KEY (post_id) REFERENCES posts(post_id)
        ON DELETE CASCADE,

    CONSTRAINT fk_post_tags_tag
        FOREIGN KEY (tag_id) REFERENCES tags(tag_id)
        ON DELETE CASCADE
);

CREATE TABLE tags (
    tag_id SERIAL PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    slug VARCHAR(50) NOT NULL,

    CONSTRAINT uq_tags_slug UNIQUE (slug)
);

CREATE TABLE comments (
    comment_id SERIAL PRIMARY KEY,
    post_id INTEGER NOT NULL,
    author_name VARCHAR(100) NOT NULL,
    author_email VARCHAR(255),
    content TEXT NOT NULL,
    is_approved BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT fk_comments_post
        FOREIGN KEY (post_id) REFERENCES posts(post_id)
        ON DELETE CASCADE
);

-- Indeksler: idx_tabloadi_sutunadi(lar)
CREATE INDEX idx_posts_author_id ON posts(author_id);
CREATE INDEX idx_posts_category_id ON posts(category_id);
CREATE INDEX idx_posts_status ON posts(status);
CREATE INDEX idx_posts_published_at ON posts(published_at DESC);
CREATE INDEX idx_comments_post_id ON comments(post_id);

-- Bilesik indeks
CREATE INDEX idx_posts_status_published
    ON posts(status, published_at)
    WHERE status = 'published';

-- Gorunumler: v_ oneki
CREATE VIEW v_published_posts AS
SELECT
    p.post_id,
    p.title,
    p.slug,
    p.excerpt,
    p.published_at,
    p.view_count,
    a.display_name AS author_name,
    c.name AS category_name
FROM posts p
JOIN authors a ON p.author_id = a.author_id
LEFT JOIN categories c ON p.category_id = c.category_id
WHERE p.status = 'published'
ORDER BY p.published_at DESC;

CREATE VIEW v_post_statistics AS
SELECT
    a.author_id,
    a.display_name,
    COUNT(p.post_id) AS total_posts,
    COUNT(p.post_id) FILTER (WHERE p.status = 'published') AS published_posts,
    COALESCE(SUM(p.view_count), 0) AS total_views
FROM authors a
LEFT JOIN posts p ON a.author_id = p.author_id
GROUP BY a.author_id, a.display_name;

-- Fonksiyon: fiil_isim kalıbı
CREATE OR REPLACE FUNCTION get_post_comment_count(p_post_id INTEGER)
RETURNS INTEGER AS $$
    SELECT COUNT(*)::INTEGER
    FROM comments
    WHERE post_id = p_post_id AND is_approved = TRUE;
$$ LANGUAGE SQL;

-- Tetikleyici: trg_tabloadi_zamanlama_olay
CREATE OR REPLACE FUNCTION update_post_timestamp()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_posts_before_update
    BEFORE UPDATE ON posts
    FOR EACH ROW
    EXECUTE FUNCTION update_post_timestamp();</code></pre>

                        <h5>Adlandirma Kurali Ozeti:</h5>
                        <table class="dataset-table">
                            <tr>
                                <th>Nesne</th>
                                <th>Kalip</th>
                                <th>Ornek</th>
                            </tr>
                            <tr>
                                <td>Tablolar</td>
                                <td>cogul_isim</td>
                                <td>posts, authors, categories</td>
                            </tr>
                            <tr>
                                <td>Baglanti Tablolari</td>
                                <td>varlik1_varlik2</td>
                                <td>post_tags, user_roles</td>
                            </tr>
                            <tr>
                                <td>Birincil Anahtar</td>
                                <td>tekil_id</td>
                                <td>post_id, author_id</td>
                            </tr>
                            <tr>
                                <td>Yabanci Anahtar Sutunu</td>
                                <td>referans_tablo_id</td>
                                <td>author_id, category_id</td>
                            </tr>
                            <tr>
                                <td>YA Kisitlamasi</td>
                                <td>fk_tablo_sutun</td>
                                <td>fk_posts_author</td>
                            </tr>
                            <tr>
                                <td>Benzersiz Kisitlama</td>
                                <td>uq_tablo_sutun</td>
                                <td>uq_authors_email</td>
                            </tr>
                            <tr>
                                <td>Kontrol Kisitlamasi</td>
                                <td>chk_tablo_aciklama</td>
                                <td>chk_posts_status</td>
                            </tr>
                            <tr>
                                <td>Indeks</td>
                                <td>idx_tablo_sutun(lar)</td>
                                <td>idx_posts_author_id</td>
                            </tr>
                            <tr>
                                <td>Gorunum</td>
                                <td>v_aciklama</td>
                                <td>v_published_posts</td>
                            </tr>
                            <tr>
                                <td>Fonksiyon</td>
                                <td>fiil_isim</td>
                                <td>get_post_comment_count</td>
                            </tr>
                            <tr>
                                <td>Tetikleyici</td>
                                <td>trg_tablo_zamanlama_olay</td>
                                <td>trg_posts_before_update</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Exercise 3: Schema Migrations -->
            <section>
                <h2 id="exercise-3">Alistirma 3: Sema Migrasyon Betikleri</h2>
                <p>Gelisen veritabani semalari icin surumlu migrasyon betikleri yazmayi pratik edin.</p>

                <div class="concept-box">
                    Migrasyon betikleri surumlu olmali, mumkun oldugunda idempotent olmali ve hem "up" (uygula) hem de "down" (geri al) bolumleri icermelidir.
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 3.1: Migrasyon Betikleri Yazma</h4>
                    <p>Bir <code>users</code> tablosundaki asagidaki degisiklikler icin migrasyon betikleri olusturun:</p>
                    <ol>
                        <li>V001: Baslangic users tablosunu olustur</li>
                        <li>V002: phone_number sutunu ekle</li>
                        <li>V003: last_login_at sutunu ve indeks ekle</li>
                        <li>V004: email sutununu email_address olarak yeniden adlandir</li>
                    </ol>

                    <div class="file-tree">
<span class="folder">migrations/</span>
├── <span class="file">V001__create_users_table.sql</span>
├── <span class="file">V002__add_phone_number.sql</span>
├── <span class="file">V003__add_last_login.sql</span>
└── <span class="file">V004__rename_email_column.sql</span>
                    </div>

                    <button class="toggle-btn" onclick="toggleSolution('solution3_1')">Cozumu Goster</button>
                    <div id="solution3_1" class="solution-box">
                        <pre><code class="language-sql">-- V001__create_users_table.sql
-- Aciklama: Baslangic users tablosunu olustur
-- Yazar: DBA Ekibi
-- Tarih: 2024-03-15

-- UP Migrasyonu
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_is_active ON users(is_active);

-- DOWN Migrasyonu (ayri dosyada veya referans icin yorumlarda)
-- DROP TABLE IF EXISTS users CASCADE;</code></pre>

                        <pre><code class="language-sql">-- V002__add_phone_number.sql
-- Aciklama: users tablosuna phone_number sutunu ekle
-- Yazar: DBA Ekibi
-- Tarih: 2024-03-18

-- UP Migrasyonu
ALTER TABLE users
ADD COLUMN phone_number VARCHAR(20);

-- Istege bagli: Sik sorgulaniyorsa indeks ekle
CREATE INDEX idx_users_phone ON users(phone_number);

-- DOWN Migrasyonu
-- DROP INDEX IF EXISTS idx_users_phone;
-- ALTER TABLE users DROP COLUMN phone_number;</code></pre>

                        <pre><code class="language-sql">-- V003__add_last_login.sql
-- Aciklama: last_login_at takibi ekle
-- Yazar: DBA Ekibi
-- Tarih: 2024-03-20

-- UP Migrasyonu
ALTER TABLE users
ADD COLUMN last_login_at TIMESTAMP;

-- "Yakinda giris yapan kullanicilar" gibi sorgular icin indeks
CREATE INDEX idx_users_last_login ON users(last_login_at DESC NULLS LAST);

-- DOWN Migrasyonu
-- DROP INDEX IF EXISTS idx_users_last_login;
-- ALTER TABLE users DROP COLUMN last_login_at;</code></pre>

                        <pre><code class="language-sql">-- V004__rename_email_column.sql
-- Aciklama: Netlik icin email'i email_address olarak yeniden adlandir
-- Yazar: DBA Ekibi
-- Tarih: 2024-03-22

-- UP Migrasyonu

-- Adim 1: Yeni sutun ekle
ALTER TABLE users ADD COLUMN email_address VARCHAR(255);

-- Adim 2: Verileri kopyala
UPDATE users SET email_address = email;

-- Adim 3: Yeni sutuna kisitlamalar ekle
ALTER TABLE users
ALTER COLUMN email_address SET NOT NULL;

ALTER TABLE users
ADD CONSTRAINT uq_users_email_address UNIQUE (email_address);

-- Adim 4: Eski sutunu ve indeksi kaldir
DROP INDEX IF EXISTS idx_users_email;
ALTER TABLE users DROP COLUMN email;

-- Adim 5: Yeni indeks olustur
CREATE INDEX idx_users_email_address ON users(email_address);

-- DOWN Migrasyonu
-- ALTER TABLE users ADD COLUMN email VARCHAR(255);
-- UPDATE users SET email = email_address;
-- ALTER TABLE users ALTER COLUMN email SET NOT NULL;
-- ALTER TABLE users ADD CONSTRAINT uq_users_email UNIQUE (email);
-- CREATE INDEX idx_users_email ON users(email);
-- DROP INDEX IF EXISTS idx_users_email_address;
-- ALTER TABLE users DROP CONSTRAINT uq_users_email_address;
-- ALTER TABLE users DROP COLUMN email_address;</code></pre>

                        <div class="warning-box">
                            Sutunlari yeniden adlandirmak karmasiktir cunku uygulama kodunu bozabilir. Genislet-daralt kalıbı (yeni ekle -> veri tasi -> uygulamayi guncelle -> eskiyi kaldir) uretim sistemleri icin daha guvenlidir.
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 3.2: Sema Degisikliklerini Siniflandirma</h4>
                    <p>Her degisikligi Guvenli, Dikkatli veya Tehlikeli olarak siniflandirin ve nedenini aciklayin:</p>

                    <table class="dataset-table">
                        <thead>
                            <tr>
                                <th>Degisiklik</th>
                                <th>Risk Seviyesi</th>
                                <th>Neden</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>CREATE TABLE new_table</td>
                                <td>?</td>
                                <td>?</td>
                            </tr>
                            <tr>
                                <td>ALTER TABLE ADD COLUMN (nullable)</td>
                                <td>?</td>
                                <td>?</td>
                            </tr>
                            <tr>
                                <td>ALTER TABLE ADD COLUMN (NOT NULL, varsayilan yok)</td>
                                <td>?</td>
                                <td>?</td>
                            </tr>
                            <tr>
                                <td>DROP TABLE</td>
                                <td>?</td>
                                <td>?</td>
                            </tr>
                            <tr>
                                <td>ALTER TABLE DROP COLUMN</td>
                                <td>?</td>
                                <td>?</td>
                            </tr>
                            <tr>
                                <td>CREATE INDEX</td>
                                <td>?</td>
                                <td>?</td>
                            </tr>
                            <tr>
                                <td>CREATE INDEX CONCURRENTLY</td>
                                <td>?</td>
                                <td>?</td>
                            </tr>
                            <tr>
                                <td>ALTER COLUMN TYPE (genislet)</td>
                                <td>?</td>
                                <td>?</td>
                            </tr>
                            <tr>
                                <td>ALTER COLUMN TYPE (daralt)</td>
                                <td>?</td>
                                <td>?</td>
                            </tr>
                            <tr>
                                <td>ADD FOREIGN KEY</td>
                                <td>?</td>
                                <td>?</td>
                            </tr>
                        </tbody>
                    </table>

                    <button class="toggle-btn" onclick="toggleSolution('solution3_2')">Cozumu Goster</button>
                    <div id="solution3_2" class="solution-box">
                        <table class="dataset-table">
                            <thead>
                                <tr>
                                    <th>Degisiklik</th>
                                    <th>Risk Seviyesi</th>
                                    <th>Neden</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>CREATE TABLE</td>
                                    <td><span class="change-type change-safe">GUVENLI</span></td>
                                    <td>Eklemeli degisiklik, mevcut nesnelere etkisi yok</td>
                                </tr>
                                <tr>
                                    <td>ADD COLUMN (nullable)</td>
                                    <td><span class="change-type change-safe">GUVENLI</span></td>
                                    <td>Eklemeli, nullable mevcut satirlarin NULL olmasina izin verir</td>
                                </tr>
                                <tr>
                                    <td>ADD COLUMN (NOT NULL, varsayilan yok)</td>
                                    <td><span class="change-type change-danger">TEHLIKELI</span></td>
                                    <td>Tabloda mevcut satirlar varsa basarisiz olur (yeni sutun icin deger yok)</td>
                                </tr>
                                <tr>
                                    <td>DROP TABLE</td>
                                    <td><span class="change-type change-danger">TEHLIKELI</span></td>
                                    <td>Kalici veri kaybi, geri alinamaz</td>
                                </tr>
                                <tr>
                                    <td>DROP COLUMN</td>
                                    <td><span class="change-type change-danger">TEHLIKELI</span></td>
                                    <td>Kalici veri kaybi, bagli nesneleri bozabilir</td>
                                </tr>
                                <tr>
                                    <td>CREATE INDEX</td>
                                    <td><span class="change-type change-caution">DIKKATLI</span></td>
                                    <td>Buyuk tablolarda olusturma sirasinda tabloyu kilitler</td>
                                </tr>
                                <tr>
                                    <td>CREATE INDEX CONCURRENTLY</td>
                                    <td><span class="change-type change-safe">GUVENLI</span></td>
                                    <td>PostgreSQL: Kilit yok, indeksi arka planda olusturur</td>
                                </tr>
                                <tr>
                                    <td>ALTER TYPE (genislet, orn. VARCHAR(50)->VARCHAR(100))</td>
                                    <td><span class="change-type change-safe">GUVENLI</span></td>
                                    <td>Kapasite genisletme, tum mevcut veriler sigar</td>
                                </tr>
                                <tr>
                                    <td>ALTER TYPE (daralt, orn. VARCHAR(100)->VARCHAR(50))</td>
                                    <td><span class="change-type change-danger">TEHLIKELI</span></td>
                                    <td>Verileri kesebilir veya veri cok uzunsa basarisiz olabilir</td>
                                </tr>
                                <tr>
                                    <td>ADD FOREIGN KEY</td>
                                    <td><span class="change-type change-caution">DIKKATLI</span></td>
                                    <td>Yetim kayitlar varsa basarisiz olur; tablolari kilitler</td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="best-practice-box">
                            Uretimde tehlikeli migrasyonlari calistirmadan once:
                            <ul>
                                <li>Veritabanini veya etkilenen tablolari yedekleyin</li>
                                <li>Uretim benzeri verilerle hazırlık ortaminda test edin</li>
                                <li>Geri alma icin plan yapin</li>
                                <li>Dusuk trafik donemlerinde zamanlamayi dusunun</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 3.3: Kesintisiz Migrasyon</h4>
                    <p>Kesinti olmadan bir <code>full_name</code> sutununu <code>first_name</code> ve <code>last_name</code> olarak ayirmaniz gerekiyor. Genislet-daralt kalibi kullanarak migrasyon adimlarini yazin.</p>

                    <p><strong>Mevcut durum:</strong></p>
                    <pre><code>users (user_id, email, full_name, created_at)</code></pre>

                    <p><strong>Hedef durum:</strong></p>
                    <pre><code>users (user_id, email, first_name, last_name, created_at)</code></pre>

                    <button class="toggle-btn" onclick="toggleSolution('solution3_3')">Cozumu Goster</button>
                    <div id="solution3_3" class="solution-box">
                        <div class="migration-flow">
                            <span class="migration-step">1. Genislet</span>
                            <span class="migration-arrow">-></span>
                            <span class="migration-step">2. Tasi</span>
                            <span class="migration-arrow">-></span>
                            <span class="migration-step">3. Uygulamayi Guncelle</span>
                            <span class="migration-arrow">-></span>
                            <span class="migration-step">4. Daralt</span>
                        </div>

                        <pre><code class="language-sql">-- AŞAMA 1: GENISLET (Yeni sutunlar ekle)
-- Migrasyon: V005__add_name_columns.sql

ALTER TABLE users ADD COLUMN first_name VARCHAR(100);
ALTER TABLE users ADD COLUMN last_name VARCHAR(100);

-- Eski sutunu yeni sutunlara senkronize etmek icin tetikleyici olustur (gecis sirasinda yazmalar icin)
CREATE OR REPLACE FUNCTION sync_name_columns()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.full_name IS NOT NULL AND NEW.first_name IS NULL THEN
        -- full_name'i first_name ve last_name'e bol
        NEW.first_name := split_part(NEW.full_name, ' ', 1);
        NEW.last_name := substring(NEW.full_name from position(' ' in NEW.full_name) + 1);
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_users_sync_names
    BEFORE INSERT OR UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION sync_name_columns();


-- ASAMA 2: TASI (Mevcut verileri doldur)
-- Migrasyon: V006__backfill_name_columns.sql

-- Uzun kilitleri onlemek icin gruplar halinde doldur
DO $$
DECLARE
    batch_size INT := 1000;
    rows_updated INT;
BEGIN
    LOOP
        UPDATE users
        SET
            first_name = split_part(full_name, ' ', 1),
            last_name = CASE
                WHEN position(' ' in full_name) > 0
                THEN substring(full_name from position(' ' in full_name) + 1)
                ELSE ''
            END
        WHERE first_name IS NULL
          AND full_name IS NOT NULL
          AND user_id IN (
              SELECT user_id FROM users
              WHERE first_name IS NULL
              LIMIT batch_size
          );

        GET DIAGNOSTICS rows_updated = ROW_COUNT;
        EXIT WHEN rows_updated = 0;

        -- Istege bagli: Yuku azaltmak icin kucuk gecikme ekle
        PERFORM pg_sleep(0.1);
    END LOOP;
END $$;


-- ASAMA 3: UYGULAMAYI GUNCELLE
-- Uygulama kodunu guncelle:
-- 1. first_name/last_name sutunlarindan oku
-- 2. first_name/last_name sutunlarina yaz
-- 3. full_name referanslarini kaldir
-- Uygulama degisikliklerini dagit


-- ASAMA 4: DARALT (Eski sutunu kaldir)
-- Migrasyon: V007__remove_full_name.sql
-- Yalnizca uygulama guncellendikten ve test edildikten SONRA calistir

-- Once senkronizasyon tetikleyicisini kaldir
DROP TRIGGER IF EXISTS trg_users_sync_names ON users;
DROP FUNCTION IF EXISTS sync_name_columns();

-- Gerekirse NOT NULL kisitlamalari ekle
ALTER TABLE users ALTER COLUMN first_name SET NOT NULL;
-- last_name tek isimli kullanicilar icin nullable kalabilir

-- Eski sutunu kaldir
ALTER TABLE users DROP COLUMN full_name;

-- Gerekirse yeni sutunlara indeks ekle
CREATE INDEX idx_users_last_name ON users(last_name);</code></pre>

                        <p><strong>Kesintisiz Migrasyon Zaman Cizelgesi:</strong></p>
                        <table class="dataset-table">
                            <tr>
                                <th>Asama</th>
                                <th>Veritabani Durumu</th>
                                <th>Uygulama Okur</th>
                                <th>Uygulama Yazar</th>
                            </tr>
                            <tr>
                                <td>Once</td>
                                <td>yalnizca full_name</td>
                                <td>full_name</td>
                                <td>full_name</td>
                            </tr>
                            <tr>
                                <td>Asama 1 Sonrasi</td>
                                <td>full_name + first/last (nullable)</td>
                                <td>full_name</td>
                                <td>full_name (tetikleyici senkronize eder)</td>
                            </tr>
                            <tr>
                                <td>Asama 2 Sonrasi</td>
                                <td>Tum sutunlar dolu</td>
                                <td>full_name</td>
                                <td>full_name (tetikleyici senkronize eder)</td>
                            </tr>
                            <tr>
                                <td>Asama 3 Sonrasi</td>
                                <td>Tum sutunlar dolu</td>
                                <td>first/last</td>
                                <td>first/last</td>
                            </tr>
                            <tr>
                                <td>Asama 4 Sonrasi</td>
                                <td>yalnizca first/last</td>
                                <td>first/last</td>
                                <td>first/last</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Challenge Exercises -->
            <section>
                <h2 id="challenge-exercises">Zorluk Alistirmalari</h2>
                <p>Tum kavramlari gercek dunya sema yonetimi senaryolarina uygulayın.</p>

                <div class="challenge-box">
                    <h4>Zorluk 1: Coklu Sema Uygulama Tasarimi</h4>
                    <p>Asagidakileri iceren bir proje yonetimi SaaS icin eksiksiz bir sema organizasyonu tasarlayin:</p>
                    <ul>
                        <li>Paylasilan yapilandirma ve arama tablolari</li>
                        <li>Temel uygulama tablolari (projeler, gorevler, kullanicilar)</li>
                        <li>Raporlama/analitik tablolari (okuma icin optimize edilmis)</li>
                        <li>Denetim gunlugu tablolari (yalnizca ekleme)</li>
                        <li>Entegrasyon tablolari (dis API verileri icin)</li>
                    </ul>
                    <p><strong>Ciktilar:</strong> Sema tasarimi, ornek tablolar, erisim kaliplari ve baslangic kurulumu icin migrasyon.</p>

                    <button class="toggle-btn" onclick="toggleSolution('challenge1')">Cozumu Goster</button>
                    <div id="challenge1" class="solution-box">
                        <pre><code class="language-sql">-- Proje Yonetimi SaaS icin Sema Organizasyonu

-- 1. CORE Semasi - Ana uygulama tablolari
CREATE SCHEMA core;

CREATE TABLE core.users (
    user_id SERIAL PRIMARY KEY,
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    display_name VARCHAR(200),
    role VARCHAR(50) DEFAULT 'member',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE
);

CREATE TABLE core.projects (
    project_id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    owner_id INTEGER NOT NULL REFERENCES core.users(user_id),
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    due_date DATE
);

CREATE TABLE core.tasks (
    task_id SERIAL PRIMARY KEY,
    project_id INTEGER NOT NULL REFERENCES core.projects(project_id),
    title VARCHAR(300) NOT NULL,
    description TEXT,
    assignee_id INTEGER REFERENCES core.users(user_id),
    priority VARCHAR(20) DEFAULT 'medium',
    status VARCHAR(20) DEFAULT 'todo',
    due_date DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP
);

CREATE TABLE core.project_members (
    project_id INTEGER REFERENCES core.projects(project_id),
    user_id INTEGER REFERENCES core.users(user_id),
    role VARCHAR(50) DEFAULT 'member',
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (project_id, user_id)
);


-- 2. CONFIG Semasi - Paylasilan yapilandirma ve aramalar
CREATE SCHEMA config;

CREATE TABLE config.task_statuses (
    status_code VARCHAR(20) PRIMARY KEY,
    display_name VARCHAR(50) NOT NULL,
    sort_order INTEGER,
    is_completed BOOLEAN DEFAULT FALSE
);

INSERT INTO config.task_statuses VALUES
    ('todo', 'Yapilacak', 1, FALSE),
    ('in_progress', 'Devam Ediyor', 2, FALSE),
    ('review', 'Inceleniyor', 3, FALSE),
    ('done', 'Tamamlandi', 4, TRUE);

CREATE TABLE config.priority_levels (
    priority_code VARCHAR(20) PRIMARY KEY,
    display_name VARCHAR(50) NOT NULL,
    color_hex VARCHAR(7),
    sort_order INTEGER
);

CREATE TABLE config.app_settings (
    setting_key VARCHAR(100) PRIMARY KEY,
    setting_value TEXT,
    description TEXT,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


-- 3. ANALYTICS Semasi - Okuma icin optimize edilmis raporlama tablolari
CREATE SCHEMA analytics;

CREATE TABLE analytics.daily_project_metrics (
    metric_date DATE,
    project_id INTEGER,
    tasks_created INTEGER DEFAULT 0,
    tasks_completed INTEGER DEFAULT 0,
    active_members INTEGER DEFAULT 0,
    PRIMARY KEY (metric_date, project_id)
);

CREATE TABLE analytics.user_activity_summary (
    summary_date DATE,
    user_id INTEGER,
    tasks_created INTEGER DEFAULT 0,
    tasks_completed INTEGER DEFAULT 0,
    comments_added INTEGER DEFAULT 0,
    PRIMARY KEY (summary_date, user_id)
);

-- Gosterge paneli icin materyalize gorunum
CREATE MATERIALIZED VIEW analytics.mv_project_overview AS
SELECT
    p.project_id,
    p.name,
    p.status,
    p.owner_id,
    u.display_name AS owner_name,
    COUNT(DISTINCT pm.user_id) AS member_count,
    COUNT(t.task_id) AS total_tasks,
    COUNT(t.task_id) FILTER (WHERE t.status = 'done') AS completed_tasks,
    MAX(t.created_at) AS last_activity
FROM core.projects p
JOIN core.users u ON p.owner_id = u.user_id
LEFT JOIN core.project_members pm ON p.project_id = pm.project_id
LEFT JOIN core.tasks t ON p.project_id = t.project_id
GROUP BY p.project_id, p.name, p.status, p.owner_id, u.display_name;

CREATE UNIQUE INDEX ON analytics.mv_project_overview(project_id);


-- 4. AUDIT Semasi - Yalnizca ekleme denetim gunlukleri
CREATE SCHEMA audit;

CREATE TABLE audit.activity_log (
    log_id BIGSERIAL PRIMARY KEY,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    user_id INTEGER,
    action VARCHAR(50) NOT NULL,
    entity_type VARCHAR(50) NOT NULL,
    entity_id INTEGER,
    old_values JSONB,
    new_values JSONB,
    ip_address INET,
    user_agent TEXT
);

CREATE INDEX idx_audit_log_timestamp ON audit.activity_log(timestamp DESC);
CREATE INDEX idx_audit_log_user ON audit.activity_log(user_id, timestamp DESC);
CREATE INDEX idx_audit_log_entity ON audit.activity_log(entity_type, entity_id);

-- Daha iyi performans icin denetim gunlugunu aya gore bolumleme
-- CREATE TABLE audit.activity_log_2024_03 PARTITION OF audit.activity_log
--     FOR VALUES FROM ('2024-03-01') TO ('2024-04-01');


-- 5. INTEGRATION Semasi - Dis API verileri
CREATE SCHEMA integration;

CREATE TABLE integration.external_users (
    integration_user_id SERIAL PRIMARY KEY,
    local_user_id INTEGER REFERENCES core.users(user_id),
    provider VARCHAR(50) NOT NULL,
    provider_user_id VARCHAR(255) NOT NULL,
    access_token TEXT,
    refresh_token TEXT,
    token_expires_at TIMESTAMP,
    synced_at TIMESTAMP,
    UNIQUE (provider, provider_user_id)
);

CREATE TABLE integration.webhook_deliveries (
    delivery_id SERIAL PRIMARY KEY,
    webhook_url TEXT NOT NULL,
    event_type VARCHAR(50) NOT NULL,
    payload JSONB NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',
    attempts INTEGER DEFAULT 0,
    last_attempt_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


-- 6. Uygulama rolleri icin varsayilan search path'leri ayarla
-- Uygulama rolu core + config kullanir
CREATE ROLE app_user;
ALTER ROLE app_user SET search_path TO core, config, public;

-- Raporlama icin analitik rolu
CREATE ROLE analytics_user;
ALTER ROLE analytics_user SET search_path TO analytics, core, config, public;

-- Admin rolu tum semalara erisebilir
CREATE ROLE admin_user;
ALTER ROLE admin_user SET search_path TO core, config, analytics, audit, integration, public;</code></pre>

                        <div class="schema-diagram">
Veritabani: project_mgmt
├── Schema: core (ana uygulama)
│   ├── users
│   ├── projects
│   ├── tasks
│   └── project_members
├── Schema: config (paylasilan ayarlar)
│   ├── task_statuses
│   ├── priority_levels
│   └── app_settings
├── Schema: analytics (raporlama)
│   ├── daily_project_metrics
│   ├── user_activity_summary
│   └── mv_project_overview
├── Schema: audit (gunlukleme)
│   └── activity_log (bolumlu)
└── Schema: integration (dis)
    ├── external_users
    └── webhook_deliveries
                        </div>
                    </div>
                </div>

                <div class="challenge-box">
                    <h4>Zorluk 2: Migrasyon Sirasi</h4>
                    <p>Bu birbirine bagli degisiklikler icin bir migrasyon sirasi planlayin. Dogru sirayi ve gerekli ara adimlari belirleyin:</p>
                    <ul>
                        <li>Yeni <code>categories</code> tablosu ekle</li>
                        <li><code>products</code> tablosuna <code>category_id</code> yabanci anahtari ekle</li>
                        <li>Mevcut urun kategorilerini virgullerle ayrilmis <code>tags</code> sutunundan tasi</li>
                        <li>Eski <code>tags</code> sutununu products'tan kaldir</li>
                        <li><code>category_id</code>'ye NOT NULL kisitlamasi ekle</li>
                    </ul>

                    <button class="toggle-btn" onclick="toggleSolution('challenge2')">Cozumu Goster</button>
                    <div id="challenge2" class="solution-box">
                        <pre><code class="language-sql">-- V010__create_categories_table.sql
CREATE TABLE categories (
    category_id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    slug VARCHAR(100) NOT NULL UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- V011__add_category_to_products.sql
ALTER TABLE products ADD COLUMN category_id INTEGER;

-- YA kisitlamasi ekle (baslangicta NOT NULL olmadan)
ALTER TABLE products
ADD CONSTRAINT fk_products_category
FOREIGN KEY (category_id) REFERENCES categories(category_id);

CREATE INDEX idx_products_category ON products(category_id);

-- V012__migrate_tags_to_categories.sql
-- Once mevcut etiketlerden benzersiz kategorileri cikar
INSERT INTO categories (name, slug)
SELECT DISTINCT
    TRIM(unnest(string_to_array(tags, ','))) AS name,
    LOWER(REPLACE(TRIM(unnest(string_to_array(tags, ','))), ' ', '-')) AS slug
FROM products
WHERE tags IS NOT NULL AND tags != ''
ON CONFLICT (name) DO NOTHING;

-- Sonra urunleri ilk esleyen kategoriyle guncelle
UPDATE products p
SET category_id = c.category_id
FROM categories c
WHERE c.name = TRIM(split_part(p.tags, ',', 1))
  AND p.tags IS NOT NULL;

-- Etiketi olmayan urunleri isle - "Kategorisiz"e ata
INSERT INTO categories (name, slug) VALUES ('Kategorisiz', 'kategorisiz')
ON CONFLICT DO NOTHING;

UPDATE products
SET category_id = (SELECT category_id FROM categories WHERE slug = 'kategorisiz')
WHERE category_id IS NULL;

-- V013__make_category_required.sql
-- Yalnizca tum urunlerin category_id'si oldugunu dogruladiktan sonra calistir
ALTER TABLE products ALTER COLUMN category_id SET NOT NULL;

-- V014__drop_tags_column.sql
-- Yalnizca uygulama artik tags sutununu kullanmadiktan sonra calistir
ALTER TABLE products DROP COLUMN tags;</code></pre>

                        <p><strong>Migrasyon Sirasi Mantigi:</strong></p>
                        <ol>
                            <li><strong>V010</strong>: Once kategorileri olustur (YA icin bagimlilik)</li>
                            <li><strong>V011</strong>: Nullable sutun + YA ekle (kademeli doldurmaya izin verir)</li>
                            <li><strong>V012</strong>: Veri tasi (tum category_id degerlerini doldur)</li>
                            <li><strong>V013</strong>: NOT NULL ekle (yalnizca tum satirlarda deger olduktan sonra)</li>
                            <li><strong>V014</strong>: Eski sutunu kaldir (yalnizca uygulama guncellendikten sonra)</li>
                        </ol>
                    </div>
                </div>
            </section>

            <!-- Key Takeaways -->
            <section>
                <h2 id="key-takeaways">Temel Cikarimlar</h2>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Kavram</th>
                            <th>En Iyi Uygulama</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Sema Organizasyonu</td>
                            <td>Ilgili nesneleri modul, islev veya kiraciya gore semalara gruplandirin</td>
                        </tr>
                        <tr>
                            <td>Nesne Referanslari</td>
                            <td>Netlik icin kodda tam nitelikli adlar (<code>schema.table</code>) kullanin</td>
                        </tr>
                        <tr>
                            <td>Adlandirma Stili</td>
                            <td>Tasinabilirlik icin <code>snake_case</code> kullanin; tutarli olun</td>
                        </tr>
                        <tr>
                            <td>Tablo Adlari</td>
                            <td>Cogul isimler (<code>customers</code>) veya tutarli olarak tekil</td>
                        </tr>
                        <tr>
                            <td>Kisitlama Adlari</td>
                            <td>Aciklayici onekler: <code>pk_</code>, <code>fk_</code>, <code>uq_</code>, <code>chk_</code></td>
                        </tr>
                        <tr>
                            <td>Migrasyon Betikleri</td>
                            <td>Zaman damgalari veya sira numaralariyla surumleme; atomik tutun</td>
                        </tr>
                        <tr>
                            <td>Eklemeli Degisiklikler</td>
                            <td>Genellikle guvenli; baslangicta nullable sutunlari tercih edin</td>
                        </tr>
                        <tr>
                            <td>Yikici Degisiklikler</td>
                            <td>Genislet-daralt kalibini kullanin; asla yedekleme olmadan calistirmayin</td>
                        </tr>
                        <tr>
                            <td>Migrasyon Testi</td>
                            <td>Her zaman once uretim benzeri verilerle hazirlik ortaminda test edin</td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <!-- Navigation -->
            <section>
                <p><a href="02_schema_management_and_organization.html">&larr; Sema Yonetimi Dersine Don</a></p>
            </section>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="../static/script.js"></script>

    <script>
        function toggleSolution(id) {
            var element = document.getElementById(id);
            if (element.classList.contains('show')) {
                element.classList.remove('show');
                event.target.textContent = 'Cozumu Goster';
            } else {
                element.classList.add('show');
                event.target.textContent = 'Cozumu Gizle';
            }
        }
    </script>
</body>

</html>
