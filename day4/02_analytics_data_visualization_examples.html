<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="../style_bootstrap.html">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/code.css">
    <link href="https://cdn.prod.website-files.com/5efdb54f07a6812bcd95cc65/6773d0fc3013e060f08d7145_favicon.jpg"
        rel="shortcut icon" type="image/x-icon">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <title>Day 4: Analytics and Data Visualization - Practical Examples</title>
    <style>
        code {
            white-space: pre-wrap;
        }

        span.smallcaps {
            font-variant: small-caps;
        }

        span.underline {
            text-decoration: underline;
        }

        div.column {
            display: inline-block;
            vertical-align: top;
            width: 50%;
        }

        div.hanging-indent {
            margin-left: 1.5em;
            text-indent: -1.5em;
        }

        ul.task-list {
            list-style: none;
        }

        .exercise-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .exercise-box h4 {
            color: #495057;
            margin-bottom: 15px;
        }

        .solution-content {
            background-color: #e7f3ff;
            border: 1px solid #b6d4fe;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .solution-content.show {
            display: block;
        }

        .solution-toggle {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        .solution-toggle:hover {
            background-color: #218838;
        }

        .hint-box {
            background-color: #fff3cd;
            border: 1px solid #ffecb5;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .hint-box strong {
            color: #664d03;
        }

        .warning-box {
            background-color: #f8d7da;
            border: 1px solid #f5c2c7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .warning-box strong {
            color: #842029;
        }

        .concept-box {
            background-color: #d1e7dd;
            border: 1px solid #badbcc;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .concept-box strong {
            color: #0f5132;
        }

        .dataset-table {
            font-size: 0.9em;
            margin: 15px 0;
        }

        .dataset-table th {
            background-color: #e9ecef;
        }

        .badge-window {
            background-color: #6f42c1;
            color: white;
        }

        .badge-aggregate {
            background-color: #198754;
            color: white;
        }

        .badge-cte {
            background-color: #0d6efd;
            color: white;
        }

        .result-table {
            font-size: 0.85em;
            margin: 15px 0;
        }

        .result-table th {
            background-color: #343a40;
            color: white;
        }

        .result-table td {
            font-family: 'Courier New', monospace;
        }

        .visual-demo {
            background-color: #f8f9fa;
            border: 2px dashed #6c757d;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }

        .visual-demo h6 {
            color: #6c757d;
            margin-bottom: 15px;
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 150px;
            padding: 10px;
        }

        .bar {
            width: 40px;
            background: linear-gradient(to top, #0d6efd, #6ea8fe);
            border-radius: 4px 4px 0 0;
            position: relative;
        }

        .bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7em;
            white-space: nowrap;
        }

        .bar-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7em;
            font-weight: bold;
        }
        .language-switcher {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .language-switcher a {
            text-decoration: none;
            padding: 5px 10px;
            margin: 0 2px;
            border-radius: 3px;
            color: #333;
        }
        .language-switcher a.active {
            background: #0d6efd;
            color: #fff;
        }
        .language-switcher a:hover:not(.active) {
            background: #e9ecef;
        }
    </style>
</head>

<body>
    <a href="../index_en.html" class="back-button">‚Üê Back to Index</a>
    <div class="language-switcher">
        <a href="02_analytics_data_visualization_examples.html" class="active">EN</a>
        <a href="02_analytics_data_visualization_examples_tr.html">TR</a>
    </div>
    <div class="copy-notification" id="copyNotification">Copied!</div>

    <div id="europeanunion-turkey">
        <img src="../static/eu.png" alt="">
    </div>
    <div id="sanayiteknolojibakan">
        <img src="../static/sanayitek.png" alt="">
    </div>
    <div id="rekabet">
        <img src="../static/rekabet.png" alt="">
    </div>
    <div id="tisk">
        <img src="../static/tisk.png" alt="">
    </div>
    <div id="undp">
        <img src="../static/undp.png" alt="">
    </div>
    <div class="content-container">
        <div class="container">
            <section>
                <h1>Analytics and Data Visualization - Practical Examples</h1>
                <p class="lead">Master window functions, advanced aggregations, CTEs, and data preparation for
                    visualization through hands-on exercises.</p>

                <div class="hint-box">
                    <strong>Learning Objectives:</strong>
                    <ul class="mb-0">
                        <li>Apply window functions for ranking, running totals, and comparisons</li>
                        <li>Use advanced aggregations (GROUPING SETS, ROLLUP, CUBE)</li>
                        <li>Build complex analytics with CTEs</li>
                        <li>Prepare data for visualization tools</li>
                    </ul>
                </div>
            </section>

            <!-- Sample Dataset -->
            <section>
                <h3>Sample Database Schema</h3>
                <p>We'll use an e-commerce analytics database:</p>

                <div class="row">
                    <div class="col-md-4">
                        <h5>orders</h5>
                        <table class="table table-bordered dataset-table">
                            <thead>
                                <tr>
                                    <th>Column</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>id</td>
                                    <td><span class="badge bg-primary">SERIAL PK</span></td>
                                </tr>
                                <tr>
                                    <td>order_number</td>
                                    <td><span class="badge bg-secondary">VARCHAR</span></td>
                                </tr>
                                <tr>
                                    <td>customer_id</td>
                                    <td><span class="badge bg-success">INTEGER FK</span></td>
                                </tr>
                                <tr>
                                    <td>order_date</td>
                                    <td><span class="badge bg-warning text-dark">DATE</span></td>
                                </tr>
                                <tr>
                                    <td>status</td>
                                    <td><span class="badge bg-secondary">VARCHAR</span></td>
                                </tr>
                                <tr>
                                    <td>total_amount</td>
                                    <td><span class="badge bg-info">DECIMAL</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-4">
                        <h5>order_lines</h5>
                        <table class="table table-bordered dataset-table">
                            <thead>
                                <tr>
                                    <th>Column</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>id</td>
                                    <td><span class="badge bg-primary">SERIAL PK</span></td>
                                </tr>
                                <tr>
                                    <td>order_id</td>
                                    <td><span class="badge bg-success">INTEGER FK</span></td>
                                </tr>
                                <tr>
                                    <td>product_id</td>
                                    <td><span class="badge bg-success">INTEGER FK</span></td>
                                </tr>
                                <tr>
                                    <td>quantity</td>
                                    <td><span class="badge bg-info">INTEGER</span></td>
                                </tr>
                                <tr>
                                    <td>unit_price</td>
                                    <td><span class="badge bg-info">DECIMAL</span></td>
                                </tr>
                                <tr>
                                    <td>line_total</td>
                                    <td><span class="badge bg-info">DECIMAL</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-4">
                        <h5>products</h5>
                        <table class="table table-bordered dataset-table">
                            <thead>
                                <tr>
                                    <th>Column</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>id</td>
                                    <td><span class="badge bg-primary">SERIAL PK</span></td>
                                </tr>
                                <tr>
                                    <td>name</td>
                                    <td><span class="badge bg-secondary">VARCHAR</span></td>
                                </tr>
                                <tr>
                                    <td>category_id</td>
                                    <td><span class="badge bg-success">INTEGER FK</span></td>
                                </tr>
                                <tr>
                                    <td>price</td>
                                    <td><span class="badge bg-info">DECIMAL</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <h5>categories</h5>
                        <table class="table table-bordered dataset-table">
                            <thead>
                                <tr>
                                    <th>Column</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>id</td>
                                    <td><span class="badge bg-primary">SERIAL PK</span></td>
                                </tr>
                                <tr>
                                    <td>name</td>
                                    <td><span class="badge bg-secondary">VARCHAR</span></td>
                                </tr>
                                <tr>
                                    <td>parent_id</td>
                                    <td><span class="badge bg-success">INTEGER FK</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-4">
                        <h5>customers</h5>
                        <table class="table table-bordered dataset-table">
                            <thead>
                                <tr>
                                    <th>Column</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>id</td>
                                    <td><span class="badge bg-primary">SERIAL PK</span></td>
                                </tr>
                                <tr>
                                    <td>name</td>
                                    <td><span class="badge bg-secondary">VARCHAR</span></td>
                                </tr>
                                <tr>
                                    <td>city</td>
                                    <td><span class="badge bg-secondary">VARCHAR</span></td>
                                </tr>
                                <tr>
                                    <td>country_id</td>
                                    <td><span class="badge bg-success">INTEGER FK</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-4">
                        <h5>employees</h5>
                        <table class="table table-bordered dataset-table">
                            <thead>
                                <tr>
                                    <th>Column</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>id</td>
                                    <td><span class="badge bg-primary">SERIAL PK</span></td>
                                </tr>
                                <tr>
                                    <td>first_name</td>
                                    <td><span class="badge bg-secondary">VARCHAR</span></td>
                                </tr>
                                <tr>
                                    <td>last_name</td>
                                    <td><span class="badge bg-secondary">VARCHAR</span></td>
                                </tr>
                                <tr>
                                    <td>department</td>
                                    <td><span class="badge bg-secondary">VARCHAR</span></td>
                                </tr>
                                <tr>
                                    <td>manager_id</td>
                                    <td><span class="badge bg-success">INTEGER FK</span></td>
                                </tr>
                                <tr>
                                    <td>salary</td>
                                    <td><span class="badge bg-info">DECIMAL</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="hint-box mt-3">
                    <strong>Note:</strong> The <code>orders.status</code> column has values: <code>'draft'</code>, <code>'confirmed'</code>, <code>'processing'</code>, <code>'shipped'</code>, <code>'delivered'</code>, <code>'cancelled'</code>, <code>'returned'</code>
                </div>
            </section>

            <!-- Part 1: Window Functions -->
            <section>
                <h2>Part 1: Window Functions</h2>
                <p>Practice ranking, aggregating, and comparing across rows.</p>

                <div class="hint-box" style="background-color: #e7f3ff; border: 1px solid #b3d9ff;">
                    <strong>üí° Practice Tip:</strong> Window functions are SQL's most powerful analytics tools. Pay attention to the OVER() clause in each exercise - PARTITION BY groups data, ORDER BY determines the sequence. Unlike GROUP BY, window functions preserve all rows.
                </div>

                <div class="exercise-box">
                    <h4>Exercise 1.1: Ranking Functions Comparison</h4>
                    <p>Given monthly sales data, show the difference between ROW_NUMBER(), RANK(), and DENSE_RANK():</p>

                    <table class="table table-bordered result-table">
                        <thead>
                            <tr>
                                <th>month</th>
                                <th>sales</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>2024-01</td>
                                <td>50000</td>
                            </tr>
                            <tr>
                                <td>2024-02</td>
                                <td>45000</td>
                            </tr>
                            <tr>
                                <td>2024-03</td>
                                <td>45000</td>
                            </tr>
                            <tr>
                                <td>2024-04</td>
                                <td>42000</td>
                            </tr>
                            <tr>
                                <td>2024-05</td>
                                <td>55000</td>
                            </tr>
                        </tbody>
                    </table>

                    <p><strong>Task:</strong> Write a query that shows all three ranking functions ranking by sales DESC.
                    </p>

                    <button class="solution-toggle" onclick="toggleSolution('sol1_1')">Show Solution</button>
                    <div id="sol1_1" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="kw">WITH</span> monthly_sales <span class="kw">AS</span> (
    <span class="kw">SELECT</span> <span class="st">'2024-01'</span> <span class="kw">AS</span> month, <span class="dv">50000</span> <span class="kw">AS</span> sales <span class="kw">UNION ALL</span>
    <span class="kw">SELECT</span> <span class="st">'2024-02'</span>, <span class="dv">45000</span> <span class="kw">UNION ALL</span>
    <span class="kw">SELECT</span> <span class="st">'2024-03'</span>, <span class="dv">45000</span> <span class="kw">UNION ALL</span>
    <span class="kw">SELECT</span> <span class="st">'2024-04'</span>, <span class="dv">42000</span> <span class="kw">UNION ALL</span>
    <span class="kw">SELECT</span> <span class="st">'2024-05'</span>, <span class="dv">55000</span>
)
<span class="kw">SELECT</span>
    month,
    sales,
    <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span> (<span class="kw">ORDER BY</span> sales <span class="kw">DESC</span>) <span class="kw">AS</span> row_num,
    <span class="fu">RANK</span>() <span class="kw">OVER</span> (<span class="kw">ORDER BY</span> sales <span class="kw">DESC</span>) <span class="kw">AS</span> rank,
    <span class="fu">DENSE_RANK</span>() <span class="kw">OVER</span> (<span class="kw">ORDER BY</span> sales <span class="kw">DESC</span>) <span class="kw">AS</span> dense_rank
<span class="kw">FROM</span> monthly_sales;</code></pre>

                        <p><strong>Result:</strong></p>
                        <table class="table table-bordered result-table">
                            <thead>
                                <tr>
                                    <th>month</th>
                                    <th>sales</th>
                                    <th>row_num</th>
                                    <th>rank</th>
                                    <th>dense_rank</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>2024-05</td>
                                    <td>55000</td>
                                    <td>1</td>
                                    <td>1</td>
                                    <td>1</td>
                                </tr>
                                <tr>
                                    <td>2024-01</td>
                                    <td>50000</td>
                                    <td>2</td>
                                    <td>2</td>
                                    <td>2</td>
                                </tr>
                                <tr>
                                    <td>2024-02</td>
                                    <td>45000</td>
                                    <td>3</td>
                                    <td>3</td>
                                    <td>3</td>
                                </tr>
                                <tr>
                                    <td>2024-03</td>
                                    <td>45000</td>
                                    <td>4</td>
                                    <td>3</td>
                                    <td>3</td>
                                </tr>
                                <tr>
                                    <td>2024-04</td>
                                    <td>42000</td>
                                    <td>5</td>
                                    <td>5</td>
                                    <td>4</td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="concept-box">
                            <strong>Key Differences:</strong>
                            <ul class="mb-0">
                                <li><strong>ROW_NUMBER()</strong>: Always unique (3, 4 for ties)</li>
                                <li><strong>RANK()</strong>: Same rank for ties, skips next (3, 3, 5)</li>
                                <li><strong>DENSE_RANK()</strong>: Same rank for ties, no skip (3, 3, 4)</li>
                            </ul>
                        </div>

                        <div style="background-color: #f3e5f5; border: 1px solid #ce93d8; border-radius: 8px; padding: 15px; margin: 15px 0;">
                            <strong>üìä Visualization Suggestion:</strong><br>
                            <ul class="mb-0">
                                <li><strong>Chart Type:</strong> Horizontal Bar Chart</li>
                                <li><strong>X Axis:</strong> Sales Amount (sales)</li>
                                <li><strong>Y Axis:</strong> Month (month) - in chronological order</li>
                                <li><strong>Color Coding:</strong> Different colors for each ranking function (row_num, rank, dense_rank)</li>
                                <li><strong>Tools:</strong> Excel, Tableau, Power BI, or matplotlib/seaborn</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Exercise 1.2: Top N Per Group</h4>
                    <p>Find the top 3 best-selling products in each category.</p>

                    <p><strong>Task:</strong> Use ROW_NUMBER() with PARTITION BY to rank products within each category,
                        then filter to top 3.</p>

                    <button class="solution-toggle" onclick="toggleSolution('sol1_2')">Show Solution</button>
                    <div id="sol1_2" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="kw">WITH</span> product_sales <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        p.id <span class="kw">AS</span> product_id,
        p.name <span class="kw">AS</span> product_name,
        c.name <span class="kw">AS</span> category_name,
        <span class="fu">SUM</span>(ol.quantity * ol.unit_price) <span class="kw">AS</span> total_sales
    <span class="kw">FROM</span> products p
    <span class="kw">JOIN</span> categories c <span class="kw">ON</span> p.category_id = c.id
    <span class="kw">JOIN</span> order_lines ol <span class="kw">ON</span> p.id = ol.product_id
    <span class="kw">GROUP BY</span> p.id, p.name, c.name
),
ranked_products <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        product_name,
        category_name,
        total_sales,
        <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span> (
            <span class="kw">PARTITION BY</span> category_name
            <span class="kw">ORDER BY</span> total_sales <span class="kw">DESC</span>
        ) <span class="kw">AS</span> rank_in_category
    <span class="kw">FROM</span> product_sales
)
<span class="kw">SELECT</span>
    category_name,
    rank_in_category,
    product_name,
    total_sales
<span class="kw">FROM</span> ranked_products
<span class="kw">WHERE</span> rank_in_category <= <span class="dv">3</span>
<span class="kw">ORDER BY</span> category_name, rank_in_category;</code></pre>

                        <div class="hint-box">
                            <strong>Use Case:</strong> This pattern is essential for "Top N" reports like:
                            <ul class="mb-0">
                                <li>Top 5 customers per region</li>
                                <li>Top 10 products per month</li>
                                <li>Best 3 salespeople per quarter</li>
                            </ul>
                        </div>

                        <div style="background-color: #f3e5f5; border: 1px solid #ce93d8; border-radius: 8px; padding: 15px; margin: 15px 0;">
                            <strong>üìä Visualization Suggestion:</strong><br>
                            <ul class="mb-0">
                                <li><strong>Chart Type:</strong> Grouped Bar Chart or Faceted Bar Chart</li>
                                <li><strong>X Axis:</strong> Product Name (product_name)</li>
                                <li><strong>Y Axis:</strong> Total Sales (total_sales)</li>
                                <li><strong>Grouping:</strong> Category Name (category_name) - each category as separate panel or color</li>
                                <li><strong>Sorting:</strong> Descending by sales within each group</li>
                                <li><strong>Alternative:</strong> Treemap (each category as an area, products inside)</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Exercise 1.3: LAG and LEAD for Trend Analysis</h4>
                    <p>Calculate month-over-month sales growth using LAG().</p>

                    <p><strong>Task:</strong> Show each month's sales, previous month's sales, and the percentage
                        change.</p>

                    <button class="solution-toggle" onclick="toggleSolution('sol1_3')">Show Solution</button>
                    <div id="sol1_3" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="kw">WITH</span> monthly_sales <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, order_date) <span class="kw">AS</span> month,
        <span class="fu">SUM</span>(total_amount) <span class="kw">AS</span> sales
    <span class="kw">FROM</span> orders
    <span class="kw">GROUP BY</span> <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, order_date)
)
<span class="kw">SELECT</span>
    month,
    sales,
    <span class="fu">LAG</span>(sales) <span class="kw">OVER</span> (<span class="kw">ORDER BY</span> month) <span class="kw">AS</span> prev_month_sales,
    sales - <span class="fu">LAG</span>(sales) <span class="kw">OVER</span> (<span class="kw">ORDER BY</span> month) <span class="kw">AS</span> absolute_change,
    <span class="fu">ROUND</span>(
        (sales - <span class="fu">LAG</span>(sales) <span class="kw">OVER</span> (<span class="kw">ORDER BY</span> month)) * <span class="fl">100.0</span> /
        <span class="fu">NULLIF</span>(<span class="fu">LAG</span>(sales) <span class="kw">OVER</span> (<span class="kw">ORDER BY</span> month), <span class="dv">0</span>),
        <span class="dv">2</span>
    ) <span class="kw">AS</span> pct_change
<span class="kw">FROM</span> monthly_sales
<span class="kw">ORDER BY</span> month;</code></pre>

                        <p><strong>Example Output:</strong></p>
                        <table class="table table-bordered result-table">
                            <thead>
                                <tr>
                                    <th>month</th>
                                    <th>sales</th>
                                    <th>prev_month</th>
                                    <th>change</th>
                                    <th>pct_change</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>2024-01-01</td>
                                    <td>50000</td>
                                    <td>NULL</td>
                                    <td>NULL</td>
                                    <td>NULL</td>
                                </tr>
                                <tr>
                                    <td>2024-02-01</td>
                                    <td>55000</td>
                                    <td>50000</td>
                                    <td>5000</td>
                                    <td>10.00</td>
                                </tr>
                                <tr>
                                    <td>2024-03-01</td>
                                    <td>48000</td>
                                    <td>55000</td>
                                    <td>-7000</td>
                                    <td>-12.73</td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="concept-box">
                            <strong>LAG vs LEAD:</strong>
                            <ul class="mb-0">
                                <li><code>LAG(col, n)</code> - Gets value from n rows BEFORE (default n=1)</li>
                                <li><code>LEAD(col, n)</code> - Gets value from n rows AFTER</li>
                            </ul>
                        </div>

                        <div style="background-color: #f3e5f5; border: 1px solid #ce93d8; border-radius: 8px; padding: 15px; margin: 15px 0;">
                            <strong>üìä Visualization Suggestion:</strong><br>
                            <ul class="mb-0">
                                <li><strong>Chart Type:</strong> Line Chart + Bar Chart Combination</li>
                                <li><strong>X Axis:</strong> Month (month)</li>
                                <li><strong>Y Axis (Left):</strong> Sales Amount (sales) - as bars</li>
                                <li><strong>Y Axis (Right):</strong> Percent Change (pct_change) - as line</li>
                                <li><strong>Color Coding:</strong> Positive change green, negative red</li>
                                <li><strong>Extra:</strong> Trend line or reference line (0% line)</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Exercise 1.4: Running Totals and Moving Averages</h4>
                    <p>Calculate cumulative sales and a 7-day moving average.</p>

                    <p><strong>Task:</strong> Use window frame clauses to compute running total and moving average.</p>

                    <button class="solution-toggle" onclick="toggleSolution('sol1_4')">Show Solution</button>
                    <div id="sol1_4" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="kw">SELECT</span>
    order_date,
    daily_total <span class="kw">AS</span> daily_sales,
    <span class="co">-- Running total: all rows from start to current</span>
    <span class="fu">SUM</span>(daily_total) <span class="kw">OVER</span> (
        <span class="kw">ORDER BY</span> order_date
        <span class="kw">ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW</span>
    ) <span class="kw">AS</span> running_total,
    <span class="co">-- 7-day moving average: 6 preceding + current</span>
    <span class="fu">ROUND</span>(
        <span class="fu">AVG</span>(daily_total) <span class="kw">OVER</span> (
            <span class="kw">ORDER BY</span> order_date
            <span class="kw">ROWS BETWEEN</span> <span class="dv">6</span> <span class="kw">PRECEDING AND CURRENT ROW</span>
        ),
        <span class="dv">2</span>
    ) <span class="kw">AS</span> moving_avg_7day,
    <span class="co">-- Count rows in moving window</span>
    <span class="fu">COUNT</span>(*) <span class="kw">OVER</span> (
        <span class="kw">ORDER BY</span> order_date
        <span class="kw">ROWS BETWEEN</span> <span class="dv">6</span> <span class="kw">PRECEDING AND CURRENT ROW</span>
    ) <span class="kw">AS</span> days_in_window
<span class="kw">FROM</span> (
    <span class="kw">SELECT</span> order_date, <span class="fu">SUM</span>(total_amount) <span class="kw">AS</span> daily_total
    <span class="kw">FROM</span> orders
    <span class="kw">GROUP BY</span> order_date
) daily_totals
<span class="kw">ORDER BY</span> order_date;</code></pre>

                        <div class="warning-box">
                            <strong>Frame Clause Gotcha:</strong>
                            <ul class="mb-0">
                                <li><code>ROWS</code> counts physical rows</li>
                                <li><code>RANGE</code> considers value ranges (handles ties differently)</li>
                                <li>Without ORDER BY, frame includes entire partition</li>
                            </ul>
                        </div>

                        <div style="background-color: #f3e5f5; border: 1px solid #ce93d8; border-radius: 8px; padding: 15px; margin: 15px 0;">
                            <strong>üìä Visualization Suggestion:</strong><br>
                            <ul class="mb-0">
                                <li><strong>Chart Type:</strong> Multi-Line Chart</li>
                                <li><strong>X Axis:</strong> Date (order_date)</li>
                                <li><strong>Y Axis:</strong> Amount</li>
                                <li><strong>Lines:</strong> Daily Sales (thin, light color), Running Total (thick, dark), 7-Day Moving Average (dashed, different color)</li>
                                <li><strong>Note:</strong> Use secondary Y axis for running total (different scale)</li>
                                <li><strong>Tools:</strong> Tableau, Power BI, Google Data Studio, D3.js</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Part 2: Advanced Aggregations -->
            <section>
                <h2>Part 2: Advanced Aggregations</h2>
                <p>Master GROUPING SETS, ROLLUP, CUBE, and conditional aggregations.</p>

                <div class="hint-box" style="background-color: #e7f3ff; border: 1px solid #b3d9ff;">
                    <strong>üí° Practice Tip:</strong> GROUPING SETS, ROLLUP, and CUBE produce results similar to Excel pivot tables. The GROUPING() function helps identify which rows are subtotals (1 = total row, 0 = detail row).
                </div>

                <div class="exercise-box">
                    <h4>Exercise 2.1: GROUPING SETS for Multiple Summaries</h4>
                    <p>Generate a report showing sales by:
                    <ul>
                        <li>Category + Month</li>
                        <li>Category only</li>
                        <li>Month only</li>
                        <li>Grand total</li>
                    </ul>
                    </p>

                    <p><strong>Task:</strong> Use GROUPING SETS to produce all summaries in one query.</p>

                    <button class="solution-toggle" onclick="toggleSolution('sol2_1')">Show Solution</button>
                    <div id="sol2_1" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="kw">SELECT</span>
    <span class="fu">COALESCE</span>(c.name, <span class="st">'All Categories'</span>) <span class="kw">AS</span> category,
    <span class="fu">COALESCE</span>(<span class="fu">TO_CHAR</span>(o.order_date, <span class="st">'YYYY-MM'</span>), <span class="st">'All Months'</span>) <span class="kw">AS</span> month,
    <span class="fu">SUM</span>(ol.quantity * ol.unit_price) <span class="kw">AS</span> total_sales,
    <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> o.id) <span class="kw">AS</span> order_count,
    <span class="co">-- Identify grouping level</span>
    <span class="fu">GROUPING</span>(c.name) <span class="kw">AS</span> is_category_total,
    <span class="fu">GROUPING</span>(<span class="fu">TO_CHAR</span>(o.order_date, <span class="st">'YYYY-MM'</span>)) <span class="kw">AS</span> is_month_total
<span class="kw">FROM</span> orders o
<span class="kw">JOIN</span> order_lines ol <span class="kw">ON</span> o.id = ol.order_id
<span class="kw">JOIN</span> products p <span class="kw">ON</span> ol.product_id = p.id
<span class="kw">JOIN</span> categories c <span class="kw">ON</span> p.category_id = c.id
<span class="kw">GROUP BY</span> <span class="fu">GROUPING</span> <span class="kw">SETS</span> (
    (c.name, <span class="fu">TO_CHAR</span>(o.order_date, <span class="st">'YYYY-MM'</span>)),  <span class="co">-- Detail</span>
    (c.name),                                      <span class="co">-- Category subtotal</span>
    (<span class="fu">TO_CHAR</span>(o.order_date, <span class="st">'YYYY-MM'</span>)),            <span class="co">-- Month subtotal</span>
    ()                                             <span class="co">-- Grand total</span>
)
<span class="kw">ORDER BY</span>
    <span class="fu">GROUPING</span>(c.name),
    <span class="fu">GROUPING</span>(<span class="fu">TO_CHAR</span>(o.order_date, <span class="st">'YYYY-MM'</span>)),
    category,
    month;</code></pre>

                        <div class="concept-box">
                            <strong>GROUPING() Function:</strong> Returns 1 if the column is aggregated (NULL due to
                            grouping), 0 if it's a real value. Useful to distinguish NULL values from aggregation NULLs.
                        </div>

                        <div style="background-color: #f3e5f5; border: 1px solid #ce93d8; border-radius: 8px; padding: 15px; margin: 15px 0;">
                            <strong>üìä Visualization Suggestion:</strong><br>
                            <ul class="mb-0">
                                <li><strong>Chart Type:</strong> Heatmap or Pivot Table</li>
                                <li><strong>Rows:</strong> Category (category)</li>
                                <li><strong>Columns:</strong> Month (month)</li>
                                <li><strong>Values:</strong> Total Sales (total_sales) - with color intensity</li>
                                <li><strong>Subtotals:</strong> Show as edge rows and columns</li>
                                <li><strong>Alternative:</strong> Stacked Bar Chart (categories stacked, months on X axis)</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Exercise 2.2: ROLLUP for Hierarchical Totals</h4>
                    <p>Create a hierarchical sales report: Year > Quarter > Month with subtotals at each level.</p>

                    <p><strong>Task:</strong> Use ROLLUP to automatically generate subtotals.</p>

                    <button class="solution-toggle" onclick="toggleSolution('sol2_2')">Show Solution</button>
                    <div id="sol2_2" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="kw">SELECT</span>
    <span class="fu">EXTRACT</span>(<span class="kw">YEAR</span> <span class="kw">FROM</span> order_date) <span class="kw">AS</span> year,
    <span class="fu">EXTRACT</span>(<span class="kw">QUARTER</span> <span class="kw">FROM</span> order_date) <span class="kw">AS</span> quarter,
    <span class="fu">EXTRACT</span>(<span class="kw">MONTH</span> <span class="kw">FROM</span> order_date) <span class="kw">AS</span> month,
    <span class="fu">SUM</span>(total_amount) <span class="kw">AS</span> total_sales,
    <span class="fu">COUNT</span>(*) <span class="kw">AS</span> order_count,
    <span class="cf">CASE</span>
        <span class="cf">WHEN</span> <span class="fu">GROUPING</span>(<span class="fu">EXTRACT</span>(<span class="kw">YEAR</span> <span class="kw">FROM</span> order_date)) = <span class="dv">1</span> <span class="cf">THEN</span> <span class="st">'Grand Total'</span>
        <span class="cf">WHEN</span> <span class="fu">GROUPING</span>(<span class="fu">EXTRACT</span>(<span class="kw">QUARTER</span> <span class="kw">FROM</span> order_date)) = <span class="dv">1</span> <span class="cf">THEN</span> <span class="st">'Year Total'</span>
        <span class="cf">WHEN</span> <span class="fu">GROUPING</span>(<span class="fu">EXTRACT</span>(<span class="kw">MONTH</span> <span class="kw">FROM</span> order_date)) = <span class="dv">1</span> <span class="cf">THEN</span> <span class="st">'Quarter Total'</span>
        <span class="cf">ELSE</span> <span class="st">'Month Detail'</span>
    <span class="cf">END</span> <span class="kw">AS</span> level_type
<span class="kw">FROM</span> orders
<span class="kw">GROUP BY</span> <span class="kw">ROLLUP</span> (
    <span class="fu">EXTRACT</span>(<span class="kw">YEAR</span> <span class="kw">FROM</span> order_date),
    <span class="fu">EXTRACT</span>(<span class="kw">QUARTER</span> <span class="kw">FROM</span> order_date),
    <span class="fu">EXTRACT</span>(<span class="kw">MONTH</span> <span class="kw">FROM</span> order_date)
)
<span class="kw">ORDER BY</span> year <span class="kw">NULLS LAST</span>, quarter <span class="kw">NULLS LAST</span>, month <span class="kw">NULLS LAST</span>;</code></pre>

                        <p><strong>ROLLUP generates:</strong></p>
                        <ul>
                            <li>(year, quarter, month) - Detail rows</li>
                            <li>(year, quarter) - Quarterly subtotals</li>
                            <li>(year) - Yearly subtotals</li>
                            <li>() - Grand total</li>
                        </ul>

                        <div style="background-color: #f3e5f5; border: 1px solid #ce93d8; border-radius: 8px; padding: 15px; margin: 15px 0;">
                            <strong>üìä Visualization Suggestion:</strong><br>
                            <ul class="mb-0">
                                <li><strong>Chart Type:</strong> Sunburst Chart or Treemap</li>
                                <li><strong>Hierarchy:</strong> Year > Quarter > Month (nested rings or boxes)</li>
                                <li><strong>Size:</strong> Total Sales (total_sales)</li>
                                <li><strong>Color:</strong> Order Count (order_count) or hierarchy level</li>
                                <li><strong>Alternative:</strong> Drill-down Bar Chart (click year > see quarters)</li>
                                <li><strong>Tools:</strong> Power BI, Tableau, D3.js sunburst</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Exercise 2.3: Conditional Aggregation with FILTER</h4>
                    <p>Create a report showing total orders, delivered orders, and cancelled orders per month.</p>

                    <p><strong>Task:</strong> Use the FILTER clause for conditional counting.</p>

                    <button class="solution-toggle" onclick="toggleSolution('sol2_3')">Show Solution</button>
                    <div id="sol2_3" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="kw">SELECT</span>
    <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, order_date) <span class="kw">AS</span> month,
    <span class="fu">COUNT</span>(*) <span class="kw">AS</span> total_orders,
    <span class="fu">COUNT</span>(*) <span class="kw">FILTER</span> (<span class="kw">WHERE</span> status = <span class="st">'delivered'</span>) <span class="kw">AS</span> delivered,
    <span class="fu">COUNT</span>(*) <span class="kw">FILTER</span> (<span class="kw">WHERE</span> status = <span class="st">'cancelled'</span>) <span class="kw">AS</span> cancelled,
    <span class="fu">COUNT</span>(*) <span class="kw">FILTER</span> (<span class="kw">WHERE</span> status = <span class="st">'processing'</span>) <span class="kw">AS</span> processing,
    <span class="fu">ROUND</span>(
        <span class="fu">COUNT</span>(*) <span class="kw">FILTER</span> (<span class="kw">WHERE</span> status = <span class="st">'delivered'</span>) * <span class="fl">100.0</span> / <span class="fu">COUNT</span>(*),
        <span class="dv">2</span>
    ) <span class="kw">AS</span> delivery_rate,
    <span class="fu">SUM</span>(total_amount) <span class="kw">FILTER</span> (<span class="kw">WHERE</span> status = <span class="st">'delivered'</span>) <span class="kw">AS</span> delivered_revenue
<span class="kw">FROM</span> orders
<span class="kw">GROUP BY</span> <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, order_date)
<span class="kw">ORDER BY</span> month;</code></pre>

                        <div class="hint-box">
                            <strong>Alternative (without FILTER):</strong>
                            <pre><code class="sourceCode sql"><span class="fu">SUM</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> status = <span class="st">'delivered'</span> <span class="cf">THEN</span> <span class="dv">1</span> <span class="cf">ELSE</span> <span class="dv">0</span> <span class="cf">END</span>) <span class="kw">AS</span> delivered</code></pre>
                            FILTER is cleaner and PostgreSQL-specific.
                        </div>

                        <div style="background-color: #f3e5f5; border: 1px solid #ce93d8; border-radius: 8px; padding: 15px; margin: 15px 0;">
                            <strong>üìä Visualization Suggestion:</strong><br>
                            <ul class="mb-0">
                                <li><strong>Chart Type:</strong> Stacked Bar Chart or 100% Stacked Bar</li>
                                <li><strong>X Axis:</strong> Month (month)</li>
                                <li><strong>Y Axis:</strong> Order Count or Percentage</li>
                                <li><strong>Colors:</strong> Status-based (green=delivered, red=cancelled, blue=processing)</li>
                                <li><strong>Extra Line:</strong> Delivery rate (delivery_rate) on secondary Y axis</li>
                                <li><strong>Alternative:</strong> Donut Chart for monthly status distribution</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Exercise 2.4: Statistical Aggregations</h4>
                    <p>Calculate statistical metrics for product prices within each category.</p>

                    <p><strong>Task:</strong> Compute mean, median, standard deviation, and identify outliers.</p>

                    <button class="solution-toggle" onclick="toggleSolution('sol2_4')">Show Solution</button>
                    <div id="sol2_4" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="kw">SELECT</span>
    c.name <span class="kw">AS</span> category_name,
    <span class="fu">COUNT</span>(*) <span class="kw">AS</span> product_count,
    <span class="fu">ROUND</span>(<span class="fu">AVG</span>(p.price), <span class="dv">2</span>) <span class="kw">AS</span> avg_price,
    <span class="fu">ROUND</span>(
        <span class="fu">PERCENTILE_CONT</span>(<span class="fl">0.5</span>) <span class="kw">WITHIN GROUP</span> (<span class="kw">ORDER BY</span> p.price),
        <span class="dv">2</span>
    ) <span class="kw">AS</span> median_price,
    <span class="fu">ROUND</span>(<span class="fu">STDDEV</span>(p.price), <span class="dv">2</span>) <span class="kw">AS</span> stddev_price,
    <span class="fu">MIN</span>(p.price) <span class="kw">AS</span> min_price,
    <span class="fu">MAX</span>(p.price) <span class="kw">AS</span> max_price,
    <span class="fu">ROUND</span>(
        <span class="fu">PERCENTILE_CONT</span>(<span class="fl">0.25</span>) <span class="kw">WITHIN GROUP</span> (<span class="kw">ORDER BY</span> p.price),
        <span class="dv">2</span>
    ) <span class="kw">AS</span> q1,
    <span class="fu">ROUND</span>(
        <span class="fu">PERCENTILE_CONT</span>(<span class="fl">0.75</span>) <span class="kw">WITHIN GROUP</span> (<span class="kw">ORDER BY</span> p.price),
        <span class="dv">2</span>
    ) <span class="kw">AS</span> q3
<span class="kw">FROM</span> products p
<span class="kw">JOIN</span> categories c <span class="kw">ON</span> p.category_id = c.id
<span class="kw">GROUP BY</span> c.name
<span class="kw">ORDER BY</span> avg_price <span class="kw">DESC</span>;</code></pre>

                        <p><strong>Finding Outliers (Z-Score > 2):</strong></p>
                        <pre><code class="sourceCode sql"><span class="kw">WITH</span> category_stats <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        p.id <span class="kw">AS</span> product_id,
        p.name,
        p.price,
        c.name <span class="kw">AS</span> category_name,
        <span class="fu">AVG</span>(p.price) <span class="kw">OVER</span> (<span class="kw">PARTITION BY</span> c.id) <span class="kw">AS</span> avg_price,
        <span class="fu">STDDEV</span>(p.price) <span class="kw">OVER</span> (<span class="kw">PARTITION BY</span> c.id) <span class="kw">AS</span> stddev_price
    <span class="kw">FROM</span> products p
    <span class="kw">JOIN</span> categories c <span class="kw">ON</span> p.category_id = c.id
)
<span class="kw">SELECT</span>
    name,
    category_name,
    price,
    <span class="fu">ROUND</span>((price - avg_price) / <span class="fu">NULLIF</span>(stddev_price, <span class="dv">0</span>), <span class="dv">2</span>) <span class="kw">AS</span> z_score
<span class="kw">FROM</span> category_stats
<span class="kw">WHERE</span> <span class="fu">ABS</span>((price - avg_price) / <span class="fu">NULLIF</span>(stddev_price, <span class="dv">0</span>)) > <span class="dv">2</span>;</code></pre>
                    </div>

                    <div style="background-color: #f3e5f5; border: 1px solid #ce93d8; border-radius: 8px; padding: 15px; margin: 15px 0;">
                        <strong>üìä Visualization Suggestion:</strong><br>
                        <ul class="mb-0">
                            <li><strong>Chart Type:</strong> Box Plot (ideal for showing distribution and outliers)</li>
                            <li><strong>X Axis:</strong> Category (category_name)</li>
                            <li><strong>Y Axis:</strong> Price (price)</li>
                            <li><strong>Box Shows:</strong> Q1, Median, Q3; Whiskers show min/max within 1.5*IQR</li>
                            <li><strong>Outliers:</strong> Individual points beyond whiskers (|z_score| > 2)</li>
                            <li><strong>Alternative:</strong> Violin Plot for distribution shape, or Histogram per category</li>
                            <li><strong>Tools:</strong> Plotly, Seaborn, Chart.js with boxplot plugin</li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Part 3: CTEs for Complex Analytics -->
            <section>
                <h2>Part 3: CTEs for Complex Analytics</h2>
                <p>Build multi-step analytics queries with Common Table Expressions.</p>

                <div class="hint-box" style="background-color: #e7f3ff; border: 1px solid #b3d9ff;">
                    <strong>üí° Practice Tip:</strong> Think of CTEs as "temporary tables within a query." They start with the WITH keyword and allow you to break complex analytics into steps. Each CTE can use previous ones, letting you build complex calculations piece by piece.
                </div>

                <div class="exercise-box">
                    <h4>Exercise 3.1: Cohort Retention Analysis</h4>
                    <p>Build a cohort analysis showing customer retention by their first purchase month.</p>

                    <div class="info-box">
                        <strong>What is Cohort Analysis?</strong><br>
                        A cohort is a group of customers who share a common characteristic - in this case, the month of their first purchase.
                        Cohort retention analysis tracks how many customers from each group return to make purchases in later months.
                    </div>

                    <p><strong>Task:</strong> Calculate what percentage of customers from each cohort made purchases in
                        subsequent months.</p>

                    <div class="hint-box" style="background-color: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #ffc107;">
                        <strong>Step-by-Step Approach:</strong> This complex analysis is built from 4 CTEs. Let's understand each step before seeing the full solution.
                    </div>

                    <h5>Step 1: Identify Customer Cohorts</h5>
                    <p><strong>Question:</strong> How do we find each customer's "cohort month" (the month of their first purchase)?</p>
                    <button class="solution-toggle" onclick="toggleSolution('sol3_1_step1')">Show Answer</button>
                    <div id="sol3_1_step1" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="co">-- Find each customer's first purchase month (their cohort)</span>
<span class="kw">SELECT</span>
    customer_id,
    <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, <span class="fu">MIN</span>(order_date)) <span class="kw">AS</span> cohort_month
<span class="kw">FROM</span> orders
<span class="kw">GROUP BY</span> customer_id;</code></pre>
                        <p><strong>Explanation:</strong> <code>MIN(order_date)</code> finds the first order date, <code>DATE_TRUNC('month', ...)</code> rounds it to the first day of the month.</p>
                    </div>

                    <h5>Step 2: Calculate Months Since Cohort</h5>
                    <p><strong>Question:</strong> For each order, how do we calculate how many months have passed since the customer's cohort month?</p>
                    <button class="solution-toggle" onclick="toggleSolution('sol3_1_step2')">Show Answer</button>
                    <div id="sol3_1_step2" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="co">-- Calculate months between cohort and each activity</span>
(<span class="fu">EXTRACT</span>(<span class="kw">YEAR</span> <span class="kw">FROM</span> activity_month) - <span class="fu">EXTRACT</span>(<span class="kw">YEAR</span> <span class="kw">FROM</span> cohort_month)) * <span class="dv">12</span> +
(<span class="fu">EXTRACT</span>(<span class="kw">MONTH</span> <span class="kw">FROM</span> activity_month) - <span class="fu">EXTRACT</span>(<span class="kw">MONTH</span> <span class="kw">FROM</span> cohort_month)) <span class="kw">AS</span> months_since_cohort</code></pre>
                        <p><strong>Explanation:</strong> We extract years and months separately to calculate the total months difference. Month 0 = first purchase month, Month 1 = next month, etc.</p>
                    </div>

                    <h5>Step 3: Count Cohort Sizes</h5>
                    <p><strong>Question:</strong> How do we count how many customers are in each cohort?</p>
                    <button class="solution-toggle" onclick="toggleSolution('sol3_1_step3')">Show Answer</button>
                    <div id="sol3_1_step3" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="co">-- Count unique customers per cohort</span>
<span class="kw">SELECT</span>
    cohort_month,
    <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> customer_id) <span class="kw">AS</span> cohort_customers
<span class="kw">FROM</span> customer_cohort
<span class="kw">GROUP BY</span> cohort_month;</code></pre>
                        <p><strong>Explanation:</strong> This gives us the "100%" baseline for each cohort.</p>
                    </div>

                    <h5>Step 4: Calculate Retention Rate</h5>
                    <p><strong>Question:</strong> How do we calculate the percentage of customers who returned?</p>
                    <button class="solution-toggle" onclick="toggleSolution('sol3_1_step4')">Show Answer</button>
                    <div id="sol3_1_step4" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="co">-- Retention percentage formula</span>
<span class="fu">ROUND</span>(active_customers * <span class="fl">100.0</span> / cohort_customers, <span class="dv">1</span>) <span class="kw">AS</span> retention_pct</code></pre>
                        <p><strong>Explanation:</strong> Divide active customers by total cohort customers, multiply by 100 for percentage.</p>
                    </div>

                    <h5>Complete Solution</h5>
                    <button class="solution-toggle" onclick="toggleSolution('sol3_1')">Show Full Solution</button>
                    <div id="sol3_1" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="kw">WITH</span>
<span class="co">-- Step 1: Identify each customer's cohort (first purchase month)</span>
customer_cohort <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        customer_id,
        <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, <span class="fu">MIN</span>(order_date)) <span class="kw">AS</span> cohort_month
    <span class="kw">FROM</span> orders
    <span class="kw">GROUP BY</span> customer_id
),
<span class="co">-- Step 2: Calculate months since cohort for each order</span>
customer_activity <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        cc.customer_id,
        cc.cohort_month,
        <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, o.order_date) <span class="kw">AS</span> activity_month,
        (<span class="fu">EXTRACT</span>(<span class="kw">YEAR</span> <span class="kw">FROM</span> <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, o.order_date)) -
         <span class="fu">EXTRACT</span>(<span class="kw">YEAR</span> <span class="kw">FROM</span> cc.cohort_month)) * <span class="dv">12</span> +
        (<span class="fu">EXTRACT</span>(<span class="kw">MONTH</span> <span class="kw">FROM</span> <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, o.order_date)) -
         <span class="fu">EXTRACT</span>(<span class="kw">MONTH</span> <span class="kw">FROM</span> cc.cohort_month)) <span class="kw">AS</span> months_since_cohort
    <span class="kw">FROM</span> customer_cohort cc
    <span class="kw">JOIN</span> orders o <span class="kw">ON</span> cc.customer_id = o.customer_id
),
<span class="co">-- Step 3: Count cohort size</span>
cohort_size <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        cohort_month,
        <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> customer_id) <span class="kw">AS</span> cohort_customers
    <span class="kw">FROM</span> customer_cohort
    <span class="kw">GROUP BY</span> cohort_month
),
<span class="co">-- Step 4: Count active customers per cohort per period</span>
retention_data <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        cohort_month,
        months_since_cohort,
        <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> customer_id) <span class="kw">AS</span> active_customers
    <span class="kw">FROM</span> customer_activity
    <span class="kw">GROUP BY</span> cohort_month, months_since_cohort
)
<span class="co">-- Final: Calculate retention rate</span>
<span class="kw">SELECT</span>
    r.cohort_month,
    cs.cohort_customers,
    r.months_since_cohort,
    r.active_customers,
    <span class="fu">ROUND</span>(r.active_customers * <span class="fl">100.0</span> / cs.cohort_customers, <span class="dv">1</span>) <span class="kw">AS</span> retention_pct
<span class="kw">FROM</span> retention_data r
<span class="kw">JOIN</span> cohort_size cs <span class="kw">ON</span> r.cohort_month = cs.cohort_month
<span class="kw">WHERE</span> r.months_since_cohort <= <span class="dv">12</span>
<span class="kw">ORDER BY</span> r.cohort_month, r.months_since_cohort;</code></pre>

                        <div class="visual-demo">
                            <h6>Cohort Retention Heatmap Concept</h6>
                            <table class="table table-sm table-bordered" style="font-size: 0.8em;">
                                <thead>
                                    <tr>
                                        <th>Cohort</th>
                                        <th>M0</th>
                                        <th>M1</th>
                                        <th>M2</th>
                                        <th>M3</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Jan 2024</td>
                                        <td style="background: #198754; color: white;">100%</td>
                                        <td style="background: #28a745; color: white;">45%</td>
                                        <td style="background: #5cb85c; color: white;">32%</td>
                                        <td style="background: #8bc34a;">28%</td>
                                    </tr>
                                    <tr>
                                        <td>Feb 2024</td>
                                        <td style="background: #198754; color: white;">100%</td>
                                        <td style="background: #28a745; color: white;">52%</td>
                                        <td style="background: #5cb85c; color: white;">38%</td>
                                        <td>-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div style="background-color: #f3e5f5; border: 1px solid #ce93d8; border-radius: 8px; padding: 15px; margin: 15px 0;">
                            <strong>üìä Visualization Suggestion:</strong><br>
                            <ul class="mb-0">
                                <li><strong>Chart Type:</strong> Heatmap (as shown above)</li>
                                <li><strong>X Axis:</strong> Months since cohort (M0, M1, M2...)</li>
                                <li><strong>Y Axis:</strong> Cohort month (Jan 2024, Feb 2024...)</li>
                                <li><strong>Cell Value:</strong> Retention percentage (retention_pct)</li>
                                <li><strong>Color Scale:</strong> Green gradient (dark=high retention, light=low)</li>
                                <li><strong>Alternative:</strong> Line chart with one line per cohort showing retention decay</li>
                                <li><strong>Tools:</strong> Plotly Heatmap, D3.js, Tableau, Google Sheets conditional formatting</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Exercise 3.2: Customer Lifetime Value (CLV)</h4>
                    <p>Calculate customer lifetime value metrics and segment customers.</p>

                    <div class="info-box">
                        <strong>What is Customer Lifetime Value?</strong><br>
                        CLV estimates the total revenue a business can expect from a single customer over their entire relationship.
                        It helps identify which customers are most valuable and how to segment them.
                    </div>

                    <p><strong>Task:</strong> Compute total spent, frequency, recency, and project future value.</p>

                    <div class="hint-box" style="background-color: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #ffc107;">
                        <strong>Step-by-Step Approach:</strong> We'll build this in 3 parts: calculate basic metrics, add quartile rankings, then segment customers.
                    </div>

                    <h5>Step 1: Calculate Basic Customer Metrics</h5>
                    <p><strong>Question:</strong> What metrics do we need to calculate for each customer? (Hint: think about spending, frequency, and recency)</p>
                    <button class="solution-toggle" onclick="toggleSolution('sol3_2_step1')">Show Answer</button>
                    <div id="sol3_2_step1" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="kw">SELECT</span>
    customer_id,
    <span class="fu">COUNT</span>(*) <span class="kw">AS</span> total_orders,           <span class="co">-- Frequency: How often they buy</span>
    <span class="fu">SUM</span>(total_amount) <span class="kw">AS</span> total_spent,   <span class="co">-- Monetary: How much they spend</span>
    <span class="fu">AVG</span>(total_amount) <span class="kw">AS</span> avg_order_value,
    <span class="fu">MIN</span>(order_date) <span class="kw">AS</span> first_order,     <span class="co">-- When they started</span>
    <span class="fu">MAX</span>(order_date) <span class="kw">AS</span> last_order,      <span class="co">-- Most recent order</span>
    <span class="fu">CURRENT_DATE</span> - <span class="fu">MAX</span>(order_date) <span class="kw">AS</span> days_since_last  <span class="co">-- Recency</span>
<span class="kw">FROM</span> orders
<span class="kw">GROUP BY</span> customer_id;</code></pre>
                        <p><strong>Explanation:</strong> These are the RFM (Recency, Frequency, Monetary) metrics commonly used in customer analysis.</p>
                    </div>

                    <h5>Step 2: Understand NTILE for Quartile Ranking</h5>
                    <p><strong>Question:</strong> What does <code>NTILE(4)</code> do and why is it useful for segmentation?</p>
                    <button class="solution-toggle" onclick="toggleSolution('sol3_2_step2')">Show Answer</button>
                    <div id="sol3_2_step2" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="co">-- NTILE(4) divides customers into 4 equal groups (quartiles)</span>
<span class="fu">NTILE</span>(<span class="dv">4</span>) <span class="kw">OVER</span> (<span class="kw">ORDER BY</span> total_spent <span class="kw">DESC</span>) <span class="kw">AS</span> spending_quartile
<span class="co">-- Quartile 1 = Top 25% spenders</span>
<span class="co">-- Quartile 4 = Bottom 25% spenders</span></code></pre>
                        <p><strong>Explanation:</strong> NTILE divides rows into N equal groups. Quartile 1 = best performers, Quartile 4 = needs attention.</p>
                    </div>

                    <h5>Step 3: Create Customer Segments</h5>
                    <p><strong>Question:</strong> How do we combine quartile rankings to create meaningful customer segments like "Champions" or "At Risk"?</p>
                    <button class="solution-toggle" onclick="toggleSolution('sol3_2_step3')">Show Answer</button>
                    <div id="sol3_2_step3" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="co">-- Segment based on combinations of quartiles</span>
<span class="cf">CASE</span>
    <span class="cf">WHEN</span> spending_quartile = <span class="dv">1</span> <span class="kw">AND</span> frequency_quartile = <span class="dv">1</span> <span class="cf">THEN</span> <span class="st">'Champions'</span>
    <span class="cf">WHEN</span> spending_quartile <= <span class="dv">2</span> <span class="kw">AND</span> recency_quartile = <span class="dv">1</span> <span class="cf">THEN</span> <span class="st">'Loyal'</span>
    <span class="cf">WHEN</span> recency_quartile >= <span class="dv">3</span> <span class="kw">AND</span> spending_quartile <= <span class="dv">2</span> <span class="cf">THEN</span> <span class="st">'At Risk'</span>
    <span class="cf">WHEN</span> recency_quartile = <span class="dv">4</span> <span class="cf">THEN</span> <span class="st">'Lost'</span>
    <span class="cf">ELSE</span> <span class="st">'Regular'</span>
<span class="cf">END</span> <span class="kw">AS</span> segment</code></pre>
                        <p><strong>Explanation:</strong></p>
                        <ul>
                            <li><strong>Champions:</strong> High spenders who buy frequently</li>
                            <li><strong>Loyal:</strong> Good spenders who purchased recently</li>
                            <li><strong>At Risk:</strong> Used to spend well but haven't bought recently</li>
                            <li><strong>Lost:</strong> Haven't purchased in a long time</li>
                        </ul>
                    </div>

                    <h5>Complete Solution</h5>
                    <button class="solution-toggle" onclick="toggleSolution('sol3_2')">Show Full Solution</button>
                    <div id="sol3_2" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="kw">WITH</span>
customer_metrics <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        customer_id,
        <span class="fu">COUNT</span>(*) <span class="kw">AS</span> total_orders,
        <span class="fu">SUM</span>(total_amount) <span class="kw">AS</span> total_spent,
        <span class="fu">AVG</span>(total_amount) <span class="kw">AS</span> avg_order_value,
        <span class="fu">MIN</span>(order_date) <span class="kw">AS</span> first_order,
        <span class="fu">MAX</span>(order_date) <span class="kw">AS</span> last_order,
        <span class="fu">CURRENT_DATE</span> - <span class="fu">MAX</span>(order_date) <span class="kw">AS</span> days_since_last,
        <span class="fu">MAX</span>(order_date) - <span class="fu">MIN</span>(order_date) <span class="kw">AS</span> customer_lifespan_days
    <span class="kw">FROM</span> orders
    <span class="kw">GROUP BY</span> customer_id
),
customer_segments <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        *,
        <span class="fu">NTILE</span>(<span class="dv">4</span>) <span class="kw">OVER</span> (<span class="kw">ORDER BY</span> total_spent <span class="kw">DESC</span>) <span class="kw">AS</span> spending_quartile,
        <span class="fu">NTILE</span>(<span class="dv">4</span>) <span class="kw">OVER</span> (<span class="kw">ORDER BY</span> total_orders <span class="kw">DESC</span>) <span class="kw">AS</span> frequency_quartile,
        <span class="fu">NTILE</span>(<span class="dv">4</span>) <span class="kw">OVER</span> (<span class="kw">ORDER BY</span> days_since_last <span class="kw">ASC</span>) <span class="kw">AS</span> recency_quartile,
        <span class="co">-- Project CLV (simple model: avg * expected orders)</span>
        <span class="cf">CASE</span>
            <span class="cf">WHEN</span> customer_lifespan_days > <span class="dv">0</span> <span class="cf">THEN</span>
                (total_orders::float / <span class="fu">GREATEST</span>(customer_lifespan_days, <span class="dv">1</span>)) * <span class="dv">365</span>
            <span class="cf">ELSE</span> <span class="dv">1</span>
        <span class="cf">END</span> <span class="kw">AS</span> orders_per_year,
        avg_order_value * <span class="dv">3</span> * <span class="co">-- 3-year projection</span>
        <span class="cf">CASE</span>
            <span class="cf">WHEN</span> customer_lifespan_days > <span class="dv">0</span> <span class="cf">THEN</span>
                (total_orders::float / <span class="fu">GREATEST</span>(customer_lifespan_days, <span class="dv">1</span>)) * <span class="dv">365</span>
            <span class="cf">ELSE</span> <span class="dv">1</span>
        <span class="cf">END</span> <span class="kw">AS</span> projected_3yr_value
    <span class="kw">FROM</span> customer_metrics
)
<span class="kw">SELECT</span>
    <span class="cf">CASE</span>
        <span class="cf">WHEN</span> spending_quartile = <span class="dv">1</span> <span class="kw">AND</span> frequency_quartile = <span class="dv">1</span> <span class="cf">THEN</span> <span class="st">'Champions'</span>
        <span class="cf">WHEN</span> spending_quartile <= <span class="dv">2</span> <span class="kw">AND</span> recency_quartile = <span class="dv">1</span> <span class="cf">THEN</span> <span class="st">'Loyal'</span>
        <span class="cf">WHEN</span> recency_quartile >= <span class="dv">3</span> <span class="kw">AND</span> spending_quartile <= <span class="dv">2</span> <span class="cf">THEN</span> <span class="st">'At Risk'</span>
        <span class="cf">WHEN</span> recency_quartile = <span class="dv">4</span> <span class="cf">THEN</span> <span class="st">'Lost'</span>
        <span class="cf">ELSE</span> <span class="st">'Regular'</span>
    <span class="cf">END</span> <span class="kw">AS</span> segment,
    <span class="fu">COUNT</span>(*) <span class="kw">AS</span> customer_count,
    <span class="fu">ROUND</span>(<span class="fu">AVG</span>(total_spent), <span class="dv">2</span>) <span class="kw">AS</span> avg_total_spent,
    <span class="fu">ROUND</span>(<span class="fu">AVG</span>(total_orders), <span class="dv">1</span>) <span class="kw">AS</span> avg_orders,
    <span class="fu">ROUND</span>(<span class="fu">AVG</span>(projected_3yr_value), <span class="dv">2</span>) <span class="kw">AS</span> avg_projected_clv
<span class="kw">FROM</span> customer_segments
<span class="kw">GROUP BY</span> <span class="dv">1</span>
<span class="kw">ORDER BY</span> avg_total_spent <span class="kw">DESC</span>;</code></pre>

                        <div style="background-color: #f3e5f5; border: 1px solid #ce93d8; border-radius: 8px; padding: 15px; margin: 15px 0;">
                            <strong>üìä Visualization Suggestion:</strong><br>
                            <ul class="mb-0">
                                <li><strong>Chart Type:</strong> RFM Scatter Plot or Bubble Chart</li>
                                <li><strong>X Axis:</strong> Recency (days_since_last - inverted so recent is right)</li>
                                <li><strong>Y Axis:</strong> Frequency (total_orders)</li>
                                <li><strong>Bubble Size:</strong> Monetary (total_spent)</li>
                                <li><strong>Color:</strong> Segment (Champions=gold, Loyal=green, At Risk=orange, Lost=red)</li>
                                <li><strong>Alternative:</strong> Treemap showing segment sizes by customer count or revenue</li>
                                <li><strong>Dashboard:</strong> KPI cards showing segment counts + bar chart of avg CLV per segment</li>
                                <li><strong>Tools:</strong> Plotly, Tableau, Power BI, Metabase</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Exercise 3.3: Recursive CTE - Organization Hierarchy</h4>
                    <p>Build a complete organization tree showing reporting chains.</p>

                    <div class="info-box">
                        <strong>What is a Recursive CTE?</strong><br>
                        A recursive CTE calls itself to process hierarchical or tree-structured data.
                        It has two parts: a <strong>base case</strong> (starting point) and a <strong>recursive case</strong> (how to find the next level).
                    </div>

                    <p><strong>Task:</strong> Use recursive CTE to traverse the employee-manager relationship.</p>

                    <div class="hint-box" style="background-color: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #ffc107;">
                        <strong>Step-by-Step Approach:</strong> A recursive CTE always has a base case (anchor) and a recursive case that references itself. Let's build each part.
                    </div>

                    <h5>Step 1: Start with the Base Case (Root Nodes)</h5>
                    <p><strong>Question:</strong> Who are the "root" employees in an organization hierarchy? How do we identify them?</p>
                    <button class="solution-toggle" onclick="toggleSolution('sol3_3_step1')">Show Answer</button>
                    <div id="sol3_3_step1" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="co">-- Base case: employees with no manager (top of hierarchy)</span>
<span class="kw">SELECT</span>
    id,
    first_name || <span class="st">' '</span> || last_name <span class="kw">AS</span> full_name,
    manager_id,
    <span class="dv">1</span> <span class="kw">AS</span> level  <span class="co">-- They are at level 1 (the top)</span>
<span class="kw">FROM</span> employees
<span class="kw">WHERE</span> manager_id <span class="kw">IS NULL</span>;</code></pre>
                        <p><strong>Explanation:</strong> <code>WHERE manager_id IS NULL</code> finds employees without a manager - typically the CEO or top executives.</p>
                    </div>

                    <h5>Step 2: Build the Recursive Case</h5>
                    <p><strong>Question:</strong> How do we find employees who report to the managers we already found?</p>
                    <button class="solution-toggle" onclick="toggleSolution('sol3_3_step2')">Show Answer</button>
                    <div id="sol3_3_step2" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="co">-- Recursive case: find employees whose manager is in our current result</span>
<span class="kw">SELECT</span>
    e.id,
    e.first_name || <span class="st">' '</span> || e.last_name,
    e.manager_id,
    oh.level + <span class="dv">1</span>  <span class="co">-- One level deeper than their manager</span>
<span class="kw">FROM</span> employees e
<span class="kw">JOIN</span> org_hierarchy oh <span class="kw">ON</span> e.manager_id = oh.id;</code></pre>
                        <p><strong>Explanation:</strong> The recursive part joins employees to the current hierarchy (<code>org_hierarchy</code>) via their <code>manager_id</code>. Each iteration finds the next level down.</p>
                    </div>

                    <h5>Step 3: Understand How Recursion Works</h5>
                    <p><strong>Question:</strong> How does the database execute a recursive CTE?</p>
                    <button class="solution-toggle" onclick="toggleSolution('sol3_3_step3')">Show Answer</button>
                    <div id="sol3_3_step3" class="solution-content">
                        <p><strong>Execution Flow:</strong></p>
                        <ol>
                            <li><strong>Iteration 1:</strong> Run base case ‚Üí Find CEO (level 1)</li>
                            <li><strong>Iteration 2:</strong> Run recursive case ‚Üí Find people reporting to CEO (level 2)</li>
                            <li><strong>Iteration 3:</strong> Run recursive case again ‚Üí Find people reporting to level 2 (level 3)</li>
                            <li><strong>Continue</strong> until no more rows are returned</li>
                        </ol>
                        <p>Each iteration's output becomes the input for the next iteration's <code>org_hierarchy</code> reference.</p>
                    </div>

                    <h5>Complete Solution</h5>
                    <button class="solution-toggle" onclick="toggleSolution('sol3_3')">Show Full Solution</button>
                    <div id="sol3_3" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="kw">WITH RECURSIVE</span> org_hierarchy <span class="kw">AS</span> (
    <span class="co">-- Base case: top-level employees (no manager)</span>
    <span class="kw">SELECT</span>
        id,
        first_name || <span class="st">' '</span> || last_name <span class="kw">AS</span> full_name,
        manager_id,
        <span class="dv">1</span> <span class="kw">AS</span> level,
        first_name || <span class="st">' '</span> || last_name <span class="kw">AS</span> path,
        <span class="kw">ARRAY</span>[id] <span class="kw">AS</span> path_ids
    <span class="kw">FROM</span> employees
    <span class="kw">WHERE</span> manager_id <span class="kw">IS NULL</span>

    <span class="kw">UNION ALL</span>

    <span class="co">-- Recursive case: employees with managers</span>
    <span class="kw">SELECT</span>
        e.id,
        e.first_name || <span class="st">' '</span> || e.last_name,
        e.manager_id,
        oh.level + <span class="dv">1</span>,
        oh.path || <span class="st">' > '</span> || e.first_name || <span class="st">' '</span> || e.last_name,
        oh.path_ids || e.id
    <span class="kw">FROM</span> employees e
    <span class="kw">JOIN</span> org_hierarchy oh <span class="kw">ON</span> e.manager_id = oh.id
)
<span class="kw">SELECT</span>
    <span class="fu">REPEAT</span>(<span class="st">'  '</span>, level - <span class="dv">1</span>) || full_name <span class="kw">AS</span> employee_tree,
    level,
    path,
    <span class="fu">ARRAY_LENGTH</span>(path_ids, <span class="dv">1</span>) <span class="kw">AS</span> depth
<span class="kw">FROM</span> org_hierarchy
<span class="kw">ORDER BY</span> path;</code></pre>

                        <p><strong>Example Output:</strong></p>
                        <pre>
employee_tree         | level | path
----------------------+-------+---------------------------
Alice (CEO)           | 1     | Alice (CEO)
  Bob (VP Sales)      | 2     | Alice (CEO) > Bob (VP Sales)
    Carol (Manager)   | 3     | Alice (CEO) > Bob > Carol
    Dave (Manager)    | 3     | Alice (CEO) > Bob > Dave
  Eve (VP Engineering)| 2     | Alice (CEO) > Eve
    Frank (Dev)       | 3     | Alice (CEO) > Eve > Frank
                        </pre>

                        <div class="warning-box">
                            <strong>Recursive CTE Caution:</strong> Always ensure there's a termination condition.
                            Circular references will cause infinite loops. Use <code>CYCLE</code> detection in
                            PostgreSQL 14+.
                        </div>

                        <div style="background-color: #f3e5f5; border: 1px solid #ce93d8; border-radius: 8px; padding: 15px; margin: 15px 0;">
                            <strong>üìä Visualization Suggestion:</strong><br>
                            <ul class="mb-0">
                                <li><strong>Chart Type:</strong> Tree Diagram or Org Chart</li>
                                <li><strong>Root Node:</strong> CEO/Top manager (level 1)</li>
                                <li><strong>Hierarchy:</strong> Levels expand downward showing reporting structure</li>
                                <li><strong>Node Label:</strong> Employee name (full_name)</li>
                                <li><strong>Connections:</strong> Lines connecting managers to direct reports</li>
                                <li><strong>Alternative:</strong> Sunburst chart (radial tree) or Collapsible Tree for large orgs</li>
                                <li><strong>Tools:</strong> D3.js Tree Layout, Mermaid.js, OrgChart.js, Lucidchart</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Part 4: Data Visualization Prep -->
            <section>
                <h2>Part 4: Preparing Data for Visualization</h2>
                <p>Format query results for charts, graphs, and dashboards.</p>

                <div class="hint-box" style="background-color: #e7f3ff; border: 1px solid #b3d9ff;">
                    <strong>üí° Practice Tip:</strong> Visualization tools work best with pre-aggregated data rather than raw data. The <code>generate_series()</code> function is very useful for creating date or number sequences - it helps fill missing dates (days with no sales) in time series data.
                </div>

                <div class="exercise-box">
                    <h4>Exercise 4.1: Time Series for Line Charts</h4>
                    <p>Prepare daily sales data with filled gaps for continuous line charts.</p>

                    <p><strong>Task:</strong> Generate a series of all dates and join with actual sales (filling gaps
                        with 0).</p>

                    <button class="solution-toggle" onclick="toggleSolution('sol4_1')">Show Solution</button>
                    <div id="sol4_1" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="kw">WITH</span>
date_range <span class="kw">AS</span> (
    <span class="kw">SELECT</span> <span class="fu">generate_series</span>(
        (<span class="kw">SELECT</span> <span class="fu">MIN</span>(order_date) <span class="kw">FROM</span> orders),
        (<span class="kw">SELECT</span> <span class="fu">MAX</span>(order_date) <span class="kw">FROM</span> orders),
        <span class="st">'1 day'</span>::interval
    )::date <span class="kw">AS</span> date
),
daily_sales <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        order_date,
        <span class="fu">SUM</span>(total_amount) <span class="kw">AS</span> sales,
        <span class="fu">COUNT</span>(*) <span class="kw">AS</span> order_count
    <span class="kw">FROM</span> orders
    <span class="kw">GROUP BY</span> order_date
)
<span class="kw">SELECT</span>
    dr.date,
    <span class="fu">COALESCE</span>(ds.sales, <span class="dv">0</span>) <span class="kw">AS</span> sales,
    <span class="fu">COALESCE</span>(ds.order_count, <span class="dv">0</span>) <span class="kw">AS</span> order_count,
    <span class="co">-- 7-day moving average</span>
    <span class="fu">ROUND</span>(
        <span class="fu">AVG</span>(<span class="fu">COALESCE</span>(ds.sales, <span class="dv">0</span>)) <span class="kw">OVER</span> (
            <span class="kw">ORDER BY</span> dr.date
            <span class="kw">ROWS BETWEEN</span> <span class="dv">6</span> <span class="kw">PRECEDING AND CURRENT ROW</span>
        ),
        <span class="dv">2</span>
    ) <span class="kw">AS</span> moving_avg
<span class="kw">FROM</span> date_range dr
<span class="kw">LEFT JOIN</span> daily_sales ds <span class="kw">ON</span> dr.date = ds.order_date
<span class="kw">ORDER BY</span> dr.date;</code></pre>

                        <div class="visual-demo">
                            <h6>Line Chart Ready Data</h6>
                            <div class="bar-chart">
                                <div class="bar" style="height: 80px;">
                                    <span class="bar-value">$800</span>
                                    <span class="bar-label">Mon</span>
                                </div>
                                <div class="bar" style="height: 60px;">
                                    <span class="bar-value">$600</span>
                                    <span class="bar-label">Tue</span>
                                </div>
                                <div class="bar" style="height: 0px; background: #ddd;">
                                    <span class="bar-value">$0</span>
                                    <span class="bar-label">Wed</span>
                                </div>
                                <div class="bar" style="height: 100px;">
                                    <span class="bar-value">$1000</span>
                                    <span class="bar-label">Thu</span>
                                </div>
                                <div class="bar" style="height: 90px;">
                                    <span class="bar-value">$900</span>
                                    <span class="bar-label">Fri</span>
                                </div>
                            </div>
                            <p style="font-size: 0.8em; color: #666;">Gap filled with $0 for Wednesday</p>
                        </div>

                        <div style="background-color: #f3e5f5; border: 1px solid #ce93d8; border-radius: 8px; padding: 15px; margin: 15px 0;">
                            <strong>üìä Visualization Suggestion:</strong><br>
                            <ul class="mb-0">
                                <li><strong>Chart Type:</strong> Line Chart with dual axis</li>
                                <li><strong>X Axis:</strong> Date (continuous time series)</li>
                                <li><strong>Y Axis (Primary):</strong> Daily Sales (sales) as bars or area</li>
                                <li><strong>Y Axis (Secondary):</strong> 7-day Moving Average (moving_avg) as smooth line</li>
                                <li><strong>Color:</strong> Blue bars for daily sales, orange line for moving average</li>
                                <li><strong>Key Feature:</strong> Gaps filled with 0 ensures continuous X axis</li>
                                <li><strong>Tools:</strong> Chart.js, Plotly, Google Charts, Apache ECharts</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Exercise 4.2: Pivot Data for Heatmaps</h4>
                    <p>Create a heatmap-ready dataset showing sales by day of week and hour.</p>

                    <p><strong>Task:</strong> Aggregate by day/hour for visualization.</p>

                    <button class="solution-toggle" onclick="toggleSolution('sol4_2')">Show Solution</button>
                    <div id="sol4_2" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="co">-- Basic day-of-week analysis (no time component in order_date)</span>
<span class="kw">SELECT</span>
    <span class="fu">EXTRACT</span>(DOW <span class="kw">FROM</span> order_date) <span class="kw">AS</span> day_of_week,
    <span class="cf">CASE</span> <span class="fu">EXTRACT</span>(DOW <span class="kw">FROM</span> order_date)
        <span class="cf">WHEN</span> <span class="dv">0</span> <span class="cf">THEN</span> <span class="st">'Sunday'</span>
        <span class="cf">WHEN</span> <span class="dv">1</span> <span class="cf">THEN</span> <span class="st">'Monday'</span>
        <span class="cf">WHEN</span> <span class="dv">2</span> <span class="cf">THEN</span> <span class="st">'Tuesday'</span>
        <span class="cf">WHEN</span> <span class="dv">3</span> <span class="cf">THEN</span> <span class="st">'Wednesday'</span>
        <span class="cf">WHEN</span> <span class="dv">4</span> <span class="cf">THEN</span> <span class="st">'Thursday'</span>
        <span class="cf">WHEN</span> <span class="dv">5</span> <span class="cf">THEN</span> <span class="st">'Friday'</span>
        <span class="cf">WHEN</span> <span class="dv">6</span> <span class="cf">THEN</span> <span class="st">'Saturday'</span>
    <span class="cf">END</span> <span class="kw">AS</span> day_name,
    <span class="fu">COUNT</span>(*) <span class="kw">AS</span> order_count,
    <span class="fu">SUM</span>(total_amount) <span class="kw">AS</span> total_sales,
    <span class="fu">ROUND</span>(<span class="fu">AVG</span>(total_amount), <span class="dv">2</span>) <span class="kw">AS</span> avg_order_value
<span class="kw">FROM</span> orders
<span class="kw">GROUP BY</span>
    <span class="fu">EXTRACT</span>(DOW <span class="kw">FROM</span> order_date)
<span class="kw">ORDER BY</span> day_of_week;</code></pre>

                        <p><strong>Pivoted format for week-by-week comparison:</strong></p>
                        <pre><code class="sourceCode sql"><span class="kw">SELECT</span>
    <span class="fu">EXTRACT</span>(<span class="kw">WEEK</span> <span class="kw">FROM</span> order_date) <span class="kw">AS</span> week_num,
    <span class="fu">SUM</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> <span class="fu">EXTRACT</span>(DOW <span class="kw">FROM</span> order_date) = <span class="dv">0</span> <span class="cf">THEN</span> total_amount <span class="cf">ELSE</span> <span class="dv">0</span> <span class="cf">END</span>) <span class="kw">AS</span> sunday,
    <span class="fu">SUM</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> <span class="fu">EXTRACT</span>(DOW <span class="kw">FROM</span> order_date) = <span class="dv">1</span> <span class="cf">THEN</span> total_amount <span class="cf">ELSE</span> <span class="dv">0</span> <span class="cf">END</span>) <span class="kw">AS</span> monday,
    <span class="fu">SUM</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> <span class="fu">EXTRACT</span>(DOW <span class="kw">FROM</span> order_date) = <span class="dv">2</span> <span class="cf">THEN</span> total_amount <span class="cf">ELSE</span> <span class="dv">0</span> <span class="cf">END</span>) <span class="kw">AS</span> tuesday,
    <span class="co">-- ... etc for other days</span>
<span class="kw">FROM</span> orders
<span class="kw">GROUP BY</span> <span class="fu">EXTRACT</span>(<span class="kw">WEEK</span> <span class="kw">FROM</span> order_date)
<span class="kw">ORDER BY</span> week_num;</code></pre>

                        <div style="background-color: #f3e5f5; border: 1px solid #ce93d8; border-radius: 8px; padding: 15px; margin: 15px 0;">
                            <strong>üìä Visualization Suggestion:</strong><br>
                            <ul class="mb-0">
                                <li><strong>Chart Type:</strong> Heatmap (Calendar Heatmap)</li>
                                <li><strong>X Axis:</strong> Day of Week (Sunday to Saturday)</li>
                                <li><strong>Y Axis:</strong> Week Number (or Month)</li>
                                <li><strong>Cell Value:</strong> Total Sales or Order Count</li>
                                <li><strong>Color Scale:</strong> Sequential (light=low, dark=high sales)</li>
                                <li><strong>Alternative:</strong> Bar chart showing sales by day of week</li>
                                <li><strong>Tools:</strong> Plotly Heatmap, D3.js Calendar, Cal-Heatmap.js, Google Charts</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Exercise 4.3: Export as JSON for APIs/Dashboards</h4>
                    <p>Generate JSON-formatted data for web dashboards.</p>

                    <p><strong>Task:</strong> Use JSON aggregation functions to build structured output.</p>

                    <button class="solution-toggle" onclick="toggleSolution('sol4_3')">Show Solution</button>
                    <div id="sol4_3" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="co">-- Category sales with products nested</span>
<span class="kw">SELECT</span>
    <span class="fu">JSON_BUILD_OBJECT</span>(
        <span class="st">'report_date'</span>, <span class="fu">CURRENT_DATE</span>,
        <span class="st">'categories'</span>, (
            <span class="kw">SELECT</span> <span class="fu">JSON_AGG</span>(category_data)
            <span class="kw">FROM</span> (
                <span class="kw">SELECT</span>
                    <span class="fu">JSON_BUILD_OBJECT</span>(
                        <span class="st">'name'</span>, c.name,
                        <span class="st">'total_sales'</span>, <span class="fu">SUM</span>(ol.quantity * ol.unit_price),
                        <span class="st">'order_count'</span>, <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> o.id),
                        <span class="st">'top_products'</span>, (
                            <span class="kw">SELECT</span> <span class="fu">JSON_AGG</span>(prod)
                            <span class="kw">FROM</span> (
                                <span class="kw">SELECT</span>
                                    <span class="fu">JSON_BUILD_OBJECT</span>(
                                        <span class="st">'name'</span>, p2.name,
                                        <span class="st">'sales'</span>, <span class="fu">SUM</span>(ol2.quantity * ol2.unit_price)
                                    ) <span class="kw">AS</span> prod
                                <span class="kw">FROM</span> products p2
                                <span class="kw">JOIN</span> order_lines ol2 <span class="kw">ON</span> p2.id = ol2.product_id
                                <span class="kw">WHERE</span> p2.category_id = c.id
                                <span class="kw">GROUP BY</span> p2.id, p2.name
                                <span class="kw">ORDER BY</span> <span class="fu">SUM</span>(ol2.quantity * ol2.unit_price) <span class="kw">DESC</span>
                                <span class="kw">LIMIT</span> <span class="dv">3</span>
                            ) top_prods
                        )
                    ) <span class="kw">AS</span> category_data
                <span class="kw">FROM</span> categories c
                <span class="kw">JOIN</span> products p <span class="kw">ON</span> c.id = p.category_id
                <span class="kw">JOIN</span> order_lines ol <span class="kw">ON</span> p.id = ol.product_id
                <span class="kw">JOIN</span> orders o <span class="kw">ON</span> ol.order_id = o.id
                <span class="kw">GROUP BY</span> c.id, c.name
            ) cats
        )
    ) <span class="kw">AS</span> dashboard_data;</code></pre>

                        <p><strong>Output structure:</strong></p>
                        <pre>{
  "report_date": "2024-06-15",
  "categories": [
    {
      "name": "Electronics",
      "total_sales": 125000,
      "order_count": 450,
      "top_products": [
        {"name": "Laptop Pro", "sales": 45000},
        {"name": "Wireless Mouse", "sales": 12000}
      ]
    }
  ]
}</pre>

                        <div style="background-color: #f3e5f5; border: 1px solid #ce93d8; border-radius: 8px; padding: 15px; margin: 15px 0;">
                            <strong>üìä Visualization Suggestion:</strong><br>
                            <ul class="mb-0">
                                <li><strong>Chart Type:</strong> Interactive Dashboard with multiple components</li>
                                <li><strong>Main Chart:</strong> Treemap or Sunburst (categories ‚Üí products hierarchy)</li>
                                <li><strong>Size:</strong> Total sales per category/product</li>
                                <li><strong>Drill-down:</strong> Click category to see top products</li>
                                <li><strong>KPI Cards:</strong> Report date, total sales, category count</li>
                                <li><strong>API Usage:</strong> Feed JSON directly to frontend charting libraries</li>
                                <li><strong>Tools:</strong> React + Recharts, Vue + ECharts, D3.js, Highcharts</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Part 5: Challenge -->
            <section>
                <h2>Part 5: Challenge Exercise</h2>

                <div class="exercise-box">
                    <h4>Challenge: Executive Dashboard Query</h4>
                    <p>Build a comprehensive dashboard query that combines multiple analytics techniques.</p>

                    <p><strong>Requirements:</strong></p>
                    <ul>
                        <li>Current month vs previous month sales comparison</li>
                        <li>Top 5 products by revenue</li>
                        <li>Customer segment distribution</li>
                        <li>Daily sales trend with moving average</li>
                    </ul>

                    <div class="hint-box" style="background-color: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #ffc107;">
                        <strong>Learning Approach:</strong> This is a complex dashboard query. Let's break it into 4 independent parts - each is a separate CTE that could be its own query!
                    </div>

                    <h5>Step 1: Monthly Sales Comparison</h5>
                    <p><strong>Question:</strong> How do we compare this month's sales vs last month's sales in a single query?</p>
                    <button class="solution-toggle" onclick="toggleSolution('sol5_1_step1')">Show Answer</button>
                    <div id="sol5_1_step1" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="co">-- Use conditional aggregation with CASE</span>
<span class="kw">SELECT</span>
    <span class="fu">SUM</span>(<span class="cf">CASE</span>
        <span class="cf">WHEN</span> <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, order_date) = <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, <span class="fu">CURRENT_DATE</span>)
        <span class="cf">THEN</span> total_amount <span class="cf">ELSE</span> <span class="dv">0</span> <span class="cf">END</span>) <span class="kw">AS</span> current_month,
    <span class="fu">SUM</span>(<span class="cf">CASE</span>
        <span class="cf">WHEN</span> <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, order_date) = <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, <span class="fu">CURRENT_DATE</span> - <span class="kw">INTERVAL</span> <span class="st">'1 month'</span>)
        <span class="cf">THEN</span> total_amount <span class="cf">ELSE</span> <span class="dv">0</span> <span class="cf">END</span>) <span class="kw">AS</span> previous_month
<span class="kw">FROM</span> orders;</code></pre>
                        <p><strong>Explanation:</strong> Conditional SUM with CASE allows us to aggregate different conditions in a single pass through the data.</p>
                    </div>

                    <h5>Step 2: Top 5 Products by Revenue</h5>
                    <p><strong>Question:</strong> How do we find the top 5 products by revenue for the current month?</p>
                    <button class="solution-toggle" onclick="toggleSolution('sol5_1_step2')">Show Answer</button>
                    <div id="sol5_1_step2" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="kw">SELECT</span>
    p.name,
    <span class="fu">SUM</span>(ol.quantity * ol.unit_price) <span class="kw">AS</span> revenue,
    <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span> (<span class="kw">ORDER BY</span> <span class="fu">SUM</span>(ol.quantity * ol.unit_price) <span class="kw">DESC</span>) <span class="kw">AS</span> rank
<span class="kw">FROM</span> products p
<span class="kw">JOIN</span> order_lines ol <span class="kw">ON</span> p.id = ol.product_id
<span class="kw">JOIN</span> orders o <span class="kw">ON</span> ol.order_id = o.id
<span class="kw">WHERE</span> o.order_date >= <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, <span class="fu">CURRENT_DATE</span>)
<span class="kw">GROUP BY</span> p.id, p.name;</code></pre>
                        <p><strong>Explanation:</strong> ROW_NUMBER() ranks products by revenue. We can then filter for rank <= 5 in the final query.</p>
                    </div>

                    <h5>Step 3: Customer Segments</h5>
                    <p><strong>Question:</strong> How do we segment customers based on their order count?</p>
                    <button class="solution-toggle" onclick="toggleSolution('sol5_1_step3')">Show Answer</button>
                    <div id="sol5_1_step3" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="kw">SELECT</span>
    <span class="cf">CASE</span>
        <span class="cf">WHEN</span> total_orders >= <span class="dv">10</span> <span class="cf">THEN</span> <span class="st">'VIP'</span>
        <span class="cf">WHEN</span> total_orders >= <span class="dv">5</span> <span class="cf">THEN</span> <span class="st">'Regular'</span>
        <span class="cf">ELSE</span> <span class="st">'Occasional'</span>
    <span class="cf">END</span> <span class="kw">AS</span> segment,
    <span class="fu">COUNT</span>(*) <span class="kw">AS</span> count
<span class="kw">FROM</span> (
    <span class="kw">SELECT</span> customer_id, <span class="fu">COUNT</span>(*) <span class="kw">AS</span> total_orders
    <span class="kw">FROM</span> orders
    <span class="kw">GROUP BY</span> customer_id
) cust
<span class="kw">GROUP BY</span> <span class="dv">1</span>;</code></pre>
                        <p><strong>Explanation:</strong> The inner query counts orders per customer, the outer query categorizes them into segments.</p>
                    </div>

                    <h5>Step 4: Daily Trend with Moving Average</h5>
                    <p><strong>Question:</strong> How do we calculate daily sales with a 7-day moving average?</p>
                    <button class="solution-toggle" onclick="toggleSolution('sol5_1_step4')">Show Answer</button>
                    <div id="sol5_1_step4" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="kw">SELECT</span>
    order_date,
    <span class="fu">SUM</span>(total_amount) <span class="kw">AS</span> daily_sales,
    <span class="fu">ROUND</span>(<span class="fu">AVG</span>(<span class="fu">SUM</span>(total_amount)) <span class="kw">OVER</span> (
        <span class="kw">ORDER BY</span> order_date
        <span class="kw">ROWS</span> <span class="dv">6</span> <span class="kw">PRECEDING</span>
    ), <span class="dv">2</span>) <span class="kw">AS</span> ma_7d
<span class="kw">FROM</span> orders
<span class="kw">WHERE</span> order_date >= <span class="fu">CURRENT_DATE</span> - <span class="dv">30</span>
<span class="kw">GROUP BY</span> order_date;</code></pre>
                        <p><strong>Explanation:</strong> <code>ROWS 6 PRECEDING</code> creates a window of 7 rows (current + 6 before). AVG over this window gives the moving average.</p>
                    </div>

                    <h5>Step 5: Combining into JSON Output (Advanced)</h5>
                    <p><strong>Question:</strong> How do we combine all 4 metrics into a single JSON result for dashboards?</p>
                    <button class="solution-toggle" onclick="toggleSolution('sol5_1_step5')">Show Answer</button>
                    <div id="sol5_1_step5" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="co">-- JSON_BUILD_OBJECT creates a JSON object</span>
<span class="fu">JSON_BUILD_OBJECT</span>(
    <span class="st">'summary'</span>, (...),
    <span class="st">'top_products'</span>, (...),
    <span class="st">'segments'</span>, (...),
    <span class="st">'daily_trend'</span>, (...)
) <span class="kw">AS</span> dashboard;</code></pre>
                        <p><strong>Explanation:</strong> JSON functions package multiple result sets into a single JSON document - perfect for API responses!</p>
                    </div>

                    <h5>Complete Solution</h5>
                    <button class="solution-toggle" onclick="toggleSolution('sol5_1')">Show Full Solution</button>
                    <div id="sol5_1" class="solution-content">
                        <pre><code class="sourceCode sql"><span class="kw">WITH</span>
<span class="co">-- Monthly comparison</span>
monthly_comparison <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        <span class="fu">SUM</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, order_date) = <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, <span class="fu">CURRENT_DATE</span>)
            <span class="cf">THEN</span> total_amount <span class="cf">ELSE</span> <span class="dv">0</span> <span class="cf">END</span>) <span class="kw">AS</span> current_month,
        <span class="fu">SUM</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, order_date) = <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, <span class="fu">CURRENT_DATE</span> - <span class="kw">INTERVAL</span> <span class="st">'1 month'</span>)
            <span class="cf">THEN</span> total_amount <span class="cf">ELSE</span> <span class="dv">0</span> <span class="cf">END</span>) <span class="kw">AS</span> previous_month
    <span class="kw">FROM</span> orders
),
<span class="co">-- Top products</span>
top_products <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        p.name,
        <span class="fu">SUM</span>(ol.quantity * ol.unit_price) <span class="kw">AS</span> revenue,
        <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span> (<span class="kw">ORDER BY</span> <span class="fu">SUM</span>(ol.quantity * ol.unit_price) <span class="kw">DESC</span>) <span class="kw">AS</span> rank
    <span class="kw">FROM</span> products p
    <span class="kw">JOIN</span> order_lines ol <span class="kw">ON</span> p.id = ol.product_id
    <span class="kw">JOIN</span> orders o <span class="kw">ON</span> ol.order_id = o.id
    <span class="kw">WHERE</span> o.order_date >= <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, <span class="fu">CURRENT_DATE</span>)
    <span class="kw">GROUP BY</span> p.id, p.name
),
<span class="co">-- Customer segments</span>
customer_segments <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        <span class="cf">CASE</span>
            <span class="cf">WHEN</span> total_orders >= <span class="dv">10</span> <span class="cf">THEN</span> <span class="st">'VIP'</span>
            <span class="cf">WHEN</span> total_orders >= <span class="dv">5</span> <span class="cf">THEN</span> <span class="st">'Regular'</span>
            <span class="cf">ELSE</span> <span class="st">'Occasional'</span>
        <span class="cf">END</span> <span class="kw">AS</span> segment,
        <span class="fu">COUNT</span>(*) <span class="kw">AS</span> count
    <span class="kw">FROM</span> (
        <span class="kw">SELECT</span> customer_id, <span class="fu">COUNT</span>(*) <span class="kw">AS</span> total_orders
        <span class="kw">FROM</span> orders
        <span class="kw">GROUP BY</span> customer_id
    ) cust
    <span class="kw">GROUP BY</span> <span class="dv">1</span>
),
<span class="co">-- Daily trend</span>
daily_trend <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        order_date,
        <span class="fu">SUM</span>(total_amount) <span class="kw">AS</span> daily_sales,
        <span class="fu">ROUND</span>(<span class="fu">AVG</span>(<span class="fu">SUM</span>(total_amount)) <span class="kw">OVER</span> (<span class="kw">ORDER BY</span> order_date <span class="kw">ROWS</span> <span class="dv">6</span> <span class="kw">PRECEDING</span>), <span class="dv">2</span>) <span class="kw">AS</span> ma_7d
    <span class="kw">FROM</span> orders
    <span class="kw">WHERE</span> order_date >= <span class="fu">CURRENT_DATE</span> - <span class="dv">30</span>
    <span class="kw">GROUP BY</span> order_date
)
<span class="kw">SELECT</span>
    <span class="fu">JSON_BUILD_OBJECT</span>(
        <span class="st">'summary'</span>, (
            <span class="kw">SELECT</span> <span class="fu">JSON_BUILD_OBJECT</span>(
                <span class="st">'current_month_sales'</span>, current_month,
                <span class="st">'previous_month_sales'</span>, previous_month,
                <span class="st">'growth_pct'</span>, <span class="fu">ROUND</span>((current_month - previous_month) * <span class="fl">100.0</span> / <span class="fu">NULLIF</span>(previous_month, <span class="dv">0</span>), <span class="dv">2</span>)
            )
            <span class="kw">FROM</span> monthly_comparison
        ),
        <span class="st">'top_products'</span>, (<span class="kw">SELECT</span> <span class="fu">JSON_AGG</span>(<span class="fu">JSON_BUILD_OBJECT</span>(<span class="st">'name'</span>, name, <span class="st">'revenue'</span>, revenue)) <span class="kw">FROM</span> top_products <span class="kw">WHERE</span> rank <= <span class="dv">5</span>),
        <span class="st">'segments'</span>, (<span class="kw">SELECT</span> <span class="fu">JSON_AGG</span>(<span class="fu">JSON_BUILD_OBJECT</span>(<span class="st">'segment'</span>, segment, <span class="st">'count'</span>, count)) <span class="kw">FROM</span> customer_segments),
        <span class="st">'daily_trend'</span>, (<span class="kw">SELECT</span> <span class="fu">JSON_AGG</span>(<span class="fu">JSON_BUILD_OBJECT</span>(<span class="st">'date'</span>, order_date, <span class="st">'sales'</span>, daily_sales, <span class="st">'ma'</span>, ma_7d) <span class="kw">ORDER BY</span> order_date) <span class="kw">FROM</span> daily_trend)
    ) <span class="kw">AS</span> dashboard;</code></pre>

                        <div style="background-color: #f3e5f5; border: 1px solid #ce93d8; border-radius: 8px; padding: 15px; margin: 15px 0;">
                            <strong>üìä Visualization Suggestion:</strong><br>
                            <ul class="mb-0">
                                <li><strong>Dashboard Layout:</strong> Multi-panel executive dashboard</li>
                                <li><strong>Panel 1 (KPI Cards):</strong> Current vs Previous month with growth % indicator (green/red arrow)</li>
                                <li><strong>Panel 2 (Horizontal Bar):</strong> Top 5 products by revenue</li>
                                <li><strong>Panel 3 (Donut/Pie):</strong> Customer segment distribution (VIP, Regular, Occasional)</li>
                                <li><strong>Panel 4 (Line Chart):</strong> Daily sales trend with 7-day moving average overlay</li>
                                <li><strong>Interactivity:</strong> Date range filter, drill-down on products</li>
                                <li><strong>Tools:</strong> Grafana, Superset, Metabase, Tableau, Power BI, or custom React/D3.js dashboard</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Key Takeaways -->
            <section>
                <h3>Key Takeaways</h3>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Topic</th>
                            <th>Key Points</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Window Functions</strong></td>
                            <td>
                                <ul class="mb-0">
                                    <li>Use PARTITION BY to create groups without aggregating</li>
                                    <li>LAG/LEAD access adjacent rows for comparisons</li>
                                    <li>Frame clauses control which rows are included</li>
                                </ul>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Advanced Aggregations</strong></td>
                            <td>
                                <ul class="mb-0">
                                    <li>GROUPING SETS for multiple summary levels</li>
                                    <li>ROLLUP for hierarchical subtotals</li>
                                    <li>FILTER for conditional aggregation</li>
                                </ul>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>CTEs</strong></td>
                            <td>
                                <ul class="mb-0">
                                    <li>Chain CTEs for step-by-step analytics</li>
                                    <li>Recursive CTEs for hierarchical data</li>
                                    <li>Improve readability of complex queries</li>
                                </ul>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Visualization Prep</strong></td>
                            <td>
                                <ul class="mb-0">
                                    <li>Fill date gaps with generate_series</li>
                                    <li>Use JSON functions for API-ready output</li>
                                    <li>Pre-aggregate at the visualization level</li>
                                </ul>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <!-- Navigation -->
            <section>
                <div class="d-flex justify-content-between">
                    <a href="02_analytics_data_visualization.html" class="btn btn-outline-primary">&larr; Back to
                        Lesson</a>
                </div>
            </section>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script>
        function toggleSolution(id) {
            var element = document.getElementById(id);
            if (element.classList.contains('show')) {
                element.classList.remove('show');
                event.target.textContent = 'Show Solution';
            } else {
                element.classList.add('show');
                event.target.textContent = 'Hide Solution';
            }
        }
    </script>
</body>

</html>
