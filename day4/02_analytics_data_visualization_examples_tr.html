<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="tr" xml:lang="tr">

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="../style_bootstrap.html">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/code.css">
    <link href="https://cdn.prod.website-files.com/5efdb54f07a6812bcd95cc65/6773d0fc3013e060f08d7145_favicon.jpg"
        rel="shortcut icon" type="image/x-icon">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <title>Gun 4: Analitik ve Veri Gorsellestirme - Pratik Ornekler</title>
    <style>
        code {
            white-space: pre-wrap;
        }

        span.smallcaps {
            font-variant: small-caps;
        }

        span.underline {
            text-decoration: underline;
        }

        div.column {
            display: inline-block;
            vertical-align: top;
            width: 50%;
        }

        div.hanging-indent {
            margin-left: 1.5em;
            text-indent: -1.5em;
        }

        ul.task-list {
            list-style: none;
        }

        .exercise-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .exercise-box h4 {
            color: #495057;
            margin-bottom: 15px;
        }

        .solution {
            background-color: #e7f3ff;
            border: 1px solid #b6d4fe;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .solution.show {
            display: block;
        }

        .btn-solution {
            background-color: #0d6efd;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-solution:hover {
            background-color: #0b5ed7;
        }

        .hint-box {
            background-color: #fff3cd;
            border: 1px solid #ffecb5;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .hint-box strong {
            color: #664d03;
        }

        .warning-box {
            background-color: #f8d7da;
            border: 1px solid #f5c2c7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .warning-box strong {
            color: #842029;
        }

        .concept-box {
            background-color: #d1e7dd;
            border: 1px solid #badbcc;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .concept-box strong {
            color: #0f5132;
        }

        .dataset-table {
            font-size: 0.9em;
            margin: 15px 0;
        }

        .dataset-table th {
            background-color: #e9ecef;
        }

        .badge-window {
            background-color: #6f42c1;
            color: white;
        }

        .badge-aggregate {
            background-color: #198754;
            color: white;
        }

        .badge-cte {
            background-color: #0d6efd;
            color: white;
        }

        .result-table {
            font-size: 0.85em;
            margin: 15px 0;
        }

        .result-table th {
            background-color: #343a40;
            color: white;
        }

        .result-table td {
            font-family: 'Courier New', monospace;
        }

        .visual-demo {
            background-color: #f8f9fa;
            border: 2px dashed #6c757d;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }

        .visual-demo h6 {
            color: #6c757d;
            margin-bottom: 15px;
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 150px;
            padding: 10px;
        }

        .bar {
            width: 40px;
            background: linear-gradient(to top, #0d6efd, #6ea8fe);
            border-radius: 4px 4px 0 0;
            position: relative;
        }

        .bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7em;
            white-space: nowrap;
        }

        .bar-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7em;
            font-weight: bold;
        }

        .language-switcher {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .language-switcher a {
            text-decoration: none;
            padding: 5px 10px;
            margin: 0 2px;
            border-radius: 3px;
            color: #333;
        }
        .language-switcher a.active {
            background: #0d6efd;
            color: #fff;
        }
        .language-switcher a:hover:not(.active) {
            background: #e9ecef;
        }
    </style>
</head>

<body>
    <div class="language-switcher">
        <a href="02_analytics_data_visualization_examples.html">EN</a>
        <a href="02_analytics_data_visualization_examples_tr.html" class="active">TR</a>
    </div>

    <div class="copy-notification" id="copyNotification">Kopyalandi!</div>

    <div id="europeanunion-turkey">
        <img src="../static/eu.png" alt="">
    </div>
    <div id="sanayiteknolojibakan">
        <img src="../static/sanayitek.png" alt="">
    </div>
    <div id="rekabet">
        <img src="../static/rekabet.png" alt="">
    </div>
    <div id="tisk">
        <img src="../static/tisk.png" alt="">
    </div>
    <div id="undp">
        <img src="../static/undp.png" alt="">
    </div>
    <div class="content-container">
        <div class="container">
            <section>
                <h1>Analitik ve Veri Gorsellestirme - Pratik Ornekler</h1>
                <p class="lead">Uygulamali alistirmalar ile pencere fonksiyonlari, ileri toplamalar, CTE'ler ve gorsellestirme icin veri hazirlama konularinda uzmanlasin.</p>

                <div class="hint-box">
                    <strong>Ogrenme Hedefleri:</strong>
                    <ul class="mb-0">
                        <li>Siralama, kumulatif toplamlar ve karsilastirmalar icin pencere fonksiyonlarini uygulayin</li>
                        <li>Ileri toplamalari kullanin (GROUPING SETS, ROLLUP, CUBE)</li>
                        <li>CTE'ler ile karmasik analitik olusturun</li>
                        <li>Gorsellestirme araclari icin veri hazirlayin</li>
                    </ul>
                </div>
            </section>

            <!-- Ornek Veriseti -->
            <section>
                <h3>Ornek Veritabani Semasi</h3>
                <p>Bir e-ticaret analitik veritabani kullanacagiz:</p>

                <div class="row">
                    <div class="col-md-4">
                        <h5>orders</h5>
                        <table class="table table-bordered dataset-table">
                            <thead>
                                <tr>
                                    <th>Sutun</th>
                                    <th>Tip</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>order_id</td>
                                    <td><span class="badge bg-primary">SERIAL PK</span></td>
                                </tr>
                                <tr>
                                    <td>customer_id</td>
                                    <td><span class="badge bg-success">INTEGER FK</span></td>
                                </tr>
                                <tr>
                                    <td>order_date</td>
                                    <td><span class="badge bg-warning text-dark">DATE</span></td>
                                </tr>
                                <tr>
                                    <td>amount</td>
                                    <td><span class="badge bg-info">DECIMAL</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-4">
                        <h5>order_items</h5>
                        <table class="table table-bordered dataset-table">
                            <thead>
                                <tr>
                                    <th>Sutun</th>
                                    <th>Tip</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>item_id</td>
                                    <td><span class="badge bg-primary">SERIAL PK</span></td>
                                </tr>
                                <tr>
                                    <td>order_id</td>
                                    <td><span class="badge bg-success">INTEGER FK</span></td>
                                </tr>
                                <tr>
                                    <td>product_id</td>
                                    <td><span class="badge bg-success">INTEGER FK</span></td>
                                </tr>
                                <tr>
                                    <td>quantity</td>
                                    <td><span class="badge bg-info">INTEGER</span></td>
                                </tr>
                                <tr>
                                    <td>price</td>
                                    <td><span class="badge bg-info">DECIMAL</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-4">
                        <h5>products</h5>
                        <table class="table table-bordered dataset-table">
                            <thead>
                                <tr>
                                    <th>Sutun</th>
                                    <th>Tip</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>product_id</td>
                                    <td><span class="badge bg-primary">SERIAL PK</span></td>
                                </tr>
                                <tr>
                                    <td>name</td>
                                    <td><span class="badge bg-secondary">VARCHAR</span></td>
                                </tr>
                                <tr>
                                    <td>category_id</td>
                                    <td><span class="badge bg-success">INTEGER FK</span></td>
                                </tr>
                                <tr>
                                    <td>price</td>
                                    <td><span class="badge bg-info">DECIMAL</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <h5>categories</h5>
                        <table class="table table-bordered dataset-table">
                            <thead>
                                <tr>
                                    <th>Sutun</th>
                                    <th>Tip</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>category_id</td>
                                    <td><span class="badge bg-primary">SERIAL PK</span></td>
                                </tr>
                                <tr>
                                    <td>category_name</td>
                                    <td><span class="badge bg-secondary">VARCHAR</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-4">
                        <h5>customers</h5>
                        <table class="table table-bordered dataset-table">
                            <thead>
                                <tr>
                                    <th>Sutun</th>
                                    <th>Tip</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>customer_id</td>
                                    <td><span class="badge bg-primary">SERIAL PK</span></td>
                                </tr>
                                <tr>
                                    <td>name</td>
                                    <td><span class="badge bg-secondary">VARCHAR</span></td>
                                </tr>
                                <tr>
                                    <td>region_id</td>
                                    <td><span class="badge bg-success">INTEGER FK</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-4">
                        <h5>employees</h5>
                        <table class="table table-bordered dataset-table">
                            <thead>
                                <tr>
                                    <th>Sutun</th>
                                    <th>Tip</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>id</td>
                                    <td><span class="badge bg-primary">SERIAL PK</span></td>
                                </tr>
                                <tr>
                                    <td>name</td>
                                    <td><span class="badge bg-secondary">VARCHAR</span></td>
                                </tr>
                                <tr>
                                    <td>manager_id</td>
                                    <td><span class="badge bg-success">INTEGER FK</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Bolum 1: Pencere Fonksiyonlari -->
            <section>
                <h2>Bolum 1: Pencere Fonksiyonlari</h2>
                <p>Siralama, toplama ve satirlar arasi karsilastirma pratigi yapin.</p>

                <div class="exercise-box">
                    <h4>Alistirma 1.1: Siralama Fonksiyonlari Karsilastirmasi</h4>
                    <p>Aylik satis verileri verildiginde, ROW_NUMBER(), RANK() ve DENSE_RANK() arasindaki farki gosterin:</p>

                    <table class="table table-bordered result-table">
                        <thead>
                            <tr>
                                <th>month</th>
                                <th>sales</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>2024-01</td>
                                <td>50000</td>
                            </tr>
                            <tr>
                                <td>2024-02</td>
                                <td>45000</td>
                            </tr>
                            <tr>
                                <td>2024-03</td>
                                <td>45000</td>
                            </tr>
                            <tr>
                                <td>2024-04</td>
                                <td>42000</td>
                            </tr>
                            <tr>
                                <td>2024-05</td>
                                <td>55000</td>
                            </tr>
                        </tbody>
                    </table>

                    <p><strong>Gorev:</strong> Her uc siralama fonksiyonunu da sales DESC'e gore siralayan bir sorgu yazin.
                    </p>

                    <button class="btn-solution" onclick="toggleSolution('sol1_1')">Cozumu Goster</button>
                    <div id="sol1_1" class="solution">
                        <pre><code class="sourceCode sql"><span class="kw">WITH</span> monthly_sales <span class="kw">AS</span> (
    <span class="kw">SELECT</span> <span class="st">'2024-01'</span> <span class="kw">AS</span> month, <span class="dv">50000</span> <span class="kw">AS</span> sales <span class="kw">UNION ALL</span>
    <span class="kw">SELECT</span> <span class="st">'2024-02'</span>, <span class="dv">45000</span> <span class="kw">UNION ALL</span>
    <span class="kw">SELECT</span> <span class="st">'2024-03'</span>, <span class="dv">45000</span> <span class="kw">UNION ALL</span>
    <span class="kw">SELECT</span> <span class="st">'2024-04'</span>, <span class="dv">42000</span> <span class="kw">UNION ALL</span>
    <span class="kw">SELECT</span> <span class="st">'2024-05'</span>, <span class="dv">55000</span>
)
<span class="kw">SELECT</span>
    month,
    sales,
    <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span> (<span class="kw">ORDER BY</span> sales <span class="kw">DESC</span>) <span class="kw">AS</span> row_num,
    <span class="fu">RANK</span>() <span class="kw">OVER</span> (<span class="kw">ORDER BY</span> sales <span class="kw">DESC</span>) <span class="kw">AS</span> rank,
    <span class="fu">DENSE_RANK</span>() <span class="kw">OVER</span> (<span class="kw">ORDER BY</span> sales <span class="kw">DESC</span>) <span class="kw">AS</span> dense_rank
<span class="kw">FROM</span> monthly_sales;</code></pre>

                        <p><strong>Sonuc:</strong></p>
                        <table class="table table-bordered result-table">
                            <thead>
                                <tr>
                                    <th>month</th>
                                    <th>sales</th>
                                    <th>row_num</th>
                                    <th>rank</th>
                                    <th>dense_rank</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>2024-05</td>
                                    <td>55000</td>
                                    <td>1</td>
                                    <td>1</td>
                                    <td>1</td>
                                </tr>
                                <tr>
                                    <td>2024-01</td>
                                    <td>50000</td>
                                    <td>2</td>
                                    <td>2</td>
                                    <td>2</td>
                                </tr>
                                <tr>
                                    <td>2024-02</td>
                                    <td>45000</td>
                                    <td>3</td>
                                    <td>3</td>
                                    <td>3</td>
                                </tr>
                                <tr>
                                    <td>2024-03</td>
                                    <td>45000</td>
                                    <td>4</td>
                                    <td>3</td>
                                    <td>3</td>
                                </tr>
                                <tr>
                                    <td>2024-04</td>
                                    <td>42000</td>
                                    <td>5</td>
                                    <td>5</td>
                                    <td>4</td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="concept-box">
                            <strong>Temel Farklar:</strong>
                            <ul class="mb-0">
                                <li><strong>ROW_NUMBER()</strong>: Her zaman benzersiz (esitler icin 3, 4)</li>
                                <li><strong>RANK()</strong>: Esitler icin ayni siralama, sonrakini atlar (3, 3, 5)</li>
                                <li><strong>DENSE_RANK()</strong>: Esitler icin ayni siralama, atlama yok (3, 3, 4)</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 1.2: Grup Basina En Iyi N</h4>
                    <p>Her kategorideki en cok satan 3 urunu bulun.</p>

                    <p><strong>Gorev:</strong> ROW_NUMBER() ile PARTITION BY kullanarak urunleri her kategori icinde siralayin,
                        sonra en iyi 3'e filtreleyin.</p>

                    <button class="btn-solution" onclick="toggleSolution('sol1_2')">Cozumu Goster</button>
                    <div id="sol1_2" class="solution">
                        <pre><code class="sourceCode sql"><span class="kw">WITH</span> product_sales <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        p.product_id,
        p.name <span class="kw">AS</span> product_name,
        c.category_name,
        <span class="fu">SUM</span>(oi.quantity * oi.price) <span class="kw">AS</span> total_sales
    <span class="kw">FROM</span> products p
    <span class="kw">JOIN</span> categories c <span class="kw">ON</span> p.category_id = c.category_id
    <span class="kw">JOIN</span> order_items oi <span class="kw">ON</span> p.product_id = oi.product_id
    <span class="kw">GROUP BY</span> p.product_id, p.name, c.category_name
),
ranked_products <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        product_name,
        category_name,
        total_sales,
        <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span> (
            <span class="kw">PARTITION BY</span> category_name
            <span class="kw">ORDER BY</span> total_sales <span class="kw">DESC</span>
        ) <span class="kw">AS</span> rank_in_category
    <span class="kw">FROM</span> product_sales
)
<span class="kw">SELECT</span>
    category_name,
    rank_in_category,
    product_name,
    total_sales
<span class="kw">FROM</span> ranked_products
<span class="kw">WHERE</span> rank_in_category <= <span class="dv">3</span>
<span class="kw">ORDER BY</span> category_name, rank_in_category;</code></pre>

                        <div class="hint-box">
                            <strong>Kullanim Alani:</strong> Bu kalip asagidaki gibi "En Iyi N" raporlari icin onemlidir:
                            <ul class="mb-0">
                                <li>Bolge basina en iyi 5 musteri</li>
                                <li>Ay basina en iyi 10 urun</li>
                                <li>Ceyrek basina en iyi 3 satis temsilcisi</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 1.3: Trend Analizi icin LAG ve LEAD</h4>
                    <p>LAG() kullanarak aydan aya satis buyumesini hesaplayin.</p>

                    <p><strong>Gorev:</strong> Her ayin satislarini, onceki ayin satislarini ve yuzde degisimi gosterin.</p>

                    <button class="btn-solution" onclick="toggleSolution('sol1_3')">Cozumu Goster</button>
                    <div id="sol1_3" class="solution">
                        <pre><code class="sourceCode sql"><span class="kw">WITH</span> monthly_sales <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, order_date) <span class="kw">AS</span> month,
        <span class="fu">SUM</span>(amount) <span class="kw">AS</span> sales
    <span class="kw">FROM</span> orders
    <span class="kw">GROUP BY</span> <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, order_date)
)
<span class="kw">SELECT</span>
    month,
    sales,
    <span class="fu">LAG</span>(sales) <span class="kw">OVER</span> (<span class="kw">ORDER BY</span> month) <span class="kw">AS</span> prev_month_sales,
    sales - <span class="fu">LAG</span>(sales) <span class="kw">OVER</span> (<span class="kw">ORDER BY</span> month) <span class="kw">AS</span> absolute_change,
    <span class="fu">ROUND</span>(
        (sales - <span class="fu">LAG</span>(sales) <span class="kw">OVER</span> (<span class="kw">ORDER BY</span> month)) * <span class="fl">100.0</span> /
        <span class="fu">NULLIF</span>(<span class="fu">LAG</span>(sales) <span class="kw">OVER</span> (<span class="kw">ORDER BY</span> month), <span class="dv">0</span>),
        <span class="dv">2</span>
    ) <span class="kw">AS</span> pct_change
<span class="kw">FROM</span> monthly_sales
<span class="kw">ORDER BY</span> month;</code></pre>

                        <p><strong>Ornek Cikti:</strong></p>
                        <table class="table table-bordered result-table">
                            <thead>
                                <tr>
                                    <th>month</th>
                                    <th>sales</th>
                                    <th>prev_month</th>
                                    <th>change</th>
                                    <th>pct_change</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>2024-01-01</td>
                                    <td>50000</td>
                                    <td>NULL</td>
                                    <td>NULL</td>
                                    <td>NULL</td>
                                </tr>
                                <tr>
                                    <td>2024-02-01</td>
                                    <td>55000</td>
                                    <td>50000</td>
                                    <td>5000</td>
                                    <td>10.00</td>
                                </tr>
                                <tr>
                                    <td>2024-03-01</td>
                                    <td>48000</td>
                                    <td>55000</td>
                                    <td>-7000</td>
                                    <td>-12.73</td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="concept-box">
                            <strong>LAG ve LEAD Karsilastirmasi:</strong>
                            <ul class="mb-0">
                                <li><code>LAG(col, n)</code> - n satir ONCESINDEN deger alir (varsayilan n=1)</li>
                                <li><code>LEAD(col, n)</code> - n satir SONRASINDAN deger alir</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 1.4: Kumulatif Toplamlar ve Hareketli Ortalamalar</h4>
                    <p>Kumulatif satis ve 7 gunluk hareketli ortalama hesaplayin.</p>

                    <p><strong>Gorev:</strong> Kumulatif toplam ve hareketli ortalama hesaplamak icin pencere cerceve ifadelerini kullanin.</p>

                    <button class="btn-solution" onclick="toggleSolution('sol1_4')">Cozumu Goster</button>
                    <div id="sol1_4" class="solution">
                        <pre><code class="sourceCode sql"><span class="kw">SELECT</span>
    order_date,
    amount <span class="kw">AS</span> daily_sales,
    <span class="co">-- Kumulatif toplam: baslangictan mevcut satira kadar tum satirlar</span>
    <span class="fu">SUM</span>(amount) <span class="kw">OVER</span> (
        <span class="kw">ORDER BY</span> order_date
        <span class="kw">ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW</span>
    ) <span class="kw">AS</span> running_total,
    <span class="co">-- 7 gunluk hareketli ortalama: onceki 6 + mevcut</span>
    <span class="fu">ROUND</span>(
        <span class="fu">AVG</span>(amount) <span class="kw">OVER</span> (
            <span class="kw">ORDER BY</span> order_date
            <span class="kw">ROWS BETWEEN</span> <span class="dv">6</span> <span class="kw">PRECEDING AND CURRENT ROW</span>
        ),
        <span class="dv">2</span>
    ) <span class="kw">AS</span> moving_avg_7day,
    <span class="co">-- Hareketli penceredeki satir sayisi</span>
    <span class="fu">COUNT</span>(*) <span class="kw">OVER</span> (
        <span class="kw">ORDER BY</span> order_date
        <span class="kw">ROWS BETWEEN</span> <span class="dv">6</span> <span class="kw">PRECEDING AND CURRENT ROW</span>
    ) <span class="kw">AS</span> days_in_window
<span class="kw">FROM</span> (
    <span class="kw">SELECT</span> order_date, <span class="fu">SUM</span>(amount) <span class="kw">AS</span> amount
    <span class="kw">FROM</span> orders
    <span class="kw">GROUP BY</span> order_date
) daily_totals
<span class="kw">ORDER BY</span> order_date;</code></pre>

                        <div class="warning-box">
                            <strong>Cerceve Ifadesi Tuzagi:</strong>
                            <ul class="mb-0">
                                <li><code>ROWS</code> fiziksel satirlari sayar</li>
                                <li><code>RANGE</code> deger araliklerini dikkate alir (esitleri farkli sekilde ele alir)</li>
                                <li>ORDER BY olmadan, cerceve tum bolumeyi icerir</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Bolum 2: Ileri Toplamalar -->
            <section>
                <h2>Bolum 2: Ileri Toplamalar</h2>
                <p>GROUPING SETS, ROLLUP, CUBE ve kosullu toplamalarda uzmanlasin.</p>

                <div class="exercise-box">
                    <h4>Alistirma 2.1: Coklu Ozetler icin GROUPING SETS</h4>
                    <p>Asagidakilere gore satislari gosteren bir rapor olusturun:
                    <ul>
                        <li>Kategori + Ay</li>
                        <li>Sadece Kategori</li>
                        <li>Sadece Ay</li>
                        <li>Genel toplam</li>
                    </ul>
                    </p>

                    <p><strong>Gorev:</strong> Tum ozetleri tek bir sorguda uretmek icin GROUPING SETS kullanin.</p>

                    <button class="btn-solution" onclick="toggleSolution('sol2_1')">Cozumu Goster</button>
                    <div id="sol2_1" class="solution">
                        <pre><code class="sourceCode sql"><span class="kw">SELECT</span>
    <span class="fu">COALESCE</span>(c.category_name, <span class="st">'Tum Kategoriler'</span>) <span class="kw">AS</span> category,
    <span class="fu">COALESCE</span>(<span class="fu">TO_CHAR</span>(o.order_date, <span class="st">'YYYY-MM'</span>), <span class="st">'Tum Aylar'</span>) <span class="kw">AS</span> month,
    <span class="fu">SUM</span>(oi.quantity * oi.price) <span class="kw">AS</span> total_sales,
    <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> o.order_id) <span class="kw">AS</span> order_count,
    <span class="co">-- Gruplama seviyesini belirle</span>
    <span class="fu">GROUPING</span>(c.category_name) <span class="kw">AS</span> is_category_total,
    <span class="fu">GROUPING</span>(<span class="fu">TO_CHAR</span>(o.order_date, <span class="st">'YYYY-MM'</span>)) <span class="kw">AS</span> is_month_total
<span class="kw">FROM</span> orders o
<span class="kw">JOIN</span> order_items oi <span class="kw">ON</span> o.order_id = oi.order_id
<span class="kw">JOIN</span> products p <span class="kw">ON</span> oi.product_id = p.product_id
<span class="kw">JOIN</span> categories c <span class="kw">ON</span> p.category_id = c.category_id
<span class="kw">GROUP BY</span> <span class="fu">GROUPING</span> <span class="kw">SETS</span> (
    (c.category_name, <span class="fu">TO_CHAR</span>(o.order_date, <span class="st">'YYYY-MM'</span>)),  <span class="co">-- Detay</span>
    (c.category_name),                                      <span class="co">-- Kategori alt toplami</span>
    (<span class="fu">TO_CHAR</span>(o.order_date, <span class="st">'YYYY-MM'</span>)),                    <span class="co">-- Ay alt toplami</span>
    ()                                                      <span class="co">-- Genel toplam</span>
)
<span class="kw">ORDER BY</span>
    <span class="fu">GROUPING</span>(c.category_name),
    <span class="fu">GROUPING</span>(<span class="fu">TO_CHAR</span>(o.order_date, <span class="st">'YYYY-MM'</span>)),
    category,
    month;</code></pre>

                        <div class="concept-box">
                            <strong>GROUPING() Fonksiyonu:</strong> Sutun toplanmissa (gruplama nedeniyle NULL) 1, gercek bir degerse 0 dondurur. NULL degerlerini toplama NULL'larindan ayirt etmek icin kullanislidir.
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 2.2: Hiyerarsik Toplamlar icin ROLLUP</h4>
                    <p>Hiyerarsik bir satis raporu olusturun: Yil > Ceyrek > Ay her seviyede alt toplamlarla.</p>

                    <p><strong>Gorev:</strong> Alt toplamlari otomatik olusturmak icin ROLLUP kullanin.</p>

                    <button class="btn-solution" onclick="toggleSolution('sol2_2')">Cozumu Goster</button>
                    <div id="sol2_2" class="solution">
                        <pre><code class="sourceCode sql"><span class="kw">SELECT</span>
    <span class="fu">EXTRACT</span>(<span class="kw">YEAR</span> <span class="kw">FROM</span> order_date) <span class="kw">AS</span> year,
    <span class="fu">EXTRACT</span>(<span class="kw">QUARTER</span> <span class="kw">FROM</span> order_date) <span class="kw">AS</span> quarter,
    <span class="fu">EXTRACT</span>(<span class="kw">MONTH</span> <span class="kw">FROM</span> order_date) <span class="kw">AS</span> month,
    <span class="fu">SUM</span>(amount) <span class="kw">AS</span> total_sales,
    <span class="fu">COUNT</span>(*) <span class="kw">AS</span> order_count,
    <span class="cf">CASE</span>
        <span class="cf">WHEN</span> <span class="fu">GROUPING</span>(<span class="fu">EXTRACT</span>(<span class="kw">YEAR</span> <span class="kw">FROM</span> order_date)) = <span class="dv">1</span> <span class="cf">THEN</span> <span class="st">'Genel Toplam'</span>
        <span class="cf">WHEN</span> <span class="fu">GROUPING</span>(<span class="fu">EXTRACT</span>(<span class="kw">QUARTER</span> <span class="kw">FROM</span> order_date)) = <span class="dv">1</span> <span class="cf">THEN</span> <span class="st">'Yil Toplami'</span>
        <span class="cf">WHEN</span> <span class="fu">GROUPING</span>(<span class="fu">EXTRACT</span>(<span class="kw">MONTH</span> <span class="kw">FROM</span> order_date)) = <span class="dv">1</span> <span class="cf">THEN</span> <span class="st">'Ceyrek Toplami'</span>
        <span class="cf">ELSE</span> <span class="st">'Ay Detayi'</span>
    <span class="cf">END</span> <span class="kw">AS</span> level_type
<span class="kw">FROM</span> orders
<span class="kw">GROUP BY</span> <span class="kw">ROLLUP</span> (
    <span class="fu">EXTRACT</span>(<span class="kw">YEAR</span> <span class="kw">FROM</span> order_date),
    <span class="fu">EXTRACT</span>(<span class="kw">QUARTER</span> <span class="kw">FROM</span> order_date),
    <span class="fu">EXTRACT</span>(<span class="kw">MONTH</span> <span class="kw">FROM</span> order_date)
)
<span class="kw">ORDER BY</span> year <span class="kw">NULLS LAST</span>, quarter <span class="kw">NULLS LAST</span>, month <span class="kw">NULLS LAST</span>;</code></pre>

                        <p><strong>ROLLUP su satirlari uretir:</strong></p>
                        <ul>
                            <li>(year, quarter, month) - Detay satirlari</li>
                            <li>(year, quarter) - Ceyrek alt toplamlari</li>
                            <li>(year) - Yillik alt toplamlar</li>
                            <li>() - Genel toplam</li>
                        </ul>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 2.3: FILTER ile Kosullu Toplama</h4>
                    <p>Her ay icin toplam siparisler, tamamlanan siparisler ve iptal edilen siparisleri gosteren bir rapor olusturun.</p>

                    <p><strong>Gorev:</strong> Kosullu sayim icin FILTER ifadesini kullanin.</p>

                    <button class="btn-solution" onclick="toggleSolution('sol2_3')">Cozumu Goster</button>
                    <div id="sol2_3" class="solution">
                        <pre><code class="sourceCode sql"><span class="kw">SELECT</span>
    <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, order_date) <span class="kw">AS</span> month,
    <span class="fu">COUNT</span>(*) <span class="kw">AS</span> total_orders,
    <span class="fu">COUNT</span>(*) <span class="kw">FILTER</span> (<span class="kw">WHERE</span> status = <span class="st">'completed'</span>) <span class="kw">AS</span> completed,
    <span class="fu">COUNT</span>(*) <span class="kw">FILTER</span> (<span class="kw">WHERE</span> status = <span class="st">'cancelled'</span>) <span class="kw">AS</span> cancelled,
    <span class="fu">COUNT</span>(*) <span class="kw">FILTER</span> (<span class="kw">WHERE</span> status = <span class="st">'pending'</span>) <span class="kw">AS</span> pending,
    <span class="fu">ROUND</span>(
        <span class="fu">COUNT</span>(*) <span class="kw">FILTER</span> (<span class="kw">WHERE</span> status = <span class="st">'completed'</span>) * <span class="fl">100.0</span> / <span class="fu">COUNT</span>(*),
        <span class="dv">2</span>
    ) <span class="kw">AS</span> completion_rate,
    <span class="fu">SUM</span>(amount) <span class="kw">FILTER</span> (<span class="kw">WHERE</span> status = <span class="st">'completed'</span>) <span class="kw">AS</span> completed_revenue
<span class="kw">FROM</span> orders
<span class="kw">GROUP BY</span> <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, order_date)
<span class="kw">ORDER BY</span> month;</code></pre>

                        <div class="hint-box">
                            <strong>Alternatif (FILTER olmadan):</strong>
                            <pre><code class="sourceCode sql"><span class="fu">SUM</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> status = <span class="st">'completed'</span> <span class="cf">THEN</span> <span class="dv">1</span> <span class="cf">ELSE</span> <span class="dv">0</span> <span class="cf">END</span>) <span class="kw">AS</span> completed</code></pre>
                            FILTER daha temizdir ve PostgreSQL'e ozgudur.
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 2.4: Istatistiksel Toplamalar</h4>
                    <p>Her kategori icinde urun fiyatlari icin istatistiksel metrikler hesaplayin.</p>

                    <p><strong>Gorev:</strong> Ortalama, medyan, standart sapma hesaplayin ve aykiri degerleri belirleyin.</p>

                    <button class="btn-solution" onclick="toggleSolution('sol2_4')">Cozumu Goster</button>
                    <div id="sol2_4" class="solution">
                        <pre><code class="sourceCode sql"><span class="kw">SELECT</span>
    c.category_name,
    <span class="fu">COUNT</span>(*) <span class="kw">AS</span> product_count,
    <span class="fu">ROUND</span>(<span class="fu">AVG</span>(p.price), <span class="dv">2</span>) <span class="kw">AS</span> avg_price,
    <span class="fu">ROUND</span>(
        <span class="fu">PERCENTILE_CONT</span>(<span class="fl">0.5</span>) <span class="kw">WITHIN GROUP</span> (<span class="kw">ORDER BY</span> p.price),
        <span class="dv">2</span>
    ) <span class="kw">AS</span> median_price,
    <span class="fu">ROUND</span>(<span class="fu">STDDEV</span>(p.price), <span class="dv">2</span>) <span class="kw">AS</span> stddev_price,
    <span class="fu">MIN</span>(p.price) <span class="kw">AS</span> min_price,
    <span class="fu">MAX</span>(p.price) <span class="kw">AS</span> max_price,
    <span class="fu">ROUND</span>(
        <span class="fu">PERCENTILE_CONT</span>(<span class="fl">0.25</span>) <span class="kw">WITHIN GROUP</span> (<span class="kw">ORDER BY</span> p.price),
        <span class="dv">2</span>
    ) <span class="kw">AS</span> q1,
    <span class="fu">ROUND</span>(
        <span class="fu">PERCENTILE_CONT</span>(<span class="fl">0.75</span>) <span class="kw">WITHIN GROUP</span> (<span class="kw">ORDER BY</span> p.price),
        <span class="dv">2</span>
    ) <span class="kw">AS</span> q3
<span class="kw">FROM</span> products p
<span class="kw">JOIN</span> categories c <span class="kw">ON</span> p.category_id = c.category_id
<span class="kw">GROUP BY</span> c.category_name
<span class="kw">ORDER BY</span> avg_price <span class="kw">DESC</span>;</code></pre>

                        <p><strong>Aykiri Degerleri Bulma (Z-Skoru > 2):</strong></p>
                        <pre><code class="sourceCode sql"><span class="kw">WITH</span> category_stats <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        p.product_id,
        p.name,
        p.price,
        c.category_name,
        <span class="fu">AVG</span>(p.price) <span class="kw">OVER</span> (<span class="kw">PARTITION BY</span> c.category_id) <span class="kw">AS</span> avg_price,
        <span class="fu">STDDEV</span>(p.price) <span class="kw">OVER</span> (<span class="kw">PARTITION BY</span> c.category_id) <span class="kw">AS</span> stddev_price
    <span class="kw">FROM</span> products p
    <span class="kw">JOIN</span> categories c <span class="kw">ON</span> p.category_id = c.category_id
)
<span class="kw">SELECT</span>
    name,
    category_name,
    price,
    <span class="fu">ROUND</span>((price - avg_price) / <span class="fu">NULLIF</span>(stddev_price, <span class="dv">0</span>), <span class="dv">2</span>) <span class="kw">AS</span> z_score
<span class="kw">FROM</span> category_stats
<span class="kw">WHERE</span> <span class="fu">ABS</span>((price - avg_price) / <span class="fu">NULLIF</span>(stddev_price, <span class="dv">0</span>)) > <span class="dv">2</span>;</code></pre>
                    </div>
                </div>
            </section>

            <!-- Bolum 3: Karmasik Analitik icin CTE'ler -->
            <section>
                <h2>Bolum 3: Karmasik Analitik icin CTE'ler</h2>
                <p>Common Table Expression'lar ile cok adimli analitik sorgular olusturun.</p>

                <div class="exercise-box">
                    <h4>Alistirma 3.1: Kohort Tutma Analizi</h4>
                    <p>Ilk satin alma aylarina gore musteri tutma oranini gosteren bir kohort analizi olusturun.</p>

                    <p><strong>Gorev:</strong> Her kohorttan musterilerin yuzde kacinin sonraki aylarda alisveris yaptigini hesaplayin.</p>

                    <button class="btn-solution" onclick="toggleSolution('sol3_1')">Cozumu Goster</button>
                    <div id="sol3_1" class="solution">
                        <pre><code class="sourceCode sql"><span class="kw">WITH</span>
<span class="co">-- Adim 1: Her musterinin kohortunu belirle (ilk satin alma ayi)</span>
customer_cohort <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        customer_id,
        <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, <span class="fu">MIN</span>(order_date)) <span class="kw">AS</span> cohort_month
    <span class="kw">FROM</span> orders
    <span class="kw">GROUP BY</span> customer_id
),
<span class="co">-- Adim 2: Her siparis icin kohorttan bu yana gecen aylari hesapla</span>
customer_activity <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        cc.customer_id,
        cc.cohort_month,
        <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, o.order_date) <span class="kw">AS</span> activity_month,
        (<span class="fu">EXTRACT</span>(<span class="kw">YEAR</span> <span class="kw">FROM</span> <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, o.order_date)) -
         <span class="fu">EXTRACT</span>(<span class="kw">YEAR</span> <span class="kw">FROM</span> cc.cohort_month)) * <span class="dv">12</span> +
        (<span class="fu">EXTRACT</span>(<span class="kw">MONTH</span> <span class="kw">FROM</span> <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, o.order_date)) -
         <span class="fu">EXTRACT</span>(<span class="kw">MONTH</span> <span class="kw">FROM</span> cc.cohort_month)) <span class="kw">AS</span> months_since_cohort
    <span class="kw">FROM</span> customer_cohort cc
    <span class="kw">JOIN</span> orders o <span class="kw">ON</span> cc.customer_id = o.customer_id
),
<span class="co">-- Adim 3: Kohort buyuklugunu say</span>
cohort_size <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        cohort_month,
        <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> customer_id) <span class="kw">AS</span> cohort_customers
    <span class="kw">FROM</span> customer_cohort
    <span class="kw">GROUP BY</span> cohort_month
),
<span class="co">-- Adim 4: Her kohort ve donem icin aktif musterileri say</span>
retention_data <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        cohort_month,
        months_since_cohort,
        <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> customer_id) <span class="kw">AS</span> active_customers
    <span class="kw">FROM</span> customer_activity
    <span class="kw">GROUP BY</span> cohort_month, months_since_cohort
)
<span class="co">-- Son: Tutma oranini hesapla</span>
<span class="kw">SELECT</span>
    r.cohort_month,
    cs.cohort_customers,
    r.months_since_cohort,
    r.active_customers,
    <span class="fu">ROUND</span>(r.active_customers * <span class="fl">100.0</span> / cs.cohort_customers, <span class="dv">1</span>) <span class="kw">AS</span> retention_pct
<span class="kw">FROM</span> retention_data r
<span class="kw">JOIN</span> cohort_size cs <span class="kw">ON</span> r.cohort_month = cs.cohort_month
<span class="kw">WHERE</span> r.months_since_cohort <= <span class="dv">12</span>
<span class="kw">ORDER BY</span> r.cohort_month, r.months_since_cohort;</code></pre>

                        <div class="visual-demo">
                            <h6>Kohort Tutma Isi Haritasi Kavrami</h6>
                            <table class="table table-sm table-bordered" style="font-size: 0.8em;">
                                <thead>
                                    <tr>
                                        <th>Kohort</th>
                                        <th>A0</th>
                                        <th>A1</th>
                                        <th>A2</th>
                                        <th>A3</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Ocak 2024</td>
                                        <td style="background: #198754; color: white;">100%</td>
                                        <td style="background: #28a745; color: white;">45%</td>
                                        <td style="background: #5cb85c; color: white;">32%</td>
                                        <td style="background: #8bc34a;">28%</td>
                                    </tr>
                                    <tr>
                                        <td>Subat 2024</td>
                                        <td style="background: #198754; color: white;">100%</td>
                                        <td style="background: #28a745; color: white;">52%</td>
                                        <td style="background: #5cb85c; color: white;">38%</td>
                                        <td>-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 3.2: Musteri Yasam Boyu Degeri (CLV)</h4>
                    <p>Musteri yasam boyu degeri metriklerini hesaplayin ve musterileri segmentleyin.</p>

                    <p><strong>Gorev:</strong> Toplam harcama, siklik, yakinlik hesaplayin ve gelecek degeri tahmin edin.</p>

                    <button class="btn-solution" onclick="toggleSolution('sol3_2')">Cozumu Goster</button>
                    <div id="sol3_2" class="solution">
                        <pre><code class="sourceCode sql"><span class="kw">WITH</span>
customer_metrics <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        customer_id,
        <span class="fu">COUNT</span>(*) <span class="kw">AS</span> total_orders,
        <span class="fu">SUM</span>(amount) <span class="kw">AS</span> total_spent,
        <span class="fu">AVG</span>(amount) <span class="kw">AS</span> avg_order_value,
        <span class="fu">MIN</span>(order_date) <span class="kw">AS</span> first_order,
        <span class="fu">MAX</span>(order_date) <span class="kw">AS</span> last_order,
        <span class="fu">CURRENT_DATE</span> - <span class="fu">MAX</span>(order_date) <span class="kw">AS</span> days_since_last,
        <span class="fu">MAX</span>(order_date) - <span class="fu">MIN</span>(order_date) <span class="kw">AS</span> customer_lifespan_days
    <span class="kw">FROM</span> orders
    <span class="kw">GROUP BY</span> customer_id
),
customer_segments <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        *,
        <span class="fu">NTILE</span>(<span class="dv">4</span>) <span class="kw">OVER</span> (<span class="kw">ORDER BY</span> total_spent <span class="kw">DESC</span>) <span class="kw">AS</span> spending_quartile,
        <span class="fu">NTILE</span>(<span class="dv">4</span>) <span class="kw">OVER</span> (<span class="kw">ORDER BY</span> total_orders <span class="kw">DESC</span>) <span class="kw">AS</span> frequency_quartile,
        <span class="fu">NTILE</span>(<span class="dv">4</span>) <span class="kw">OVER</span> (<span class="kw">ORDER BY</span> days_since_last <span class="kw">ASC</span>) <span class="kw">AS</span> recency_quartile,
        <span class="co">-- CLV projeksiyonu (basit model: ortalama * beklenen siparis)</span>
        <span class="cf">CASE</span>
            <span class="cf">WHEN</span> customer_lifespan_days > <span class="dv">0</span> <span class="cf">THEN</span>
                (total_orders::float / <span class="fu">GREATEST</span>(customer_lifespan_days, <span class="dv">1</span>)) * <span class="dv">365</span>
            <span class="cf">ELSE</span> <span class="dv">1</span>
        <span class="cf">END</span> <span class="kw">AS</span> orders_per_year,
        avg_order_value * <span class="dv">3</span> * <span class="co">-- 3 yillik projeksiyon</span>
        <span class="cf">CASE</span>
            <span class="cf">WHEN</span> customer_lifespan_days > <span class="dv">0</span> <span class="cf">THEN</span>
                (total_orders::float / <span class="fu">GREATEST</span>(customer_lifespan_days, <span class="dv">1</span>)) * <span class="dv">365</span>
            <span class="cf">ELSE</span> <span class="dv">1</span>
        <span class="cf">END</span> <span class="kw">AS</span> projected_3yr_value
    <span class="kw">FROM</span> customer_metrics
)
<span class="kw">SELECT</span>
    <span class="cf">CASE</span>
        <span class="cf">WHEN</span> spending_quartile = <span class="dv">1</span> <span class="kw">AND</span> frequency_quartile = <span class="dv">1</span> <span class="cf">THEN</span> <span class="st">'Sampiyonlar'</span>
        <span class="cf">WHEN</span> spending_quartile <= <span class="dv">2</span> <span class="kw">AND</span> recency_quartile = <span class="dv">1</span> <span class="cf">THEN</span> <span class="st">'Sadik'</span>
        <span class="cf">WHEN</span> recency_quartile >= <span class="dv">3</span> <span class="kw">AND</span> spending_quartile <= <span class="dv">2</span> <span class="cf">THEN</span> <span class="st">'Risk Altinda'</span>
        <span class="cf">WHEN</span> recency_quartile = <span class="dv">4</span> <span class="cf">THEN</span> <span class="st">'Kaybedilmis'</span>
        <span class="cf">ELSE</span> <span class="st">'Normal'</span>
    <span class="cf">END</span> <span class="kw">AS</span> segment,
    <span class="fu">COUNT</span>(*) <span class="kw">AS</span> customer_count,
    <span class="fu">ROUND</span>(<span class="fu">AVG</span>(total_spent), <span class="dv">2</span>) <span class="kw">AS</span> avg_total_spent,
    <span class="fu">ROUND</span>(<span class="fu">AVG</span>(total_orders), <span class="dv">1</span>) <span class="kw">AS</span> avg_orders,
    <span class="fu">ROUND</span>(<span class="fu">AVG</span>(projected_3yr_value), <span class="dv">2</span>) <span class="kw">AS</span> avg_projected_clv
<span class="kw">FROM</span> customer_segments
<span class="kw">GROUP BY</span> <span class="dv">1</span>
<span class="kw">ORDER BY</span> avg_total_spent <span class="kw">DESC</span>;</code></pre>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 3.3: Recursive CTE - Organizasyon Hiyerarsisi</h4>
                    <p>Raporlama zincirlerini gosteren eksiksiz bir organizasyon agaci olusturun.</p>

                    <p><strong>Gorev:</strong> Calisan-yonetici iliskisini dolasmak icin recursive CTE kullanin.</p>

                    <button class="btn-solution" onclick="toggleSolution('sol3_3')">Cozumu Goster</button>
                    <div id="sol3_3" class="solution">
                        <pre><code class="sourceCode sql"><span class="kw">WITH RECURSIVE</span> org_hierarchy <span class="kw">AS</span> (
    <span class="co">-- Temel durum: ust duzey calisanlar (yoneticisi yok)</span>
    <span class="kw">SELECT</span>
        id,
        name,
        manager_id,
        <span class="dv">1</span> <span class="kw">AS</span> level,
        name <span class="kw">AS</span> path,
        <span class="kw">ARRAY</span>[id] <span class="kw">AS</span> path_ids
    <span class="kw">FROM</span> employees
    <span class="kw">WHERE</span> manager_id <span class="kw">IS NULL</span>

    <span class="kw">UNION ALL</span>

    <span class="co">-- Recursive durum: yoneticisi olan calisanlar</span>
    <span class="kw">SELECT</span>
        e.id,
        e.name,
        e.manager_id,
        oh.level + <span class="dv">1</span>,
        oh.path || <span class="st">' > '</span> || e.name,
        oh.path_ids || e.id
    <span class="kw">FROM</span> employees e
    <span class="kw">JOIN</span> org_hierarchy oh <span class="kw">ON</span> e.manager_id = oh.id
)
<span class="kw">SELECT</span>
    <span class="fu">REPEAT</span>(<span class="st">'  '</span>, level - <span class="dv">1</span>) || name <span class="kw">AS</span> employee_tree,
    level,
    path,
    <span class="fu">ARRAY_LENGTH</span>(path_ids, <span class="dv">1</span>) <span class="kw">AS</span> depth
<span class="kw">FROM</span> org_hierarchy
<span class="kw">ORDER BY</span> path;</code></pre>

                        <p><strong>Ornek Cikti:</strong></p>
                        <pre>
employee_tree         | level | path
----------------------+-------+---------------------------
Ali (CEO)             | 1     | Ali (CEO)
  Burak (VP Satis)    | 2     | Ali (CEO) > Burak (VP Satis)
    Canan (Mudur)     | 3     | Ali (CEO) > Burak > Canan
    Deniz (Mudur)     | 3     | Ali (CEO) > Burak > Deniz
  Elif (VP Muhendislik)| 2    | Ali (CEO) > Elif
    Fatih (Gelistirici)| 3    | Ali (CEO) > Elif > Fatih
                        </pre>

                        <div class="warning-box">
                            <strong>Recursive CTE Uyarisi:</strong> Her zaman bir sonlandirma kosulu oldugunu garanti edin.
                            Dairesel referanslar sonsuz donguye neden olur. PostgreSQL 14+'te <code>CYCLE</code> algilamasi kullanin.
                        </div>
                    </div>
                </div>
            </section>

            <!-- Bolum 4: Veri Gorsellestirme Hazirligi -->
            <section>
                <h2>Bolum 4: Gorsellestirme icin Veri Hazirlama</h2>
                <p>Sorgu sonuclarini grafikler ve panolar icin bicimlendir.</p>

                <div class="exercise-box">
                    <h4>Alistirma 4.1: Cizgi Grafikleri icin Zaman Serileri</h4>
                    <p>Surekli cizgi grafikleri icin bosluklari doldurulmus gunluk satis verileri hazirlayin.</p>

                    <p><strong>Gorev:</strong> Tum tarihlerin bir serisini olusturun ve gercek satislarla birlestirin (bosluklar icin 0 koyun).</p>

                    <button class="btn-solution" onclick="toggleSolution('sol4_1')">Cozumu Goster</button>
                    <div id="sol4_1" class="solution">
                        <pre><code class="sourceCode sql"><span class="kw">WITH</span>
date_range <span class="kw">AS</span> (
    <span class="kw">SELECT</span> <span class="fu">generate_series</span>(
        (<span class="kw">SELECT</span> <span class="fu">MIN</span>(order_date) <span class="kw">FROM</span> orders),
        (<span class="kw">SELECT</span> <span class="fu">MAX</span>(order_date) <span class="kw">FROM</span> orders),
        <span class="st">'1 day'</span>::interval
    )::date <span class="kw">AS</span> date
),
daily_sales <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        order_date,
        <span class="fu">SUM</span>(amount) <span class="kw">AS</span> sales,
        <span class="fu">COUNT</span>(*) <span class="kw">AS</span> order_count
    <span class="kw">FROM</span> orders
    <span class="kw">GROUP BY</span> order_date
)
<span class="kw">SELECT</span>
    dr.date,
    <span class="fu">COALESCE</span>(ds.sales, <span class="dv">0</span>) <span class="kw">AS</span> sales,
    <span class="fu">COALESCE</span>(ds.order_count, <span class="dv">0</span>) <span class="kw">AS</span> order_count,
    <span class="co">-- 7 gunluk hareketli ortalama</span>
    <span class="fu">ROUND</span>(
        <span class="fu">AVG</span>(<span class="fu">COALESCE</span>(ds.sales, <span class="dv">0</span>)) <span class="kw">OVER</span> (
            <span class="kw">ORDER BY</span> dr.date
            <span class="kw">ROWS BETWEEN</span> <span class="dv">6</span> <span class="kw">PRECEDING AND CURRENT ROW</span>
        ),
        <span class="dv">2</span>
    ) <span class="kw">AS</span> moving_avg
<span class="kw">FROM</span> date_range dr
<span class="kw">LEFT JOIN</span> daily_sales ds <span class="kw">ON</span> dr.date = ds.order_date
<span class="kw">ORDER BY</span> dr.date;</code></pre>

                        <div class="visual-demo">
                            <h6>Cizgi Grafigi icin Hazir Veri</h6>
                            <div class="bar-chart">
                                <div class="bar" style="height: 80px;">
                                    <span class="bar-value">$800</span>
                                    <span class="bar-label">Pzt</span>
                                </div>
                                <div class="bar" style="height: 60px;">
                                    <span class="bar-value">$600</span>
                                    <span class="bar-label">Sal</span>
                                </div>
                                <div class="bar" style="height: 0px; background: #ddd;">
                                    <span class="bar-value">$0</span>
                                    <span class="bar-label">Car</span>
                                </div>
                                <div class="bar" style="height: 100px;">
                                    <span class="bar-value">$1000</span>
                                    <span class="bar-label">Per</span>
                                </div>
                                <div class="bar" style="height: 90px;">
                                    <span class="bar-value">$900</span>
                                    <span class="bar-label">Cum</span>
                                </div>
                            </div>
                            <p style="font-size: 0.8em; color: #666;">Carsamba icin $0 ile bosluk dolduruldu</p>
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 4.2: Isi Haritalari icin Pivot Veri</h4>
                    <p>Haftanin gunu ve saate gore satislari gosteren isi haritasi icin hazir veri seti olusturun.</p>

                    <p><strong>Gorev:</strong> Gorsellestirme icin gun/saat bazinda toplama yapin.</p>

                    <button class="btn-solution" onclick="toggleSolution('sol4_2')">Cozumu Goster</button>
                    <div id="sol4_2" class="solution">
                        <pre><code class="sourceCode sql"><span class="kw">SELECT</span>
    <span class="fu">EXTRACT</span>(DOW <span class="kw">FROM</span> order_date) <span class="kw">AS</span> day_of_week,
    <span class="cf">CASE</span> <span class="fu">EXTRACT</span>(DOW <span class="kw">FROM</span> order_date)
        <span class="cf">WHEN</span> <span class="dv">0</span> <span class="cf">THEN</span> <span class="st">'Pazar'</span>
        <span class="cf">WHEN</span> <span class="dv">1</span> <span class="cf">THEN</span> <span class="st">'Pazartesi'</span>
        <span class="cf">WHEN</span> <span class="dv">2</span> <span class="cf">THEN</span> <span class="st">'Sali'</span>
        <span class="cf">WHEN</span> <span class="dv">3</span> <span class="cf">THEN</span> <span class="st">'Carsamba'</span>
        <span class="cf">WHEN</span> <span class="dv">4</span> <span class="cf">THEN</span> <span class="st">'Persembe'</span>
        <span class="cf">WHEN</span> <span class="dv">5</span> <span class="cf">THEN</span> <span class="st">'Cuma'</span>
        <span class="cf">WHEN</span> <span class="dv">6</span> <span class="cf">THEN</span> <span class="st">'Cumartesi'</span>
    <span class="cf">END</span> <span class="kw">AS</span> day_name,
    <span class="fu">EXTRACT</span>(<span class="kw">HOUR</span> <span class="kw">FROM</span> order_time) <span class="kw">AS</span> hour_of_day,
    <span class="fu">COUNT</span>(*) <span class="kw">AS</span> order_count,
    <span class="fu">SUM</span>(amount) <span class="kw">AS</span> total_sales,
    <span class="fu">ROUND</span>(<span class="fu">AVG</span>(amount), <span class="dv">2</span>) <span class="kw">AS</span> avg_order_value
<span class="kw">FROM</span> orders
<span class="kw">GROUP BY</span>
    <span class="fu">EXTRACT</span>(DOW <span class="kw">FROM</span> order_date),
    <span class="fu">EXTRACT</span>(<span class="kw">HOUR</span> <span class="kw">FROM</span> order_time)
<span class="kw">ORDER BY</span> day_of_week, hour_of_day;</code></pre>

                        <p><strong>Gorsellestirme araclari icin pivot format:</strong></p>
                        <pre><code class="sourceCode sql"><span class="kw">SELECT</span>
    <span class="fu">EXTRACT</span>(<span class="kw">HOUR</span> <span class="kw">FROM</span> order_time) <span class="kw">AS</span> hour,
    <span class="fu">SUM</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> <span class="fu">EXTRACT</span>(DOW <span class="kw">FROM</span> order_date) = <span class="dv">0</span> <span class="cf">THEN</span> amount <span class="cf">ELSE</span> <span class="dv">0</span> <span class="cf">END</span>) <span class="kw">AS</span> pazar,
    <span class="fu">SUM</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> <span class="fu">EXTRACT</span>(DOW <span class="kw">FROM</span> order_date) = <span class="dv">1</span> <span class="cf">THEN</span> amount <span class="cf">ELSE</span> <span class="dv">0</span> <span class="cf">END</span>) <span class="kw">AS</span> pazartesi,
    <span class="fu">SUM</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> <span class="fu">EXTRACT</span>(DOW <span class="kw">FROM</span> order_date) = <span class="dv">2</span> <span class="cf">THEN</span> amount <span class="cf">ELSE</span> <span class="dv">0</span> <span class="cf">END</span>) <span class="kw">AS</span> sali,
    <span class="co">-- ... vb</span>
<span class="kw">FROM</span> orders
<span class="kw">GROUP BY</span> <span class="fu">EXTRACT</span>(<span class="kw">HOUR</span> <span class="kw">FROM</span> order_time)
<span class="kw">ORDER BY</span> hour;</code></pre>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Alistirma 4.3: API'ler/Panolar icin JSON Olarak Disari Aktar</h4>
                    <p>Web panolari icin JSON formatli veri uretin.</p>

                    <p><strong>Gorev:</strong> Yapilandirilmis cikti olusturmak icin JSON toplama fonksiyonlarini kullanin.</p>

                    <button class="btn-solution" onclick="toggleSolution('sol4_3')">Cozumu Goster</button>
                    <div id="sol4_3" class="solution">
                        <pre><code class="sourceCode sql"><span class="co">-- Ic ice urunlerle kategori satislari</span>
<span class="kw">SELECT</span>
    <span class="fu">JSON_BUILD_OBJECT</span>(
        <span class="st">'report_date'</span>, <span class="fu">CURRENT_DATE</span>,
        <span class="st">'categories'</span>, (
            <span class="kw">SELECT</span> <span class="fu">JSON_AGG</span>(category_data)
            <span class="kw">FROM</span> (
                <span class="kw">SELECT</span>
                    <span class="fu">JSON_BUILD_OBJECT</span>(
                        <span class="st">'name'</span>, c.category_name,
                        <span class="st">'total_sales'</span>, <span class="fu">SUM</span>(oi.quantity * oi.price),
                        <span class="st">'order_count'</span>, <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> o.order_id),
                        <span class="st">'top_products'</span>, (
                            <span class="kw">SELECT</span> <span class="fu">JSON_AGG</span>(prod)
                            <span class="kw">FROM</span> (
                                <span class="kw">SELECT</span>
                                    <span class="fu">JSON_BUILD_OBJECT</span>(
                                        <span class="st">'name'</span>, p2.name,
                                        <span class="st">'sales'</span>, <span class="fu">SUM</span>(oi2.quantity * oi2.price)
                                    ) <span class="kw">AS</span> prod
                                <span class="kw">FROM</span> products p2
                                <span class="kw">JOIN</span> order_items oi2 <span class="kw">ON</span> p2.product_id = oi2.product_id
                                <span class="kw">WHERE</span> p2.category_id = c.category_id
                                <span class="kw">GROUP BY</span> p2.product_id, p2.name
                                <span class="kw">ORDER BY</span> <span class="fu">SUM</span>(oi2.quantity * oi2.price) <span class="kw">DESC</span>
                                <span class="kw">LIMIT</span> <span class="dv">3</span>
                            ) top_prods
                        )
                    ) <span class="kw">AS</span> category_data
                <span class="kw">FROM</span> categories c
                <span class="kw">JOIN</span> products p <span class="kw">ON</span> c.category_id = p.category_id
                <span class="kw">JOIN</span> order_items oi <span class="kw">ON</span> p.product_id = oi.product_id
                <span class="kw">JOIN</span> orders o <span class="kw">ON</span> oi.order_id = o.order_id
                <span class="kw">GROUP BY</span> c.category_id, c.category_name
            ) cats
        )
    ) <span class="kw">AS</span> dashboard_data;</code></pre>

                        <p><strong>Cikti yapisi:</strong></p>
                        <pre>{
  "report_date": "2024-06-15",
  "categories": [
    {
      "name": "Elektronik",
      "total_sales": 125000,
      "order_count": 450,
      "top_products": [
        {"name": "Laptop Pro", "sales": 45000},
        {"name": "Kablosuz Mouse", "sales": 12000}
      ]
    }
  ]
}</pre>
                    </div>
                </div>
            </section>

            <!-- Bolum 5: Zorluk -->
            <section>
                <h2>Bolum 5: Zorluk Alistirmasi</h2>

                <div class="exercise-box">
                    <h4>Zorluk: Yonetici Panosu Sorgusu</h4>
                    <p>Birden fazla analitik teknigini birlestiren kapsamli bir pano sorgusu olusturun.</p>

                    <p><strong>Gereksinimler:</strong></p>
                    <ul>
                        <li>Mevcut ay ile onceki ay satis karsilastirmasi</li>
                        <li>Gelire gore en iyi 5 urun</li>
                        <li>Musteri segment dagilimi</li>
                        <li>Hareketli ortalamali gunluk satis trendi</li>
                    </ul>

                    <button class="btn-solution" onclick="toggleSolution('sol5_1')">Cozumu Goster</button>
                    <div id="sol5_1" class="solution">
                        <pre><code class="sourceCode sql"><span class="kw">WITH</span>
<span class="co">-- Aylik karsilastirma</span>
monthly_comparison <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        <span class="fu">SUM</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, order_date) = <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, <span class="fu">CURRENT_DATE</span>)
            <span class="cf">THEN</span> amount <span class="cf">ELSE</span> <span class="dv">0</span> <span class="cf">END</span>) <span class="kw">AS</span> current_month,
        <span class="fu">SUM</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, order_date) = <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, <span class="fu">CURRENT_DATE</span> - <span class="kw">INTERVAL</span> <span class="st">'1 month'</span>)
            <span class="cf">THEN</span> amount <span class="cf">ELSE</span> <span class="dv">0</span> <span class="cf">END</span>) <span class="kw">AS</span> previous_month
    <span class="kw">FROM</span> orders
),
<span class="co">-- En iyi urunler</span>
top_products <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        p.name,
        <span class="fu">SUM</span>(oi.quantity * oi.price) <span class="kw">AS</span> revenue,
        <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span> (<span class="kw">ORDER BY</span> <span class="fu">SUM</span>(oi.quantity * oi.price) <span class="kw">DESC</span>) <span class="kw">AS</span> rank
    <span class="kw">FROM</span> products p
    <span class="kw">JOIN</span> order_items oi <span class="kw">ON</span> p.product_id = oi.product_id
    <span class="kw">JOIN</span> orders o <span class="kw">ON</span> oi.order_id = o.order_id
    <span class="kw">WHERE</span> o.order_date >= <span class="fu">DATE_TRUNC</span>(<span class="st">'month'</span>, <span class="fu">CURRENT_DATE</span>)
    <span class="kw">GROUP BY</span> p.product_id, p.name
),
<span class="co">-- Musteri segmentleri</span>
customer_segments <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        <span class="cf">CASE</span>
            <span class="cf">WHEN</span> total_orders >= <span class="dv">10</span> <span class="cf">THEN</span> <span class="st">'VIP'</span>
            <span class="cf">WHEN</span> total_orders >= <span class="dv">5</span> <span class="cf">THEN</span> <span class="st">'Normal'</span>
            <span class="cf">ELSE</span> <span class="st">'Ara Sira'</span>
        <span class="cf">END</span> <span class="kw">AS</span> segment,
        <span class="fu">COUNT</span>(*) <span class="kw">AS</span> count
    <span class="kw">FROM</span> (
        <span class="kw">SELECT</span> customer_id, <span class="fu">COUNT</span>(*) <span class="kw">AS</span> total_orders
        <span class="kw">FROM</span> orders
        <span class="kw">GROUP BY</span> customer_id
    ) cust
    <span class="kw">GROUP BY</span> <span class="dv">1</span>
),
<span class="co">-- Gunluk trend</span>
daily_trend <span class="kw">AS</span> (
    <span class="kw">SELECT</span>
        order_date,
        <span class="fu">SUM</span>(amount) <span class="kw">AS</span> daily_sales,
        <span class="fu">ROUND</span>(<span class="fu">AVG</span>(<span class="fu">SUM</span>(amount)) <span class="kw">OVER</span> (<span class="kw">ORDER BY</span> order_date <span class="kw">ROWS</span> <span class="dv">6</span> <span class="kw">PRECEDING</span>), <span class="dv">2</span>) <span class="kw">AS</span> ma_7d
    <span class="kw">FROM</span> orders
    <span class="kw">WHERE</span> order_date >= <span class="fu">CURRENT_DATE</span> - <span class="dv">30</span>
    <span class="kw">GROUP BY</span> order_date
)
<span class="kw">SELECT</span>
    <span class="fu">JSON_BUILD_OBJECT</span>(
        <span class="st">'summary'</span>, (
            <span class="kw">SELECT</span> <span class="fu">JSON_BUILD_OBJECT</span>(
                <span class="st">'current_month_sales'</span>, current_month,
                <span class="st">'previous_month_sales'</span>, previous_month,
                <span class="st">'growth_pct'</span>, <span class="fu">ROUND</span>((current_month - previous_month) * <span class="fl">100.0</span> / <span class="fu">NULLIF</span>(previous_month, <span class="dv">0</span>), <span class="dv">2</span>)
            )
            <span class="kw">FROM</span> monthly_comparison
        ),
        <span class="st">'top_products'</span>, (<span class="kw">SELECT</span> <span class="fu">JSON_AGG</span>(<span class="fu">JSON_BUILD_OBJECT</span>(<span class="st">'name'</span>, name, <span class="st">'revenue'</span>, revenue)) <span class="kw">FROM</span> top_products <span class="kw">WHERE</span> rank <= <span class="dv">5</span>),
        <span class="st">'segments'</span>, (<span class="kw">SELECT</span> <span class="fu">JSON_AGG</span>(<span class="fu">JSON_BUILD_OBJECT</span>(<span class="st">'segment'</span>, segment, <span class="st">'count'</span>, count)) <span class="kw">FROM</span> customer_segments),
        <span class="st">'daily_trend'</span>, (<span class="kw">SELECT</span> <span class="fu">JSON_AGG</span>(<span class="fu">JSON_BUILD_OBJECT</span>(<span class="st">'date'</span>, order_date, <span class="st">'sales'</span>, daily_sales, <span class="st">'ma'</span>, ma_7d) <span class="kw">ORDER BY</span> order_date) <span class="kw">FROM</span> daily_trend)
    ) <span class="kw">AS</span> dashboard;</code></pre>
                    </div>
                </div>
            </section>

            <!-- Onemli Cikarimlar -->
            <section>
                <h3>Onemli Cikarimlar</h3>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Konu</th>
                            <th>Ana Noktalar</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Pencere Fonksiyonlari</strong></td>
                            <td>
                                <ul class="mb-0">
                                    <li>Toplamadan grup olusturmak icin PARTITION BY kullanin</li>
                                    <li>LAG/LEAD karsilastirmalar icin komsu satirlara erisir</li>
                                    <li>Cerceve ifadeleri hangi satirlarin dahil edilecegini kontrol eder</li>
                                </ul>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Ileri Toplamalar</strong></td>
                            <td>
                                <ul class="mb-0">
                                    <li>Birden fazla ozet seviyesi icin GROUPING SETS</li>
                                    <li>Hiyerarsik alt toplamlar icin ROLLUP</li>
                                    <li>Kosullu toplama icin FILTER</li>
                                </ul>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>CTE'ler</strong></td>
                            <td>
                                <ul class="mb-0">
                                    <li>Adim adim analitik icin CTE'leri zincirleyin</li>
                                    <li>Hiyerarsik veriler icin recursive CTE'ler</li>
                                    <li>Karmasik sorgularin okunabilirligini artirin</li>
                                </ul>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Gorsellestirme Hazirligi</strong></td>
                            <td>
                                <ul class="mb-0">
                                    <li>Tarih bosluklarini generate_series ile doldurun</li>
                                    <li>API'ye hazir cikti icin JSON fonksiyonlarini kullanin</li>
                                    <li>Gorsellestirme seviyesinde on-toplama yapin</li>
                                </ul>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <!-- Navigasyon -->
            <section>
                <div class="d-flex justify-content-between">
                    <a href="02_analytics_data_visualization_tr.html" class="btn btn-outline-primary">&larr; Derse Don</a>
                </div>
            </section>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script>
        function toggleSolution(id) {
            var element = document.getElementById(id);
            if (element.classList.contains('show')) {
                element.classList.remove('show');
                event.target.textContent = 'Cozumu Goster';
            } else {
                element.classList.add('show');
                event.target.textContent = 'Cozumu Gizle';
            }
        }
    </script>
</body>

</html>
