<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">


<!-- Mirrored from code-mext.github.io/sql-training/day5/01_advanced_postgresql_features.html by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 10 Jan 2026 07:44:40 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="../style_bootstrap.html">
  <link rel="stylesheet" href="../css/style.css">
  <link href="https://cdn.prod.website-files.com/5efdb54f07a6812bcd95cc65/6773d0fc3013e060f08d7145_favicon.jpg"
    rel="shortcut icon" type="image/x-icon">
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Day 5: Advanced PostgreSQL Features</title>
  <style>
    code {
      white-space: pre-wrap;
    }

    span.smallcaps {
      font-variant: small-caps;
    }

    span.underline {
      text-decoration: underline;
    }

    div.column {
      display: inline-block;
      vertical-align: top;
      width: 50%;
    }

    div.hanging-indent {
      margin-left: 1.5em;
      text-indent: -1.5em;
    }

    ul.task-list {
      list-style: none;
    }

    pre>code.sourceCode {
      white-space: pre;
      position: relative;
    }

    pre>code.sourceCode>span {
      display: inline-block;
      line-height: 1.25;
    }

    pre>code.sourceCode>span:empty {
      height: 1.2em;
    }

    code.sourceCode>span {
      color: inherit;
      text-decoration: inherit;
    }

    div.sourceCode {
      margin: 1em 0;
    }

    pre.sourceCode {
      margin: 0;
    }

    @media screen {
      div.sourceCode {
        overflow: auto;
      }
    }

    @media print {
      pre>code.sourceCode {
        white-space: pre-wrap;
      }

      pre>code.sourceCode>span {
        text-indent: -5em;
        padding-left: 5em;
      }
    }

    pre.numberSource code {
      counter-reset: source-line 0;
    }

    pre.numberSource code>span {
      position: relative;
      left: -4em;
      counter-increment: source-line;
    }

    pre.numberSource code>span>a:first-child::before {
      content: counter(source-line);
      position: relative;
      left: -1em;
      text-align: right;
      vertical-align: baseline;
      border: none;
      display: inline-block;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      padding: 0 4px;
      width: 4em;
      color: #aaaaaa;
    }

    pre.numberSource {
      margin-left: 3em;
      border-left: 1px solid #aaaaaa;
      padding-left: 4px;
    }

    div.sourceCode {}

    @media screen {
      pre>code.sourceCode>span>a:first-child::before {
        text-decoration: underline;
      }
    }

    code span.al {
      color: #ff0000;
      font-weight: bold;
    }

    /* Alert */
    code span.an {
      color: #60a0b0;
      font-weight: bold;
      font-style: italic;
    }

    /* Annotation */
    code span.at {
      color: #7d9029;
    }

    /* Attribute */
    code span.bn {
      color: #40a070;
    }

    /* BaseN */
    code span.bu {}

    /* BuiltIn */
    code span.cf {
      color: #007020;
      font-weight: bold;
    }

    /* ControlFlow */
    code span.ch {
      color: #4070a0;
    }

    /* Char */
    code span.cn {
      color: #880000;
    }

    /* Constant */
    code span.co {
      color: #60a0b0;
      font-style: italic;
    }

    /* Comment */
    code span.cv {
      color: #60a0b0;
      font-weight: bold;
      font-style: italic;
    }

    /* CommentVar */
    code span.do {
      color: #ba2121;
      font-style: italic;
    }

    /* Documentation */
    code span.dt {
      color: #902000;
    }

    /* DataType */
    code span.dv {
      color: #40a070;
    }

    /* DecVal */
    code span.er {
      color: #ff0000;
      font-weight: bold;
    }

    /* Error */
    code span.ex {}

    /* Extension */
    code span.fl {
      color: #40a070;
    }

    /* Float */
    code span.fu {
      color: #06287e;
    }

    /* Function */
    code span.im {}

    /* Import */
    code span.in {
      color: #60a0b0;
      font-weight: bold;
      font-style: italic;
    }

    /* Information */
    code span.kw {
      color: #007020;
      font-weight: bold;
    }

    /* Keyword */
    code span.op {
      color: #666666;
    }

    /* Operator */
    code span.ot {
      color: #007020;
    }

    /* Other */
    code span.pp {
      color: #bc7a00;
    }

    /* Preprocessor */
    code span.sc {
      color: #4070a0;
    }

    /* SpecialChar */
    code span.ss {
      color: #bb6688;
    }

    /* SpecialString */
    code span.st {
      color: #4070a0;
    }

    /* String */
    code span.va {
      color: #19177c;
    }

    /* Variable */
    code span.vs {
      color: #4070a0;
    }

    /* VerbatimString */
    code span.wa {
      color: #60a0b0;
      font-weight: bold;
      font-style: italic;
    }

    /* Warning */
    .language-switcher { position: fixed; top: 10px; right: 10px; z-index: 1000; background: #fff; padding: 5px 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .language-switcher a { text-decoration: none; padding: 5px 10px; margin: 0 2px; border-radius: 3px; color: #333; }
    .language-switcher a.active { background: #0d6efd; color: #fff; }
    .language-switcher a:hover:not(.active) { background: #e9ecef; }
  </style>
</head>

<body>
  <div class="language-switcher">
    <a href="01_advanced_postgresql_features.html" class="active">EN</a>
    <a href="01_advanced_postgresql_features_tr.html">TR</a>
  </div>
  <div class="copy-notification" id="copyNotification">Copied!</div>

  <div id="europeanunion-turkey">
    <img src="../static/eu.png" alt="">
  </div>
  <div id="sanayiteknolojibakan">
    <img src="../static/sanayitek.png" alt="">
  </div>
  <div id="rekabet">
    <img src="../static/rekabet.png" alt="">
  </div>
  <div id="tisk">
    <img src="../static/tisk.png" alt="">
  </div>
  <div id="undp">
    <img src="../static/undp.png" alt="">
  </div>
  <div class="content-container">
    <div class="container">
      <section>
        <h1 id="day-5-advanced-postgresql-features">Day 5: Advanced PostgreSQL Features</h1>
        <h2 id="session-1-advanced-postgresql-features-2-hours">Session 1: Advanced PostgreSQL Features (2 hours)</h2>
        <h3 id="stored-procedures-and-functions">Stored Procedures and Functions</h3>
        <p>PostgreSQL offers powerful capabilities for creating stored procedures and functions that can encapsulate
          business logic directly in the database. This approach provides several benefits, including improved
          performance, code reuse, and security.</p>
        <p><strong>Functions vs. Procedures</strong>:</p>
        <p>In PostgreSQL, there are two types of routines:</p>
        <ol type="1">
          <li><strong>Functions</strong>: Return a value and can be used in SQL expressions</li>
          <li><strong>Procedures</strong>: Don’t return a value but can perform transactions (COMMIT/ROLLBACK)</li>
        </ol>
      </section>
      <section>

        <p><strong>Creating Basic Functions</strong>:</p>
        <div class="sourceCode" id="cb1">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="co">-- Simple function that returns a scalar value</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> get_customer_count()</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a>RETURNS <span class="dt">integer</span> <span class="kw">AS</span> $$</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a>    <span class="kw">RETURN</span> (<span class="kw">SELECT</span> <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">FROM</span> customer);</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a>$$ LANGUAGE plpgsql;</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a><span class="co">-- Usage</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a><span class="kw">SELECT</span> get_customer_count();</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true"></a><span class="co">-- Function with parameters</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> get_orders_by_customer(customer_id_param <span class="dt">integer</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true"></a>RETURNS <span class="dt">integer</span> <span class="kw">AS</span> $$</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true"></a>    <span class="kw">RETURN</span> (<span class="kw">SELECT</span> <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">FROM</span> orders <span class="kw">WHERE</span> customer_id <span class="op">=</span> customer_id_param);</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true"></a>$$ LANGUAGE plpgsql;</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true"></a><span class="co">-- Usage</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true"></a><span class="kw">SELECT</span> get_orders_by_customer(<span class="dv">123</span>);</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Creating Table-Returning Functions</strong>:</p>
        <div class="sourceCode" id="cb2">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="co">-- Function that returns a table</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> get_top_customers(n <span class="dt">integer</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a>RETURNS <span class="kw">TABLE</span> (</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>    customer_id <span class="dt">integer</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>    customer_name text,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>    total_orders <span class="dt">integer</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a>    total_spent <span class="dt">numeric</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a>) <span class="kw">AS</span> $$</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a>    <span class="kw">RETURN</span> <span class="kw">QUERY</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a>    <span class="kw">SELECT</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a>        c.<span class="kw">id</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true"></a>        c.name,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a>        <span class="fu">COUNT</span>(o.<span class="kw">id</span>),</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true"></a>        <span class="fu">SUM</span>(o.amount)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true"></a>    <span class="kw">FROM</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true"></a>        customer c</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true"></a>    <span class="kw">JOIN</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true"></a>        orders o <span class="kw">ON</span> c.<span class="kw">id</span> <span class="op">=</span> o.customer_id</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true"></a>    <span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true"></a>        c.<span class="kw">id</span>, c.name</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true"></a>    <span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true"></a>        <span class="fu">SUM</span>(o.amount) <span class="kw">DESC</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true"></a>    <span class="kw">LIMIT</span> n;</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true"></a>$$ LANGUAGE plpgsql;</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true"></a><span class="co">-- Usage</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> get_top_customers(<span class="dv">10</span>);</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Creating Stored Procedures</strong>:</p>
        <div class="sourceCode" id="cb3">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="co">-- Simple procedure</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">PROCEDURE</span> update_product_prices(category_id_param <span class="dt">integer</span>, increase_percent <span class="dt">numeric</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a>LANGUAGE plpgsql</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a><span class="kw">AS</span> $$</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a>    <span class="kw">UPDATE</span> product</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a>    <span class="kw">SET</span> price <span class="op">=</span> price <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> increase_percent <span class="op">/</span> <span class="dv">100</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a>    <span class="kw">WHERE</span> category_id <span class="op">=</span> category_id_param;</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a>    </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a>    <span class="kw">COMMIT</span>;</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true"></a>$$;</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true"></a><span class="co">-- Usage</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true"></a><span class="kw">CALL</span> update_product_prices(<span class="dv">5</span>, <span class="dv">10</span>);  <span class="co">-- Increase prices in category 5 by 10%</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true"></a><span class="co">-- Procedure with transaction control</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">PROCEDURE</span> transfer_funds(</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true"></a>    sender_id <span class="dt">integer</span>,</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true"></a>    receiver_id <span class="dt">integer</span>,</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true"></a>    amount <span class="dt">numeric</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true"></a>)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true"></a>LANGUAGE plpgsql</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true"></a><span class="kw">AS</span> $$</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true"></a><span class="kw">DECLARE</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true"></a>    sender_balance <span class="dt">numeric</span>;</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true"></a>    <span class="co">-- Start a transaction</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true"></a>    <span class="cf">BEGIN</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true"></a>        <span class="co">-- Check sender balance</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true"></a>        <span class="kw">SELECT</span> balance <span class="kw">INTO</span> sender_balance</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true"></a>        <span class="kw">FROM</span> <span class="kw">account</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true"></a>        <span class="kw">WHERE</span> account_id <span class="op">=</span> sender_id</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true"></a>        <span class="cf">FOR</span> <span class="kw">UPDATE</span>;  <span class="co">-- Lock the row</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true"></a>        </span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true"></a>        <span class="cf">IF</span> sender_balance <span class="op">&lt;</span> amount <span class="cf">THEN</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true"></a>            RAISE <span class="kw">EXCEPTION</span> <span class="st">&#39;Insufficient funds&#39;</span>;</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true"></a>        <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true"></a>        </span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true"></a>        <span class="co">-- Update sender account</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true"></a>        <span class="kw">UPDATE</span> <span class="kw">account</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true"></a>        <span class="kw">SET</span> balance <span class="op">=</span> balance <span class="op">-</span> amount</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true"></a>        <span class="kw">WHERE</span> account_id <span class="op">=</span> sender_id;</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true"></a>        </span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true"></a>        <span class="co">-- Update receiver account</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true"></a>        <span class="kw">UPDATE</span> <span class="kw">account</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true"></a>        <span class="kw">SET</span> balance <span class="op">=</span> balance <span class="op">+</span> amount</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true"></a>        <span class="kw">WHERE</span> account_id <span class="op">=</span> receiver_id;</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true"></a>        </span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true"></a>        <span class="co">-- Commit the transaction</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true"></a>        <span class="kw">COMMIT</span>;</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true"></a>    <span class="kw">EXCEPTION</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true"></a>        <span class="cf">WHEN</span> OTHERS <span class="cf">THEN</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true"></a>            <span class="co">-- Rollback the transaction on error</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true"></a>            <span class="kw">ROLLBACK</span>;</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true"></a>            RAISE;</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true"></a>    <span class="cf">END</span>;</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true"></a>$$;</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true"></a></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true"></a><span class="co">-- Usage</span></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true"></a><span class="kw">CALL</span> transfer_funds(<span class="dv">101</span>, <span class="dv">202</span>, <span class="fl">500.00</span>);</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>PL/pgSQL Language Features</strong>:</p>
        <p>PL/pgSQL is PostgreSQL’s procedural language that extends SQL with control structures and more complex
          processing.</p>
        <ol type="1">
          <li><strong>Variables and Constants</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb4">
          <pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> calculate_order_total(order_id_param <span class="dt">integer</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a>RETURNS <span class="dt">numeric</span> <span class="kw">AS</span> $$</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a><span class="kw">DECLARE</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a>    total_amount <span class="dt">numeric</span> <span class="op">:=</span> <span class="dv">0</span>;</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a>    tax_rate <span class="kw">constant</span> <span class="dt">numeric</span> <span class="op">:=</span> <span class="fl">0.08</span>;</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a>    shipping_fee <span class="dt">numeric</span>;</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a>    customer_type text;</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a>    <span class="co">-- Get the customer type</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a>    <span class="kw">SELECT</span> c.customer_type <span class="kw">INTO</span> customer_type</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true"></a>    <span class="kw">FROM</span> orders o</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true"></a>    <span class="kw">JOIN</span> customer c <span class="kw">ON</span> o.customer_id <span class="op">=</span> c.<span class="kw">id</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true"></a>    <span class="kw">WHERE</span> o.<span class="kw">id</span> <span class="op">=</span> order_id_param;</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true"></a>    </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true"></a>    <span class="co">-- Set shipping fee based on customer type</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true"></a>    <span class="cf">IF</span> customer_type <span class="op">=</span> <span class="st">&#39;premium&#39;</span> <span class="cf">THEN</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true"></a>        shipping_fee <span class="op">:=</span> <span class="dv">0</span>;</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true"></a>    <span class="cf">ELSE</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true"></a>        shipping_fee <span class="op">:=</span> <span class="dv">10</span>;</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true"></a>    </span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true"></a>    <span class="co">-- Calculate order total</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true"></a>    <span class="kw">SELECT</span> <span class="fu">SUM</span>(quantity <span class="op">*</span> price) <span class="kw">INTO</span> total_amount</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true"></a>    <span class="kw">FROM</span> order_item</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true"></a>    <span class="kw">WHERE</span> order_id <span class="op">=</span> order_id_param;</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true"></a>    </span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true"></a>    <span class="co">-- Add tax and shipping</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true"></a>    total_amount <span class="op">:=</span> total_amount <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> tax_rate) <span class="op">+</span> shipping_fee;</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true"></a>    </span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true"></a>    <span class="kw">RETURN</span> total_amount;</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true"></a>$$ LANGUAGE plpgsql;</span></code></pre>
        </div>
      </section>
      <section>
        <ol start="2" type="1">
          <li><strong>Control Structures</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb5">
          <pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="co">-- IF statement</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> get_price_category(price <span class="dt">numeric</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a>RETURNS text <span class="kw">AS</span> $$</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a>    <span class="cf">IF</span> price <span class="op">&lt;</span> <span class="dv">50</span> <span class="cf">THEN</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a>        <span class="kw">RETURN</span> <span class="st">&#39;Budget&#39;</span>;</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true"></a>    <span class="cf">ELSIF</span> price <span class="op">&lt;</span> <span class="dv">200</span> <span class="cf">THEN</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true"></a>        <span class="kw">RETURN</span> <span class="st">&#39;Mid-range&#39;</span>;</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true"></a>    <span class="cf">ELSE</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true"></a>        <span class="kw">RETURN</span> <span class="st">&#39;Premium&#39;</span>;</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true"></a>$$ LANGUAGE plpgsql;</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true"></a><span class="co">-- CASE statement</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> get_shipping_method(weight <span class="dt">numeric</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true"></a>RETURNS text <span class="kw">AS</span> $$</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true"></a>    <span class="kw">RETURN</span> <span class="cf">CASE</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true"></a>        <span class="cf">WHEN</span> weight <span class="op">&lt;</span> <span class="dv">1</span> <span class="cf">THEN</span> <span class="st">&#39;Standard Mail&#39;</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true"></a>        <span class="cf">WHEN</span> weight <span class="op">&lt;</span> <span class="dv">5</span> <span class="cf">THEN</span> <span class="st">&#39;Express Mail&#39;</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true"></a>        <span class="cf">WHEN</span> weight <span class="op">&lt;</span> <span class="dv">20</span> <span class="cf">THEN</span> <span class="st">&#39;Ground Shipping&#39;</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true"></a>        <span class="cf">ELSE</span> <span class="st">&#39;Freight&#39;</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true"></a>    <span class="cf">END</span>;</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true"></a>$$ LANGUAGE plpgsql;</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true"></a></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true"></a><span class="co">-- LOOP</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> sum_integers(n <span class="dt">integer</span>)</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true"></a>RETURNS <span class="dt">integer</span> <span class="kw">AS</span> $$</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true"></a><span class="kw">DECLARE</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true"></a>    i <span class="dt">integer</span> <span class="op">:=</span> <span class="dv">0</span>;</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true"></a>    total <span class="dt">integer</span> <span class="op">:=</span> <span class="dv">0</span>;</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true"></a>    <span class="cf">LOOP</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true"></a>        i <span class="op">:=</span> i <span class="op">+</span> <span class="dv">1</span>;</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true"></a>        total <span class="op">:=</span> total <span class="op">+</span> i;</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true"></a>        EXIT <span class="cf">WHEN</span> i <span class="op">&gt;=</span> n;</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true"></a>    <span class="cf">END</span> <span class="cf">LOOP</span>;</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true"></a>    </span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true"></a>    <span class="kw">RETURN</span> total;</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true"></a>$$ LANGUAGE plpgsql;</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true"></a></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true"></a><span class="co">-- WHILE LOOP</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> factorial(n <span class="dt">integer</span>)</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true"></a>RETURNS <span class="dt">integer</span> <span class="kw">AS</span> $$</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true"></a><span class="kw">DECLARE</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true"></a>    result <span class="dt">integer</span> <span class="op">:=</span> <span class="dv">1</span>;</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true"></a>    <span class="cf">WHILE</span> n <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">LOOP</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true"></a>        result <span class="op">:=</span> result <span class="op">*</span> n;</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true"></a>        n <span class="op">:=</span> n <span class="op">-</span> <span class="dv">1</span>;</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true"></a>    <span class="cf">END</span> <span class="cf">LOOP</span>;</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true"></a>    </span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true"></a>    <span class="kw">RETURN</span> result;</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true"></a>$$ LANGUAGE plpgsql;</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true"></a></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true"></a><span class="co">-- FOR LOOP (integer range)</span></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> sum_even_numbers(n <span class="dt">integer</span>)</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true"></a>RETURNS <span class="dt">integer</span> <span class="kw">AS</span> $$</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true"></a><span class="kw">DECLARE</span></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true"></a>    i <span class="dt">integer</span>;</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true"></a>    total <span class="dt">integer</span> <span class="op">:=</span> <span class="dv">0</span>;</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true"></a>    <span class="cf">FOR</span> i <span class="kw">IN</span> <span class="dv">1</span><span class="op">..</span>n <span class="cf">LOOP</span></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true"></a>        <span class="cf">IF</span> i % <span class="dv">2</span> <span class="op">=</span> <span class="dv">0</span> <span class="cf">THEN</span></span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true"></a>            total <span class="op">:=</span> total <span class="op">+</span> i;</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true"></a>        <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true"></a>    <span class="cf">END</span> <span class="cf">LOOP</span>;</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true"></a>    </span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true"></a>    <span class="kw">RETURN</span> total;</span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true"></a>$$ LANGUAGE plpgsql;</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true"></a></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true"></a><span class="co">-- FOR LOOP (query results)</span></span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> update_inventory_levels()</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true"></a>RETURNS void <span class="kw">AS</span> $$</span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true"></a><span class="kw">DECLARE</span></span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true"></a>    product_record <span class="dt">record</span>;</span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true"></a>    <span class="cf">FOR</span> product_record <span class="kw">IN</span></span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true"></a>        <span class="kw">SELECT</span> product_id, name</span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true"></a>        <span class="kw">FROM</span> product</span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true"></a>        <span class="kw">WHERE</span> stock_level <span class="op">&lt;</span> reorder_level</span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true"></a>    <span class="cf">LOOP</span></span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true"></a>        RAISE NOTICE <span class="st">&#39;Low stock for product %: %&#39;</span>, </span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true"></a>                     product_record.product_id, </span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true"></a>                     product_record.name;</span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true"></a>        </span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true"></a>        <span class="co">-- Update the reorder flag</span></span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true"></a>        <span class="kw">UPDATE</span> product</span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true"></a>        <span class="kw">SET</span> reorder_flag <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true"></a>        <span class="kw">WHERE</span> product_id <span class="op">=</span> product_record.product_id;</span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true"></a>    <span class="cf">END</span> <span class="cf">LOOP</span>;</span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true"></a>$$ LANGUAGE plpgsql;</span></code></pre>
        </div>
      </section>
      <section>
        <ol start="3" type="1">
          <li><strong>Exception Handling</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb6">
          <pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> divide_safely(a <span class="dt">numeric</span>, b <span class="dt">numeric</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a>RETURNS <span class="dt">numeric</span> <span class="kw">AS</span> $$</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a>    <span class="kw">RETURN</span> a <span class="op">/</span> b;</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a><span class="kw">EXCEPTION</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a>    <span class="cf">WHEN</span> division_by_zero <span class="cf">THEN</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a>        RAISE NOTICE <span class="st">&#39;Division by zero detected&#39;</span>;</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a>        <span class="kw">RETURN</span> <span class="dv">0</span>;</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a>    <span class="cf">WHEN</span> others <span class="cf">THEN</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true"></a>        RAISE NOTICE <span class="st">&#39;Other error: %&#39;</span>, SQLERRM;</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true"></a>        <span class="kw">RETURN</span> <span class="kw">NULL</span>;</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true"></a>$$ LANGUAGE plpgsql;</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true"></a><span class="co">-- Custom exceptions</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> withdraw_money(account_id_param <span class="dt">integer</span>, amount <span class="dt">numeric</span>)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true"></a>RETURNS void <span class="kw">AS</span> $$</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true"></a><span class="kw">DECLARE</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true"></a>    current_balance <span class="dt">numeric</span>;</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true"></a>    insufficient_funds <span class="kw">EXCEPTION</span>;</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true"></a>    <span class="co">-- Get current balance</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true"></a>    <span class="kw">SELECT</span> balance <span class="kw">INTO</span> current_balance</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true"></a>    <span class="kw">FROM</span> <span class="kw">account</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true"></a>    <span class="kw">WHERE</span> account_id <span class="op">=</span> account_id_param;</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true"></a>    </span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true"></a>    <span class="co">-- Check if enough funds</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true"></a>    <span class="cf">IF</span> current_balance <span class="op">&lt;</span> amount <span class="cf">THEN</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true"></a>        RAISE insufficient_funds;</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true"></a>    </span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true"></a>    <span class="co">-- Update balance</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true"></a>    <span class="kw">UPDATE</span> <span class="kw">account</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true"></a>    <span class="kw">SET</span> balance <span class="op">=</span> balance <span class="op">-</span> amount</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true"></a>    <span class="kw">WHERE</span> account_id <span class="op">=</span> account_id_param;</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true"></a>    </span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true"></a><span class="kw">EXCEPTION</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true"></a>    <span class="cf">WHEN</span> insufficient_funds <span class="cf">THEN</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true"></a>        RAISE <span class="kw">EXCEPTION</span> <span class="st">&#39;Account % has insufficient funds (balance: %)&#39;</span>, </span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true"></a>                        account_id_param, current_balance;</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true"></a>    <span class="cf">WHEN</span> no_data_found <span class="cf">THEN</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true"></a>        RAISE <span class="kw">EXCEPTION</span> <span class="st">&#39;Account % not found&#39;</span>, account_id_param;</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true"></a>$$ LANGUAGE plpgsql;</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Function Security and Permissions</strong>:</p>
        <p>Functions can be executed with different security contexts:</p>
        <div class="sourceCode" id="cb7">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a><span class="co">-- Function executes with the privileges of the caller</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> get_my_orders()</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a>RETURNS <span class="kw">TABLE</span> (order_id <span class="dt">integer</span>, order_date <span class="dt">date</span>, amount <span class="dt">numeric</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a><span class="kw">AS</span> $$</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true"></a>    <span class="kw">RETURN</span> <span class="kw">QUERY</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true"></a>    <span class="kw">SELECT</span> <span class="kw">id</span>, order_date, amount</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true"></a>    <span class="kw">FROM</span> orders</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true"></a>    <span class="kw">WHERE</span> customer_id <span class="op">=</span> current_user_id();</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true"></a>$$ LANGUAGE plpgsql;</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true"></a><span class="co">-- Function executes with the privileges of the definer</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> get_sensitive_data()</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true"></a>RETURNS <span class="kw">TABLE</span> (customer_id <span class="dt">integer</span>, credit_score <span class="dt">integer</span>)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true"></a>SECURITY <span class="kw">DEFINER</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true"></a><span class="kw">AS</span> $$</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true"></a>    <span class="kw">RETURN</span> <span class="kw">QUERY</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true"></a>    <span class="kw">SELECT</span> <span class="kw">id</span>, credit_score</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true"></a>    <span class="kw">FROM</span> customer_credit_data;</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true"></a>$$ LANGUAGE plpgsql;</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true"></a></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true"></a><span class="co">-- Grant execute permission</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true"></a><span class="kw">GRANT</span> <span class="kw">EXECUTE</span> <span class="kw">ON</span> <span class="kw">FUNCTION</span> get_sensitive_data() <span class="kw">TO</span> analyst_role;</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Practical Examples</strong>:</p>
        <ol type="1">
          <li><strong>Audit Trail Function</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb8">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="co">-- Create audit table</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> audit_log (</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a>    log_id serial <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a>    table_name text <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a>    operation text <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a>    record_id <span class="dt">integer</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true"></a>    changed_by text <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true"></a>    changed_at <span class="dt">timestamp</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true"></a>    old_data jsonb,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true"></a>    new_data jsonb</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true"></a>);</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true"></a><span class="co">-- Create audit function</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> audit_trigger_function()</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true"></a>RETURNS <span class="kw">trigger</span> <span class="kw">AS</span> $$</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true"></a>    <span class="cf">IF</span> (TG_OP <span class="op">=</span> <span class="st">&#39;DELETE&#39;</span>) <span class="cf">THEN</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true"></a>        <span class="kw">INSERT</span> <span class="kw">INTO</span> audit_log (</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true"></a>            table_name,</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true"></a>            operation,</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true"></a>            record_id,</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true"></a>            changed_by,</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true"></a>            old_data</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true"></a>        )</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true"></a>        <span class="kw">VALUES</span> (</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true"></a>            TG_TABLE_NAME,</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true"></a>            TG_OP,</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true"></a>            <span class="kw">OLD</span>.<span class="kw">id</span>,</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true"></a>            current_user,</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true"></a>            to_jsonb(<span class="kw">OLD</span>)</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true"></a>        );</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true"></a>        <span class="kw">RETURN</span> <span class="kw">OLD</span>;</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true"></a>    <span class="cf">ELSIF</span> (TG_OP <span class="op">=</span> <span class="st">&#39;UPDATE&#39;</span>) <span class="cf">THEN</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true"></a>        <span class="kw">INSERT</span> <span class="kw">INTO</span> audit_log (</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true"></a>            table_name,</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true"></a>            operation,</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true"></a>            record_id,</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true"></a>            changed_by,</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true"></a>            old_data,</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true"></a>            new_data</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true"></a>        )</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true"></a>        <span class="kw">VALUES</span> (</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true"></a>            TG_TABLE_NAME,</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true"></a>            TG_OP,</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true"></a>            <span class="kw">NEW</span>.<span class="kw">id</span>,</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true"></a>            current_user,</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true"></a>            to_jsonb(<span class="kw">OLD</span>),</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true"></a>            to_jsonb(<span class="kw">NEW</span>)</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true"></a>        );</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true"></a>        <span class="kw">RETURN</span> <span class="kw">NEW</span>;</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true"></a>    <span class="cf">ELSIF</span> (TG_OP <span class="op">=</span> <span class="st">&#39;INSERT&#39;</span>) <span class="cf">THEN</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true"></a>        <span class="kw">INSERT</span> <span class="kw">INTO</span> audit_log (</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true"></a>            table_name,</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true"></a>            operation,</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true"></a>            record_id,</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true"></a>            changed_by,</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true"></a>            new_data</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true"></a>        )</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true"></a>        <span class="kw">VALUES</span> (</span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true"></a>            TG_TABLE_NAME,</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true"></a>            TG_OP,</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true"></a>            <span class="kw">NEW</span>.<span class="kw">id</span>,</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true"></a>            current_user,</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true"></a>            to_jsonb(<span class="kw">NEW</span>)</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true"></a>        );</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true"></a>        <span class="kw">RETURN</span> <span class="kw">NEW</span>;</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true"></a>    <span class="kw">RETURN</span> <span class="kw">NULL</span>;</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true"></a>$$ LANGUAGE plpgsql;</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true"></a></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true"></a><span class="co">-- Apply the trigger to a table</span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TRIGGER</span> product_audit</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true"></a><span class="kw">AFTER</span> <span class="kw">INSERT</span> <span class="kw">OR</span> <span class="kw">UPDATE</span> <span class="kw">OR</span> <span class="kw">DELETE</span> <span class="kw">ON</span> product</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true"></a><span class="cf">FOR</span> <span class="kw">EACH</span> <span class="kw">ROW</span> <span class="kw">EXECUTE</span> <span class="kw">FUNCTION</span> audit_trigger_function();</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Practical Examples</strong>:</p>
        <ol start="2" type="1">
          <li><strong>Order Processing Procedure</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb9">
          <pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">PROCEDURE</span> process_order(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a>    customer_id_param <span class="dt">integer</span>,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a>    items jsonb,  <span class="co">-- Array of {product_id, quantity}</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true"></a>    shipping_address_param jsonb,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true"></a>    payment_method_param text</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true"></a>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true"></a>LANGUAGE plpgsql</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true"></a><span class="kw">AS</span> $$</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true"></a><span class="kw">DECLARE</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true"></a>    new_order_id <span class="dt">integer</span>;</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true"></a>    item_record jsonb;</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true"></a>    product_price <span class="dt">numeric</span>;</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true"></a>    product_stock <span class="dt">integer</span>;</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true"></a>    total_amount <span class="dt">numeric</span> <span class="op">:=</span> <span class="dv">0</span>;</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true"></a>    insufficient_stock <span class="dt">boolean</span> <span class="op">:=</span> <span class="kw">false</span>;</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true"></a>    <span class="co">-- Start transaction</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true"></a>    <span class="cf">BEGIN</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true"></a>        <span class="co">-- Create order record</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true"></a>        <span class="kw">INSERT</span> <span class="kw">INTO</span> orders (</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true"></a>            customer_id,</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true"></a>            order_date,</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true"></a>            status,</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true"></a>            shipping_address,</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true"></a>            payment_method</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true"></a>        )</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true"></a>        <span class="kw">VALUES</span> (</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true"></a>            customer_id_param,</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true"></a>            <span class="fu">CURRENT_DATE</span>,</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true"></a>            <span class="st">&#39;pending&#39;</span>,</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true"></a>            shipping_address_param,</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true"></a>            payment_method_param</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true"></a>        )</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true"></a>        <span class="kw">RETURNING</span> <span class="kw">id</span> <span class="kw">INTO</span> new_order_id;</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true"></a>        </span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true"></a>        <span class="co">-- Process each item</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true"></a>        <span class="cf">FOR</span> item_record <span class="kw">IN</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> jsonb_array_elements(items)</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true"></a>        <span class="cf">LOOP</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true"></a>            <span class="co">-- Get product price and stock</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true"></a>            <span class="kw">SELECT</span> price, stock_level </span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true"></a>            <span class="kw">INTO</span> product_price, product_stock</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true"></a>            <span class="kw">FROM</span> product</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true"></a>            <span class="kw">WHERE</span> product_id <span class="op">=</span> (item_record<span class="op">-&gt;&gt;</span><span class="st">&#39;product_id&#39;</span>):<span class="ch">:integer</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true"></a>            <span class="cf">FOR</span> <span class="kw">UPDATE</span>;  <span class="co">-- Lock the row</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true"></a>            </span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true"></a>            <span class="co">-- Check stock</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true"></a>            <span class="cf">IF</span> product_stock <span class="op">&lt;</span> (item_record<span class="op">-&gt;&gt;</span><span class="st">&#39;quantity&#39;</span>):<span class="ch">:integer</span> <span class="cf">THEN</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true"></a>                insufficient_stock <span class="op">:=</span> <span class="kw">true</span>;</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true"></a>                RAISE NOTICE <span class="st">&#39;Insufficient stock for product %&#39;</span>, </span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true"></a>                             (item_record<span class="op">-&gt;&gt;</span><span class="st">&#39;product_id&#39;</span>):<span class="ch">:integer</span>;</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true"></a>                <span class="kw">CONTINUE</span>;</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true"></a>            <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true"></a>            </span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true"></a>            <span class="co">-- Add order item</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true"></a>            <span class="kw">INSERT</span> <span class="kw">INTO</span> order_item (</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true"></a>                order_id,</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true"></a>                product_id,</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true"></a>                quantity,</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true"></a>                price</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true"></a>            )</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true"></a>            <span class="kw">VALUES</span> (</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true"></a>                new_order_id,</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true"></a>                (item_record<span class="op">-&gt;&gt;</span><span class="st">&#39;product_id&#39;</span>):<span class="ch">:integer</span>,</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true"></a>                (item_record<span class="op">-&gt;&gt;</span><span class="st">&#39;quantity&#39;</span>):<span class="ch">:integer</span>,</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true"></a>                product_price</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true"></a>            );</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true"></a>            </span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true"></a>            <span class="co">-- Update stock</span></span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true"></a>            <span class="kw">UPDATE</span> product</span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true"></a>            <span class="kw">SET</span> stock_level <span class="op">=</span> stock_level <span class="op">-</span> (item_record<span class="op">-&gt;&gt;</span><span class="st">&#39;quantity&#39;</span>):<span class="ch">:integer</span></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true"></a>            <span class="kw">WHERE</span> product_id <span class="op">=</span> (item_record<span class="op">-&gt;&gt;</span><span class="st">&#39;product_id&#39;</span>):<span class="ch">:integer</span>;</span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true"></a>            </span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true"></a>            <span class="co">-- Add to total</span></span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true"></a>            total_amount <span class="op">:=</span> total_amount <span class="op">+</span> (product_price <span class="op">*</span> (item_record<span class="op">-&gt;&gt;</span><span class="st">&#39;quantity&#39;</span>):<span class="ch">:integer</span>);</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true"></a>        <span class="cf">END</span> <span class="cf">LOOP</span>;</span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true"></a>        </span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true"></a>        <span class="co">-- Check if any items had insufficient stock</span></span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true"></a>        <span class="cf">IF</span> insufficient_stock <span class="cf">THEN</span></span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true"></a>            RAISE <span class="kw">EXCEPTION</span> <span class="st">&#39;Order contains items with insufficient stock&#39;</span>;</span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true"></a>        <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true"></a>        </span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true"></a>        <span class="co">-- Update order total</span></span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true"></a>        <span class="kw">UPDATE</span> orders</span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true"></a>        <span class="kw">SET</span> amount <span class="op">=</span> total_amount</span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true"></a>        <span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">=</span> new_order_id;</span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true"></a>        </span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true"></a>        <span class="co">-- Commit transaction</span></span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true"></a>        <span class="kw">COMMIT</span>;</span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true"></a>        </span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true"></a>        <span class="co">-- Return order ID</span></span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true"></a>        RAISE NOTICE <span class="st">&#39;Order % created successfully with total amount %&#39;</span>, </span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true"></a>                     new_order_id, total_amount;</span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true"></a>    <span class="kw">EXCEPTION</span></span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true"></a>        <span class="cf">WHEN</span> OTHERS <span class="cf">THEN</span></span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true"></a>            <span class="co">-- Rollback transaction on error</span></span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true"></a>            <span class="kw">ROLLBACK</span>;</span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true"></a>            RAISE;</span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true"></a>    <span class="cf">END</span>;</span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true"></a>$$;</span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true"></a></span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true"></a><span class="co">-- Usage</span></span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true"></a><span class="kw">CALL</span> process_order(</span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true"></a>    <span class="dv">123</span>,  <span class="co">-- customer_id</span></span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true"></a>    <span class="st">&#39;[</span></span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true"></a><span class="st">        {&quot;product_id&quot;: 101, &quot;quantity&quot;: 2},</span></span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true"></a><span class="st">        {&quot;product_id&quot;: 205, &quot;quantity&quot;: 1}</span></span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true"></a><span class="st">    ]&#39;</span>:<span class="ch">:jsonb</span>,</span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true"></a>    <span class="st">&#39;{&quot;street&quot;: &quot;123 Main St&quot;, &quot;city&quot;: &quot;Anytown&quot;, &quot;zip&quot;: &quot;12345&quot;}&#39;</span>:<span class="ch">:jsonb</span>,</span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true"></a>    <span class="st">&#39;credit_card&#39;</span></span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true"></a>);</span></code></pre>
        </div>
      </section>
      <section>
        <h3 id="triggers-and-event-based-programming">Triggers and Event-Based Programming</h3>
        <p>Triggers allow you to automatically execute a function when certain events occur on a table. They’re useful
          for
          enforcing business rules, maintaining derived data, and creating audit trails.</p>
        <p><strong>Types of Triggers</strong>:</p>
        <ol type="1">
          <li><strong>Row-level triggers</strong>: Execute once for each affected row</li>
          <li><strong>Statement-level triggers</strong>: Execute once per SQL statement</li>
          <li><strong>Before triggers</strong>: Execute before the operation</li>
          <li><strong>After triggers</strong>: Execute after the operation</li>
          <li><strong>Instead of triggers</strong>: Replace the operation (for views)</li>
        </ol>
      </section>
      <section>

        <p><strong>Creating Basic Triggers</strong>:</p>
        <div class="sourceCode" id="cb10">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a><span class="co">-- Create a trigger function</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> update_modified_column()</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a>RETURNS <span class="kw">trigger</span> <span class="kw">AS</span> $$</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true"></a>    <span class="kw">NEW</span>.updated_at <span class="op">=</span> <span class="fu">CURRENT_TIMESTAMP</span>;</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true"></a>    <span class="kw">RETURN</span> <span class="kw">NEW</span>;</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true"></a>$$ LANGUAGE plpgsql;</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true"></a><span class="co">-- Apply the trigger to a table</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TRIGGER</span> set_updated_at</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true"></a><span class="kw">BEFORE</span> <span class="kw">UPDATE</span> <span class="kw">ON</span> product</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true"></a><span class="cf">FOR</span> <span class="kw">EACH</span> <span class="kw">ROW</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true"></a><span class="kw">EXECUTE</span> <span class="kw">FUNCTION</span> update_modified_column();</span></code></pre>
        </div>
      </section>
      <section>

        <p><strong>Trigger Timing and Events</strong>:</p>
        <div class="sourceCode" id="cb11">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a><span class="co">-- Before INSERT trigger</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TRIGGER</span> check_product_price</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a><span class="kw">BEFORE</span> <span class="kw">INSERT</span> <span class="kw">ON</span> product</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true"></a><span class="cf">FOR</span> <span class="kw">EACH</span> <span class="kw">ROW</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true"></a><span class="kw">EXECUTE</span> <span class="kw">FUNCTION</span> validate_product_price();</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true"></a><span class="co">-- After UPDATE trigger</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TRIGGER</span> notify_price_change</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true"></a><span class="kw">AFTER</span> <span class="kw">UPDATE</span> <span class="kw">OF</span> price <span class="kw">ON</span> product</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true"></a><span class="cf">FOR</span> <span class="kw">EACH</span> <span class="kw">ROW</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true"></a><span class="cf">WHEN</span> (<span class="kw">OLD</span>.price <span class="kw">IS</span> <span class="kw">DISTINCT</span> <span class="kw">FROM</span> <span class="kw">NEW</span>.price)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true"></a><span class="kw">EXECUTE</span> <span class="kw">FUNCTION</span> log_price_change();</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true"></a><span class="co">-- Statement-level trigger</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TRIGGER</span> cleanup_after_bulk_update</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true"></a><span class="kw">AFTER</span> <span class="kw">UPDATE</span> <span class="kw">ON</span> inventory</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true"></a><span class="cf">FOR</span> <span class="kw">EACH</span> STATEMENT</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true"></a><span class="kw">EXECUTE</span> <span class="kw">FUNCTION</span> refresh_inventory_summary();</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true"></a><span class="co">-- Multiple events in one trigger</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TRIGGER</span> maintain_audit_log</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true"></a><span class="kw">AFTER</span> <span class="kw">INSERT</span> <span class="kw">OR</span> <span class="kw">UPDATE</span> <span class="kw">OR</span> <span class="kw">DELETE</span> <span class="kw">ON</span> customer</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true"></a><span class="cf">FOR</span> <span class="kw">EACH</span> <span class="kw">ROW</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true"></a><span class="kw">EXECUTE</span> <span class="kw">FUNCTION</span> audit_customer_changes();</span></code></pre>
        </div>
      </section>
      <section>

        <p><strong>Accessing Trigger Data</strong>:</p>
        <p>Within a trigger function, you can access special variables:</p>
        <ul>
          <li><code>NEW</code>: The new row for INSERT/UPDATE operations</li>
          <li><code>OLD</code>: The old row for UPDATE/DELETE operations</li>
          <li><code>TG_OP</code>: The operation (‘INSERT’, ‘UPDATE’, ‘DELETE’)</li>
          <li><code>TG_TABLE_NAME</code>: The name of the table</li>
          <li><code>TG_WHEN</code>: The timing (‘BEFORE’, ‘AFTER’, ‘INSTEAD OF’)</li>
          <li><code>TG_LEVEL</code>: The level (‘ROW’, ‘STATEMENT’)</li>
        </ul>
      </section>
      <section>

        <div class="sourceCode" id="cb12">
          <pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> log_employee_changes()</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a>RETURNS <span class="kw">trigger</span> <span class="kw">AS</span> $$</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true"></a>    <span class="kw">INSERT</span> <span class="kw">INTO</span> employee_audit_log (</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true"></a>        employee_id,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true"></a>        operation,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true"></a>        changed_at,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true"></a>        old_data,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true"></a>        new_data</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true"></a>    )</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true"></a>    <span class="kw">VALUES</span> (</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true"></a>        <span class="cf">CASE</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true"></a>            <span class="cf">WHEN</span> TG_OP <span class="op">=</span> <span class="st">&#39;DELETE&#39;</span> <span class="cf">THEN</span> <span class="kw">OLD</span>.<span class="kw">id</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true"></a>            <span class="cf">ELSE</span> <span class="kw">NEW</span>.<span class="kw">id</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true"></a>        <span class="cf">END</span>,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true"></a>        TG_OP,</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true"></a>        <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true"></a>        <span class="cf">CASE</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true"></a>            <span class="cf">WHEN</span> TG_OP <span class="op">=</span> <span class="st">&#39;INSERT&#39;</span> <span class="cf">THEN</span> <span class="kw">NULL</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true"></a>            <span class="cf">ELSE</span> to_jsonb(<span class="kw">OLD</span>)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true"></a>        <span class="cf">END</span>,</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true"></a>        <span class="cf">CASE</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true"></a>            <span class="cf">WHEN</span> TG_OP <span class="op">=</span> <span class="st">&#39;DELETE&#39;</span> <span class="cf">THEN</span> <span class="kw">NULL</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true"></a>            <span class="cf">ELSE</span> to_jsonb(<span class="kw">NEW</span>)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true"></a>        <span class="cf">END</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true"></a>    );</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true"></a>    </span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true"></a>    <span class="kw">RETURN</span> <span class="kw">NULL</span>;  <span class="co">-- For AFTER triggers, the return value is ignored</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true"></a>$$ LANGUAGE plpgsql;</span></code></pre>
        </div>
      </section>
      <section>

        <p><strong>Conditional Trigger Execution</strong>:</p>
        <div class="sourceCode" id="cb13">
          <pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a><span class="co">-- Using WHEN clause</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TRIGGER</span> check_price_increase</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true"></a><span class="kw">BEFORE</span> <span class="kw">UPDATE</span> <span class="kw">OF</span> price <span class="kw">ON</span> product</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true"></a><span class="cf">FOR</span> <span class="kw">EACH</span> <span class="kw">ROW</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true"></a><span class="cf">WHEN</span> (<span class="kw">NEW</span>.price <span class="op">&gt;</span> <span class="kw">OLD</span>.price <span class="op">*</span> <span class="fl">1.5</span>)  <span class="co">-- Only trigger if price increases by more than 50%</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true"></a><span class="kw">EXECUTE</span> <span class="kw">FUNCTION</span> validate_large_price_increase();</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true"></a><span class="co">-- Using IF in the function</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> check_stock_level()</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true"></a>RETURNS <span class="kw">trigger</span> <span class="kw">AS</span> $$</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true"></a>    <span class="cf">IF</span> <span class="kw">NEW</span>.stock_level <span class="op">&lt;</span> <span class="dv">0</span> <span class="cf">THEN</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true"></a>        RAISE <span class="kw">EXCEPTION</span> <span class="st">&#39;Stock level cannot be negative&#39;</span>;</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true"></a>    </span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true"></a>    <span class="cf">IF</span> <span class="kw">NEW</span>.stock_level <span class="op">&lt;</span> <span class="kw">NEW</span>.reorder_level <span class="kw">AND</span> <span class="kw">NEW</span>.reorder_flag <span class="op">=</span> <span class="kw">FALSE</span> <span class="cf">THEN</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true"></a>        <span class="kw">NEW</span>.reorder_flag <span class="op">:=</span> <span class="kw">TRUE</span>;</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true"></a>    </span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true"></a>    <span class="kw">RETURN</span> <span class="kw">NEW</span>;</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true"></a>$$ LANGUAGE plpgsql;</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Disabling and Enabling Triggers</strong>:</p>
        <div class="sourceCode" id="cb14">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a><span class="co">-- Disable a specific trigger</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> product <span class="kw">DISABLE</span> <span class="kw">TRIGGER</span> set_updated_at;</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true"></a><span class="co">-- Disable all triggers on a table</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> product <span class="kw">DISABLE</span> <span class="kw">TRIGGER</span> <span class="kw">ALL</span>;</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true"></a><span class="co">-- Enable a specific trigger</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> product <span class="kw">ENABLE</span> <span class="kw">TRIGGER</span> set_updated_at;</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true"></a><span class="co">-- Enable all triggers on a table</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> product <span class="kw">ENABLE</span> <span class="kw">TRIGGER</span> <span class="kw">ALL</span>;</span></code></pre>
        </div>
      </section>
      <section>

        <p><strong>Practical Trigger Examples</strong>:</p>
        <ol type="1">
          <li><strong>Maintaining a Denormalized Summary Table</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb15">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a><span class="co">-- Create summary table</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> order_summary (</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true"></a>    customer_id <span class="dt">integer</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true"></a>    total_orders <span class="dt">integer</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="dv">0</span>,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true"></a>    total_spent <span class="dt">numeric</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="dv">0</span>,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true"></a>    last_order_date <span class="dt">date</span>,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true"></a>    avg_order_value <span class="dt">numeric</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true"></a>);</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true"></a><span class="co">-- Create trigger function</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> update_order_summary()</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true"></a>RETURNS <span class="kw">trigger</span> <span class="kw">AS</span> $$</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true"></a>    <span class="co">-- For new orders</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true"></a>    <span class="cf">IF</span> (TG_OP <span class="op">=</span> <span class="st">&#39;INSERT&#39;</span>) <span class="cf">THEN</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true"></a>        <span class="kw">INSERT</span> <span class="kw">INTO</span> order_summary (</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true"></a>            customer_id,</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true"></a>            total_orders,</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true"></a>            total_spent,</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true"></a>            last_order_date,</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true"></a>            avg_order_value</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true"></a>        )</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true"></a>        <span class="kw">VALUES</span> (</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true"></a>            <span class="kw">NEW</span>.customer_id,</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true"></a>            <span class="dv">1</span>,</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true"></a>            <span class="kw">NEW</span>.amount,</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true"></a>            <span class="kw">NEW</span>.order_date,</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true"></a>            <span class="kw">NEW</span>.amount</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true"></a>        )</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true"></a>        <span class="kw">ON</span> CONFLICT (customer_id) DO <span class="kw">UPDATE</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true"></a>        <span class="kw">SET</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true"></a>            total_orders <span class="op">=</span> order_summary.total_orders <span class="op">+</span> <span class="dv">1</span>,</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true"></a>            total_spent <span class="op">=</span> order_summary.total_spent <span class="op">+</span> <span class="kw">NEW</span>.amount,</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true"></a>            last_order_date <span class="op">=</span> <span class="fu">GREATEST</span>(order_summary.last_order_date, <span class="kw">NEW</span>.order_date),</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true"></a>            avg_order_value <span class="op">=</span> (order_summary.total_spent <span class="op">+</span> <span class="kw">NEW</span>.amount) <span class="op">/</span> (order_summary.total_orders <span class="op">+</span> <span class="dv">1</span>);</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true"></a>    </span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true"></a>    <span class="co">-- For updated orders</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true"></a>    <span class="cf">ELSIF</span> (TG_OP <span class="op">=</span> <span class="st">&#39;UPDATE&#39;</span>) <span class="cf">THEN</span></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true"></a>        <span class="co">-- Only process if amount changed</span></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true"></a>        <span class="cf">IF</span> <span class="kw">OLD</span>.amount <span class="kw">IS</span> <span class="kw">DISTINCT</span> <span class="kw">FROM</span> <span class="kw">NEW</span>.amount <span class="cf">THEN</span></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true"></a>            <span class="kw">UPDATE</span> order_summary</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true"></a>            <span class="kw">SET</span></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true"></a>                total_spent <span class="op">=</span> total_spent <span class="op">-</span> <span class="kw">OLD</span>.amount <span class="op">+</span> <span class="kw">NEW</span>.amount,</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true"></a>                last_order_date <span class="op">=</span> <span class="fu">GREATEST</span>(last_order_date, <span class="kw">NEW</span>.order_date),</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true"></a>                avg_order_value <span class="op">=</span> (total_spent <span class="op">-</span> <span class="kw">OLD</span>.amount <span class="op">+</span> <span class="kw">NEW</span>.amount) <span class="op">/</span> total_orders</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true"></a>            <span class="kw">WHERE</span> customer_id <span class="op">=</span> <span class="kw">NEW</span>.customer_id;</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true"></a>        <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true"></a>    </span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true"></a>    <span class="co">-- For deleted orders</span></span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true"></a>    <span class="cf">ELSIF</span> (TG_OP <span class="op">=</span> <span class="st">&#39;DELETE&#39;</span>) <span class="cf">THEN</span></span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true"></a>        <span class="kw">UPDATE</span> order_summary</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true"></a>        <span class="kw">SET</span></span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true"></a>            total_orders <span class="op">=</span> total_orders <span class="op">-</span> <span class="dv">1</span>,</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true"></a>            total_spent <span class="op">=</span> total_spent <span class="op">-</span> <span class="kw">OLD</span>.amount,</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true"></a>            last_order_date <span class="op">=</span> (</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true"></a>                <span class="kw">SELECT</span> <span class="fu">MAX</span>(order_date)</span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true"></a>                <span class="kw">FROM</span> orders</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true"></a>                <span class="kw">WHERE</span> customer_id <span class="op">=</span> <span class="kw">OLD</span>.customer_id</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true"></a>                  <span class="kw">AND</span> <span class="kw">id</span> <span class="op">!=</span> <span class="kw">OLD</span>.<span class="kw">id</span></span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true"></a>            ),</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true"></a>            avg_order_value <span class="op">=</span> <span class="cf">CASE</span></span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true"></a>                <span class="cf">WHEN</span> total_orders <span class="op">-</span> <span class="dv">1</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">THEN</span> (total_spent <span class="op">-</span> <span class="kw">OLD</span>.amount) <span class="op">/</span> (total_orders <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true"></a>                <span class="cf">ELSE</span> <span class="dv">0</span></span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true"></a>            <span class="cf">END</span></span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true"></a>        <span class="kw">WHERE</span> customer_id <span class="op">=</span> <span class="kw">OLD</span>.customer_id;</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true"></a>        </span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true"></a>        <span class="co">-- If no orders left, remove summary record</span></span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true"></a>        <span class="kw">DELETE</span> <span class="kw">FROM</span> order_summary</span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true"></a>        <span class="kw">WHERE</span> customer_id <span class="op">=</span> <span class="kw">OLD</span>.customer_id</span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true"></a>          <span class="kw">AND</span> total_orders <span class="op">=</span> <span class="dv">0</span>;</span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true"></a>    </span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true"></a>    <span class="kw">RETURN</span> <span class="kw">NULL</span>;</span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true"></a>$$ LANGUAGE plpgsql;</span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true"></a></span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true"></a><span class="co">-- Create the trigger</span></span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TRIGGER</span> maintain_order_summary</span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true"></a><span class="kw">AFTER</span> <span class="kw">INSERT</span> <span class="kw">OR</span> <span class="kw">UPDATE</span> <span class="kw">OR</span> <span class="kw">DELETE</span> <span class="kw">ON</span> orders</span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true"></a><span class="cf">FOR</span> <span class="kw">EACH</span> <span class="kw">ROW</span></span>
<span id="cb15-81"><a href="#cb15-81" aria-hidden="true"></a><span class="kw">EXECUTE</span> <span class="kw">FUNCTION</span> update_order_summary();</span></code></pre>
        </div>
      </section>
      <section>

        <ol start="2" type="1">
          <li><strong>Enforcing Business Rules</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb16">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a><span class="co">-- Prevent deletion of active customers</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> prevent_active_customer_deletion()</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true"></a>RETURNS <span class="kw">trigger</span> <span class="kw">AS</span> $$</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true"></a>    <span class="cf">IF</span> <span class="kw">EXISTS</span> (</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true"></a>        <span class="kw">SELECT</span> <span class="dv">1</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true"></a>        <span class="kw">FROM</span> orders</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true"></a>        <span class="kw">WHERE</span> customer_id <span class="op">=</span> <span class="kw">OLD</span>.<span class="kw">id</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true"></a>          <span class="kw">AND</span> status <span class="kw">IN</span> (<span class="st">&#39;pending&#39;</span>, <span class="st">&#39;processing&#39;</span>)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true"></a>    ) <span class="cf">THEN</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true"></a>        RAISE <span class="kw">EXCEPTION</span> <span class="st">&#39;Cannot delete customer with pending or processing orders&#39;</span>;</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true"></a>    </span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true"></a>    <span class="kw">RETURN</span> <span class="kw">OLD</span>;</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true"></a>$$ LANGUAGE plpgsql;</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TRIGGER</span> check_before_customer_deletion</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true"></a><span class="kw">BEFORE</span> <span class="kw">DELETE</span> <span class="kw">ON</span> customer</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true"></a><span class="cf">FOR</span> <span class="kw">EACH</span> <span class="kw">ROW</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true"></a><span class="kw">EXECUTE</span> <span class="kw">FUNCTION</span> prevent_active_customer_deletion();</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true"></a><span class="co">-- Enforce price constraints</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> validate_product_price()</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true"></a>RETURNS <span class="kw">trigger</span> <span class="kw">AS</span> $$</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true"></a>    <span class="co">-- Check minimum price</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true"></a>    <span class="cf">IF</span> <span class="kw">NEW</span>.price <span class="op">&lt;</span> <span class="dv">0</span> <span class="cf">THEN</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true"></a>        RAISE <span class="kw">EXCEPTION</span> <span class="st">&#39;Product price cannot be negative&#39;</span>;</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true"></a>    </span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true"></a>    <span class="co">-- Check maximum price increase</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true"></a>    <span class="cf">IF</span> TG_OP <span class="op">=</span> <span class="st">&#39;UPDATE&#39;</span> <span class="kw">AND</span> <span class="kw">NEW</span>.price <span class="op">&gt;</span> <span class="kw">OLD</span>.price <span class="op">*</span> <span class="dv">2</span> <span class="cf">THEN</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true"></a>        RAISE <span class="kw">EXCEPTION</span> <span class="st">&#39;Price increase cannot exceed 100%%&#39;</span>;</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true"></a>    </span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true"></a>    <span class="co">-- Check discount price</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true"></a>    <span class="cf">IF</span> <span class="kw">NEW</span>.discount_price <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="cf">THEN</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true"></a>        <span class="cf">IF</span> <span class="kw">NEW</span>.discount_price <span class="op">&gt;=</span> <span class="kw">NEW</span>.price <span class="cf">THEN</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true"></a>            RAISE <span class="kw">EXCEPTION</span> <span class="st">&#39;Discount price must be less than regular price&#39;</span>;</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true"></a>        <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true"></a>        </span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true"></a>        <span class="cf">IF</span> <span class="kw">NEW</span>.discount_price <span class="op">&lt;</span> <span class="kw">NEW</span>.price <span class="op">*</span> <span class="fl">0.5</span> <span class="cf">THEN</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true"></a>            RAISE <span class="kw">EXCEPTION</span> <span class="st">&#39;Discount cannot exceed 50%%&#39;</span>;</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true"></a>        <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true"></a>    </span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true"></a>    <span class="kw">RETURN</span> <span class="kw">NEW</span>;</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true"></a>$$ LANGUAGE plpgsql;</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true"></a></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TRIGGER</span> enforce_price_rules</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true"></a><span class="kw">BEFORE</span> <span class="kw">INSERT</span> <span class="kw">OR</span> <span class="kw">UPDATE</span> <span class="kw">OF</span> price, discount_price <span class="kw">ON</span> product</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true"></a><span class="cf">FOR</span> <span class="kw">EACH</span> <span class="kw">ROW</span></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true"></a><span class="kw">EXECUTE</span> <span class="kw">FUNCTION</span> validate_product_price();</span></code></pre>
        </div>
      </section>
      <section>

        <ol start="3" type="1">
          <li><strong>Implementing Soft Deletes</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb17">
          <pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true"></a><span class="co">-- Add deleted_at column to tables</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> customer <span class="kw">ADD</span> <span class="kw">COLUMN</span> deleted_at <span class="dt">timestamp</span>;</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> product <span class="kw">ADD</span> <span class="kw">COLUMN</span> deleted_at <span class="dt">timestamp</span>;</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true"></a><span class="co">-- Create soft delete function</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> soft_delete()</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true"></a>RETURNS <span class="kw">trigger</span> <span class="kw">AS</span> $$</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true"></a>    <span class="co">-- Update the row instead of deleting it</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true"></a>    <span class="kw">UPDATE</span> <span class="kw">ONLY</span> customer</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true"></a>    <span class="kw">SET</span> deleted_at <span class="op">=</span> <span class="fu">CURRENT_TIMESTAMP</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true"></a>    <span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">=</span> <span class="kw">OLD</span>.<span class="kw">id</span>;</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true"></a>    </span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true"></a>    <span class="co">-- Prevent the actual deletion</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true"></a>    <span class="kw">RETURN</span> <span class="kw">NULL</span>;</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true"></a>$$ LANGUAGE plpgsql;</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true"></a></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true"></a><span class="co">-- Create trigger</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TRIGGER</span> customer_soft_delete</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true"></a><span class="kw">BEFORE</span> <span class="kw">DELETE</span> <span class="kw">ON</span> customer</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true"></a><span class="cf">FOR</span> <span class="kw">EACH</span> <span class="kw">ROW</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true"></a><span class="cf">WHEN</span> (<span class="kw">OLD</span>.deleted_at <span class="kw">IS</span> <span class="kw">NULL</span>)</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true"></a><span class="kw">EXECUTE</span> <span class="kw">FUNCTION</span> soft_delete();</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true"></a></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true"></a><span class="co">-- Create views that filter out deleted records</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">VIEW</span> active_customers <span class="kw">AS</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> customer <span class="kw">WHERE</span> deleted_at <span class="kw">IS</span> <span class="kw">NULL</span>;</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true"></a></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true"></a><span class="co">-- Modify queries to respect soft deletes</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> get_customer(customer_id_param <span class="dt">integer</span>)</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true"></a>RETURNS customer <span class="kw">AS</span> $$</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true"></a>    <span class="kw">RETURN</span> (</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true"></a>        <span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true"></a>        <span class="kw">FROM</span> customer</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true"></a>        <span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">=</span> customer_id_param</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true"></a>          <span class="kw">AND</span> deleted_at <span class="kw">IS</span> <span class="kw">NULL</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true"></a>    );</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true"></a>$$ LANGUAGE plpgsql;</span></code></pre>
        </div>
      </section>
      <section>

        <h3 id="advanced-indexing-and-query-optimization">Advanced Indexing and Query Optimization</h3>
        <p>Building on our earlier discussion of indexing, let’s explore some advanced indexing techniques and query
          optimization strategies.</p>
        <p><strong>Partial Indexes with Complex Conditions</strong>:</p>
        <div class="sourceCode" id="cb18">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a><span class="co">-- Partial index for active orders</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_active_orders <span class="kw">ON</span> orders(order_date)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true"></a><span class="kw">WHERE</span> status <span class="kw">IN</span> (<span class="st">&#39;pending&#39;</span>, <span class="st">&#39;processing&#39;</span>);</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true"></a><span class="co">-- Partial index for high-value products</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_high_value_products <span class="kw">ON</span> product(name, category_id)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true"></a><span class="kw">WHERE</span> price <span class="op">&gt;</span> <span class="dv">1000</span>;</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true"></a><span class="co">-- Partial index with function</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_recent_customer_activity <span class="kw">ON</span> customer(last_activity_date)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true"></a><span class="kw">WHERE</span> last_activity_date <span class="op">&gt;</span> <span class="fu">CURRENT_DATE</span> <span class="op">-</span> <span class="dt">INTERVAL</span> <span class="st">&#39;90 days&#39;</span>;</span></code></pre>
        </div>
      </section>
      <section>

        <p><strong>Functional Indexes for Complex Queries</strong>:</p>
        <div class="sourceCode" id="cb19">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true"></a><span class="co">-- Index for case-insensitive search</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_customer_name_lower <span class="kw">ON</span> customer(<span class="fu">LOWER</span>(name));</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true"></a><span class="co">-- Index for date extraction</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_order_year_month <span class="kw">ON</span> orders(</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true"></a>    <span class="fu">EXTRACT</span>(<span class="dt">YEAR</span> <span class="kw">FROM</span> order_date),</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true"></a>    <span class="fu">EXTRACT</span>(<span class="dt">MONTH</span> <span class="kw">FROM</span> order_date)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true"></a>);</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true"></a><span class="co">-- Index for JSON/JSONB paths</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_product_attributes_material <span class="kw">ON</span> product((<span class="kw">attributes</span><span class="op">-&gt;&gt;</span><span class="st">&#39;material&#39;</span>));</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true"></a><span class="co">-- Index for computed values</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_order_item_total <span class="kw">ON</span> order_item((quantity <span class="op">*</span> price));</span></code></pre>
        </div>
      </section>
      <section>

        <p><strong>Covering Indexes for Performance</strong>:</p>
        <div class="sourceCode" id="cb20">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true"></a><span class="co">-- Include additional columns in the index</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_order_customer_date_include_status <span class="kw">ON</span> orders(customer_id, order_date)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true"></a>INCLUDE (status, amount);</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true"></a><span class="co">-- Test with EXPLAIN</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true"></a><span class="kw">EXPLAIN</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true"></a><span class="kw">SELECT</span> customer_id, order_date, status, amount</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true"></a><span class="kw">FROM</span> orders</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true"></a><span class="kw">WHERE</span> customer_id <span class="op">=</span> <span class="dv">123</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true"></a>  <span class="kw">AND</span> order_date <span class="op">&gt;</span> <span class="st">&#39;2023-01-01&#39;</span>;</span></code></pre>
        </div>
      </section>
      <section>

        <p><strong>Index-Only Scans</strong>:</p>
        <div class="sourceCode" id="cb21">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true"></a><span class="co">-- Create an index that covers all needed columns</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_product_category_price <span class="kw">ON</span> product(category_id, price)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true"></a>INCLUDE (name);</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true"></a><span class="co">-- Query that can use index-only scan</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true"></a><span class="kw">EXPLAIN</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true"></a><span class="kw">SELECT</span> name, price</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true"></a><span class="kw">FROM</span> product</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true"></a><span class="kw">WHERE</span> category_id <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true"></a><span class="kw">ORDER</span> <span class="kw">BY</span> price <span class="kw">DESC</span>;</span></code></pre>
        </div>
      </section>
      <section>

        <p><strong>Optimizing Joins with Specialized Indexes</strong>:</p>
        <div class="sourceCode" id="cb22">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true"></a><span class="co">-- Index for foreign key columns</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_order_item_order_id <span class="kw">ON</span> order_item(order_id);</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_order_item_product_id <span class="kw">ON</span> order_item(product_id);</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true"></a><span class="co">-- Composite index for common join patterns</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_order_item_order_product <span class="kw">ON</span> order_item(order_id, product_id);</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true"></a><span class="co">-- Index for multi-table join conditions</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_inventory_product_location <span class="kw">ON</span> inventory(product_id, location_id);</span></code></pre>
        </div>
      </section>
      <section>

        <p><strong>Using pg_stat_statements for Query Analysis</strong>:</p>
        <div class="sourceCode" id="cb23">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true"></a><span class="co">-- Enable the extension</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true"></a><span class="kw">CREATE</span> EXTENSION pg_stat_statements;</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true"></a><span class="co">-- View the most time-consuming queries</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true"></a>    <span class="kw">query</span>,</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true"></a>    calls,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true"></a>    total_exec_time <span class="op">/</span> <span class="dv">1000</span> <span class="kw">AS</span> total_exec_time_sec,</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true"></a>    min_exec_time <span class="op">/</span> <span class="dv">1000</span> <span class="kw">AS</span> min_exec_time_sec,</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true"></a>    max_exec_time <span class="op">/</span> <span class="dv">1000</span> <span class="kw">AS</span> max_exec_time_sec,</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true"></a>    mean_exec_time <span class="op">/</span> <span class="dv">1000</span> <span class="kw">AS</span> mean_exec_time_sec,</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true"></a>    stddev_exec_time <span class="op">/</span> <span class="dv">1000</span> <span class="kw">AS</span> stddev_exec_time_sec,</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true"></a>    <span class="kw">rows</span>,</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true"></a>    shared_blks_hit,</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true"></a>    shared_blks_read,</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true"></a>    shared_blks_dirtied,</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true"></a>    shared_blks_written</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true"></a>    pg_stat_statements</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true"></a>    total_exec_time <span class="kw">DESC</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true"></a><span class="kw">LIMIT</span> <span class="dv">10</span>;</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true"></a></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true"></a><span class="co">-- Reset statistics</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true"></a><span class="kw">SELECT</span> pg_stat_statements_reset();</span></code></pre>
        </div>
      </section>
      <section>

        <p><strong>Optimizing with Parallel Query Execution</strong>:</p>
        <div class="sourceCode" id="cb24">
          <pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true"></a><span class="co">-- Check parallel query settings</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true"></a>SHOW max_parallel_workers_per_gather;</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true"></a>SHOW max_parallel_workers;</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true"></a>SHOW parallel_setup_cost;</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true"></a>SHOW parallel_tuple_cost;</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true"></a><span class="co">-- Adjust for the session</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true"></a><span class="kw">SET</span> max_parallel_workers_per_gather <span class="op">=</span> <span class="dv">4</span>;</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true"></a><span class="co">-- Test a query with parallel execution</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true"></a><span class="kw">EXPLAIN</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true"></a>    c.category_name,</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true"></a>    <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> product_count,</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true"></a>    <span class="fu">AVG</span>(p.price) <span class="kw">AS</span> avg_price</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true"></a>    product p</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true"></a><span class="kw">JOIN</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true"></a>    <span class="kw">category</span> c <span class="kw">ON</span> p.category_id <span class="op">=</span> c.<span class="kw">id</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true"></a>    c.category_name;</span></code></pre>
        </div>
      </section>
      <section>

        <p><strong>Optimizing with Materialized Views</strong>:</p>
        <div class="sourceCode" id="cb25">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true"></a><span class="co">-- Create a materialized view for expensive queries</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">MATERIALIZED</span> <span class="kw">VIEW</span> product_sales_summary <span class="kw">AS</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true"></a>    p.product_id,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true"></a>    p.name <span class="kw">AS</span> product_name,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true"></a>    c.category_name,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true"></a>    <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> oi.order_id) <span class="kw">AS</span> order_count,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true"></a>    <span class="fu">SUM</span>(oi.quantity) <span class="kw">AS</span> units_sold,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true"></a>    <span class="fu">SUM</span>(oi.quantity <span class="op">*</span> oi.price) <span class="kw">AS</span> revenue</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true"></a>    product p</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true"></a><span class="kw">JOIN</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true"></a>    <span class="kw">category</span> c <span class="kw">ON</span> p.category_id <span class="op">=</span> c.category_id</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true"></a>    order_item oi <span class="kw">ON</span> p.product_id <span class="op">=</span> oi.product_id</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true"></a>    p.product_id, p.name, c.category_name;</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true"></a></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true"></a><span class="co">-- Create indexes on the materialized view</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_product_sales_summary_product <span class="kw">ON</span> product_sales_summary(product_id);</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_product_sales_summary_category <span class="kw">ON</span> product_sales_summary(category_name);</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true"></a></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true"></a><span class="co">-- Refresh the materialized view</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true"></a><span class="kw">REFRESH</span> <span class="kw">MATERIALIZED</span> <span class="kw">VIEW</span> product_sales_summary;</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true"></a></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true"></a><span class="co">-- Query the materialized view</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true"></a>    category_name,</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true"></a>    <span class="fu">SUM</span>(units_sold) <span class="kw">AS</span> total_units,</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true"></a>    <span class="fu">SUM</span>(revenue) <span class="kw">AS</span> total_revenue</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true"></a>    product_sales_summary</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true"></a>    category_name</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true"></a>    total_revenue <span class="kw">DESC</span>;</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Query Optimization Techniques</strong>:</p>
        <ol type="1">
          <li><strong>Rewriting Subqueries as Joins</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb26">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true"></a><span class="co">-- Subquery version</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true"></a>    c.name,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true"></a>    (<span class="kw">SELECT</span> <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">FROM</span> orders o <span class="kw">WHERE</span> o.customer_id <span class="op">=</span> c.<span class="kw">id</span>) <span class="kw">AS</span> order_count</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true"></a>    customer c;</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true"></a><span class="co">-- Join version (often more efficient)</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true"></a>    c.name,</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true"></a>    <span class="fu">COUNT</span>(o.<span class="kw">id</span>) <span class="kw">AS</span> order_count</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true"></a>    customer c</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true"></a>    orders o <span class="kw">ON</span> c.<span class="kw">id</span> <span class="op">=</span> o.customer_id</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true"></a>    c.<span class="kw">id</span>, c.name;</span></code></pre>
        </div>
      </section>
      <section>
        <ol start="2" type="1">
          <li><strong>Using CTEs for Complex Queries</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb27">
          <pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true"></a><span class="co">-- Break down complex logic with CTEs</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true"></a><span class="kw">WITH</span> monthly_sales <span class="kw">AS</span> (</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true"></a>    <span class="kw">SELECT</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true"></a>        DATE_TRUNC(<span class="st">&#39;month&#39;</span>, order_date) <span class="kw">AS</span> <span class="dt">month</span>,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true"></a>        <span class="fu">SUM</span>(amount) <span class="kw">AS</span> total_sales</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true"></a>    <span class="kw">FROM</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true"></a>        orders</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true"></a>    <span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true"></a>        DATE_TRUNC(<span class="st">&#39;month&#39;</span>, order_date)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true"></a>),</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true"></a>sales_growth <span class="kw">AS</span> (</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true"></a>    <span class="kw">SELECT</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true"></a>        <span class="dt">month</span>,</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true"></a>        total_sales,</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true"></a>        <span class="fu">LAG</span>(total_sales) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">month</span>) <span class="kw">AS</span> prev_month_sales</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true"></a>    <span class="kw">FROM</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true"></a>        monthly_sales</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true"></a>)</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true"></a>    <span class="dt">month</span>,</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true"></a>    total_sales,</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true"></a>    prev_month_sales,</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true"></a>    (total_sales <span class="op">-</span> prev_month_sales) <span class="op">/</span> <span class="fu">NULLIF</span>(prev_month_sales, <span class="dv">0</span>) <span class="op">*</span> <span class="dv">100</span> <span class="kw">AS</span> growth_percent</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true"></a>    sales_growth</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true"></a>    <span class="dt">month</span>;</span></code></pre>
        </div>
      </section>
      <section>
        <ol start="3" type="1">
          <li><strong>Optimizing IN Clauses with Arrays</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb28">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true"></a><span class="co">-- Standard IN clause</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> product <span class="kw">WHERE</span> category_id <span class="kw">IN</span> (<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>);</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true"></a><span class="co">-- Using ANY with array (can be more efficient for large lists)</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> product <span class="kw">WHERE</span> category_id <span class="op">=</span> <span class="kw">ANY</span>(<span class="dt">ARRAY</span>[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>]);</span></code></pre>
        </div>
        <ol start="4" type="1">
          <li><strong>Using LATERAL Joins for Row-by-Row Processing</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb29">
          <pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true"></a><span class="co">-- Get each customer&#39;s top 3 orders</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true"></a>    c.name <span class="kw">AS</span> customer_name,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true"></a>    o.order_id,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true"></a>    o.order_date,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true"></a>    o.amount</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true"></a>    customer c</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true"></a><span class="kw">CROSS</span> <span class="kw">JOIN</span> LATERAL (</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true"></a>    <span class="kw">SELECT</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true"></a>        <span class="kw">id</span> <span class="kw">AS</span> order_id,</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true"></a>        order_date,</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true"></a>        amount</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true"></a>    <span class="kw">FROM</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true"></a>        orders</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true"></a>    <span class="kw">WHERE</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true"></a>        customer_id <span class="op">=</span> c.<span class="kw">id</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true"></a>    <span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true"></a>        amount <span class="kw">DESC</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true"></a>    <span class="kw">LIMIT</span> <span class="dv">3</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true"></a>) o;</span></code></pre>
        </div>
      </section>
      <section>
        <ol start="5" type="1">
          <li><strong>Optimizing Aggregations with Window Functions</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb30">
          <pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true"></a><span class="co">-- Without window functions (requires multiple scans)</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true"></a>    category_id,</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true"></a>    product_id,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true"></a>    name,</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true"></a>    price,</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true"></a>    (<span class="kw">SELECT</span> <span class="fu">AVG</span>(price) <span class="kw">FROM</span> product p2 <span class="kw">WHERE</span> p2.category_id <span class="op">=</span> p1.category_id) <span class="kw">AS</span> category_avg_price</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true"></a>    product p1;</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true"></a></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true"></a><span class="co">-- With window functions (single scan)</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true"></a>    category_id,</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true"></a>    product_id,</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true"></a>    name,</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true"></a>    price,</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true"></a>    <span class="fu">AVG</span>(price) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> category_id) <span class="kw">AS</span> category_avg_price</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true"></a>    product;</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Advanced Performance Tuning</strong>:</p>
        <ol type="1">
          <li><strong>Table Partitioning</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb31">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true"></a><span class="co">-- Create a partitioned table</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> orders (</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true"></a>    <span class="kw">id</span> serial,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true"></a>    order_date <span class="dt">date</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true"></a>    customer_id <span class="dt">integer</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true"></a>    amount <span class="dt">numeric</span>(<span class="dv">10</span>,<span class="dv">2</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true"></a>    <span class="kw">PRIMARY</span> <span class="kw">KEY</span> (<span class="kw">id</span>, order_date)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true"></a>) <span class="kw">PARTITION</span> <span class="kw">BY</span> <span class="kw">RANGE</span> (order_date);</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true"></a><span class="co">-- Create partitions</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> orders_2023_q1 <span class="kw">PARTITION</span> <span class="kw">OF</span> orders</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true"></a>    <span class="cf">FOR</span> <span class="kw">VALUES</span> <span class="kw">FROM</span> (<span class="st">&#39;2023-01-01&#39;</span>) <span class="kw">TO</span> (<span class="st">&#39;2023-04-01&#39;</span>);</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true"></a></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> orders_2023_q2 <span class="kw">PARTITION</span> <span class="kw">OF</span> orders</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true"></a>    <span class="cf">FOR</span> <span class="kw">VALUES</span> <span class="kw">FROM</span> (<span class="st">&#39;2023-04-01&#39;</span>) <span class="kw">TO</span> (<span class="st">&#39;2023-07-01&#39;</span>);</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true"></a></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> orders_2023_q3 <span class="kw">PARTITION</span> <span class="kw">OF</span> orders</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true"></a>    <span class="cf">FOR</span> <span class="kw">VALUES</span> <span class="kw">FROM</span> (<span class="st">&#39;2023-07-01&#39;</span>) <span class="kw">TO</span> (<span class="st">&#39;2023-10-01&#39;</span>);</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true"></a></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> orders_2023_q4 <span class="kw">PARTITION</span> <span class="kw">OF</span> orders</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true"></a>    <span class="cf">FOR</span> <span class="kw">VALUES</span> <span class="kw">FROM</span> (<span class="st">&#39;2023-10-01&#39;</span>) <span class="kw">TO</span> (<span class="st">&#39;2024-01-01&#39;</span>);</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true"></a></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true"></a><span class="co">-- Create indexes on partitions</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_orders_2023_q1_customer <span class="kw">ON</span> orders_2023_q1(customer_id);</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_orders_2023_q2_customer <span class="kw">ON</span> orders_2023_q2(customer_id);</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_orders_2023_q3_customer <span class="kw">ON</span> orders_2023_q3(customer_id);</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_orders_2023_q4_customer <span class="kw">ON</span> orders_2023_q4(customer_id);</span></code></pre>
        </div>
      </section>
      <section>
        <ol start="2" type="1">
          <li><strong>Optimizing with Prepared Statements</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb32">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true"></a><span class="co">-- Create a prepared statement</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true"></a><span class="kw">PREPARE</span> get_customer_orders(<span class="dt">integer</span>) <span class="kw">AS</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true"></a>    o.<span class="kw">id</span>,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true"></a>    o.order_date,</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true"></a>    o.amount,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true"></a>    <span class="fu">COUNT</span>(oi.product_id) <span class="kw">AS</span> item_count</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true"></a>    orders o</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true"></a><span class="kw">JOIN</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true"></a>    order_item oi <span class="kw">ON</span> o.<span class="kw">id</span> <span class="op">=</span> oi.order_id</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true"></a><span class="kw">WHERE</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true"></a>    o.customer_id <span class="op">=</span> $<span class="dv">1</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true"></a>    o.<span class="kw">id</span>, o.order_date, o.amount</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true"></a>    o.order_date <span class="kw">DESC</span>;</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true"></a></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true"></a><span class="co">-- Execute the prepared statement</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true"></a><span class="kw">EXECUTE</span> get_customer_orders(<span class="dv">123</span>);</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true"></a><span class="kw">EXECUTE</span> get_customer_orders(<span class="dv">456</span>);</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true"></a></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true"></a><span class="co">-- Deallocate when done</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true"></a><span class="kw">DEALLOCATE</span> get_customer_orders;</span></code></pre>
        </div>
      </section>
      <section>
        <ol start="3" type="1">
          <li><strong>Using Advisory Locks for Application-Level Locking</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb33">
          <pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true"></a><span class="co">-- Acquire an advisory lock</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true"></a><span class="kw">SELECT</span> pg_advisory_lock(<span class="dv">123</span>);</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true"></a><span class="co">-- Try to acquire a lock with timeout</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true"></a><span class="kw">SELECT</span> pg_try_advisory_lock_shared(<span class="dv">123</span>);</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true"></a><span class="co">-- Release a lock</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true"></a><span class="kw">SELECT</span> pg_advisory_unlock(<span class="dv">123</span>);</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true"></a><span class="co">-- Example: Implementing a job queue</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> process_next_job()</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true"></a>RETURNS <span class="dt">integer</span> <span class="kw">AS</span> $$</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true"></a><span class="kw">DECLARE</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true"></a>    job_id <span class="dt">integer</span>;</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true"></a>    <span class="co">-- Begin transaction</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true"></a>    <span class="cf">BEGIN</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true"></a>        <span class="co">-- Get the next job and lock it</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true"></a>        <span class="kw">SELECT</span> <span class="kw">id</span> <span class="kw">INTO</span> job_id</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true"></a>        <span class="kw">FROM</span> job_queue</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true"></a>        <span class="kw">WHERE</span> status <span class="op">=</span> <span class="st">&#39;pending&#39;</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true"></a>        <span class="kw">ORDER</span> <span class="kw">BY</span> priority <span class="kw">DESC</span>, created_at</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true"></a>        <span class="kw">LIMIT</span> <span class="dv">1</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true"></a>        <span class="cf">FOR</span> <span class="kw">UPDATE</span> <span class="kw">SKIP</span> <span class="kw">LOCKED</span>;</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true"></a>        </span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true"></a>        <span class="co">-- If no job found, return 0</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true"></a>        <span class="cf">IF</span> job_id <span class="kw">IS</span> <span class="kw">NULL</span> <span class="cf">THEN</span></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true"></a>            <span class="kw">RETURN</span> <span class="dv">0</span>;</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true"></a>        <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true"></a>        </span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true"></a>        <span class="co">-- Update job status</span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true"></a>        <span class="kw">UPDATE</span> job_queue</span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true"></a>        <span class="kw">SET</span></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true"></a>            status <span class="op">=</span> <span class="st">&#39;processing&#39;</span>,</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true"></a>            started_at <span class="op">=</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true"></a>            worker_id <span class="op">=</span> pg_backend_pid()</span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true"></a>        <span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">=</span> job_id;</span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true"></a>        </span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true"></a>        <span class="co">-- Commit transaction</span></span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true"></a>        <span class="kw">COMMIT</span>;</span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true"></a>        </span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true"></a>        <span class="kw">RETURN</span> job_id;</span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true"></a>    <span class="kw">EXCEPTION</span></span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true"></a>        <span class="cf">WHEN</span> OTHERS <span class="cf">THEN</span></span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true"></a>            <span class="co">-- Rollback on error</span></span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true"></a>            <span class="kw">ROLLBACK</span>;</span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true"></a>            RAISE;</span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true"></a>    <span class="cf">END</span>;</span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true"></a>$$ LANGUAGE plpgsql;</span></code></pre>
        </div>
      </section>
      <section>
        <h3 id="working-with-json-and-jsonb-data">Working with JSON and JSONB Data</h3>
        <p>PostgreSQL provides robust support for JSON data, allowing you to store and query semi-structured data
          efficiently.</p>
        <p><strong>JSON vs. JSONB</strong>:</p>
        <p>PostgreSQL offers two JSON data types:</p>
        <ol type="1">
          <li><strong>JSON</strong>: Stores the exact text of the JSON input, including whitespace</li>
          <li><strong>JSONB</strong>: Stores JSON in a binary format, which is more efficient for processing but doesn’t
            preserve whitespace or key order</li>
        </ol>
        <div class="sourceCode" id="cb34">
          <pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true"></a><span class="co">-- Create tables with JSON and JSONB columns</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> product_json (</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true"></a>    product_id serial <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true"></a>    name text <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true"></a>    <span class="kw">attributes</span> JSON</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true"></a>);</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> product_jsonb (</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true"></a>    product_id serial <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true"></a>    name text <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true"></a>    <span class="kw">attributes</span> JSONB</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true"></a>);</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true"></a></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true"></a><span class="co">-- Insert data</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> product_json (name, <span class="kw">attributes</span>)</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true"></a><span class="kw">VALUES</span> (</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true"></a>    <span class="st">&#39;Smartphone X&#39;</span>,</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true"></a>    <span class="st">&#39;{&quot;color&quot;: &quot;black&quot;, &quot;storage&quot;: &quot;128GB&quot;, &quot;screen&quot;: &quot;6.1 inch&quot;, &quot;features&quot;: [&quot;waterproof&quot;, &quot;5G&quot;, &quot;dual camera&quot;]}&#39;</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true"></a>);</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true"></a></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> product_jsonb (name, <span class="kw">attributes</span>)</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true"></a><span class="kw">VALUES</span> (</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true"></a>    <span class="st">&#39;Smartphone X&#39;</span>,</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true"></a>    <span class="st">&#39;{&quot;color&quot;: &quot;black&quot;, &quot;storage&quot;: &quot;128GB&quot;, &quot;screen&quot;: &quot;6.1 inch&quot;, &quot;features&quot;: [&quot;waterproof&quot;, &quot;5G&quot;, &quot;dual camera&quot;]}&#39;</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true"></a>);</span></code></pre>
        </div>
      </section>
      <section>

        <p><strong>Querying JSON Data</strong>:</p>
        <ol type="1">
          <li><strong>Accessing JSON Elements</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb35">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true"></a><span class="co">-- Using -&gt; operator (returns JSON)</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true"></a><span class="kw">SELECT</span> <span class="kw">attributes</span><span class="op">-&gt;</span><span class="st">&#39;color&#39;</span> <span class="kw">FROM</span> product_json;</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true"></a><span class="co">-- Using -&gt;&gt; operator (returns text)</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true"></a><span class="kw">SELECT</span> <span class="kw">attributes</span><span class="op">-&gt;&gt;</span><span class="st">&#39;color&#39;</span> <span class="kw">FROM</span> product_json;</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true"></a><span class="co">-- Accessing nested elements</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true"></a><span class="kw">SELECT</span> <span class="kw">attributes</span><span class="op">-&gt;</span><span class="st">&#39;features&#39;</span><span class="op">-&gt;</span><span class="dv">0</span> <span class="kw">FROM</span> product_json;</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true"></a></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true"></a><span class="co">-- Accessing array elements</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true"></a><span class="kw">SELECT</span> <span class="kw">attributes</span><span class="op">-&gt;</span><span class="st">&#39;features&#39;</span> <span class="kw">FROM</span> product_json;</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true"></a><span class="kw">SELECT</span> <span class="kw">attributes</span><span class="op">-&gt;</span><span class="st">&#39;features&#39;</span><span class="op">-&gt;&gt;</span><span class="dv">1</span> <span class="kw">FROM</span> product_json;</span></code></pre>
        </div>
        <ol start="2" type="1">
          <li><strong>Filtering with JSON</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb36">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true"></a><span class="co">-- Filter by exact value</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> product_jsonb</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true"></a><span class="kw">WHERE</span> <span class="kw">attributes</span><span class="op">-&gt;&gt;</span><span class="st">&#39;color&#39;</span> <span class="op">=</span> <span class="st">&#39;black&#39;</span>;</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true"></a><span class="co">-- Filter with LIKE</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> product_jsonb</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true"></a><span class="kw">WHERE</span> <span class="kw">attributes</span><span class="op">-&gt;&gt;</span><span class="st">&#39;screen&#39;</span> <span class="kw">LIKE</span> <span class="st">&#39;%inch&#39;</span>;</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true"></a></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true"></a><span class="co">-- Check if a key exists</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> product_jsonb</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true"></a><span class="kw">WHERE</span> <span class="kw">attributes</span> ? <span class="st">&#39;waterproof&#39;</span>;</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true"></a></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true"></a><span class="co">-- Check if array contains a value</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> product_jsonb</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true"></a><span class="kw">WHERE</span> <span class="kw">attributes</span><span class="op">-&gt;</span><span class="st">&#39;features&#39;</span> ? <span class="st">&#39;waterproof&#39;</span>;</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true"></a></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true"></a><span class="co">-- JSONB containment operator (@&gt;)</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> product_jsonb</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true"></a><span class="kw">WHERE</span> <span class="kw">attributes</span> @<span class="op">&gt;</span> <span class="st">&#39;{&quot;color&quot;: &quot;black&quot;, &quot;storage&quot;: &quot;128GB&quot;}&#39;</span>;</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true"></a></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true"></a><span class="co">-- JSONB contained by operator (&lt;@)</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> product_jsonb</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true"></a><span class="kw">WHERE</span> <span class="st">&#39;{&quot;color&quot;: &quot;black&quot;}&#39;</span> <span class="op">&lt;</span>@ <span class="kw">attributes</span>;</span></code></pre>
        </div>
      </section>
      <section>
        <ol start="3" type="1">
          <li><strong>Indexing JSON Data</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb37">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true"></a><span class="co">-- GIN index for JSONB (supports @&gt;, ?, ?|, ?&amp; operators)</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_product_attributes <span class="kw">ON</span> product_jsonb <span class="kw">USING</span> GIN (<span class="kw">attributes</span>);</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true"></a><span class="co">-- GIN index for specific paths</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_product_attributes_path <span class="kw">ON</span> product_jsonb <span class="kw">USING</span> GIN ((<span class="kw">attributes</span><span class="op">-&gt;</span><span class="st">&#39;features&#39;</span>));</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true"></a></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true"></a><span class="co">-- GIN index with jsonb_path_ops (optimized for @&gt; operator)</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_product_attributes_path_ops <span class="kw">ON</span> product_jsonb <span class="kw">USING</span> GIN (<span class="kw">attributes</span> jsonb_path_ops);</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true"></a><span class="co">-- B-tree index for specific JSON values</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_product_color <span class="kw">ON</span> product_jsonb ((<span class="kw">attributes</span><span class="op">-&gt;&gt;</span><span class="st">&#39;color&#39;</span>));</span></code></pre>
        </div>
        <p><strong>Modifying JSON Data</strong>:</p>
        <div class="sourceCode" id="cb38">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true"></a><span class="co">-- Update a specific field</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true"></a><span class="kw">UPDATE</span> product_jsonb</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true"></a><span class="kw">SET</span> <span class="kw">attributes</span> <span class="op">=</span> jsonb_set(<span class="kw">attributes</span>, <span class="st">&#39;{color}&#39;</span>, <span class="st">&#39;&quot;red&quot;&#39;</span>)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true"></a><span class="kw">WHERE</span> product_id <span class="op">=</span> <span class="dv">1</span>;</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true"></a><span class="co">-- Add a new field</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true"></a><span class="kw">UPDATE</span> product_jsonb</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true"></a><span class="kw">SET</span> <span class="kw">attributes</span> <span class="op">=</span> <span class="kw">attributes</span> <span class="op">||</span> <span class="st">&#39;{&quot;weight&quot;: &quot;150g&quot;}&#39;</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true"></a><span class="kw">WHERE</span> product_id <span class="op">=</span> <span class="dv">1</span>;</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true"></a><span class="co">-- Remove a field</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true"></a><span class="kw">UPDATE</span> product_jsonb</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true"></a><span class="kw">SET</span> <span class="kw">attributes</span> <span class="op">=</span> <span class="kw">attributes</span> <span class="op">-</span> <span class="st">&#39;weight&#39;</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true"></a><span class="kw">WHERE</span> product_id <span class="op">=</span> <span class="dv">1</span>;</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true"></a></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true"></a><span class="co">-- Append to an array</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true"></a><span class="kw">UPDATE</span> product_jsonb</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true"></a><span class="kw">SET</span> <span class="kw">attributes</span> <span class="op">=</span> jsonb_set(</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true"></a>    <span class="kw">attributes</span>,</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true"></a>    <span class="st">&#39;{features}&#39;</span>,</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true"></a>    (<span class="kw">attributes</span><span class="op">-&gt;</span><span class="st">&#39;features&#39;</span>) <span class="op">||</span> <span class="st">&#39;&quot;wireless charging&quot;&#39;</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true"></a>)</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true"></a><span class="kw">WHERE</span> product_id <span class="op">=</span> <span class="dv">1</span>;</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>JSON Functions and Operators</strong>:</p>
        <div class="sourceCode" id="cb39">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true"></a><span class="co">-- Convert to/from JSON</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true"></a><span class="kw">SELECT</span> to_json(<span class="kw">row</span>(<span class="dv">1</span>, <span class="st">&#39;test&#39;</span>));</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true"></a><span class="kw">SELECT</span> to_jsonb(<span class="kw">row</span>(<span class="dv">1</span>, <span class="st">&#39;test&#39;</span>));</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true"></a><span class="kw">SELECT</span> row_to_json(<span class="kw">row</span>(<span class="dv">1</span>, <span class="st">&#39;test&#39;</span>));</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true"></a><span class="co">-- Build JSON objects</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true"></a><span class="kw">SELECT</span> json_build_object(<span class="st">&#39;name&#39;</span>, name, <span class="st">&#39;price&#39;</span>, price) <span class="kw">FROM</span> product;</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true"></a><span class="kw">SELECT</span> jsonb_build_object(<span class="st">&#39;name&#39;</span>, name, <span class="st">&#39;price&#39;</span>, price) <span class="kw">FROM</span> product;</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true"></a></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true"></a><span class="co">-- Build JSON arrays</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true"></a><span class="kw">SELECT</span> json_build_array(<span class="dv">1</span>, <span class="dv">2</span>, <span class="st">&#39;three&#39;</span>);</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true"></a><span class="kw">SELECT</span> jsonb_build_array(<span class="dv">1</span>, <span class="dv">2</span>, <span class="st">&#39;three&#39;</span>);</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true"></a></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true"></a><span class="co">-- Aggregate to JSON</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true"></a>    category_id,</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true"></a>    json_agg(json_build_object(<span class="st">&#39;id&#39;</span>, product_id, <span class="st">&#39;name&#39;</span>, name, <span class="st">&#39;price&#39;</span>, price)) <span class="kw">AS</span> products</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true"></a>    product</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true"></a>    category_id;</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true"></a></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true"></a><span class="co">-- Extract keys and values</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true"></a><span class="kw">SELECT</span> jsonb_object_keys(<span class="kw">attributes</span>) <span class="kw">FROM</span> product_jsonb;</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true"></a><span class="kw">SELECT</span> jsonb_each(<span class="kw">attributes</span>) <span class="kw">FROM</span> product_jsonb;</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true"></a><span class="kw">SELECT</span> jsonb_array_elements(<span class="kw">attributes</span><span class="op">-&gt;</span><span class="st">&#39;features&#39;</span>) <span class="kw">FROM</span> product_jsonb;</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true"></a></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true"></a><span class="co">-- Check if JSON is valid</span></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true"></a><span class="kw">SELECT</span> <span class="kw">attributes</span>:<span class="ch">:jsonb</span> <span class="kw">FROM</span> product_json;  <span class="co">-- Will error if invalid</span></span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>JSON Path Expressions (PostgreSQL 12+)</strong>:</p>
        <div class="sourceCode" id="cb40">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true"></a><span class="co">-- Simple path expression</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true"></a><span class="kw">SELECT</span> jsonb_path_query(</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true"></a>    <span class="kw">attributes</span>,</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true"></a>    <span class="st">&#39;$.features[*] ? (@ == &quot;waterproof&quot;)&#39;</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true"></a>)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true"></a><span class="kw">FROM</span> product_jsonb;</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true"></a><span class="co">-- Check existence</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true"></a><span class="kw">FROM</span> product_jsonb</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true"></a><span class="kw">WHERE</span> jsonb_path_exists(</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true"></a>    <span class="kw">attributes</span>,</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true"></a>    <span class="st">&#39;$.features[*] ? (@ == &quot;5G&quot;)&#39;</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true"></a>);</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true"></a></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true"></a><span class="co">-- Extract first match</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true"></a><span class="kw">SELECT</span> jsonb_path_query_first(</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true"></a>    <span class="kw">attributes</span>,</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true"></a>    <span class="st">&#39;$.features[0]&#39;</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true"></a>)</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true"></a><span class="kw">FROM</span> product_jsonb;</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true"></a></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true"></a><span class="co">-- Extract multiple values</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true"></a><span class="kw">SELECT</span> jsonb_path_query(</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true"></a>    <span class="kw">attributes</span>,</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true"></a>    <span class="st">&#39;$.features[*]&#39;</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true"></a>)</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true"></a><span class="kw">FROM</span> product_jsonb;</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Practical JSON Examples</strong>:</p>
        <ol type="1">
          <li><strong>Storing Configuration Settings</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb41">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true"></a><span class="co">-- Create a configuration table</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> app_config (</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true"></a>    config_key text <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true"></a>    config_value jsonb <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true"></a>    updated_at <span class="dt">timestamp</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true"></a>);</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true"></a></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true"></a><span class="co">-- Insert configuration</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> app_config (config_key, config_value)</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true"></a><span class="kw">VALUES</span> (</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true"></a>    <span class="st">&#39;email_settings&#39;</span>,</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true"></a>    <span class="st">&#39;{</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true"></a><span class="st">        &quot;smtp_server&quot;: &quot;smtp.example.com&quot;,</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true"></a><span class="st">        &quot;smtp_port&quot;: 587,</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true"></a><span class="st">        &quot;use_ssl&quot;: true,</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true"></a><span class="st">        &quot;default_sender&quot;: &quot;noreply@example.com&quot;,</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true"></a><span class="st">        &quot;templates&quot;: {</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true"></a><span class="st">            &quot;welcome&quot;: {</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true"></a><span class="st">                &quot;subject&quot;: &quot;Welcome to our service&quot;,</span></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true"></a><span class="st">                &quot;template_id&quot;: &quot;welcome-001&quot;</span></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true"></a><span class="st">            },</span></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true"></a><span class="st">            &quot;password_reset&quot;: {</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true"></a><span class="st">                &quot;subject&quot;: &quot;Reset your password&quot;,</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true"></a><span class="st">                &quot;template_id&quot;: &quot;pwd-reset-001&quot;,</span></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true"></a><span class="st">                &quot;expire_hours&quot;: 24</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true"></a><span class="st">            }</span></span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true"></a><span class="st">        }</span></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true"></a><span class="st">    }&#39;</span></span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true"></a>);</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true"></a></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true"></a><span class="co">-- Query specific settings</span></span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true"></a><span class="kw">SELECT</span> config_value<span class="op">-&gt;</span><span class="st">&#39;smtp_server&#39;</span> <span class="kw">AS</span> server,</span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true"></a>       config_value<span class="op">-&gt;</span><span class="st">&#39;smtp_port&#39;</span> <span class="kw">AS</span> port</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true"></a><span class="kw">FROM</span> app_config</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true"></a><span class="kw">WHERE</span> config_key <span class="op">=</span> <span class="st">&#39;email_settings&#39;</span>;</span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true"></a></span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true"></a><span class="co">-- Get nested settings</span></span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true"></a><span class="kw">SELECT</span> config_value<span class="op">-&gt;</span><span class="st">&#39;templates&#39;</span><span class="op">-&gt;</span><span class="st">&#39;welcome&#39;</span><span class="op">-&gt;&gt;</span><span class="st">&#39;subject&#39;</span> <span class="kw">AS</span> welcome_subject</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true"></a><span class="kw">FROM</span> app_config</span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true"></a><span class="kw">WHERE</span> config_key <span class="op">=</span> <span class="st">&#39;email_settings&#39;</span>;</span></code></pre>
        </div>
      </section>
      <section>
        <ol start="2" type="1">
          <li><strong>Handling Flexible Product Attributes</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb42">
          <pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true"></a><span class="co">-- Create a product table with flexible attributes</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> product_flexible (</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true"></a>    product_id serial <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true"></a>    sku text <span class="kw">UNIQUE</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true"></a>    name text <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true"></a>    base_price <span class="dt">numeric</span>(<span class="dv">10</span>,<span class="dv">2</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true"></a>    category_id <span class="dt">integer</span> <span class="kw">REFERENCES</span> <span class="kw">category</span>(<span class="kw">id</span>),</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true"></a>    <span class="kw">attributes</span> jsonb,</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true"></a>    created_at <span class="dt">timestamp</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true"></a>    updated_at <span class="dt">timestamp</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true"></a>);</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true"></a></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true"></a><span class="co">-- Insert products with different attribute structures</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> product_flexible (sku, name, base_price, category_id, <span class="kw">attributes</span>)</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true"></a><span class="kw">VALUES</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true"></a>    (<span class="st">&#39;LAPTOP-001&#39;</span>, <span class="st">&#39;Business Laptop Pro&#39;</span>, <span class="fl">1299.99</span>, <span class="dv">1</span>, </span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true"></a>     <span class="st">&#39;{</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true"></a><span class="st">         &quot;specs&quot;: {</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true"></a><span class="st">             &quot;processor&quot;: &quot;Intel i7&quot;,</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true"></a><span class="st">             &quot;memory&quot;: &quot;16GB&quot;,</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true"></a><span class="st">             &quot;storage&quot;: &quot;512GB SSD&quot;,</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true"></a><span class="st">             &quot;display&quot;: &quot;15.6 inch&quot;,</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true"></a><span class="st">             &quot;resolution&quot;: &quot;1920x1080&quot;</span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true"></a><span class="st">         },</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true"></a><span class="st">         &quot;connectivity&quot;: [&quot;WiFi 6&quot;, &quot;Bluetooth 5.0&quot;, &quot;USB-C&quot;, &quot;HDMI&quot;],</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true"></a><span class="st">         &quot;battery_life&quot;: &quot;10 hours&quot;,</span></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true"></a><span class="st">         &quot;weight&quot;: &quot;1.8kg&quot;,</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true"></a><span class="st">         &quot;colors_available&quot;: [&quot;silver&quot;, &quot;black&quot;]</span></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true"></a><span class="st">     }&#39;</span></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true"></a>    ),</span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true"></a>    (<span class="st">&#39;PHONE-001&#39;</span>, <span class="st">&#39;Smartphone X&#39;</span>, <span class="fl">899.99</span>, <span class="dv">2</span>,</span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true"></a>     <span class="st">&#39;{</span></span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true"></a><span class="st">         &quot;specs&quot;: {</span></span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true"></a><span class="st">             &quot;processor&quot;: &quot;A15 chip&quot;,</span></span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true"></a><span class="st">             &quot;memory&quot;: &quot;8GB&quot;,</span></span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true"></a><span class="st">             &quot;storage&quot;: &quot;128GB&quot;,</span></span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true"></a><span class="st">             &quot;display&quot;: &quot;6.1 inch&quot;,</span></span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true"></a><span class="st">             &quot;resolution&quot;: &quot;2532x1170&quot;</span></span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true"></a><span class="st">         },</span></span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true"></a><span class="st">         &quot;camera&quot;: {</span></span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true"></a><span class="st">             &quot;main&quot;: &quot;12MP&quot;,</span></span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true"></a><span class="st">             &quot;ultrawide&quot;: &quot;12MP&quot;,</span></span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true"></a><span class="st">             &quot;front&quot;: &quot;7MP&quot;</span></span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true"></a><span class="st">         },</span></span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true"></a><span class="st">         &quot;connectivity&quot;: [&quot;5G&quot;, &quot;WiFi 6&quot;, &quot;Bluetooth 5.2&quot;, &quot;NFC&quot;],</span></span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true"></a><span class="st">         &quot;battery_life&quot;: &quot;17 hours&quot;,</span></span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true"></a><span class="st">         &quot;weight&quot;: &quot;174g&quot;,</span></span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true"></a><span class="st">         &quot;colors_available&quot;: [&quot;black&quot;, &quot;white&quot;, &quot;blue&quot;, &quot;red&quot;],</span></span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true"></a><span class="st">         &quot;waterproof&quot;: true</span></span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true"></a><span class="st">     }&#39;</span></span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true"></a>    );</span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true"></a></span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true"></a><span class="co">-- Query products with specific attributes</span></span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true"></a>    product_id,</span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true"></a>    name,</span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true"></a>    base_price,</span>
<span id="cb42-58"><a href="#cb42-58" aria-hidden="true"></a>    <span class="kw">attributes</span><span class="op">-&gt;</span><span class="st">&#39;specs&#39;</span><span class="op">-&gt;&gt;</span><span class="st">&#39;processor&#39;</span> <span class="kw">AS</span> processor,</span>
<span id="cb42-59"><a href="#cb42-59" aria-hidden="true"></a>    <span class="kw">attributes</span><span class="op">-&gt;</span><span class="st">&#39;specs&#39;</span><span class="op">-&gt;&gt;</span><span class="st">&#39;memory&#39;</span> <span class="kw">AS</span> memory</span>
<span id="cb42-60"><a href="#cb42-60" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb42-61"><a href="#cb42-61" aria-hidden="true"></a>    product_flexible</span>
<span id="cb42-62"><a href="#cb42-62" aria-hidden="true"></a><span class="kw">WHERE</span></span>
<span id="cb42-63"><a href="#cb42-63" aria-hidden="true"></a>    <span class="kw">attributes</span><span class="op">-&gt;</span><span class="st">&#39;connectivity&#39;</span> ? <span class="st">&#39;USB-C&#39;</span>;</span>
<span id="cb42-64"><a href="#cb42-64" aria-hidden="true"></a></span>
<span id="cb42-65"><a href="#cb42-65" aria-hidden="true"></a><span class="co">-- Find products with specific color</span></span>
<span id="cb42-66"><a href="#cb42-66" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb42-67"><a href="#cb42-67" aria-hidden="true"></a>    product_id,</span>
<span id="cb42-68"><a href="#cb42-68" aria-hidden="true"></a>    name</span>
<span id="cb42-69"><a href="#cb42-69" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb42-70"><a href="#cb42-70" aria-hidden="true"></a>    product_flexible,</span>
<span id="cb42-71"><a href="#cb42-71" aria-hidden="true"></a>    jsonb_array_elements_text(<span class="kw">attributes</span><span class="op">-&gt;</span><span class="st">&#39;colors_available&#39;</span>) <span class="kw">AS</span> color</span>
<span id="cb42-72"><a href="#cb42-72" aria-hidden="true"></a><span class="kw">WHERE</span></span>
<span id="cb42-73"><a href="#cb42-73" aria-hidden="true"></a>    color <span class="op">=</span> <span class="st">&#39;black&#39;</span>;</span>
<span id="cb42-74"><a href="#cb42-74" aria-hidden="true"></a></span>
<span id="cb42-75"><a href="#cb42-75" aria-hidden="true"></a><span class="co">-- Calculate prices with attribute-based adjustments</span></span>
<span id="cb42-76"><a href="#cb42-76" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb42-77"><a href="#cb42-77" aria-hidden="true"></a>    pf.product_id,</span>
<span id="cb42-78"><a href="#cb42-78" aria-hidden="true"></a>    pf.name,</span>
<span id="cb42-79"><a href="#cb42-79" aria-hidden="true"></a>    pf.base_price,</span>
<span id="cb42-80"><a href="#cb42-80" aria-hidden="true"></a>    <span class="cf">CASE</span></span>
<span id="cb42-81"><a href="#cb42-81" aria-hidden="true"></a>        <span class="cf">WHEN</span> pf.<span class="kw">attributes</span><span class="op">-&gt;</span><span class="st">&#39;specs&#39;</span><span class="op">-&gt;&gt;</span><span class="st">&#39;storage&#39;</span> <span class="op">=</span> <span class="st">&#39;512GB SSD&#39;</span> <span class="cf">THEN</span> pf.base_price <span class="op">*</span> <span class="fl">1.1</span></span>
<span id="cb42-82"><a href="#cb42-82" aria-hidden="true"></a>        <span class="cf">WHEN</span> pf.<span class="kw">attributes</span><span class="op">-&gt;</span><span class="st">&#39;specs&#39;</span><span class="op">-&gt;&gt;</span><span class="st">&#39;storage&#39;</span> <span class="op">=</span> <span class="st">&#39;1TB SSD&#39;</span> <span class="cf">THEN</span> pf.base_price <span class="op">*</span> <span class="fl">1.2</span></span>
<span id="cb42-83"><a href="#cb42-83" aria-hidden="true"></a>        <span class="cf">ELSE</span> pf.base_price</span>
<span id="cb42-84"><a href="#cb42-84" aria-hidden="true"></a>    <span class="cf">END</span> <span class="kw">AS</span> adjusted_price</span>
<span id="cb42-85"><a href="#cb42-85" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb42-86"><a href="#cb42-86" aria-hidden="true"></a>    product_flexible pf;</span></code></pre>
        </div>
      </section>
      <section>
        <ol start="3" type="1">
          <li><strong>Storing Event Data</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb43">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true"></a><span class="co">-- Create an events table</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> system_events (</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true"></a>    event_id serial <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true"></a>    event_type text <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true"></a>    event_time <span class="dt">timestamp</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true"></a>    actor_id <span class="dt">integer</span>,</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true"></a>    event_data jsonb <span class="kw">NOT</span> <span class="kw">NULL</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true"></a>);</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true"></a></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true"></a><span class="co">-- Insert various event types</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> system_events (event_type, actor_id, event_data)</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true"></a><span class="kw">VALUES</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true"></a>    (<span class="st">&#39;user_login&#39;</span>, <span class="dv">123</span>, <span class="st">&#39;{&quot;ip&quot;: &quot;192.168.1.1&quot;, &quot;user_agent&quot;: &quot;Mozilla/5.0&quot;, &quot;device&quot;: &quot;mobile&quot;}&#39;</span>),</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true"></a>    (<span class="st">&#39;order_placed&#39;</span>, <span class="dv">123</span>, <span class="st">&#39;{&quot;order_id&quot;: 456, &quot;items&quot;: [{&quot;product_id&quot;: 101, &quot;quantity&quot;: 2}, {&quot;product_id&quot;: 202, &quot;quantity&quot;: 1}], &quot;total&quot;: 129.99, &quot;payment_method&quot;: &quot;credit_card&quot;}&#39;</span>),</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true"></a>    (<span class="st">&#39;product_viewed&#39;</span>, <span class="kw">NULL</span>, <span class="st">&#39;{&quot;product_id&quot;: 101, &quot;referrer&quot;: &quot;search&quot;, &quot;session_id&quot;: &quot;abc123&quot;}&#39;</span>);</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true"></a></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true"></a><span class="co">-- Query events by type with specific data</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true"></a>    event_id,</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true"></a>    event_time,</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true"></a>    actor_id,</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true"></a>    event_data<span class="op">-&gt;&gt;</span><span class="st">&#39;order_id&#39;</span> <span class="kw">AS</span> order_id,</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true"></a>    event_data<span class="op">-&gt;&gt;</span><span class="st">&#39;total&#39;</span> <span class="kw">AS</span> total</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true"></a>    system_events</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true"></a><span class="kw">WHERE</span></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true"></a>    event_type <span class="op">=</span> <span class="st">&#39;order_placed&#39;</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true"></a>    <span class="kw">AND</span> (event_data<span class="op">-&gt;&gt;</span><span class="st">&#39;total&#39;</span>):<span class="ch">:numeric</span> <span class="op">&gt;</span> <span class="dv">100</span>;</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true"></a></span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true"></a><span class="co">-- Extract and analyze items from orders</span></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true"></a>    e.event_id,</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true"></a>    e.event_time,</span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true"></a>    item<span class="op">-&gt;&gt;</span><span class="st">&#39;product_id&#39;</span> <span class="kw">AS</span> product_id,</span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true"></a>    (item<span class="op">-&gt;&gt;</span><span class="st">&#39;quantity&#39;</span>):<span class="ch">:integer</span> <span class="kw">AS</span> quantity</span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true"></a>    system_events e,</span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true"></a>    jsonb_array_elements(e.event_data<span class="op">-&gt;</span><span class="st">&#39;items&#39;</span>) <span class="kw">AS</span> item</span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true"></a><span class="kw">WHERE</span></span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true"></a>    e.event_type <span class="op">=</span> <span class="st">&#39;order_placed&#39;</span>;</span></code></pre>
        </div>
        <p>By mastering these advanced PostgreSQL features, you'll be able to build more sophisticated and efficient
          database applications. These techniques are particularly valuable for product owners who need to understand
          the
          capabilities and limitations of their database systems.</p>

      </section>

      <section>
        <h3 id="practice-exercises">Practice What You Learned</h3>
        <p>Ready to master advanced PostgreSQL features? Practice with hands-on exercises covering stored procedures, functions, triggers, and advanced indexing techniques.</p>
        <p><a href="01_advanced_postgresql_features_examples.html" class="btn btn-primary">Go to Practical Examples &rarr;</a></p>
      </section>
    </div>
  </div> <!-- /container -->
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>


<!-- Mirrored from code-mext.github.io/sql-training/day5/01_advanced_postgresql_features.html by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 10 Jan 2026 07:44:40 GMT -->
</html>