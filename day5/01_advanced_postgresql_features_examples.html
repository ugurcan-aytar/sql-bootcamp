<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="../style_bootstrap.html">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/code.css">
    <link href="https://cdn.prod.website-files.com/5efdb54f07a6812bcd95cc65/6773d0fc3013e060f08d7145_favicon.jpg"
        rel="shortcut icon" type="image/x-icon">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <title>Day 5: Advanced PostgreSQL Features - Practical Examples</title>
    <style>
        code {
            white-space: pre-wrap;
        }

        span.smallcaps {
            font-variant: small-caps;
        }

        span.underline {
            text-decoration: underline;
        }

        div.column {
            display: inline-block;
            vertical-align: top;
            width: 50%;
        }

        div.hanging-indent {
            margin-left: 1.5em;
            text-indent: -1.5em;
        }

        ul.task-list {
            list-style: none;
        }

        .exercise-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .exercise-box h4 {
            color: #495057;
            margin-bottom: 15px;
        }

        .solution {
            background-color: #e7f3ff;
            border: 1px solid #b6d4fe;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .solution.show {
            display: block;
        }

        .btn-solution {
            background-color: #0d6efd;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-solution:hover {
            background-color: #0b5ed7;
        }

        .hint-box {
            background-color: #fff3cd;
            border: 1px solid #ffecb5;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .hint-box strong {
            color: #664d03;
        }

        .warning-box {
            background-color: #f8d7da;
            border: 1px solid #f5c2c7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .warning-box strong {
            color: #842029;
        }

        .concept-box {
            background-color: #d1e7dd;
            border: 1px solid #badbcc;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .concept-box strong {
            color: #0f5132;
        }

        .dataset-table {
            font-size: 0.9em;
            margin: 15px 0;
        }

        .dataset-table th {
            background-color: #e9ecef;
        }

        .badge-function {
            background-color: #6f42c1;
            color: white;
        }

        .badge-trigger {
            background-color: #fd7e14;
            color: white;
        }

        .badge-index {
            background-color: #198754;
            color: white;
        }

        .result-table {
            font-size: 0.85em;
            margin: 15px 0;
        }

        .result-table th {
            background-color: #343a40;
            color: white;
        }

        .result-table td {
            font-family: 'Courier New', monospace;
        }

        .code-block {
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
        }

        .flow-diagram {
            background-color: #f8f9fa;
            border: 2px dashed #6c757d;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }

        .flow-box {
            display: inline-block;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 5px;
            font-size: 0.9em;
        }

        .flow-box.event {
            background-color: #cfe2ff;
            border: 1px solid #9ec5fe;
        }

        .flow-box.trigger {
            background-color: #fff3cd;
            border: 1px solid #ffda6a;
        }

        .flow-box.action {
            background-color: #d1e7dd;
            border: 1px solid #a3cfbb;
        }

        .flow-arrow {
            font-size: 1.5em;
            color: #6c757d;
            margin: 0 10px;
        }
        .language-switcher { position: fixed; top: 10px; right: 10px; z-index: 1000; background: #fff; padding: 5px 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .language-switcher a { text-decoration: none; padding: 5px 10px; margin: 0 2px; border-radius: 3px; color: #333; }
        .language-switcher a.active { background: #0d6efd; color: #fff; }
        .language-switcher a:hover:not(.active) { background: #e9ecef; }
    </style>
</head>

<body>
    <a href="../index_en.html" class="back-button">← Back to Index</a>
    <div class="language-switcher">
        <a href="01_advanced_postgresql_features_examples.html" class="active">EN</a>
        <a href="01_advanced_postgresql_features_examples_tr.html">TR</a>
    </div>
    <div class="copy-notification" id="copyNotification">Copied!</div>

    <div id="europeanunion-turkey">
        <img src="../static/eu.png" alt="">
    </div>
    <div id="sanayiteknolojibakan">
        <img src="../static/sanayitek.png" alt="">
    </div>
    <div id="rekabet">
        <img src="../static/rekabet.png" alt="">
    </div>
    <div id="tisk">
        <img src="../static/tisk.png" alt="">
    </div>
    <div id="undp">
        <img src="../static/undp.png" alt="">
    </div>
    <div class="content-container">
        <div class="container">
            <section>
                <h1>Advanced PostgreSQL Features - Practical Examples</h1>
                <p class="lead">Master stored procedures, functions, triggers, and advanced indexing through hands-on
                    exercises.</p>

                <div class="hint-box">
                    <strong>Learning Objectives:</strong>
                    <ul class="mb-0">
                        <li>Write PL/pgSQL functions with control structures and exception handling</li>
                        <li>Create triggers for automated data management</li>
                        <li>Implement business rules through database logic</li>
                        <li>Design advanced indexes for optimal query performance</li>
                    </ul>
                </div>
            </section>

            <!-- Sample Dataset -->
            <section>
                <h3>Sample Database Schema</h3>
                <p>We'll use the bootcamp e-commerce database for these exercises. The following tables are from the <code>public</code> schema:</p>

                <div class="hint-box mb-3">
                    <strong>Note:</strong> These tables match the <code>bootcamp_db.sql</code> schema. The <code>customer_type</code> values are: 'individual', 'business', 'vip'. Order <code>status</code> values are: 'draft', 'confirmed', 'processing', 'shipped', 'delivered', 'cancelled', 'returned'.
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <h5>customers</h5>
                        <table class="table table-bordered dataset-table">
                            <thead>
                                <tr>
                                    <th>Column</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>id</td>
                                    <td><span class="badge bg-primary">SERIAL PK</span></td>
                                </tr>
                                <tr>
                                    <td>name</td>
                                    <td><span class="badge bg-secondary">VARCHAR(255)</span></td>
                                </tr>
                                <tr>
                                    <td>email</td>
                                    <td><span class="badge bg-secondary">VARCHAR(255)</span></td>
                                </tr>
                                <tr>
                                    <td>customer_type</td>
                                    <td><span class="badge bg-secondary">VARCHAR(20)</span></td>
                                </tr>
                                <tr>
                                    <td>credit_limit</td>
                                    <td><span class="badge bg-info">DECIMAL(12,2)</span></td>
                                </tr>
                                <tr>
                                    <td>deleted_at</td>
                                    <td><span class="badge bg-warning text-dark">TIMESTAMP</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-4">
                        <h5>orders</h5>
                        <table class="table table-bordered dataset-table">
                            <thead>
                                <tr>
                                    <th>Column</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>id</td>
                                    <td><span class="badge bg-primary">SERIAL PK</span></td>
                                </tr>
                                <tr>
                                    <td>customer_id</td>
                                    <td><span class="badge bg-success">INTEGER FK</span></td>
                                </tr>
                                <tr>
                                    <td>order_date</td>
                                    <td><span class="badge bg-warning text-dark">DATE</span></td>
                                </tr>
                                <tr>
                                    <td>total_amount</td>
                                    <td><span class="badge bg-info">DECIMAL(12,2)</span></td>
                                </tr>
                                <tr>
                                    <td>status</td>
                                    <td><span class="badge bg-secondary">VARCHAR(20)</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-4">
                        <h5>products</h5>
                        <table class="table table-bordered dataset-table">
                            <thead>
                                <tr>
                                    <th>Column</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>id</td>
                                    <td><span class="badge bg-primary">SERIAL PK</span></td>
                                </tr>
                                <tr>
                                    <td>name</td>
                                    <td><span class="badge bg-secondary">VARCHAR(255)</span></td>
                                </tr>
                                <tr>
                                    <td>price</td>
                                    <td><span class="badge bg-info">DECIMAL(10,2)</span></td>
                                </tr>
                                <tr>
                                    <td>stock_quantity</td>
                                    <td><span class="badge bg-info">INTEGER</span></td>
                                </tr>
                                <tr>
                                    <td>updated_at</td>
                                    <td><span class="badge bg-warning text-dark">TIMESTAMP</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Part 1: Functions -->
            <section>
                <h2>Part 1: Functions and Stored Procedures</h2>
                <p>Create reusable database logic with PL/pgSQL.</p>

                <div class="exercise-box">
                    <h4>Exercise 1.1: Basic Scalar Function</h4>
                    <p>Create a function that calculates the total order value for a customer, including a loyalty
                        discount based on their customer type.</p>

                    <p><strong>Requirements:</strong></p>
                    <ul>
                        <li>Premium customers get 10% discount</li>
                        <li>Regular customers get 5% discount</li>
                        <li>New customers get no discount</li>
                    </ul>

                    <button class="btn-solution" onclick="toggleSolution('sol1_1')">Show Solution</button>
                    <div id="sol1_1" class="solution">
                        <pre><code class="sourceCode sql"><span class="kw">CREATE OR REPLACE FUNCTION</span> calculate_order_total(
    order_id_param <span class="dt">INTEGER</span>
)
<span class="kw">RETURNS</span> <span class="dt">NUMERIC</span> <span class="kw">AS</span> $$
<span class="kw">DECLARE</span>
    base_amount <span class="dt">NUMERIC</span>;
    customer_type_val <span class="dt">TEXT</span>;
    discount_rate <span class="dt">NUMERIC</span>;
    final_amount <span class="dt">NUMERIC</span>;
<span class="kw">BEGIN</span>
    <span class="co">-- Get order total_amount and customer type</span>
    <span class="kw">SELECT</span> o.total_amount, c.customer_type
    <span class="kw">INTO</span> base_amount, customer_type_val
    <span class="kw">FROM</span> orders o
    <span class="kw">JOIN</span> customers c <span class="kw">ON</span> o.customer_id = c.id
    <span class="kw">WHERE</span> o.id = order_id_param;

    <span class="co">-- Check if order exists</span>
    <span class="kw">IF</span> base_amount <span class="kw">IS NULL THEN</span>
        <span class="kw">RAISE EXCEPTION</span> <span class="st">'Order % not found'</span>, order_id_param;
    <span class="kw">END IF</span>;

    <span class="co">-- Determine discount rate based on customer type (bootcamp_db values)</span>
    <span class="kw">CASE</span> customer_type_val
        <span class="kw">WHEN</span> <span class="st">'vip'</span> <span class="kw">THEN</span> discount_rate := <span class="fl">0.10</span>;
        <span class="kw">WHEN</span> <span class="st">'business'</span> <span class="kw">THEN</span> discount_rate := <span class="fl">0.05</span>;
        <span class="kw">ELSE</span> discount_rate := <span class="fl">0.00</span>;  <span class="co">-- individual customers</span>
    <span class="kw">END CASE</span>;

    <span class="co">-- Calculate final amount</span>
    final_amount := base_amount * (<span class="dv">1</span> - discount_rate);

    <span class="kw">RETURN</span> <span class="fu">ROUND</span>(final_amount, <span class="dv">2</span>);
<span class="kw">END</span>;
$$ <span class="kw">LANGUAGE</span> plpgsql;

<span class="co">-- Usage</span>
<span class="kw">SELECT</span> calculate_order_total(<span class="dv">123</span>);</code></pre>

                        <div class="concept-box">
                            <strong>Key Concepts:</strong>
                            <ul class="mb-0">
                                <li><code>DECLARE</code> block for local variables</li>
                                <li><code>SELECT INTO</code> to assign query results to variables</li>
                                <li><code>CASE</code> for conditional logic</li>
                                <li><code>RAISE EXCEPTION</code> for error handling</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Exercise 1.2: Table-Returning Function</h4>
                    <p>Create a function that returns the top N customers by total spending, along with their order
                        statistics.</p>

                    <p><strong>Output columns:</strong> customer_id, customer_name, total_orders, total_spent,
                        avg_order_value</p>

                    <button class="btn-solution" onclick="toggleSolution('sol1_2')">Show Solution</button>
                    <div id="sol1_2" class="solution">
                        <pre><code class="sourceCode sql"><span class="kw">CREATE OR REPLACE FUNCTION</span> get_top_customers(n <span class="dt">INTEGER</span>)
<span class="kw">RETURNS TABLE</span> (
    customer_id <span class="dt">INTEGER</span>,
    customer_name <span class="dt">TEXT</span>,
    total_orders <span class="dt">BIGINT</span>,
    total_spent <span class="dt">NUMERIC</span>,
    avg_order_value <span class="dt">NUMERIC</span>
) <span class="kw">AS</span> $$
<span class="kw">BEGIN</span>
    <span class="kw">RETURN QUERY</span>
    <span class="kw">SELECT</span>
        c.id,
        c.name::text,
        <span class="fu">COUNT</span>(o.id),
        <span class="fu">COALESCE</span>(<span class="fu">SUM</span>(o.total_amount), <span class="dv">0</span>),
        <span class="fu">COALESCE</span>(<span class="fu">ROUND</span>(<span class="fu">AVG</span>(o.total_amount), <span class="dv">2</span>), <span class="dv">0</span>)
    <span class="kw">FROM</span> customers c
    <span class="kw">LEFT JOIN</span> orders o <span class="kw">ON</span> c.id = o.customer_id
    <span class="kw">WHERE</span> c.deleted_at <span class="kw">IS NULL</span>
    <span class="kw">GROUP BY</span> c.id, c.name
    <span class="kw">ORDER BY</span> <span class="fu">SUM</span>(o.total_amount) <span class="kw">DESC NULLS LAST</span>
    <span class="kw">LIMIT</span> n;
<span class="kw">END</span>;
$$ <span class="kw">LANGUAGE</span> plpgsql;

<span class="co">-- Usage: Get top 10 customers</span>
<span class="kw">SELECT</span> * <span class="kw">FROM</span> get_top_customers(<span class="dv">10</span>);

<span class="co">-- Use in a JOIN</span>
<span class="kw">SELECT</span>
    tc.*,
    c.email
<span class="kw">FROM</span> get_top_customers(<span class="dv">5</span>) tc
<span class="kw">JOIN</span> customers c <span class="kw">ON</span> tc.customer_id = c.id;</code></pre>

                        <div class="hint-box">
                            <strong>RETURN QUERY vs RETURN NEXT:</strong>
                            <ul class="mb-0">
                                <li><code>RETURN QUERY</code> - Returns all rows from a query at once</li>
                                <li><code>RETURN NEXT</code> - Returns one row at a time (useful in loops)</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Exercise 1.3: Function with Exception Handling</h4>
                    <p>Create a function to transfer inventory between warehouses with proper error handling.</p>

                    <p><strong>Requirements:</strong></p>
                    <ul>
                        <li>Check that source warehouse has sufficient stock</li>
                        <li>Check that both warehouses exist</li>
                        <li>Return success/failure message</li>
                    </ul>

                    <button class="btn-solution" onclick="toggleSolution('sol1_3')">Show Solution</button>
                    <div id="sol1_3" class="solution">
                        <pre><code class="sourceCode sql"><span class="kw">CREATE OR REPLACE FUNCTION</span> transfer_inventory(
    p_product_id <span class="dt">INTEGER</span>,
    p_source_warehouse <span class="dt">INTEGER</span>,
    p_dest_warehouse <span class="dt">INTEGER</span>,
    p_quantity <span class="dt">INTEGER</span>
)
<span class="kw">RETURNS</span> <span class="dt">TEXT</span> <span class="kw">AS</span> $$
<span class="kw">DECLARE</span>
    v_source_stock <span class="dt">INTEGER</span>;
    v_product_name <span class="dt">TEXT</span>;
    insufficient_stock <span class="kw">EXCEPTION</span>;
    warehouse_not_found <span class="kw">EXCEPTION</span>;
<span class="kw">BEGIN</span>
    <span class="co">-- Validate quantity</span>
    <span class="kw">IF</span> p_quantity <= <span class="dv">0</span> <span class="kw">THEN</span>
        <span class="kw">RAISE EXCEPTION</span> <span class="st">'Quantity must be positive'</span>;
    <span class="kw">END IF</span>;

    <span class="co">-- Check source warehouse stock (warehouse_inventory.product_id → products.id)</span>
    <span class="kw">SELECT</span> stock_quantity, p.name
    <span class="kw">INTO</span> v_source_stock, v_product_name
    <span class="kw">FROM</span> warehouse_inventory wi
    <span class="kw">JOIN</span> products p <span class="kw">ON</span> wi.product_id = p.id
    <span class="kw">WHERE</span> wi.product_id = p_product_id
      <span class="kw">AND</span> wi.warehouse_id = p_source_warehouse
    <span class="kw">FOR UPDATE</span>;

    <span class="kw">IF</span> v_source_stock <span class="kw">IS NULL THEN</span>
        <span class="kw">RAISE</span> warehouse_not_found;
    <span class="kw">END IF</span>;

    <span class="kw">IF</span> v_source_stock < p_quantity <span class="kw">THEN</span>
        <span class="kw">RAISE</span> insufficient_stock;
    <span class="kw">END IF</span>;

    <span class="co">-- Deduct from source</span>
    <span class="kw">UPDATE</span> warehouse_inventory
    <span class="kw">SET</span> stock_quantity = stock_quantity - p_quantity
    <span class="kw">WHERE</span> product_id = p_product_id
      <span class="kw">AND</span> warehouse_id = p_source_warehouse;

    <span class="co">-- Add to destination (upsert)</span>
    <span class="kw">INSERT INTO</span> warehouse_inventory (warehouse_id, product_id, stock_quantity)
    <span class="kw">VALUES</span> (p_dest_warehouse, p_product_id, p_quantity)
    <span class="kw">ON CONFLICT</span> (warehouse_id, product_id)
    <span class="kw">DO UPDATE SET</span> stock_quantity = warehouse_inventory.stock_quantity + p_quantity;

    <span class="kw">RETURN</span> <span class="fu">FORMAT</span>(<span class="st">'Successfully transferred %s units of %s'</span>, p_quantity, v_product_name);

<span class="kw">EXCEPTION</span>
    <span class="kw">WHEN</span> insufficient_stock <span class="kw">THEN</span>
        <span class="kw">RETURN</span> <span class="fu">FORMAT</span>(<span class="st">'Error: Insufficient stock. Available: %s, Requested: %s'</span>,
                      v_source_stock, p_quantity);
    <span class="kw">WHEN</span> warehouse_not_found <span class="kw">THEN</span>
        <span class="kw">RETURN</span> <span class="st">'Error: Source warehouse or product not found'</span>;
    <span class="kw">WHEN OTHERS THEN</span>
        <span class="kw">RETURN</span> <span class="fu">FORMAT</span>(<span class="st">'Error: %s'</span>, SQLERRM);
<span class="kw">END</span>;
$$ <span class="kw">LANGUAGE</span> plpgsql;

<span class="co">-- Usage</span>
<span class="kw">SELECT</span> transfer_inventory(<span class="dv">101</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">50</span>);</code></pre>

                        <div class="warning-box">
                            <strong>FOR UPDATE:</strong> This locks the row until the transaction completes, preventing
                            race conditions when checking and updating inventory.
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Exercise 1.4: Stored Procedure with Transaction Control</h4>
                    <p>Create a procedure that processes a batch of orders, committing successful ones and rolling back
                        failed ones.</p>

                    <button class="btn-solution" onclick="toggleSolution('sol1_4')">Show Solution</button>
                    <div id="sol1_4" class="solution">
                        <pre><code class="sourceCode sql"><span class="kw">CREATE OR REPLACE PROCEDURE</span> process_pending_orders()
<span class="kw">LANGUAGE</span> plpgsql
<span class="kw">AS</span> $$
<span class="kw">DECLARE</span>
    v_order <span class="kw">RECORD</span>;
    v_success_count <span class="dt">INTEGER</span> := <span class="dv">0</span>;
    v_fail_count <span class="dt">INTEGER</span> := <span class="dv">0</span>;
<span class="kw">BEGIN</span>
    <span class="co">-- Loop through pending orders</span>
    <span class="kw">FOR</span> v_order <span class="kw">IN</span>
        <span class="kw">SELECT</span> id, customer_id, amount
        <span class="kw">FROM</span> orders
        <span class="kw">WHERE</span> status = <span class="st">'pending'</span>
        <span class="kw">ORDER BY</span> order_date
        <span class="kw">LIMIT</span> <span class="dv">100</span>
    <span class="kw">LOOP</span>
        <span class="kw">BEGIN</span>
            <span class="co">-- Try to process this order</span>
            <span class="kw">UPDATE</span> orders
            <span class="kw">SET</span> status = <span class="st">'processing'</span>,
                updated_at = <span class="fu">CURRENT_TIMESTAMP</span>
            <span class="kw">WHERE</span> id = v_order.id;

            <span class="co">-- Simulate some business logic that might fail</span>
            <span class="kw">IF</span> v_order.amount > <span class="dv">10000</span> <span class="kw">THEN</span>
                <span class="co">-- High-value orders need manual review</span>
                <span class="kw">UPDATE</span> orders
                <span class="kw">SET</span> status = <span class="st">'review_required'</span>
                <span class="kw">WHERE</span> id = v_order.id;
            <span class="kw">ELSE</span>
                <span class="kw">UPDATE</span> orders
                <span class="kw">SET</span> status = <span class="st">'completed'</span>
                <span class="kw">WHERE</span> id = v_order.id;
            <span class="kw">END IF</span>;

            v_success_count := v_success_count + <span class="dv">1</span>;

            <span class="co">-- Commit after each successful order</span>
            <span class="kw">COMMIT</span>;

        <span class="kw">EXCEPTION WHEN OTHERS THEN</span>
            <span class="co">-- Rollback this order's changes</span>
            <span class="kw">ROLLBACK</span>;
            v_fail_count := v_fail_count + <span class="dv">1</span>;

            <span class="co">-- Log the error</span>
            <span class="kw">INSERT INTO</span> order_processing_log (order_id, error_message, created_at)
            <span class="kw">VALUES</span> (v_order.id, SQLERRM, <span class="fu">CURRENT_TIMESTAMP</span>);
            <span class="kw">COMMIT</span>;
        <span class="kw">END</span>;
    <span class="kw">END LOOP</span>;

    <span class="kw">RAISE NOTICE</span> <span class="st">'Processed: % success, % failed'</span>, v_success_count, v_fail_count;
<span class="kw">END</span>;
$$;

<span class="co">-- Usage</span>
<span class="kw">CALL</span> process_pending_orders();</code></pre>

                        <div class="concept-box">
                            <strong>Procedures vs Functions:</strong>
                            <ul class="mb-0">
                                <li>Procedures can use <code>COMMIT</code> and <code>ROLLBACK</code></li>
                                <li>Functions cannot control transactions</li>
                                <li>Call procedures with <code>CALL</code>, functions with <code>SELECT</code></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Part 2: Triggers -->
            <section>
                <h2>Part 2: Triggers and Event-Based Programming</h2>
                <p>Automate database operations with triggers.</p>

                <div class="flow-diagram">
                    <span class="flow-box event">Event (INSERT/UPDATE/DELETE)</span>
                    <span class="flow-arrow">&rarr;</span>
                    <span class="flow-box trigger">Trigger Function</span>
                    <span class="flow-arrow">&rarr;</span>
                    <span class="flow-box action">Automated Action</span>
                </div>

                <div class="exercise-box">
                    <h4>Exercise 2.1: Auto-Update Timestamp Trigger</h4>
                    <p>Create a trigger that automatically updates the <code>updated_at</code> column whenever a product
                        is modified.</p>

                    <button class="btn-solution" onclick="toggleSolution('sol2_1')">Show Solution</button>
                    <div id="sol2_1" class="solution">
                        <pre><code class="sourceCode sql"><span class="co">-- Create the trigger function</span>
<span class="kw">CREATE OR REPLACE FUNCTION</span> update_modified_timestamp()
<span class="kw">RETURNS TRIGGER AS</span> $$
<span class="kw">BEGIN</span>
    <span class="co">-- Set updated_at to current timestamp</span>
    NEW.updated_at := <span class="fu">CURRENT_TIMESTAMP</span>;
    <span class="kw">RETURN</span> NEW;
<span class="kw">END</span>;
$$ <span class="kw">LANGUAGE</span> plpgsql;

<span class="co">-- Apply to products table</span>
<span class="kw">CREATE TRIGGER</span> products_update_timestamp
<span class="kw">BEFORE UPDATE ON</span> products
<span class="kw">FOR EACH ROW</span>
<span class="kw">EXECUTE FUNCTION</span> update_modified_timestamp();

<span class="co">-- Test it</span>
<span class="kw">UPDATE</span> products <span class="kw">SET</span> price = price * <span class="fl">1.1</span> <span class="kw">WHERE</span> id = <span class="dv">1</span>;
<span class="kw">SELECT</span> id, name, updated_at <span class="kw">FROM</span> products <span class="kw">WHERE</span> id = <span class="dv">1</span>;</code></pre>

                        <div class="concept-box">
                            <strong>Trigger Timing:</strong>
                            <ul class="mb-0">
                                <li><code>BEFORE</code> - Can modify NEW values before they're written</li>
                                <li><code>AFTER</code> - Runs after the change, can't modify NEW</li>
                                <li><code>INSTEAD OF</code> - Replaces the operation (for views)</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Exercise 2.2: Audit Trail Trigger</h4>
                    <p>Create a comprehensive audit trigger that logs all changes to the orders table.</p>

                    <button class="btn-solution" onclick="toggleSolution('sol2_2')">Show Solution</button>
                    <div id="sol2_2" class="solution">
                        <pre><code class="sourceCode sql"><span class="co">-- Create audit log table</span>
<span class="kw">CREATE TABLE</span> orders_audit (
    audit_id <span class="dt">SERIAL PRIMARY KEY</span>,
    order_id <span class="dt">INTEGER NOT NULL</span>,
    operation <span class="dt">VARCHAR</span>(<span class="dv">10</span>) <span class="kw">NOT NULL</span>,
    changed_by <span class="dt">TEXT NOT NULL DEFAULT</span> current_user,
    changed_at <span class="dt">TIMESTAMP NOT NULL DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,
    old_data <span class="dt">JSONB</span>,
    new_data <span class="dt">JSONB</span>,
    changed_fields <span class="dt">TEXT</span>[]
);

<span class="co">-- Create audit trigger function</span>
<span class="kw">CREATE OR REPLACE FUNCTION</span> audit_orders_changes()
<span class="kw">RETURNS TRIGGER AS</span> $$
<span class="kw">DECLARE</span>
    v_changed_fields <span class="dt">TEXT</span>[] := <span class="kw">ARRAY</span>[]::text[];
    v_old_json <span class="dt">JSONB</span>;
    v_new_json <span class="dt">JSONB</span>;
<span class="kw">BEGIN</span>
    <span class="kw">IF</span> (TG_OP = <span class="st">'DELETE'</span>) <span class="kw">THEN</span>
        v_old_json := to_jsonb(OLD);
        <span class="kw">INSERT INTO</span> orders_audit (order_id, operation, old_data)
        <span class="kw">VALUES</span> (OLD.id, <span class="st">'DELETE'</span>, v_old_json);
        <span class="kw">RETURN</span> OLD;

    <span class="kw">ELSIF</span> (TG_OP = <span class="st">'UPDATE'</span>) <span class="kw">THEN</span>
        v_old_json := to_jsonb(OLD);
        v_new_json := to_jsonb(NEW);

        <span class="co">-- Track which fields changed</span>
        <span class="kw">IF</span> OLD.amount <span class="kw">IS DISTINCT FROM</span> NEW.amount <span class="kw">THEN</span>
            v_changed_fields := <span class="fu">array_append</span>(v_changed_fields, <span class="st">'amount'</span>);
        <span class="kw">END IF</span>;
        <span class="kw">IF</span> OLD.status <span class="kw">IS DISTINCT FROM</span> NEW.status <span class="kw">THEN</span>
            v_changed_fields := <span class="fu">array_append</span>(v_changed_fields, <span class="st">'status'</span>);
        <span class="kw">END IF</span>;

        <span class="kw">INSERT INTO</span> orders_audit (order_id, operation, old_data, new_data, changed_fields)
        <span class="kw">VALUES</span> (NEW.id, <span class="st">'UPDATE'</span>, v_old_json, v_new_json, v_changed_fields);
        <span class="kw">RETURN</span> NEW;

    <span class="kw">ELSIF</span> (TG_OP = <span class="st">'INSERT'</span>) <span class="kw">THEN</span>
        v_new_json := to_jsonb(NEW);
        <span class="kw">INSERT INTO</span> orders_audit (order_id, operation, new_data)
        <span class="kw">VALUES</span> (NEW.id, <span class="st">'INSERT'</span>, v_new_json);
        <span class="kw">RETURN</span> NEW;
    <span class="kw">END IF</span>;

    <span class="kw">RETURN NULL</span>;
<span class="kw">END</span>;
$$ <span class="kw">LANGUAGE</span> plpgsql;

<span class="co">-- Create the trigger</span>
<span class="kw">CREATE TRIGGER</span> orders_audit_trigger
<span class="kw">AFTER INSERT OR UPDATE OR DELETE ON</span> orders
<span class="kw">FOR EACH ROW</span>
<span class="kw">EXECUTE FUNCTION</span> audit_orders_changes();

<span class="co">-- Query audit log</span>
<span class="kw">SELECT</span>
    order_id,
    operation,
    changed_at,
    changed_fields,
    old_data->><span class="st">'status'</span> <span class="kw">AS</span> old_status,
    new_data->><span class="st">'status'</span> <span class="kw">AS</span> new_status
<span class="kw">FROM</span> orders_audit
<span class="kw">ORDER BY</span> changed_at <span class="kw">DESC</span>;</code></pre>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Exercise 2.3: Business Rule Enforcement Trigger</h4>
                    <p>Create a trigger that enforces business rules for product pricing:</p>
                    <ul>
                        <li>Price cannot be negative</li>
                        <li>Price increase cannot exceed 50% in a single update</li>
                        <li>Discount price must be less than regular price</li>
                    </ul>

                    <button class="btn-solution" onclick="toggleSolution('sol2_3')">Show Solution</button>
                    <div id="sol2_3" class="solution">
                        <pre><code class="sourceCode sql"><span class="kw">CREATE OR REPLACE FUNCTION</span> validate_product_price()
<span class="kw">RETURNS TRIGGER AS</span> $$
<span class="kw">BEGIN</span>
    <span class="co">-- Rule 1: Price cannot be negative</span>
    <span class="kw">IF</span> NEW.price < <span class="dv">0</span> <span class="kw">THEN</span>
        <span class="kw">RAISE EXCEPTION</span> <span class="st">'Product price cannot be negative (got: %)'</span>, NEW.price;
    <span class="kw">END IF</span>;

    <span class="co">-- Rule 2: Limit price increase (only for updates)</span>
    <span class="kw">IF</span> TG_OP = <span class="st">'UPDATE'</span> <span class="kw">THEN</span>
        <span class="kw">IF</span> OLD.price > <span class="dv">0</span> <span class="kw">AND</span> NEW.price > OLD.price * <span class="fl">1.5</span> <span class="kw">THEN</span>
            <span class="kw">RAISE EXCEPTION</span>
                <span class="st">'Price increase exceeds 50%% limit. Old: %, New: %, Max allowed: %'</span>,
                OLD.price, NEW.price, OLD.price * <span class="fl">1.5</span>;
        <span class="kw">END IF</span>;
    <span class="kw">END IF</span>;

    <span class="co">-- Rule 3: Discount price validation</span>
    <span class="kw">IF</span> NEW.discount_price <span class="kw">IS NOT NULL THEN</span>
        <span class="kw">IF</span> NEW.discount_price >= NEW.price <span class="kw">THEN</span>
            <span class="kw">RAISE EXCEPTION</span>
                <span class="st">'Discount price (%) must be less than regular price (%)'</span>,
                NEW.discount_price, NEW.price;
        <span class="kw">END IF</span>;

        <span class="kw">IF</span> NEW.discount_price < <span class="dv">0</span> <span class="kw">THEN</span>
            <span class="kw">RAISE EXCEPTION</span> <span class="st">'Discount price cannot be negative'</span>;
        <span class="kw">END IF</span>;
    <span class="kw">END IF</span>;

    <span class="kw">RETURN</span> NEW;
<span class="kw">END</span>;
$$ <span class="kw">LANGUAGE</span> plpgsql;

<span class="kw">CREATE TRIGGER</span> enforce_product_pricing
<span class="kw">BEFORE INSERT OR UPDATE OF</span> price, discount_price <span class="kw">ON</span> products
<span class="kw">FOR EACH ROW</span>
<span class="kw">EXECUTE FUNCTION</span> validate_product_price();

<span class="co">-- Test: This should fail</span>
<span class="kw">UPDATE</span> products <span class="kw">SET</span> price = -<span class="dv">10</span> <span class="kw">WHERE</span> id = <span class="dv">1</span>;
<span class="co">-- ERROR: Product price cannot be negative (got: -10)</span></code></pre>

                        <div class="warning-box">
                            <strong>WHEN Clause Optimization:</strong>
                            You can add a WHEN clause to avoid calling the trigger function unnecessarily:
                            <pre><code class="sourceCode sql"><span class="kw">CREATE TRIGGER</span> check_large_price_change
<span class="kw">BEFORE UPDATE ON</span> products
<span class="kw">FOR EACH ROW</span>
<span class="kw">WHEN</span> (NEW.price > OLD.price * <span class="fl">1.2</span>)  <span class="co">-- Only fire for >20% increases</span>
<span class="kw">EXECUTE FUNCTION</span> log_significant_price_change();</code></pre>
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Exercise 2.4: Soft Delete Implementation</h4>
                    <p>Implement soft deletes for the customers table - instead of actually deleting records, set a
                        <code>deleted_at</code> timestamp.</p>

                    <button class="btn-solution" onclick="toggleSolution('sol2_4')">Show Solution</button>
                    <div id="sol2_4" class="solution">
                        <pre><code class="sourceCode sql"><span class="co">-- Trigger function for soft delete</span>
<span class="kw">CREATE OR REPLACE FUNCTION</span> soft_delete_customer()
<span class="kw">RETURNS TRIGGER AS</span> $$
<span class="kw">BEGIN</span>
    <span class="co">-- Instead of deleting, set deleted_at</span>
    <span class="kw">UPDATE</span> customers
    <span class="kw">SET</span> deleted_at = <span class="fu">CURRENT_TIMESTAMP</span>
    <span class="kw">WHERE</span> id = OLD.id;

    <span class="co">-- Return NULL to prevent the actual delete</span>
    <span class="kw">RETURN NULL</span>;
<span class="kw">END</span>;
$$ <span class="kw">LANGUAGE</span> plpgsql;

<span class="co">-- Create trigger (only for non-deleted records)</span>
<span class="kw">CREATE TRIGGER</span> customer_soft_delete
<span class="kw">BEFORE DELETE ON</span> customers
<span class="kw">FOR EACH ROW</span>
<span class="kw">WHEN</span> (OLD.deleted_at <span class="kw">IS NULL</span>)
<span class="kw">EXECUTE FUNCTION</span> soft_delete_customer();

<span class="co">-- Create a view for active customers</span>
<span class="kw">CREATE OR REPLACE VIEW</span> active_customers <span class="kw">AS</span>
<span class="kw">SELECT</span> * <span class="kw">FROM</span> customers <span class="kw">WHERE</span> deleted_at <span class="kw">IS NULL</span>;

<span class="co">-- Test soft delete</span>
<span class="kw">DELETE FROM</span> customers <span class="kw">WHERE</span> id = <span class="dv">1</span>;

<span class="co">-- Record still exists with deleted_at set</span>
<span class="kw">SELECT</span> id, name, deleted_at <span class="kw">FROM</span> customers <span class="kw">WHERE</span> id = <span class="dv">1</span>;

<span class="co">-- But not visible in the view</span>
<span class="kw">SELECT</span> * <span class="kw">FROM</span> active_customers <span class="kw">WHERE</span> id = <span class="dv">1</span>; <span class="co">-- Returns nothing</span>

<span class="co">-- Restore a soft-deleted record</span>
<span class="kw">UPDATE</span> customers <span class="kw">SET</span> deleted_at = <span class="kw">NULL WHERE</span> id = <span class="dv">1</span>;</code></pre>

                        <div class="concept-box">
                            <strong>Benefits of Soft Deletes:</strong>
                            <ul class="mb-0">
                                <li>Data recovery without backups</li>
                                <li>Maintain referential integrity</li>
                                <li>Audit trail of deletions</li>
                                <li>Compliance requirements (data retention)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Part 3: Advanced Indexing -->
            <section>
                <h2>Part 3: Advanced Indexing Techniques</h2>
                <p>Optimize query performance with specialized indexes.</p>

                <div class="exercise-box">
                    <h4>Exercise 3.1: Partial Index for Common Queries</h4>
                    <p>Create indexes optimized for frequently queried subsets of data.</p>

                    <p><strong>Scenario:</strong> 90% of order queries are for 'pending' or 'processing' orders (only 5%
                        of all orders).</p>

                    <button class="btn-solution" onclick="toggleSolution('sol3_1')">Show Solution</button>
                    <div id="sol3_1" class="solution">
                        <pre><code class="sourceCode sql"><span class="co">-- Partial index for active orders only</span>
<span class="kw">CREATE INDEX</span> idx_orders_active
<span class="kw">ON</span> orders (order_date, customer_id)
<span class="kw">WHERE</span> status <span class="kw">IN</span> (<span class="st">'pending'</span>, <span class="st">'processing'</span>);

<span class="co">-- Compare with full index</span>
<span class="kw">CREATE INDEX</span> idx_orders_full
<span class="kw">ON</span> orders (order_date, customer_id);

<span class="co">-- Check index sizes</span>
<span class="kw">SELECT</span>
    indexrelname <span class="kw">AS</span> index_name,
    pg_size_pretty(pg_relation_size(indexrelid)) <span class="kw">AS</span> index_size
<span class="kw">FROM</span> pg_stat_user_indexes
<span class="kw">WHERE</span> relname = <span class="st">'orders'</span>
<span class="kw">ORDER BY</span> pg_relation_size(indexrelid) <span class="kw">DESC</span>;

<span class="co">-- Query that uses partial index</span>
<span class="kw">EXPLAIN ANALYZE</span>
<span class="kw">SELECT</span> * <span class="kw">FROM</span> orders
<span class="kw">WHERE</span> status = <span class="st">'pending'</span>
  <span class="kw">AND</span> order_date > <span class="fu">CURRENT_DATE</span> - <span class="dv">7</span>;</code></pre>

                        <table class="table table-bordered mt-3">
                            <thead>
                                <tr>
                                    <th>Index Type</th>
                                    <th>Rows Indexed</th>
                                    <th>Approx Size</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Full Index</td>
                                    <td>2,000,000</td>
                                    <td>~60 MB</td>
                                </tr>
                                <tr>
                                    <td>Partial Index</td>
                                    <td>100,000 (5%)</td>
                                    <td>~3 MB</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Exercise 3.2: Expression Index for Computed Values</h4>
                    <p>Create indexes that support queries with functions and expressions.</p>

                    <button class="btn-solution" onclick="toggleSolution('sol3_2')">Show Solution</button>
                    <div id="sol3_2" class="solution">
                        <pre><code class="sourceCode sql"><span class="co">-- Index for case-insensitive email search</span>
<span class="kw">CREATE INDEX</span> idx_customers_email_lower
<span class="kw">ON</span> customers (<span class="fu">LOWER</span>(email));

<span class="co">-- Query MUST use the same expression</span>
<span class="kw">SELECT</span> * <span class="kw">FROM</span> customers
<span class="kw">WHERE</span> <span class="fu">LOWER</span>(email) = <span class="st">'john@example.com'</span>;

<span class="co">-- Index for year-month grouping</span>
<span class="kw">CREATE INDEX</span> idx_orders_year_month
<span class="kw">ON</span> orders (
    <span class="fu">EXTRACT</span>(<span class="kw">YEAR FROM</span> order_date),
    <span class="fu">EXTRACT</span>(<span class="kw">MONTH FROM</span> order_date)
);

<span class="co">-- Index for JSONB attribute</span>
<span class="kw">CREATE INDEX</span> idx_products_brand
<span class="kw">ON</span> products ((attributes->><span class="st">'brand'</span>))
<span class="kw">WHERE</span> attributes->><span class="st">'brand'</span> <span class="kw">IS NOT NULL</span>;

<span class="co">-- Query using JSONB index</span>
<span class="kw">EXPLAIN ANALYZE</span>
<span class="kw">SELECT</span> * <span class="kw">FROM</span> products
<span class="kw">WHERE</span> attributes->><span class="st">'brand'</span> = <span class="st">'Apple'</span>;</code></pre>

                        <div class="warning-box">
                            <strong>Expression Match Required:</strong>
                            The query must use the EXACT same expression as the index.
                            <code>WHERE UPPER(email) = ...</code> won't use an index on <code>LOWER(email)</code>.
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Exercise 3.3: Covering Index for Index-Only Scans</h4>
                    <p>Create an index that includes all columns needed by a query, eliminating table access.</p>

                    <p><strong>Frequent query:</strong></p>
                    <pre><code class="sourceCode sql"><span class="kw">SELECT</span> customer_id, order_date, amount, status
<span class="kw">FROM</span> orders
<span class="kw">WHERE</span> customer_id = ?
<span class="kw">ORDER BY</span> order_date <span class="kw">DESC</span>
<span class="kw">LIMIT</span> <span class="dv">10</span>;</code></pre>

                    <button class="btn-solution" onclick="toggleSolution('sol3_3')">Show Solution</button>
                    <div id="sol3_3" class="solution">
                        <pre><code class="sourceCode sql"><span class="co">-- Covering index with INCLUDE</span>
<span class="kw">CREATE INDEX</span> idx_orders_customer_covering
<span class="kw">ON</span> orders (customer_id, order_date <span class="kw">DESC</span>)
<span class="kw">INCLUDE</span> (amount, status);

<span class="co">-- Test the query</span>
<span class="kw">EXPLAIN ANALYZE</span>
<span class="kw">SELECT</span> customer_id, order_date, amount, status
<span class="kw">FROM</span> orders
<span class="kw">WHERE</span> customer_id = <span class="dv">12345</span>
<span class="kw">ORDER BY</span> order_date <span class="kw">DESC</span>
<span class="kw">LIMIT</span> <span class="dv">10</span>;

<span class="co">-- Look for "Index Only Scan" in the plan</span>
<span class="co">-- Index Only Scan using idx_orders_customer_covering</span>
<span class="co">--   Index Cond: (customer_id = 12345)</span>
<span class="co">--   Heap Fetches: 0  <-- No table access!</span></code></pre>

                        <div class="concept-box">
                            <strong>INCLUDE vs Key Columns:</strong>
                            <ul class="mb-0">
                                <li><strong>Key columns</strong> (before INCLUDE): Used for filtering and sorting</li>
                                <li><strong>Included columns</strong>: Only stored for retrieval, not indexed for
                                    searching</li>
                                <li>Use INCLUDE for columns only in SELECT, not in WHERE/ORDER BY</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="exercise-box">
                    <h4>Exercise 3.4: Materialized View for Complex Analytics</h4>
                    <p>Create a materialized view for a frequently-run sales summary report.</p>

                    <button class="btn-solution" onclick="toggleSolution('sol3_4')">Show Solution</button>
                    <div id="sol3_4" class="solution">
                        <pre><code class="sourceCode sql"><span class="co">-- Create materialized view (using order_lines table from bootcamp_db)</span>
<span class="kw">CREATE MATERIALIZED VIEW</span> mv_daily_sales_summary <span class="kw">AS</span>
<span class="kw">SELECT</span>
    <span class="fu">DATE_TRUNC</span>(<span class="st">'day'</span>, o.order_date) <span class="kw">AS</span> sale_date,
    c.name <span class="kw">AS</span> category_name,
    <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> o.id) <span class="kw">AS</span> order_count,
    <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> o.customer_id) <span class="kw">AS</span> unique_customers,
    <span class="fu">SUM</span>(ol.quantity) <span class="kw">AS</span> units_sold,
    <span class="fu">SUM</span>(ol.quantity * ol.unit_price) <span class="kw">AS</span> revenue,
    <span class="fu">ROUND</span>(<span class="fu">AVG</span>(ol.quantity * ol.unit_price), <span class="dv">2</span>) <span class="kw">AS</span> avg_order_value
<span class="kw">FROM</span> orders o
<span class="kw">JOIN</span> order_lines ol <span class="kw">ON</span> o.id = ol.order_id
<span class="kw">JOIN</span> products p <span class="kw">ON</span> ol.product_id = p.id
<span class="kw">JOIN</span> categories c <span class="kw">ON</span> p.category_id = c.id
<span class="kw">WHERE</span> o.status = <span class="st">'delivered'</span>
<span class="kw">GROUP BY</span>
    <span class="fu">DATE_TRUNC</span>(<span class="st">'day'</span>, o.order_date),
    c.name
<span class="kw">WITH DATA</span>;

<span class="co">-- Create indexes on the materialized view</span>
<span class="kw">CREATE INDEX</span> idx_mv_daily_sales_date
<span class="kw">ON</span> mv_daily_sales_summary (sale_date);

<span class="kw">CREATE INDEX</span> idx_mv_daily_sales_category
<span class="kw">ON</span> mv_daily_sales_summary (category_name);

<span class="co">-- Query is now super fast</span>
<span class="kw">SELECT</span>
    category_name,
    <span class="fu">SUM</span>(revenue) <span class="kw">AS</span> total_revenue
<span class="kw">FROM</span> mv_daily_sales_summary
<span class="kw">WHERE</span> sale_date >= <span class="fu">CURRENT_DATE</span> - <span class="dv">30</span>
<span class="kw">GROUP BY</span> category_name
<span class="kw">ORDER BY</span> total_revenue <span class="kw">DESC</span>;

<span class="co">-- Refresh the view (run periodically)</span>
<span class="kw">REFRESH MATERIALIZED VIEW</span> mv_daily_sales_summary;

<span class="co">-- Concurrent refresh (doesn't block reads)</span>
<span class="kw">CREATE UNIQUE INDEX</span> idx_mv_daily_sales_pk
<span class="kw">ON</span> mv_daily_sales_summary (sale_date, category_name);

<span class="kw">REFRESH MATERIALIZED VIEW CONCURRENTLY</span> mv_daily_sales_summary;</code></pre>

                        <div class="hint-box">
                            <strong>Refresh Strategy:</strong>
                            <ul class="mb-0">
                                <li>Schedule refresh during low-traffic periods</li>
                                <li>Use <code>CONCURRENTLY</code> if reads must not be blocked (requires unique
                                    index)</li>
                                <li>Consider incremental refresh patterns for very large datasets</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Part 4: Challenge -->
            <section>
                <h2>Part 4: Challenge Exercise</h2>

                <div class="exercise-box">
                    <h4>Challenge: Complete Order Processing System</h4>
                    <p>Build a complete order processing system combining functions, triggers, and proper indexing.</p>

                    <p><strong>Requirements:</strong></p>
                    <ol>
                        <li>Function to create orders with multiple items</li>
                        <li>Trigger to validate stock availability</li>
                        <li>Trigger to update order summary table</li>
                        <li>Proper indexes for common queries</li>
                    </ol>

                    <button class="btn-solution" onclick="toggleSolution('sol4_1')">Show Solution</button>
                    <div id="sol4_1" class="solution">
                        <pre><code class="sourceCode sql"><span class="co">-- 1. Create supporting tables</span>
<span class="kw">CREATE TABLE</span> order_summary (
    customer_id <span class="dt">INTEGER PRIMARY KEY</span>,
    total_orders <span class="dt">INTEGER DEFAULT</span> <span class="dv">0</span>,
    total_spent <span class="dt">NUMERIC DEFAULT</span> <span class="dv">0</span>,
    last_order_date <span class="dt">DATE</span>,
    avg_order_value <span class="dt">NUMERIC</span>
);

<span class="co">-- 2. Stock validation trigger (uses order_lines.product_id FK to products.id)</span>
<span class="kw">CREATE OR REPLACE FUNCTION</span> check_stock_before_order_item()
<span class="kw">RETURNS TRIGGER AS</span> $$
<span class="kw">DECLARE</span>
    v_stock <span class="dt">INTEGER</span>;
    v_product_name <span class="dt">TEXT</span>;
<span class="kw">BEGIN</span>
    <span class="kw">SELECT</span> stock_quantity, name <span class="kw">INTO</span> v_stock, v_product_name
    <span class="kw">FROM</span> products
    <span class="kw">WHERE</span> id = NEW.product_id
    <span class="kw">FOR UPDATE</span>;

    <span class="kw">IF</span> v_stock < NEW.quantity <span class="kw">THEN</span>
        <span class="kw">RAISE EXCEPTION</span>
            <span class="st">'Insufficient stock for %. Available: %, Requested: %'</span>,
            v_product_name, v_stock, NEW.quantity;
    <span class="kw">END IF</span>;

    <span class="co">-- Reduce stock</span>
    <span class="kw">UPDATE</span> products
    <span class="kw">SET</span> stock_quantity = stock_quantity - NEW.quantity
    <span class="kw">WHERE</span> id = NEW.product_id;

    <span class="kw">RETURN</span> NEW;
<span class="kw">END</span>;
$$ <span class="kw">LANGUAGE</span> plpgsql;

<span class="kw">CREATE TRIGGER</span> validate_stock
<span class="kw">BEFORE INSERT ON</span> order_items
<span class="kw">FOR EACH ROW</span>
<span class="kw">EXECUTE FUNCTION</span> check_stock_before_order_item();

<span class="co">-- 3. Order summary update trigger (uses total_amount from orders table)</span>
<span class="kw">CREATE OR REPLACE FUNCTION</span> update_order_summary()
<span class="kw">RETURNS TRIGGER AS</span> $$
<span class="kw">BEGIN</span>
    <span class="kw">INSERT INTO</span> order_summary (customer_id, total_orders, total_spent, last_order_date, avg_order_value)
    <span class="kw">VALUES</span> (NEW.customer_id, <span class="dv">1</span>, NEW.total_amount, NEW.order_date, NEW.total_amount)
    <span class="kw">ON CONFLICT</span> (customer_id)
    <span class="kw">DO UPDATE SET</span>
        total_orders = order_summary.total_orders + <span class="dv">1</span>,
        total_spent = order_summary.total_spent + NEW.total_amount,
        last_order_date = <span class="fu">GREATEST</span>(order_summary.last_order_date, NEW.order_date),
        avg_order_value = (order_summary.total_spent + NEW.total_amount) / (order_summary.total_orders + <span class="dv">1</span>);

    <span class="kw">RETURN</span> NEW;
<span class="kw">END</span>;
$$ <span class="kw">LANGUAGE</span> plpgsql;

<span class="kw">CREATE TRIGGER</span> maintain_order_summary
<span class="kw">AFTER INSERT ON</span> orders
<span class="kw">FOR EACH ROW</span>
<span class="kw">EXECUTE FUNCTION</span> update_order_summary();

<span class="co">-- 4. Main order creation function</span>
<span class="kw">CREATE OR REPLACE FUNCTION</span> create_order(
    p_customer_id <span class="dt">INTEGER</span>,
    p_items <span class="dt">JSONB</span>  <span class="co">-- [{product_id: 1, quantity: 2}, ...]</span>
)
<span class="kw">RETURNS INTEGER AS</span> $$
<span class="kw">DECLARE</span>
    v_order_id <span class="dt">INTEGER</span>;
    v_item <span class="dt">JSONB</span>;
    v_total <span class="dt">NUMERIC</span> := <span class="dv">0</span>;
    v_price <span class="dt">NUMERIC</span>;
<span class="kw">BEGIN</span>
    <span class="co">-- Create order</span>
    <span class="kw">INSERT INTO</span> orders (customer_id, order_date, status, amount)
    <span class="kw">VALUES</span> (p_customer_id, <span class="fu">CURRENT_DATE</span>, <span class="st">'pending'</span>, <span class="dv">0</span>)
    <span class="kw">RETURNING</span> id <span class="kw">INTO</span> v_order_id;

    <span class="co">-- Add items</span>
    <span class="kw">FOR</span> v_item <span class="kw">IN SELECT</span> * <span class="kw">FROM</span> jsonb_array_elements(p_items)
    <span class="kw">LOOP</span>
        <span class="kw">SELECT</span> price <span class="kw">INTO</span> v_price
        <span class="kw">FROM</span> products
        <span class="kw">WHERE</span> product_id = (v_item->><span class="st">'product_id'</span>)::<span class="dt">integer</span>;

        <span class="kw">INSERT INTO</span> order_items (order_id, product_id, quantity, price)
        <span class="kw">VALUES</span> (
            v_order_id,
            (v_item->><span class="st">'product_id'</span>)::<span class="dt">integer</span>,
            (v_item->><span class="st">'quantity'</span>)::<span class="dt">integer</span>,
            v_price
        );

        v_total := v_total + (v_price * (v_item->><span class="st">'quantity'</span>)::<span class="dt">integer</span>);
    <span class="kw">END LOOP</span>;

    <span class="co">-- Update order total</span>
    <span class="kw">UPDATE</span> orders <span class="kw">SET</span> amount = v_total <span class="kw">WHERE</span> id = v_order_id;

    <span class="kw">RETURN</span> v_order_id;
<span class="kw">END</span>;
$$ <span class="kw">LANGUAGE</span> plpgsql;

<span class="co">-- 5. Create optimized indexes</span>
<span class="kw">CREATE INDEX</span> idx_orders_customer_date
<span class="kw">ON</span> orders (customer_id, order_date <span class="kw">DESC</span>)
<span class="kw">INCLUDE</span> (amount, status);

<span class="kw">CREATE INDEX</span> idx_orders_pending
<span class="kw">ON</span> orders (order_date)
<span class="kw">WHERE</span> status = <span class="st">'pending'</span>;

<span class="kw">CREATE INDEX</span> idx_order_items_order
<span class="kw">ON</span> order_items (order_id)
<span class="kw">INCLUDE</span> (product_id, quantity, price);

<span class="co">-- Usage example</span>
<span class="kw">SELECT</span> create_order(
    <span class="dv">123</span>,
    <span class="st">'[{"product_id": 1, "quantity": 2}, {"product_id": 3, "quantity": 1}]'</span>::jsonb
);</code></pre>
                    </div>
                </div>
            </section>

            <!-- Key Takeaways -->
            <section>
                <h3>Key Takeaways</h3>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Topic</th>
                            <th>Key Points</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Functions</strong></td>
                            <td>
                                <ul class="mb-0">
                                    <li>Use <code>RETURNS TABLE</code> for set-returning functions</li>
                                    <li>Handle errors with <code>EXCEPTION</code> blocks</li>
                                    <li><code>FOR UPDATE</code> prevents race conditions</li>
                                </ul>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Procedures</strong></td>
                            <td>
                                <ul class="mb-0">
                                    <li>Can use <code>COMMIT</code> and <code>ROLLBACK</code></li>
                                    <li>Call with <code>CALL procedure_name()</code></li>
                                    <li>Use for batch operations with transaction control</li>
                                </ul>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Triggers</strong></td>
                            <td>
                                <ul class="mb-0">
                                    <li><code>BEFORE</code> triggers can modify NEW values</li>
                                    <li>Use <code>WHEN</code> clause to avoid unnecessary execution</li>
                                    <li>Return <code>NULL</code> from BEFORE trigger to cancel operation</li>
                                </ul>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Indexing</strong></td>
                            <td>
                                <ul class="mb-0">
                                    <li>Partial indexes save space and improve performance</li>
                                    <li>Expression indexes must match query expressions exactly</li>
                                    <li>Use <code>INCLUDE</code> for covering indexes</li>
                                    <li>Materialized views pre-compute expensive aggregations</li>
                                </ul>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <!-- Navigation -->
            <section>
                <div class="d-flex justify-content-between">
                    <a href="01_advanced_postgresql_features.html" class="btn btn-outline-primary">&larr; Back to
                        Lesson</a>
                </div>
            </section>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script>
        function toggleSolution(id) {
            var element = document.getElementById(id);
            if (element.classList.contains('show')) {
                element.classList.remove('show');
                event.target.textContent = 'Show Solution';
            } else {
                element.classList.add('show');
                event.target.textContent = 'Hide Solution';
            }
        }
    </script>
</body>

</html>
