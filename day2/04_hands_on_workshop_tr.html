<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="tr" xml:lang="tr">

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="../css/style_bootstrap.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/code.css">
    <link href="https://cdn.prod.website-files.com/5efdb54f07a6812bcd95cc65/6773d0fc3013e060f08d7145_favicon.jpg"
        rel="shortcut icon" type="image/x-icon">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <title>Gün 2: Uygulamalı Atölye</title>
    <style>
        code {
            white-space: pre-wrap;
        }

        span.smallcaps {
            font-variant: small-caps;
        }

        span.underline {
            text-decoration: underline;
        }

        div.column {
            display: inline-block;
            vertical-align: top;
            width: 50%;
        }

        div.hanging-indent {
            margin-left: 1.5em;
            text-indent: -1.5em;
        }

        ul.task-list {
            list-style: none;
        }

        .language-switcher {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .language-switcher a {
            text-decoration: none;
            padding: 5px 10px;
            margin: 0 2px;
            border-radius: 3px;
            color: #333;
        }

        .language-switcher a.active {
            background: #0d6efd;
            color: #fff;
        }

        .language-switcher a:hover:not(.active) {
            background: #e9ecef;
        }

        .exercise-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .exercise-box h4 {
            color: #495057;
            margin-bottom: 15px;
        }

        .solution-box {
            background-color: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .solution-box.show {
            display: block;
        }

        .toggle-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        .toggle-btn:hover {
            background-color: #0056b3;
        }

        .hint-box {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .hint-box::before {
            content: "İpucu: ";
            font-weight: bold;
        }

        .concept-box {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .concept-box::before {
            content: "Kavram: ";
            font-weight: bold;
        }

        .dataset-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
        }

        .dataset-table th,
        .dataset-table td {
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            text-align: left;
        }

        .dataset-table th {
            background-color: #343a40;
            color: white;
        }

        .dataset-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
    </style>
</head>

<body>
    <a href="../index_tr.html" class="back-button">&larr; İçindekiler'e Dön</a>
    <div class="language-switcher">
        <a href="04_hands_on_workshop.html">EN</a>
        <a href="04_hands_on_workshop_tr.html" class="active">TR</a>
    </div>
    <div class="copy-notification" id="copyNotification">Kopyalandı!</div>
    <div id="europeanunion-turkey">
        <img src="../static/eu.png" alt="">
    </div>
    <div id="sanayiteknolojibakan">
        <img src="../static/sanayitek.png" alt="">
    </div>
    <div id="rekabet">
        <img src="../static/rekabet.png" alt="">
    </div>
    <div id="tisk">
        <img src="../static/tisk.png" alt="">
    </div>
    <div id="undp">
        <img src="../static/undp.png" alt="">
    </div>
    <div class="content-container">
        <div class="container">
            <section>
                <h1 id="gun-2-uygulamali-atolye">Gün 2: Uygulamalı Atölye</h1>
                <h2 id="veritabanini-kesif">bootcamp_db Veritabanını Keşfetme</h2>

                <p>Bu uygulamalı atölyede, öğrendiğimiz SQL kavramlarını uygulayarak <code>bootcamp_db</code> veritabanının yapısını ve içeriğini keşfedeceğiz. Bu PostgreSQL veritabanı, tipik bir e-ticaret senaryosu için tablolar içermektedir.</p>

                <div class="concept-box">
                    <code>bootcamp_db</code> veritabanı şunları içerir: <code>customers</code> (müşteriler), <code>products</code> (JSONB attributes ile), <code>orders</code> (JSONB metadata ile), <code>order_lines</code>, <code>categories</code>, <code>suppliers</code>, <code>employees</code>, <code>stock_movements</code> ve <code>countries</code>.
                </div>

                <h3 id="semalari-ve-tablolari-gezinme">Şemaları ve Tabloları Gezinme</h3>
                <p>Mevcut şemaları ve tabloları keşfederek başlayalım:</p>

                <div class="row">
                    <div class="col-md-4">
                        <pre><code class="language-sql">-- Veritabanındaki tüm şemaları listele
SELECT schema_name
FROM information_schema.schemata
ORDER BY schema_name;</code></pre>
                    </div>
                    <div class="col-md-4">
                        <pre><code class="language-sql">-- public şemasındaki tabloları listele
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
ORDER BY table_name;</code></pre>
                    </div>
                    <div class="col-md-4">
                        <pre><code class="language-sql">-- Her şemadaki tablo sayısını say
SELECT table_schema, COUNT(*) as table_count
FROM information_schema.tables
WHERE table_type = 'BASE TABLE'
GROUP BY table_schema
ORDER BY table_count DESC;</code></pre>
                    </div>
                </div>
            </section>

            <section>
                <h3 id="tablo-yapisini-kesfetme">Tablo Yapısını Keşfetme</h3>
                <p>Veritabanındaki bazı önemli tabloların yapısını inceleyelim:</p>

                <div class="row">
                    <div class="col-md-6">
                        <pre><code class="language-sql">-- customers tablosunu tanımla
SELECT
    column_name,
    data_type,
    character_maximum_length,
    is_nullable
FROM
    information_schema.columns
WHERE
    table_name = 'customers'
ORDER BY
    ordinal_position;</code></pre>
                    </div>
                    <div class="col-md-6">
                        <pre><code class="language-sql">-- orders tablosundaki kısıtlamaları incele
SELECT
    tc.constraint_name,
    tc.constraint_type,
    kcu.column_name,
    ccu.table_name AS foreign_table,
    ccu.column_name AS foreign_column
FROM
    information_schema.table_constraints tc
JOIN
    information_schema.key_column_usage kcu
    ON tc.constraint_name = kcu.constraint_name
LEFT JOIN
    information_schema.constraint_column_usage ccu
    ON ccu.constraint_name = tc.constraint_name
WHERE
    tc.table_name = 'orders'
ORDER BY
    tc.constraint_type,
    kcu.column_name;</code></pre>
                    </div>
                </div>
            </section>

            <section>
                <h3 id="iliskileri-bulma">Tablolar Arası İlişkileri Bulma</h3>
                <p>Tablo ilişkilerini anlamak etkili sorgulama için çok önemlidir:</p>
                <pre><code class="language-sql">-- customers'a referans veren tüm tabloları bul
SELECT
    tc.table_name,
    kcu.column_name
FROM
    information_schema.table_constraints tc
JOIN
    information_schema.key_column_usage kcu
    ON tc.constraint_name = kcu.constraint_name
JOIN
    information_schema.constraint_column_usage ccu
    ON ccu.constraint_name = tc.constraint_name
WHERE
    tc.constraint_type = 'FOREIGN KEY' AND
    ccu.table_name = 'customers' AND
    ccu.column_name = 'id'
ORDER BY
    tc.table_name;</code></pre>
            </section>

            <section>
                <h3 id="veri-modelini-anlama">Veri Modelini Anlama</h3>
                <p><code>bootcamp_db</code> veri modeli e-ticaret senaryoları için tasarlanmıştır. Temel iş varlıklarını keşfedelim:</p>

                <div class="row">
                    <div class="col-md-6">
                        <ol>
                            <li><strong>Müşteriler (Customers)</strong>:
                                <ul>
                                    <li>Müşteri bilgileri ve türleri: individual, business, vip</li>
                                    <li>Siparişler ve ülkelerle bağlantılı</li>
                                </ul>
                            </li>
                            <li><strong>Ürünler (Products)</strong>:
                                <ul>
                                    <li>Kategoriler ve tedarikçilerle ürün kataloğu</li>
                                    <li>Esnek özellikler için <code>attributes</code> JSONB sütunu</li>
                                </ul>
                            </li>
                            <li><strong>Siparişler ve Sipariş Satırları</strong>:
                                <ul>
                                    <li><code>orders</code>: Durum, toplamlar ve metadata JSONB ile sipariş başlığı</li>
                                    <li><code>order_lines</code>: Siparişlerdeki bireysel ürünler</li>
                                </ul>
                            </li>
                        </ol>
                    </div>
                    <div class="col-md-6">
                        <ol start="4">
                            <li><strong>Kategoriler (Categories)</strong>:
                                <ul>
                                    <li>parent_id ile hiyerarşik ürün kategorileri</li>
                                    <li>Özyinelemeli sorguları destekler</li>
                                </ul>
                            </li>
                            <li><strong>Çalışanlar (Employees)</strong>:
                                <ul>
                                    <li>manager_id ile çalışan hiyerarşisi</li>
                                    <li>Departman ve maaş bilgilerini içerir</li>
                                </ul>
                            </li>
                            <li><strong>Stok Hareketleri (Stock Movements)</strong>:
                                <ul>
                                    <li>Envanter değişikliklerini takip eder: satın alma, satış, iade, düzeltme</li>
                                </ul>
                            </li>
                        </ol>
                    </div>
                </div>
            </section>

            <section>
                <p>Bu varlıkları bazı sorgularla keşfedelim:</p>
                <div class="row">
                    <div class="col-md-6">
                        <pre><code class="language-sql">-- Müşterilerin türe göre dağılımı
SELECT
    customer_type,
    COUNT(*) as count
FROM
    customers
WHERE
    status = 'active'
GROUP BY
    customer_type
ORDER BY
    count DESC;</code></pre>
                    </div>
                    <div class="col-md-6">
                        <pre><code class="language-sql">-- Ürün kategorileri hiyerarşisi
WITH RECURSIVE category_tree AS (
    SELECT
        id,
        name,
        parent_id,
        0 AS level,
        name::TEXT AS path
    FROM categories
    WHERE parent_id IS NULL
    UNION ALL
    SELECT
        c.id,
        c.name,
        c.parent_id,
        ct.level + 1,
        ct.path || ' > ' || c.name
    FROM categories c
    JOIN category_tree ct ON c.parent_id = ct.id
)
SELECT
    level,
    path,
    (SELECT COUNT(*) FROM products p WHERE p.category_id = category_tree.id) AS product_count
FROM category_tree
ORDER BY path;</code></pre>
                    </div>
                </div>
            </section>

            <section>
                <h3 id="temel-sorgular-yazma">Veritabanına Karşı Temel Sorgular Yazma</h3>
                <p>Şimdi yararlı iş bilgilerini çıkaran sorgular yazmayı pratik yapalım. SQL koduna bakmadan önce her örneği dikkatlice inceleyin.</p>

                <div class="exercise-box">
                    <h4>Örnek 1: Müşteri Analizi</h4>
                    <p><strong>Amaç:</strong> Toplam satın alma tutarına göre en değerli 10 müşteriyi belirleyin.</p>
                    <p><strong>İş Sorusu:</strong> En iyi müşterilerimiz kimler ve ne kadar harcadılar?</p>
                    <p><strong>Kullanılan Kavramlar:</strong></p>
                    <ul>
                        <li>Müşterileri siparişleriyle bağlamak için <code>JOIN</code></li>
                        <li>Müşteri başına verileri toplamak için <code>GROUP BY</code></li>
                        <li><code>SUM()</code> ve <code>COUNT()</code> toplama fonksiyonları</li>
                        <li>En iyi sonuçları almak için <code>ORDER BY ... DESC</code> ve <code>LIMIT</code></li>
                    </ul>
                    <p><strong>Tablolar:</strong> <code>customers</code>, <code>orders</code></p>
                </div>
                <pre><code class="language-sql">-- Toplam sipariş değerine göre ilk 10 müşteri
SELECT
    c.name AS customer,
    c.email,
    c.customer_type,
    COUNT(o.id) AS order_count,
    SUM(o.total_amount) AS total_spent
FROM
    customers c
JOIN
    orders o ON c.id = o.customer_id
WHERE
    o.status IN ('delivered', 'shipped', 'confirmed')
GROUP BY
    c.id, c.name, c.email, c.customer_type
ORDER BY
    total_spent DESC
LIMIT 10;</code></pre>
            </section>

            <section>
                <div class="exercise-box">
                    <p><strong>Amaç:</strong> Siparişi olmayanlar dahil TÜM müşterilerin sipariş aktivitelerini gösteren bir özet oluşturun.</p>
                    <p><strong>İş Sorusu:</strong> Hangi müşteriler pasif veya düşük etkileşimli?</p>
                    <p><strong>Anahtar Kavram:</strong> <code>LEFT JOIN</code> eşleşen siparişi olmasa bile tüm müşterileri tutar. <code>COALESCE()</code> join'den gelen NULL değerlerini işler.</p>
                </div>
                <pre><code class="language-sql">-- Müşteri sipariş özeti (tüm müşterileri sipariş sayılarıyla gösterir)
SELECT
    c.name,
    c.email,
    c.customer_type,
    COUNT(o.id) AS order_count,
    COALESCE(SUM(o.total_amount), 0) AS total_spent
FROM
    customers c
LEFT JOIN
    orders o ON c.id = o.customer_id AND o.status NOT IN ('cancelled', 'draft')
GROUP BY
    c.id, c.name, c.email, c.customer_type
ORDER BY
    order_count ASC, c.name
LIMIT 20;</code></pre>
            </section>

            <section>
                <div class="exercise-box">
                    <h4>Örnek 2: Ürün Performansı</h4>
                    <p><strong>Amaç:</strong> Toplam gelire göre sıralanmış en çok satan ürünleri bulun.</p>
                    <p><strong>İş Sorusu:</strong> İşletmemiz için en çok gelir getiren ürünler hangileri?</p>
                    <p><strong>Kullanılan Kavramlar:</strong></p>
                    <ul>
                        <li>order_lines → orders → products → categories bağlantısı için çoklu <code>JOIN</code></li>
                        <li>Toplam miktar ve geliri hesaplamak için <code>SUM()</code></li>
                        <li><code>WHERE status IN (...)</code> ile tamamlanmış siparişleri filtreleme</li>
                    </ul>
                    <p><strong>Tablolar:</strong> <code>order_lines</code>, <code>orders</code>, <code>products</code>, <code>categories</code></p>
                </div>
                <pre><code class="language-sql">-- Gelire göre en çok satan ürünler
SELECT
    p.name AS product,
    cat.name AS category,
    SUM(ol.quantity) AS quantity_sold,
    SUM(ol.line_total) AS revenue
FROM
    order_lines ol
JOIN
    orders o ON ol.order_id = o.id
JOIN
    products p ON ol.product_id = p.id
LEFT JOIN
    categories cat ON p.category_id = cat.id
WHERE
    o.status IN ('delivered', 'shipped', 'confirmed')
GROUP BY
    p.id, p.name, cat.name
ORDER BY
    revenue DESC
LIMIT 15;</code></pre>
            </section>

            <section>
                <div class="exercise-box">
                    <p><strong>Amaç:</strong> Stok seviyesi minimum eşiğin altında olduğu için yeniden sipariş verilmesi gereken ürünleri belirleyin.</p>
                    <p><strong>İş Sorusu:</strong> Hangi ürünler azalıyor ve stoklama gerekiyor?</p>
                    <p><strong>Anahtar Kavram:</strong> <code>CASE WHEN</code> koşullu bir durum sütunu oluşturur. <code>stock_quantity</code> ile <code>reorder_level</code> karşılaştırması dikkat gerektiren ürünleri belirler.</p>
                </div>
                <pre><code class="language-sql">-- Düşük stoklu ürünler (yeniden sipariş seviyesinin altında)
SELECT
    p.name AS product,
    p.sku,
    p.price,
    p.stock_quantity AS current_stock,
    p.reorder_level,
    CASE
        WHEN p.stock_quantity < p.reorder_level THEN 'Yeniden Sipariş Gerekli'
        ELSE 'OK'
    END AS stock_status
FROM
    products p
WHERE
    p.active = true
    AND p.stock_quantity < p.reorder_level
ORDER BY
    p.stock_quantity ASC;</code></pre>
            </section>

            <section>
                <div class="exercise-box">
                    <h4>Örnek 3: Satış Analizi</h4>
                    <p><strong>Amaç:</strong> Siparişleri aylık dönemlere gruplayarak satış trendlerini analiz edin.</p>
                    <p><strong>İş Sorusu:</strong> Satışlarımız aydan aya nasıl değişiyor? Mevsimsel kalıplar var mı?</p>
                    <p><strong>Kullanılan Kavramlar:</strong></p>
                    <ul>
                        <li>Tarihleri aylık gruplara ayırmak için <code>DATE_TRUNC('month', ...)</code></li>
                        <li>Benzersiz siparişleri saymak için <code>COUNT(DISTINCT ...)</code></li>
                        <li>Zaman serisi analiz kalıbı</li>
                    </ul>
                    <p><strong>Tablolar:</strong> <code>orders</code></p>
                </div>
                <pre><code class="language-sql">-- Aylık satış trendi (tüm zamanlar)
SELECT
    DATE_TRUNC('month', o.order_date) AS month,
    COUNT(DISTINCT o.id) AS order_count,
    SUM(o.total_amount) AS total_sales
FROM
    orders o
WHERE
    o.status IN ('delivered', 'shipped', 'confirmed')
GROUP BY
    DATE_TRUNC('month', o.order_date)
ORDER BY
    month;</code></pre>
            </section>

            <section>
                <div class="exercise-box">
                    <p><strong>Amaç:</strong> Satış performansını coğrafi bölgelere (ülkelere) göre ayrıştırın.</p>
                    <p><strong>İş Sorusu:</strong> Hangi ülkeler en çok gelir üretiyor? Pazarlamayı nereye odaklamalıyız?</p>
                    <p><strong>Anahtar Kavram:</strong> Satış verilerini coğrafi bilgilerle bağlamak için zincirleme <code>JOIN</code>: orders → customers → countries.</p>
                </div>
                <pre><code class="language-sql">-- Ülkelere göre satışlar
SELECT
    co.name AS country,
    COUNT(DISTINCT o.id) AS order_count,
    SUM(o.total_amount) AS total_sales
FROM
    orders o
JOIN
    customers c ON o.customer_id = c.id
JOIN
    countries co ON c.country_id = co.id
WHERE
    o.status IN ('delivered', 'shipped', 'confirmed')
GROUP BY
    co.name
ORDER BY
    total_sales DESC;</code></pre>
            </section>

            <section>
                <h3 id="pratik-alistirmalar">Pratik Alıştırmalar</h3>
                <p>Şimdi bazı rehberli alıştırmalarla pratik yapma zamanı. Her alıştırma için, çözüme bakmadan önce sorguyu kendiniz yazmayı deneyin.</p>

                <div class="exercise-box">
                    <h4>Alıştırma 1: Yüksek İndirimli Siparişleri Bulma</h4>
                    <p><strong>Amaç:</strong> İndirim tutarı ara toplamın %10'undan fazla olan tüm siparişleri bulun. Sipariş numarası, müşteri adı, ara toplam, indirim tutarı ve indirim yüzdesini dahil edin.</p>

                    <div class="hint-box">
                        <code>orders</code> tablosunu <code>customers</code> ile birleştirin. İndirim yüzdesini <code>(discount_amount / subtotal) * 100</code> olarak hesaplayın.
                    </div>

                    <button class="toggle-btn" onclick="toggleSolution('solution1')">Çözümü Göster</button>
                    <div id="solution1" class="solution-box">
                        <pre><code class="language-sql">SELECT
    o.order_number,
    c.name AS customer,
    o.subtotal,
    o.discount_amount,
    ROUND((o.discount_amount / NULLIF(o.subtotal, 0)) * 100, 2) AS discount_percentage
FROM
    orders o
JOIN
    customers c ON o.customer_id = c.id
WHERE
    o.subtotal > 0
    AND (o.discount_amount / o.subtotal) > 0.10
ORDER BY
    discount_percentage DESC;</code></pre>
                    </div>
                </div>
            </section>

            <section>
                <div class="exercise-box">
                    <h4>Alıştırma 2: Ürün Karlılık Analizi</h4>
                    <p><strong>Amaç:</strong> Satılan her ürün için kar marjını hesaplayın. Ürün adı, kategori, toplam satış adedi, toplam gelir, toplam maliyet, kar ve kar marjı yüzdesini dahil edin.</p>

                    <div class="hint-box">
                        <code>order_lines</code>, <code>orders</code>, <code>products</code> ve <code>categories</code> tablolarını kullanın. Kar = Gelir - (Adet * Maliyet). Kar marjı = (Kar / Gelir) * 100.
                    </div>

                    <button class="toggle-btn" onclick="toggleSolution('solution2')">Çözümü Göster</button>
                    <div id="solution2" class="solution-box">
                        <pre><code class="language-sql">SELECT
    p.name AS product,
    cat.name AS category,
    SUM(ol.quantity) AS quantity_sold,
    SUM(ol.line_total) AS revenue,
    SUM(ol.quantity * p.cost) AS total_cost,
    SUM(ol.line_total) - SUM(ol.quantity * p.cost) AS profit,
    CASE
        WHEN SUM(ol.line_total) = 0 THEN 0
        ELSE ROUND(
            (SUM(ol.line_total) - SUM(ol.quantity * p.cost)) / SUM(ol.line_total) * 100,
            2
        )
    END AS profit_margin_percentage
FROM
    order_lines ol
JOIN
    orders o ON ol.order_id = o.id
JOIN
    products p ON ol.product_id = p.id
LEFT JOIN
    categories cat ON p.category_id = cat.id
WHERE
    o.status IN ('delivered', 'shipped', 'confirmed')
    AND p.cost IS NOT NULL
GROUP BY
    p.id, p.name, cat.name
HAVING
    SUM(ol.line_total) > 0
ORDER BY
    profit_margin_percentage DESC;</code></pre>
                    </div>
                </div>
            </section>

            <section>
                <div class="exercise-box">
                    <h4>Alıştırma 3: Müşteri Segmentasyonu</h4>
                    <p><strong>Amaç:</strong> Müşterileri toplam satın alma tutarlarına göre şu kategorilere segmente edin:</p>
                    <ul>
                        <li><strong>VIP:</strong> 10.000$'dan fazla alışveriş</li>
                        <li><strong>Regular (Düzenli):</strong> 1.000$ ile 10.000$ arası alışveriş</li>
                        <li><strong>Occasional (Ara Sıra):</strong> 1.000$'dan az alışveriş (ama > 0)</li>
                        <li><strong>Inactive (Pasif):</strong> Hiç alışveriş yok</li>
                    </ul>
                    <p>Her segmentteki müşteri sayısını gösterin.</p>

                    <button class="toggle-btn" onclick="toggleSolution('solution3')">Çözümü Göster</button>
                    <div id="solution3" class="solution-box">
                        <pre><code class="language-sql">SELECT
    customer_segment,
    COUNT(*) AS customer_count
FROM (
    SELECT
        CASE
            WHEN total_spent > 10000 THEN 'VIP'
            WHEN total_spent BETWEEN 1000 AND 10000 THEN 'Regular'
            WHEN total_spent < 1000 AND total_spent > 0 THEN 'Occasional'
            ELSE 'Inactive'
        END AS customer_segment
    FROM (
        SELECT
            c.id,
            COALESCE(SUM(o.total_amount), 0) AS total_spent
        FROM
            customers c
        LEFT JOIN
            orders o ON c.id = o.customer_id
            AND o.status IN ('delivered', 'shipped', 'confirmed')
        GROUP BY
            c.id
    ) AS spending_data
) AS segmented_data
GROUP BY
    customer_segment
ORDER BY
    MIN(CASE customer_segment
        WHEN 'VIP' THEN 1
        WHEN 'Regular' THEN 2
        WHEN 'Occasional' THEN 3
        ELSE 4
    END);</code></pre>
                    </div>
                </div>
            </section>

            <section>
                <div class="exercise-box">
                    <h4>Alıştırma 4: Çalışan Hiyerarşisi</h4>
                    <p><strong>Amaç:</strong> Her çalışanın adını, yöneticisinin adını ve organizasyondaki seviyesini (CEO = seviye 0) gösteren tam çalışan hiyerarşisini görüntüleyin.</p>

                    <div class="hint-box">
                        <code>manager_id IS NULL</code> olan çalışanlardan (üst seviye) başlayarak özyinelemeli bir CTE kullanın.
                    </div>

                    <button class="toggle-btn" onclick="toggleSolution('solution4')">Çözümü Göster</button>
                    <div id="solution4" class="solution-box">
                        <pre><code class="language-sql">WITH RECURSIVE employee_hierarchy AS (
    -- Temel durum: üst seviye çalışanlar (yöneticisi yok)
    SELECT
        id,
        (first_name || ' ' || last_name)::TEXT AS employee_name,
        department,
        job_title,
        manager_id,
        0 AS level,
        (first_name || ' ' || last_name)::TEXT AS path
    FROM employees
    WHERE manager_id IS NULL

    UNION ALL

    -- Özyinelemeli durum: yöneticisi olan çalışanlar
    SELECT
        e.id,
        e.first_name || ' ' || e.last_name,
        e.department,
        e.job_title,
        e.manager_id,
        eh.level + 1,
        eh.path || ' > ' || e.first_name || ' ' || e.last_name
    FROM employees e
    JOIN employee_hierarchy eh ON e.manager_id = eh.id
)
SELECT
    eh.employee_name,
    eh.department,
    eh.job_title,
    COALESCE(m.first_name || ' ' || m.last_name, 'Yönetici Yok') AS manager_name,
    eh.level
FROM employee_hierarchy eh
LEFT JOIN employees m ON eh.manager_id = m.id
ORDER BY eh.level, eh.employee_name;</code></pre>
                    </div>
                </div>
            </section>

            <section>
                <div class="exercise-box">
                    <h4>Alıştırma 5: JSON Analizi - Sipariş Kaynakları</h4>
                    <p><strong>Amaç:</strong> Siparişler tablosundaki <code>metadata</code> JSONB sütununu analiz edin. Siparişleri kaynak kanallarına göre (<code>metadata->>'source'</code> ile saklanır) sayın ve her kaynak için toplam geliri hesaplayın.</p>

                    <div class="hint-box">
                        Kaynağı metin olarak çıkarmak için <code>metadata->>'source'</code> kullanın. NULL metadata değerlerini filtreleyin.
                    </div>

                    <button class="toggle-btn" onclick="toggleSolution('solution5')">Çözümü Göster</button>
                    <div id="solution5" class="solution-box">
                        <pre><code class="language-sql">SELECT
    metadata->>'source' AS order_source,
    COUNT(*) AS order_count,
    SUM(total_amount) AS total_revenue,
    ROUND(AVG(total_amount), 2) AS avg_order_value
FROM
    orders
WHERE
    metadata IS NOT NULL
    AND metadata->>'source' IS NOT NULL
    AND status IN ('delivered', 'shipped', 'confirmed')
GROUP BY
    metadata->>'source'
ORDER BY
    total_revenue DESC;</code></pre>
                    </div>
                </div>
            </section>

            <section>
                <div class="exercise-box">
                    <h4>Alıştırma 6: JSON Analizi - Ürün Özellikleri</h4>
                    <p><strong>Amaç:</strong> '5g' özelliğine sahip tüm ürünleri bulun (<code>attributes</code> JSONB sütununda <code>{"5g": true}</code> olarak saklanır). Ürün adı, marka ve fiyatı görüntüleyin.</p>

                    <div class="hint-box">
                        Attributes'un <code>{"5g": true}</code> içerip içermediğini kontrol etmek için <code>@></code> kapsama operatörünü kullanın. Markayı <code>attributes->>'brand'</code> ile çıkarın.
                    </div>

                    <button class="toggle-btn" onclick="toggleSolution('solution6')">Çözümü Göster</button>
                    <div id="solution6" class="solution-box">
                        <pre><code class="language-sql">-- Kapsama operatörü kullanarak
SELECT
    name,
    attributes->>'brand' AS brand,
    price,
    attributes->>'storage' AS storage
FROM
    products
WHERE
    attributes @> '{"5g": true}'::jsonb
ORDER BY
    price DESC;

-- Alternatif: boolean değeri kontrol etme
SELECT
    name,
    attributes->>'brand' AS brand,
    price
FROM
    products
WHERE
    (attributes->>'5g')::BOOLEAN = true;</code></pre>
                    </div>
                </div>
            </section>

            <section>
                <div class="exercise-box">
                    <h4>Alıştırma 7: Stok Hareketi Analizi</h4>
                    <p><strong>Amaç:</strong> Her ürün için envanterdeki net değişimi göstermek üzere stok hareketlerini analiz edin. En az bir satış hareketi olan ürünleri dahil edin. Ürün adı, toplam satın alınan, toplam satılan ve net değişimi gösterin.</p>

                    <button class="toggle-btn" onclick="toggleSolution('solution7')">Çözümü Göster</button>
                    <div id="solution7" class="solution-box">
                        <pre><code class="language-sql">SELECT
    p.name AS product,
    p.sku,
    COALESCE(SUM(CASE WHEN sm.movement_type = 'purchase' THEN sm.quantity ELSE 0 END), 0) AS total_purchased,
    COALESCE(SUM(CASE WHEN sm.movement_type = 'sale' THEN ABS(sm.quantity) ELSE 0 END), 0) AS total_sold,
    COALESCE(SUM(CASE WHEN sm.movement_type = 'return' THEN sm.quantity ELSE 0 END), 0) AS total_returned,
    SUM(sm.quantity) AS net_change,
    p.stock_quantity AS current_stock
FROM
    products p
LEFT JOIN
    stock_movements sm ON p.id = sm.product_id
GROUP BY
    p.id, p.name, p.sku, p.stock_quantity
HAVING
    SUM(CASE WHEN sm.movement_type = 'sale' THEN 1 ELSE 0 END) > 0
ORDER BY
    total_sold DESC;</code></pre>
                    </div>
                </div>
            </section>

            <section>
                <h3 id="sonuc">Sonuç ve Sonraki Adımlar</h3>
                <p>Bu uygulamalı atölyede, <code>bootcamp_db</code> veritabanı yapısını keşfettiniz ve değerli iş içgörüleri çıkarmak için SQL sorguları yazmayı pratik ettiniz. Bu beceriler şunları yapmanızı sağlayacaktır:</p>
                <ol>
                    <li>Veritabanınızın altında yatan veri modelini anlama</li>
                    <li>Karar verme için gerekli belirli bilgileri çıkarma</li>
                    <li>Gerçek verileri inceleyerek sistem davranışını doğrulama</li>
                    <li>Belirli iş sorularını yanıtlayan özel raporlar oluşturma</li>
                    <li>PostgreSQL'in güçlü JSONB özellikleriyle JSON verileriyle çalışma</li>
                </ol>
                <p>Bu sorguları farklı iş sorularını yanıtlamak için değiştirerek veya birden fazla kavramı daha karmaşık analizlerde birleştirerek pratik yapmaya devam edin.</p>
            </section>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="../static/script.js"></script>

    <script>
        function toggleSolution(id) {
            var element = document.getElementById(id);
            if (element.classList.contains('show')) {
                element.classList.remove('show');
                event.target.textContent = 'Çözümü Göster';
            } else {
                element.classList.add('show');
                event.target.textContent = 'Çözümü Gizle';
            }
        }
    </script>
</body>

</html>
